/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","Store","service/avatar","Promise","lib/spin.min"],function(e,t,s,n,a,o,r,c,d){return function(){var l=new e,u=new a,p=new o({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),g=new o([]),m={},v=t.get("user"),h=t.get("transport"),b=t.get("labels"),f=new d({color:"#5F8F28",lines:8,length:8,width:4,radius:8,left:26,top:-7}).spin(),w=function(e,t){var s=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;"email"===e?s.test(t.toLowerCase())?(p.set("result",""),y("userid",t.toLowerCase())):p.set("result",b.get("signupinvalidemail")):p.get("email")?p.set("result",b.get("clearemailfirst")):p.get("firstname")&&p.get("lastname")?(p.set("result",""),y("username",p.get("firstname").toLowerCase()+" "+p.get("lastname").toLowerCase())):p.set("result",b.get("needbothfnln"))},y=function(e,s){var i=new a;i.setTransport(h),"userid"===e?i.sync(t.get("db"),"users","_view/searchbyid",{key:'"'+s+'"',descending:!0}).then(function(){g.reset(JSON.parse(i.toJSON())),g.getNbItems()?p.set("display",!0):p.set("invite",!0),i.unsync()}):i.sync(t.get("db"),"users","_view/searchbyusername",{key:'"'+s+'"',descending:!0}).then(function(){g.reset(JSON.parse(i.toJSON())),g.getNbItems()?p.set("display",!0):p.set("result",b.get("noentryfound")),i.unsync()})},L=function(e){var t,s,i,n,a=!1,o=v.get("sentMessages")||[],r=v.get("connections"),c=!1,d=!1;if(e.userid===v.get("_id"))p.set("result",b.get("cannotaddself"));else{for(s=0,i=r.length;i>s;s++)if(r[s].userid===e.userid){d=!0;break}if(d)p.set("result",e.username+b.get("alreadyconnected"));else{for(t=0,n=o.length;n>t;t++)if("CXR"===o[t].type&&o[t].toList.search(e.username)>-1){c=!0;break}c?p.set("result",b.get("alreadysentCXR")+e.username):a=!0}}return a},k=function(e){var t=new Date,s={};L(e)&&(s.dest=[e.userid],s.type="CXR",s.status="unread",s.date=[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],s.author=v.get("_id"),s.username=v.get("username"),s.firstname=v.get("firstname"),s.toList=e.username,s.ccList="",s.object=v.get("username")+b.get("CXRobject"),s.body=p.get("message"),s.signature=v.get("signature"),s.contactInfo={firstname:v.get("firstname"),lastname:v.get("lastname"),userid:v.get("_id"),username:v.get("username"),intro:v.get("intro"),type:"user"},h.request("Notify",s,function(e){var t=JSON.parse(e);"ok"===t[0].res?(p.set("result",b.get("CXRsent")),setTimeout(function(){l.reset()},2e3)):model.set("result","There was an error, please try again later")}))};return l.plugins.addAll({label:new s(b),count:new s(u),search:new s(p,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")}}),contacts:new s(g,{setAvatar:function(e){_frag=document.createDocumentFragment(),_ui=new r([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),searchdbevent:new n(l),invitecontactevent:new n(l)}),l.template='<div id="addcontact"><div class="header blue-dark"><span class="newcontactlbl" data-label="bind:innerHTML, newcontactlbl"></span></div><div class = "detail-contents"><div class="doctor-deedee"></div><div class="addcontactform"><p class="half"><span data-label="bind:innerHTML, beforecount"></span><strong><span data-count="bind:innerHTML, 0.value"></span></strong><span data-label="bind:innerHTML, aftercount"></span></p><p class="half" data-label="bind: innerHTML, addcontactrightintro"></p><legend data-label="bind:innerHTML, addcontactnow"></legend><input class="search" type="text" name="email" data-label="bind:placeholder, searchcontactplaceholder" data-search="bind: value, email" data-searchdbevent="listen: keypress, searchDB"><legend data-label="bind:innerHTML, lookup"></legend><div class="searchcontact"><input type="text" class="search half" name="fn" data-label="bind:placeholder, firstnameplaceholder" data-search="bind: value, firstname" data-searchdbevent="listen: keypress, searchDB"><input class="search half right" type="text" name="ln" data-label="bind: placeholder, lastnameplaceholder" data-search="bind: value, lastname" data-searchdbevent="listen: keypress, searchDB"></div><p class="searchresult" data-search="bind: innerHTML, result; bind:setStyle, sentok"></p></div><div class="contactinvite" data-search="bind: setVisible, invite"><p>The person you are looking for was not found in Ideafy. Would you like to send him/her an invitation ? You will receive 200 Ideafy Points if the person joins the community</p><div class="invitebuttons"><span class="sendmail" data-label="bind:innerHTML, sendlbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, sendInvite">Accept</span><span class="cancelmail" data-label="bind:innerHTML, cancellbl" data-invitecontactevent="listen: mousedown, press; listen:mouseup, cancelInvite">Cancel</span></div></div><div class = "contactlist invisible" data-search="bind: setVisible, display"><legend data-label="bind:innerHTML, selectcontact"></legend><ul data-contacts="foreach"><li class = "contact list-item"><div data-contacts="bind:setAvatar, value.userid"></div><p class="contact-name" data-contacts="bind:innerHTML, value.username"></p><p class="contact-intro" data-contacts="bind:innerHTML, value.intro"></p><div class="select-contact" data-searchdbevent="listen:mousedown, check"></div></li></ul><textarea class="input" data-label="bind:placeholder, addamessage" data-search="bind:value, message"></textarea><div class="addcontactbtns"><div class="addct" data-searchdbevent="listen:mousedown, push; listen:mouseup, add"></div><div class="cancelct" data-searchdbevent="listen:mousedown, push; listen:mouseup, cancel"></div></div></div></div></div>',l.init=function(){var e=new c;return u.setTransport(h),u.sync(t.get("db"),"users","_view/count").then(function(){e.fulfill()}),e},l.searchDB=function(e,t){var s;13===e.keyCode&&(e.target.blur(),s=t.getAttribute("name"),w(s,t.value))},l.check=function(e,t){var s=t.getAttribute("data-contacts_id");t.innerHTML?(t.innerHTML="",m[s]=!1):(t.innerHTML="&#10003;",m[s]=!0)},l.reset=function(){p.reset({email:"",firstname:"",lastname:"",result:"",display:!1,sentok:!1,message:"",invite:!1}),g.reset([])},l.push=function(e,t){t.classList.add("pushed")},l.cancel=function(e,t){t.classList.remove("pushed"),l.reset()},l.press=function(e,t){t.classList.add("pressed")},l.cancelInvite=function(e,t){t.classList.remove("pressed"),l.reset()},l.sendInvite=function(e,t){var s={id:p.get("email").toLowerCase(),senderid:v.get("_id"),sendername:v.get("username"),subject:v.get("username")+b.get("invitesyou"),body:b.get("invitebody")};f.spin(t),h.request("Invite",s,function(e){"ok"===e&&alert(b.get("invitationsent")),"alreadyinvited"===e&&alert(b.get("alreadyinvited")),f.stop(),t.classList.remove("pressed"),l.reset()})},l.add=function(e,t){t.classList.remove("pushed");for(i in Object.keys(m))k(g.get(i).value)},l}});