/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Amy/Stack-plugin","Bind.plugin","Event.plugin","Amy/Control-plugin","Store","service/avatar","service/actionbar","./addcontact","./addgroup","./contact-detail","./group-detail"],function(e,t,s,n,a,o,r,c,d,u,p,g,m,v){return function(){var h=new e,b=new n,f=new p,w=new g,y=new m,L=new v,k=new c([{name:"all",label:"allbtn",selected:!0},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),S=0,T=new c([]),x=null,q=s.get("user"),A=s.get("labels"),M=function(e){var t=k.get(e).name,s=q.get("connections"),n=s.length,a=[];switch(t){case"users":for(i=0;n>i;i++)"user"===s[i].type&&a.push(s[i]);break;case"groups":for(i=0;n>i;i++)"group"===s[i].type&&a.push(s[i]);break;default:a=s}return a},I=function(e){var t=[],s=[];if(t=q.get("connections").concat(),""===e)s=t,k.update(0,"selected",!0),S=0;else for(i=0,l=t.length;l>i;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&s.push(t[i]);return s};return h.plugins.addAll({label:new a(A),sort:new a(k,{setLabel:function(e){this.innerHTML=A.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),contact:new a(T,{setAvatar:function(e){var t,s,i=this.getAttribute("data-contact_id");"group"===e?(this.hasChildNodes()&&this.removeChild(this.firstChild),this.setAttribute("style","background: url('img/connect/"+T.get(i).color+"') no-repeat center center; background-size: contain;display:block; width:40px; height:40px;float:left;")):"user"===e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),s=new d([T.get(i).userid]),s.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "}}),contactdetailstack:b,contactlistcontrol:new r(h),contactlistevent:new o(h)}),h.template='<div id="connect-contacts"><div class="contacts"><div class="header blue-light"><span data-label="bind: innerHTML, contactlistheadertitle">My Contacts</span><div class="option right" data-contactlistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-contactlistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-contactlistevent="listen: keypress, search"><div class="contactlist overflow" data-contactlistcontrol="radio:li,selected,mousedown,selectContact"><ul data-contact="foreach"><li class="contact list-item" data-contactlistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-contact="bind:setAvatar, type"></div><p class="contact-name" data-contact="bind:innerHTML, username"></p><p class="contact-intro" data-contact="bind:setIntro, intro"></p><div class="select-contact"></div></li></ul></div></div><div id="toggleadd" class="group" data-contactlistevent="listen:mousedown, press; listen:mouseup, toggleAddUI"></div><div id="contact-detail" class="details" data-contactdetailstack="destination"></div></div>',h.place(t.get("connect-contacts")),h.plus=function(){var e=document.getElementById("toggleadd");b.getStack().get("#addcontact").reset(),b.getStack().show("#addcontact"),e.classList.contains("user")&&e.classList.remove("user"),e.classList.add("group")},h.init=function(){T.reset(q.get("connections")),f.init().then(function(){b.getStack().show("#addcontact")}),w.init(),L.init()},h.reset=function(){T.reset(q.get("connections")),f.reset(),b.getStack().show("#addcontact")},h.getSelectedContact=function(){var e=document.querySelector(".contact.selected"),t=-1;return e&&(t=e.getAttribute("data-contact_id")),t},h.selectContact=function(e){var t=e.target.getAttribute("data-contact_id"),s=T.get(t);document.getElementById("toggleadd").classList.remove("group"),document.getElementById("toggleadd").classList.remove("user"),"user"===s.type?(y.reset(T.get(t)),"#contactdetails"!==b.getStack().getCurrentName()&&b.getStack().show("#contactdetails")):(L.reset(T.get(t)),"#groupdetails"!==b.getStack().getCurrentName()&&b.getStack().show("#groupdetails"))},h.displaySort=function(e,t){var s=t.getAttribute("data-sort_id");T.reset([]),S>-1&&k.update(S,"selected",!1),k.update(s,"selected",!0),S=s,T.reset(M(s))},h.search=function(e,t){13===e.keyCode&&(k.update(S,"selected",!1),S=-1,T.reset(I(t.value)))},h.setStart=function(){x&&x.hide()},h.showActionBar=function(e,t){var s,i=t.getAttribute("data-contact_id"),n=!1;x&&x.getParent()===t&&(n=!0),n||(x=new u("contact",t,T.get(i)),s=document.createDocumentFragment(),x.place(s),t.appendChild(s),n=!0)},h.press=function(e,t){t.classList.add("pressed")},h.toggleAddUI=function(e,t){t.classList.remove("pressed"),t.classList.contains("group")?(t.classList.remove("group"),b.getStack().get("#addgroup").reset(),b.getStack().show("#addgroup"),t.classList.add("user")):(t.classList.remove("user"),b.getStack().get("#addcontact").reset(),b.getStack().show("#addcontact"),t.classList.add("group"))},b.getStack().add("#contactdetails",y),b.getStack().add("#groupdetails",L),b.getStack().add("#addcontact",f),b.getStack().add("#addgroup",w),w.init(),h.init(),q.watchValue("connections",function(){var e;S>-1&&T.reset(M(S)),"#contactdetails"===b.getStack().getCurrentName()&&(e=h.getSelectedContact(),e>-1?(contactDetail.reset(T.get(e)),b.getStack().show("#contactdetails")):(b.getStack().show("#addcontact"),document.getElementById("toggleadd").classList.add("group")))}),s.get("observer").watch("contact-deleted",function(){b.getStack().show("#addcontact")}),q.watchValue("lang",function(){var e;k.loop(function(t,s){t.selected&&(e=s)}),k.reset([{name:"all",label:"allbtn",selected:!1},{name:"users",label:"usrbtn",selected:!1},{name:"groups",label:"grpbtn",selected:!1}]),k.update(e,"selected",!0)}),h}});