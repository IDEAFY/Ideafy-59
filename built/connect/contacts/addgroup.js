/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/avatar"],function(e,t,s,n,a,o){return function(){var r=new e,c=new a({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),d=new a([{color:"#4D4D4D",icon:"graygroup.png",selected:!0},{color:"#657B99",icon:"bluegroup.png",selected:!1},{color:"#9AC9CD",icon:"azurgroup.png",selected:!1},{color:"#5F8F28",icon:"greengroup.png",selected:!1},{color:"#F2E520",icon:"yellowgroup.png",selected:!1},{color:"#F27B3D",icon:"orangegroup.png",selected:!1},{color:"#BD262C",icon:"redgroup.png",selected:!1}]),u=new a([]),p=new a([]),g=new a({error:""}),m=t.get("user"),v=t.get("labels");return r.plugins.addAll({label:new s(v),error:new s(g),color:new s(d,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),group:new s(c,{setColor:function(e){this.setAttribute("style","background: url('img/connect/"+e+"') no-repeat top left; background-size: contain;")},setStyle:function(e){e?this.setAttribute("style","color: #5F8F28;"):this.setAttribute("style","color: #F27B3D;")},setVisible:function(e){e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),contacts:new s(u,{setAvatar:function(e){_frag=document.createDocumentFragment(),_ui=new o([e]),_ui.place(_frag),this.hasChildNodes()?this.replaceChild(_frag,this.firstChild):this.appendChild(_frag)},setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),auto:new s(p,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),addgrpevent:new n(r)}),r.template='<div id="addgroup"><div class="header blue-dark"><span class="newfolderlbl" data-label="bind:innerHTML, newfolderlbl"></span></div><div class = "detail-contents"><div class="folderpic" data-group="bind: setColor, color"></div><form><p><input type="text" class="input" data-group="bind:value, username" data-label="bind:placeholder, groupnamelbl"></p><p><textarea class="input" data-group="bind:value, intro" data-label="bind:placeholder, groupdesclbl"></textarea></p><legend data-label="bind:innerHTML, colortouch"></legend><ul class="groupcolors" data-color="foreach"><li data-color="bind:setColor, color; bind:setSelected, selected" data-addgrpevent="listen: mousedown, selectColor"></li></ul></form><div class = "groupcontactlist" data-group="bind: setVisible, contacts"><legend name="list" data-label="bind:innerHTML, grpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><ul class="contactlistdetail" data-contacts="foreach"><li class = "contact list-item" data-addgrpevent="listen:mousedown, discardContact"><div data-contacts="bind:setAvatar, userid"></div><p class="contact-name" data-contacts="bind:innerHTML, username"></p><div class="remove-contact"></div><p class="contact-intro" data-contacts="bind:innerHTML, intro"></p></li></ul></div><div class="addgroupbtns"><span class="errormsg" data-error="bind:innerHTML, error"></span><div class="addct" data-addgrpevent="listen:mousedown, press; listen:mouseup, add"></div><div class="cancelct" data-addgrpevent="listen:mousedown, press; listen:mouseup, cancel"></div></div><div class="addgrpcontacts"><legend name="add" data-label="bind:innerHTML, addgrpcontacts" data-addgrpevent="listen: mousedown, toggleHide"></legend><div class="addgrpcontactdetails"><input class="search" data-addgrpevent="listen:keyup, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div class = "autocontact"><ul data-auto="foreach"><li data-auto="bind:innerHTML, contact.username; bind:highlight, selected" data-addgrpevent="listen:mouseup, select"></li></ul></div></div></div></div>',r.init=function(){m.get("connections").forEach(function(e){"user"===e.type&&p.alter("push",{contact:e,selected:!1})})},r.selectColor=function(e,t){var s=t.getAttribute("data-color_id");d.loop(function(e,t){d.update(t,"selected",!1)}),d.update(s,"selected",!0),c.set("color",d.get(s).icon)},r.toggleHide=function(e,t){var s=t.getAttribute("name");t.classList.contains("hide")?(t.classList.remove("hide"),"add"===s?document.querySelector(".addgrpcontactdetails").classList.remove("invisible"):document.querySelector(".contactlistdetail").classList.remove("invisible")):(t.classList.add("hide"),"add"===s?document.querySelector(".addgrpcontactdetails").classList.add("invisible"):document.querySelector(".contactlistdetail").classList.add("invisible"))},r.select=function(e,t){var s=t.getAttribute("data-auto_id");p.get(s).selected?(r.removeContact(s),setTimeout(function(){p.update(s,"selected",!1)},200)):(r.addContact(s),setTimeout(function(){p.update(s,"selected",!0)},200))},r.addContact=function(e){var t=JSON.parse(u.toJSON()),s=p.get(e).contact,n=0;if(u.toJSON().search(s.userid)<0){for(i=0,l=t.length;l>i;i++)s.lastname>t[i].lastname?n++:s.lastname===t[i].lastname&&s.username>t[i].username&&n++;t.splice(n,0,s),u.reset(t),c.set("contacts",t)}},r.removeContact=function(e){var t=JSON.parse(u.toJSON());for(i=t.length-1;i>=0;i--)t[i].userid===p.get(e).contact.userid&&t.splice(i,1);u.reset(t)},r.updateAutoContact=function(e,t){var s,n=JSON.parse(p.toJSON()),a=m.get("connections"),o=t.value.toLowerCase();if(""===t.value)for(n=[],i=0,l=a.length;l>i;i++)"user"===a[i].type&&n.push({contact:a[i],selected:!1});else if(8===e.keyCode||46===e.keyCode){for(n=[],i=0,l=a.length;l>i;i++)"user"===a[i].type&&n.push({contact:a[i],selected:!1});for(i=n.length-1;i>=0;i--)0!==n[i].contact.username.toLowerCase().search(o)&&n.splice(i,1)}else for(i=n.length-1;i>=0;i--)s=n[i].contact.username.toLowerCase(),0!==s.search(o)&&n.splice(i,1);p.reset(n),p.loop(function(e,t){u.toJSON().search(e.contact.userid)>-1&&p.update(t,"selected",!0)})},r.discardContact=function(e,t){var s=t.getAttribute("data-contacts_id"),i=u.get(s).userid;u.alter("splice",s,1),p.loop(function(e,t){e.contact.userid===i&&setTimeout(function(){p.update(t,"selected",!1)},200)})},r.reset=function(){c.reset({username:"",intro:"",type:"group",color:"graygroup.png",contacts:[]}),u.reset([]),p.reset([]),g.reset({error:""}),m.get("connections").forEach(function(e){"user"===e.type&&p.alter("push",{contact:e,selected:!1})})},r.press=function(e,t){t.classList.add("pushed")},r.cancel=function(e,t){t.classList.remove("pushed"),r.reset(),document.querySelector("#addgroup input.search").value=""},r.add=function(e,t){var s=m.get("connections"),n=0,a=JSON.parse(c.toJSON());if(t.classList.remove("pushed"),g.set("error",""),""===a.username)g.set("error",v.get("nogrpname"));else if(""===a.intro)g.set("error",v.get("nogrpintro"));else if(a.contacts.length){for(i=0,l=s.length;l>i;i++)"user"===s[i].type?a.username>s[i].lastname&&n++:(a.username===s[i].username&&g.set("error",v.get("grpnameexists")),a.username>s[i].username&&n++);g.get("error")||(s.splice(n,0,a),m.set("connections",s),m.upload().then(function(){r.reset()}))}else g.set("error",v.get("nocontactselected"))},r}});