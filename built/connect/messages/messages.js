/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Amy/Control-plugin","Amy/Stack-plugin","Store","service/config","service/avatar","service/utils","./message-detail","./newmessage","service/actionbar","Promise"],function(e,t,s,n,a,o,r,c,d,u,p,g,m,v){return function(){var b=new e,h=new a(b),f=new o,w=function(e){f.getStack().show(e)},y="#defaultPage",L=new e,k=new p(w),S=new g(w),T=new r([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),M=0,x=new r([]),q=c.get("labels"),A=null,C=c.get("user"),H=c.get("observer"),I=function(e){var t,s=T.get(e).name,i=C.get("notifications"),n=i.length,a=[];switch(s){case"messages":for(t=0;n>t;t++)"MSG"===i[t].type&&a.push(i[t]);break;case"notifications":for(t=0;n>t;t++)"MSG"!==i[t].type&&a.push(i[t]);break;case"unread":for(t=0;n>t;t++)"unread"===i[t].status&&a.push(i[t]);break;default:a=i}return a},D=function(e){var t=[],s=[];if(t=C.get("notifications").concat(),""===e)s=t,T.update(0,"selected",!0),M=0;else for(i=0,l=t.length;l>i;i++)JSON.stringify(t[i]).toLowerCase().search(e.toLowerCase())>-1&&s.push(t[i]);return s};return b.plugins.addAll({label:new s(q),sort:new s(T,{setLabel:function(e){this.innerHTML=q.get(e)},setSelected:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")}}),msg:new s(x,{setObject:function(e){var t=this.getAttribute("data-msg_id");switch(e){case"INV":this.innerHTML=x.get(t).username+q.get("INVObject");break;case"CXR":this.innerHTML=x.get(t).username+q.get("CXRobject");break;case"CXRaccept":this.innerHTML=x.get(t).username+q.get("acceptedCXR");break;case"CXRreject":this.innerHTML=x.get(t).username+q.get("rejectedCXR");break;case"CXCancel":this.innerHTML=x.get(t).username+q.get("canceledCX");break;case"DOC":this.innerHTML=x.get(t).username+q.get("sentdocmsg");break;case"2Q+":this.innerHTML=x.get(t).username+q.get("askednew");break;case"2C+":this.innerHTML=x.get(t).username+q.get("senttc");break;case"REF":this.innerHTML=x.get(t).username+q.get("joinedideafy");break;case"MUD-":this.innerHTML=q.get("muinaday");break;case"MUQ-":this.innerHTML=q.get("mufifteen");break;case"MUP+":this.innerHTML=q.get("newpart");break;case"MUP-":this.innerHTML=q.get("partleft");break;case"SCANCEL":this.innerHTML=q.get("scancel");break;case"SSTART":this.innerHTML=q.get("sstart");break;default:this.innerHTML=x.get(t).object}},date:function N(N){var e=new Date;if(N&&N[0]===e.getFullYear()&&N[1]===e.getMonth()&&N[2]===e.getDate()){var t=N[3],s=N[4],i=N[5];10>t&&(t="0"+t),10>s&&(s="0"+s),10>i&&(i="0"+i),this.innerHTML=t+":"+s+":"+i}else this.innerHTML=u.formatDate(N)},highlight:function(e){e&&"unread"===e?this.classList.add("unread"):this.classList.remove("unread")},setAvatar:function(e){var t,s;e&&(t=document.createDocumentFragment(),s=new d([e]),s.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))}}),msglistevent:new n(b),msglistcontrol:h,msgdetailstack:f}),b.template='<div id="connect-messages"><div class="messages"><div class="header blue-light"><span data-label="bind: innerHTML, msglistheadertitle">My Messages</span><div class="option right" data-msglistevent="listen: mousedown, plus"></div></div><ul class="selectors" data-sort = "foreach"><li class="sort-button" data-sort="bind: setLabel, label; bind:setSelected, selected, bind: name, name" data-msglistevent="listen:mousedown, displaySort"></li></ul><input class="search" type="text" data-label="bind: placeholder, searchmsgplaceholder" data-msglistevent="listen: keypress, search"><div class="msglist overflow" data-msglistcontrol="radio:li,selected,mouseup,selectMsg"><ul data-msg="foreach"><li class="msg list-item" data-msglistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div data-msg="bind:setAvatar, author"></div><p class="msg-author unread" data-msg="bind:highlight, status; bind:innerHTML, username">Author</p><div class="select-msg"></div><span class="date" data-msg="bind: date, date"></span><p class="msg-subject unread" data-msg="bind:highlight, status; bind:setObject, type">Subject</p></li></ul></div></div><div id="msg-detail" class="details" data-msgdetailstack="destination"></div></div>',b.place(t.get("connect-messages")),b.plus=function(){f.getStack().get("#newmsg").reset(),f.getStack().show("#newmsg")},b.displaySort=function(e,t){var s=t.getAttribute("data-sort_id");x.reset([]),f.getStack().show("#defaultPage"),M>-1&&T.update(M,"selected",!1),T.update(s,"selected",!0),M=s,x.reset(I(s))},b.search=function(e,t){13===e.keyCode&&(T.update(M,"selected",!1),M=-1,x.reset(D(t.value)))},b.selectMsg=function(e){var t=e.target.getAttribute("data-msg_id"),s=C.get("notifications");if("unread"===x.get(t).status){for(i=0,l=s.length;l>i;i++)if(JSON.stringify(s[i])===JSON.stringify(x.get(t))){index=i;break}x.update(t,"status","read"),s[index]=x.get(t),C.set("notifications",s),C.upload()}f.getStack().show("#msgdetail"),k.reset(x.get(t)),y="#msgdetail"},b.init=function(){x.reset(C.get("notifications")),b.cleanOld()},b.reset=function(){T.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),b.init(),f.getStack().show("#defaultPage"),display=!1},b.getSelectedmsg=function(){var e=document.querySelector(".msg.selected"),t=-1;return e&&(t=e.getAttribute("data-msg_id")),t},b.cleanOld=function(){var e,t,s=new v,n=new Date,a=!1,o=C.get("notifications")||[],r=C.get("sentMessages")||[];for(i=o.length-1;i>=0;i--)e=new Date(o[i].date[0],o[i].date[1],o[i].date[2],o[i].date[3],o[i].date[4],o[i].date[5]),n.getTime()-e.getTime()>2592e6&&(o.pop(),a=!0);for(i=r.length-1;i>=0;i--)t=new Date(r[i].date[0],r[i].date[1],r[i].date[2],r[i].date[3],r[i].date[4],r[i].date[5]),n.getTime()-t.getTime()>2592e6&&(r.pop(),a=!0);return a?(C.set("notifications",o),C.set("sentMessages",r),C.upload().then(function(){s.fulfill()})):s.fulfill(),s},b.setStart=function(){A&&A.hide()},b.showActionBar=function(e,t){var s,i=t.getAttribute("data-msg_id"),n=!1;A&&A.getParent()===t&&(n=!0),n||(A=new m("message",t,x.get(i)),s=document.createDocumentFragment(),A.place(s),t.appendChild(s),n=!0)},L.template='<div class="msgsplash"><div class="header blue-dark"><span>'+c.get("labels").get("messageview")+'</span></div><div class="innersplash" data-labels="bind: innerHTML, messagecenter"></div></div>',L.plugins.add("labels",new s(q)),b.init(),f.getStack().add("#defaultPage",L),f.getStack().add("#msgdetail",k),f.getStack().add("#newmsg",S),f.getStack().show("#defaultPage"),C.watchValue("notifications",function(){var e,t=[];x.reset([]),t=I(M),x.reset(t),"#msgdetail"===f.getStack().getCurrentName()&&(e=b.getSelectedmsg(),e>-1?k.reset(x.get(e)):f.getStack().show("#defaultPage"))}),H.watch("display-message",function(e){var t=C.get("notifications");T.update(M,"selected",!1),"MSG"===t[e].type?(T.update(1,"selected",!0),M=1):(T.update(2,"selected",!0),M=2),t[e].status="read",C.set("notifications",t),C.upload(),x.reset([t[e]]),document.querySelector('li[data-msg_id="0"]').classList.add("selected"),h.init(document.querySelector('li[data-msg_id="0"]')),f.getStack().show("#msgdetail"),k.reset(t[e]),y="#msgdetail"}),H.watch("message-contact",function(e){S.reset(e),f.getStack().show("#newmsg")}),C.watchValue("lang",function(){var e;T.loop(function(t,s){t.selected&&(e=s)}),T.reset([{name:"all",label:"allbtn",selected:!0},{name:"messages",label:"msgbtn",selected:!1},{name:"notifications",label:"notifbtn",selected:!1},{name:"unread",label:"unreadbtn",selected:!1}]),T.update(e,"selected",!0)}),b}});