/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,s,i,n,a,o,c,r,l){function d(e,d,u,p,g){var m=new s([]),v=new t([]),h="",b=null,f={db:d,view:p,design:u,query:{descending:!0}},w=i.get("labels"),y=this;m.setTransport(i.get("transport")),h="contact"===e?"contacttwoqlist":"",this.template='<div><ul class="twoq-list '+h+'" data-twoqlist="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqlist="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqlist="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqlist="bind:showReplies, value.twocents"></span></div></li></ul><ul class="twoq-searchlist invisible '+h+'" data-twoqsearch="foreach"><li class="list-item" data-twoqlistevent="listen:mousedown, setStart"><div class="item-header"><span class="date" data-twoqsearch="bind:date,value.creation_date"></span></div><div class="item-body"><p data-twoqsearch="bind:innerHTML,value.question"></p></div><div class="item-footer"><a class="item-twocent"></a><span class="replies" data-twoqsearch="bind:showReplies, value.twocents"></span></div></li></ul></div>',this.plugins.addAll({twoqlist:new n(m,{date:function L(L){this.innerHTML=L?o.formatDate(L):""},showReplies:function(e){var t;e&&(t=e.length),0===t?this.innerHTML=w.get("noreplyyet"):1===t?this.innerHTML=t+" "+w.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+w.get("showtcrepliesafter"))},setAvatar:function(e){var t,s;e&&(s=document.createDocumentFragment(),t=new c([e]),t.place(s),this.hasChildNodes()?this.replaceChild(s,this.firstChild):this.appendChild(s))},setVisibility:function(e){e&&"public"===e?this.classList.add("public"):this.classList.remove("public")}}),twoqsearch:new n(v,{date:function k(k){this.innerHTML=k?o.formatDate(k):""},showReplies:function(e){var t;e&&(t=e.length),0===t?this.innerHTML=w.get("noreplyyet"):1===t?this.innerHTML=t+" "+w.get("showonetcreply"):t>1&&(this.innerHTML=t+" "+w.get("showtcrepliesafter"))},setAvatar:function(e){var t,s;e&&(s=document.createDocumentFragment(),t=new c([e]),t.place(s),this.hasChildNodes()?this.replaceChild(s,this.firstChild):this.appendChild(s))},setVisibility:function(e){e&&"public"===e?this.classList.add("public"):this.classList.remove("public")}}),twoqlistevent:new a(this)}),this.getModel=function(){var e,t;return t=!y.dom.querySelector(".twoq-searchlist").classList.contains("invisible"),e=t?v:m},this.resetQuery=function(e){var t=new l;return f.query=e,m.unsync(),m.reset([]),y.hideSearch(),m.sync(f.db,f.design,f.view,f.query).then(function(){t.fulfill()}),t},this.setStart=function(){b&&b.hide()},this.showActionBar=function(e,t){var s,i=t.getAttribute("data-twoqlist_id"),n=!1,a=document.getElementById("mtc-list");b&&b.getParent()===t&&(n=!0),a.classList.contains("mosaic")||n||(b=new r("2Q",t,m.get(i).value),s=document.createDocumentFragment(),b.place(s),t.appendChild(s),n=!0)},this.showSearch=function(){var e=document.querySelector(".twoq-searchlist"),t=document.querySelector(".twoq-list");e&&e.classList.contains("invisible")&&(t.classList.add("invisible"),e.classList.remove("invisible"))},this.hideSearch=function(){var e=this.dom.querySelector(".twoq-searchlist"),t=this.dom.querySelector(".twoq-list");e&&!e.classList.contains("invisible")&&(t.classList.remove("invisible"),e.classList.add("invisible"))},this.search=function(e){v.reset([]),e.toLowerCase()?(this.showSearch(),m.loop(function(t){JSON.stringify(t).search(e)>-1&&v.alter("push",t)})):this.hideSearch()},g&&(f.query=g),this.init=function(){var e=new l;return m.sync(f.db,f.design,f.view,f.query).then(function(){e.fulfill()}),e}}return function(t,s,i,n,a){return d.prototype=new e,new d(t,s,i,n,a)}});