/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min","service/confirm"],function(e,t,s,n,a,l,o,d,r,c){return function(){var d,u=new e,m=t.get("labels"),g=t.get("user"),p=t.get("transport"),v=new s,h=new n({msg:""}),b=new n([]),f=new r({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return v.setTransport(p),u.plugins.addAll({labels:new a(m),model:new a(v,{setTitle:function(e){this.innerHTML=e,g.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),g.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},showDate:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){var t,i;e?(this.setAttribute("style","display:inline-block"),t=new Date(e),i=new Date,this.innerHTML=t.toDateString()===i.toDateString()?m.get("today"):t.toLocaleDateString()):this.setAttribute("style","display:none")},setTime:function(e){var t,i;e?(this.setAttribute("style","display:inline-block"),t=new Date(e),i=new Date,this.innerHTML=t.getTime()-i.getTime()<=3e5?m.get("now"):t.toLocaleTimeString().replace(/:\d\d /," ")):this.setAttribute("style","display:none")},setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new o([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setUsername:function(e){e&&(this.innerHTML=e)},setIntro:function(e){this.innerHTML=e?e:" "},showJoinButton:function(e){u.displayJoinButton(this,e,v.get("participants"))},updateJoinButton:function(e){var t=this;b.reset(e),u.displayJoinButton(t,v.get("status"),e)},displayCancel:function(e){this.innerHTML=e.id===g.get("_id")?"&#10007":""}}),participant:new a(b,{setAvatar:function(e){var t,i;this.setAttribute("style","background:none;"),e&&(t=document.createDocumentFragment(),i=new o([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},showCancel:function(e){e===g.get("_id")?this.classList.remove("invisible"):this.classList.add("invisible")}}),info:new a(h,{showMsg:function(e){e?(this.innerHTML=e,this.classList.remove("invisible")):(this.classList.add("invisible"),this.innerHTML="")}}),previewevent:new l(u)}),u.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:mousedown, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="datetime invisible" data-model="bind:showDate, scheduled"><div class="date" data-model="bind: setDate, scheduled"></div><div class="time" data-model="bind:setTime, scheduled"></div><div class="cancelsession" data-model = "bind: displayCancel, initiator" data-previewevent="listen: mousedown, cancelSession">&#10007</div></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:setUsername, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p><div class="cancelsession cancelpart invisible" data-participant="bind:showCancel, id" data-previewevent="listen: mousedown, cancelPart">&#10007</div></li></ul></div><div class="start-button invisible" data-model="bind:showJoinButton, status; bind: updateJoinButton, participants" data-previewevent="listen: mousedown, press; listen:mouseup, action"></div><div class="infopreview invisible" data-info="bind:showMsg, msg"></div></div></div>',u.reset=function(e){u.dom.classList.remove("invisible"),v.sync(t.get("db"),e).then(function(){v.watchValue("participants",function(){b.reset(v.get("participants").concat())})})},u.closePreview=function(){u.dom.classList.add("invisible"),v.unsync(),v.reset({}),d&&d()},u.press=function(e,t){t.classList.add("pressed")},u.notify=function(e){var t,s={},n=new Date,a=v.get("initiator").id,l=v.get("participants")||[],o=[];for(t=[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],s={status:"unread",date:t,author:g.get("_id"),username:g.get("username"),firstname:g.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:v.get("_id"),docTitle:v.get("title"),scheduled:v.get("scheduled")},i=0;i<l.length;i++)o.push(l[i].id);switch(e){case"newpart":s.type="MUP+",s.dest=[a].concat(o);break;case"partleave":s.type="MUP-",s.dest=[a].concat(o);break;case"cancel":s.type="SCANCEL",s.dest=o;break;case"start":s.type="SSTART",s.dest=o}p.request("Notify",s,function(e){return e})},u.action=function w(e,t){var w=t.getAttribute("name"),i=v.get("participants").concat()||[];switch(t.classList.add("invisible"),t.classList.remove("pressed"),f.spin(t.parentNode),w){case"open":v.get("initiator").id===g.get("_id")?(v.set("status","waiting"),v.upload().then(function(){v.get("scheduled")&&u.notify("start"),u.enter()})):console.log("Error : operation not permitted for ",g.get("_id"));break;case"enter":i.indexOf(g.get("_id"))>-1?u.enter():console.log("Error: operation not permitted for ",g.get("_id"));break;case"join":i.indexOf(g.get("_id"))>-1||i.length>=3?console.log("Error session already full and/or user already a participant"):(i.push({id:g.get("_id"),intro:g.get("intro"),username:g.get("username")}),v.set("participants",i),v.upload().then(function(){b.reset(v.get("participants")),v.get("scheduled")&&u.notify("newpart"),"waiting"===v.get("status")?u.enter():f.stop()}))}},u.enter=function(){t.get("observer").notify("join-musession",v.get("_id")),setTimeout(function(){f.stop(),u.dom.classList.add("invisible"),v.unsync(),v.reset()},3e3)},u.init=function(e){d=e},u.displayJoinButton=function(e,t,i){var s=g.get("_id"),n=v.get("initiator").id,a=v.get("scheduled")||0;now=(new Date).getTime(),a&&(a=new Date(a).getTime()),e.hasAttribute("name")&&e.removeAttribute("name"),"in progress"===t?h.set("msg",m.get("sessionstarted")):"deleted"===t?h.set("msg",m.get("sessiondeleted")):n===s?"waiting"!==t&&"scheduled"!==t?e.classList.add("invisible"):9e5>a-now?(e.innerHTML=m.get("openbutton"),e.setAttribute("name","open"),e.classList.remove("invisible"),h.set("msg",m.get("opennow"))):(e.classList.add("invisible"),h.set("msg",m.get("openfifteen"))):JSON.stringify(i).search(s)>-1?"waiting"===t?(e.innerHTML=m.get("enterbutton"),e.setAttribute("name","enter"),e.classList.remove("invisible"),h.set("msg",m.get("enternow"))):(e.classList.add("invisible"),h.set("msg",m.get("enterfifteen"))):i.length<3&&("scheduled"===t||"waiting"===t)?(e.innerHTML=m.get("joinbutton"),e.setAttribute("name","join"),e.classList.remove("invisible"),h.set("msg",m.get("joinnow"))):(e.classList.add("invisible"),h.set("msg",m.get("sessionfull")))},u.cancelSession=function(){var e=function(e){console.log(e),e&&(v.set("status","deleted"),console.log("before muCDB upload"),v.upload().then(function(){return console.log("upload successful",v.toJSON()),v.get("participants").length&&u.notify("cancel"),v.remove()}).then(function(){console.log("remove successful"),u.closePreview()})),c.hide()};c.reset(m.get("delsession"),e,"musession-confirm"),c.show()},u.cancelPart=function(e,t){var i=t.getAttribute("data-participant_id"),s=v.get("participants").concat(),n=function(e){e&&(b.alter("splice",i,1),s.splice(i,1),v.set("participants",s),v.upload().then(function(){u.notify("partleave")})),c.hide()};c.reset(m.get("partcancel"),n,"musession-confirm"),c.show()},u}});