/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","CouchDBDocument","Store","Bind.plugin","Event.plugin","service/avatar","service/utils","lib/spin.min"],function(e,t,i,s,a,n,l,o,d){return function(){var o,r=new e,c=t.get("labels"),u=t.get("user"),m=new i,g=new s({msg:""}),v=new s([]),p=new d({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return m.setTransport(t.get("transport")),r.plugins.addAll({labels:new a(c),model:new a(m,{setTitle:function(e){this.innerHTML=e,u.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>"),u.get("_id")===session.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},showDate:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){var t,i;e?(this.setAttribute("style","display:inline-block"),t=new Date(e),i=new Date,this.innerHTML=t.getDate()===i.getDate()?c.get("today"):t.toLocaleDateString()):this.setAttribute("style","display:none")},setTime:function(e){var t,i;e?(this.setAttribute("style","display:inline-block"),t=new Date(e),i=new Date,this.innerHTML=t.getTime()-i.getTime()<=3e5?c.get("now"):t.toLocaleTimeString().replace(/:\d\d /," ")):this.setAttribute("style","display:none")},setAvatar:function(e){var t,i;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new l([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){this.innerHTML=e?e:" "},showJoinButton:function(e){var t=u.get("_id"),i=m.get("initiator"),s=m.get("participants")||[],a=(new Date).getTime(),n=new Date(scheduled).getTime();this.hasAttribute("name")&&this.removeAttribute("name"),"in progress"===e?g.set("msg",c.get("sessionstarted")):"deleted"===e?(g.set("msg",c.get("sessiondeleted")),m.unsync()):i===t?"scheduled"!==e?this.classList.add("invisible"):9e5>n-a?(this.innerHTML=c.get("openbutton"),this.setAttribute("name","open"),this.classList.remove("invisible"),g.set("msg",c.get("opennow"))):(this.classList.add("invisible"),g.set("msg",c.get("openfifteen"))):s.indexOf(t)>-1?"waiting"===e?(this.innerHTML=c.get("enterbutton"),this.setAttribute("name","enter"),this.classList.remove("invisible"),g.set("msg",c.get("enternow"))):(this.classList.add("invisible"),g.set("msg",c.get("enterfifteen"))):s.length<3&&"scheduled"===e?(this.innerHTML=c.get("joinbutton"),this.setAttribute("name","join"),this.classList.remove("invisible"),g.set("msg",c.get("joinnow"))):(this.classList.add("invisible"),g.set("msg",c.get("sessionfull")))}}),participant:new a(v,{setAvatar:function(e){var t,i;this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new l([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setIntro:function(e){this.innerHTML=e?e:" "}}),info:new a(g),previewevent:new n(r)}),r.template='<div id="mupreview" class="invisible"><div class="cache"></div><div class="contentarea"><div class="close" data-previewevent="listen:mousedown, closePreview"></div><div class="mubwait-title" name="title" data-model="bind:setTitle, title"></div><div class="datetime invisible" data-model="bind:showDate, scheduled"><div class="date" data-model="bind: setDate, scheduled"></div><div class="time" data-model="bind:setTime, scheduled"></div></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-model="bind:showJoinButton, status" data-previewevent="listen: mousedown, press; listen:mouseup, action"></div><div class="infopreview invisible" data-info="bind:innerHTML, msg"></div></div></div>',r.reset=function(e){document.getElementById("mupreview").classList.remove("invisible"),m.sync(t.get("db"),e).then(function(){v.reset(m.get("participants"))})},r.closePreview=function(){r.dom.classList.add("invisible"),m.unsync(),m.reset(),o()},r.press=function(e,t){t.classList.add("pressed")},r.action=function h(e,t){var h=t.getAttribute("name"),i=m.get("participants").concat()||[];switch(t.classList.add("invisible"),t.classList.remove("pressed"),p.spin(t.parentNode),h){case"open":m.get("initiator").id===u.get("_id")?(m.set("status","waiting"),m.upload().then(function(){r.join()})):console.log("Error : operation not permitted for ",u.get("_id"));break;case"enter":i.indexOf(u.get("_id"))>-1?r.join():console.log("Error: operation not permitted for ",u.get("_id"));break;case"join":i.indexOf(u.get("_id"))>-1||i.length>=3?console.log("Error session already full and/or user already a participant"):(i.push(u.get("_id")),m.set("participants",i),m.upload().then(function(){r.join()}))}},r.join=function(){t.get("observer").notify("join-musession",m.get("_id")),setTimeout(function(){p.stop(),r.dom.classList.add("invisible"),m.unsync(),m.reset()},5e3)},r.init=function(e){o=e},m.watchValue("participants",function(e){var t=document.getElementById("mupreview"),i=t.querySelector(".start-button");t.querySelector(".infopreview"),v.reset(e),e.length<3&&"waiting"===m.get("status")?(i.classList.remove("invisible"),g.set("msg",c.get("joinnow"))):(3===e.length&&"waiting"===m.get("status")&&(i.classList.add("invisible"),g.set("msg",c.get("sessionfull"))),i.classList.add("invisible"))}),r}});