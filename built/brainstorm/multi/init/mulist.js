/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview","service/utils"],function(e,t,s,i,a,n,l,o,r,d,c,o){return function(){var u,m=new e,g=a.get("labels"),v=a.get("user"),p=a.get("db"),h=a.get("transport"),b=new l([]),f=new l([]),y=new c,w=(new l([]),new l({modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"})),L=new l([{name:"*"}]),S=a.get("userLanguages"),T="mulistall",A=new r({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200}).spin();return S.forEach(function(e){L.alter("push",e)}),m.plugins.addAll({labels:new t(g),options:new t(w,{setBg:function(e){"all"===e?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))},setMode:function(e){var t,s,i="";for(t=0,s=e.length;s>t;t++)i+="<option>"+g.get(e[t])+"</option>";this.innerHTML=i}}),select:new t(L,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),muall:new t(b,{setParticipants:function(e){var t,s=e.length+1,i="<ul>";for(t=0;s>t;t++)i+="<li></li>";i+="</ul>",this.innerHTML=i},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setDate:function(e){var t,s;e?(t=new Date,s=new Date(e),this.innerHTML=t.toDateString()===s.toDateString()?s.getTime()-t.getTime()<=3e5?g.get("now"):s.toLocaleTimeString():o.formatDate([s.getFullYear(),s.getMonth(),s.getDate()])):this.innerHTML=g.get("now")},setLang:function(e){this.setAttribute("style","background-image: url('img/flags/"+e.substring(0,2)+".png');"),this.innerHTML=" "}}),musearch:new t(f,{setParticipants:function(e){var t,s=parseInt(e,10)+1,i="<ul>";for(t=0;s>t;t++)i+="<li></li>";i+="</ul>",this.innerHTML=i},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setDate:function(e){e=parseInt(e,10);var t,s;e?(t=new Date,s=new Date(e),this.innerHTML=t.toDateString()===s.toDateString()?s.getTime()-t.getTime()<=3e5?g.get("now"):s.toLocaleTimeString():o.formatDate([s.getFullYear(),s.getMonth(),s.getDate()])):this.innerHTML=g.get("now")},setLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');"),this.innerHTML=" "}}),mupreview:new d({preview:y}),mulistevent:new s(m)}),m.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><div class="selectlang"><div data-options="bind:setBg, selectedLang"></div><button data-mulistevent = "listen:mouseup, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-mulistevent="listen: mouseup, filterLang"></li></ul></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class=mudate data-labels="bind:innerHTML, sbydate"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div class="noresult invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mudate" data-muall="bind:setDate, value.scheduled"></div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mudate" data-musearch="bind:setDate, fields.scheduled"></div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',m.reset=function(){T="mulistall",A.spin(m.dom.querySelector("#mulistspinner")),w.set("selectedLang","all"),w.set("selectedMode","allmodes"),m.buildList(T).then(function(){A.stop()})},m.buildList=function(e,t){var s=[],i=new n;return"mulistall"===e&&(b.reset([]),m.addSessions(s,"roulette").then(function(){return m.addSessions(s,"campfire")}).then(function(){return m.addSessions(s,"boardroom")}).then(function(){s.length?m.dom.querySelector(".noresult").classList.add("invisible"):m.dom.querySelector(".noresult").classList.remove("invisible"),b.reset(s),i.fulfill()})),"musearch"===e&&(f.reset([]),m.syncSearch(s,t).then(function(){s.length?m.dom.querySelector(".noresult").classList.add("invisible"):m.dom.querySelector(".noresult").classList.remove("invisible"),f.reset(s),i.fulfill()})),i},m.syncSearch=function(e,t,s){var a=new n,l=new i;return l.setTransport(h),l.sync("_fti/local/"+p,"indexedsessions","waiting",{q:t,descending:!0}).then(function(){u=o.getContactUsernames().join(),l.loop(function(t){var i=!1;"roulette"===t.fields.mode&&t.score>.66?i=!0:"campfire"===t.fields.mode&&t.score>.66&&(t.fields.initiator===v.get("username")||u.search(t.fields.initiator)>-1)?i=!0:"boardroom"===t.fields.mode&&t.score>.66&&(t.fields.initiator===v.get("username")||t.fields.invited.search(v.get("_id"))>-1)&&(i=!0),i&&(s?t.fields.mode.search(s.mode)>-1&&t.fields.lang.search(s.lang)>-1&&e.push(t):e.push(t))},function(e){alert(e)}),a.fulfill()}),a},m.addSessions=function(e,t,s){var a=new n,l=new i,o="_view/"+t,r={};return l.setTransport(h),r="roulette"===t?s?{key:'"'+s+'"',descending:!1,limit:50}:{descending:!1,limit:50}:s?{key:'["'+v.get("_id")+'","'+s+'"]',descending:!1}:{startkey:'["'+v.get("_id")+'",{}]',endkey:'["'+v.get("_id")+'"]',descending:!0},l.sync(p,"library",o,r).then(function(){l.loop(function(t){var s=new Date;(!t.value.scheduled||s-t.value.scheduled<=9e5)&&e.unshift(t)}),a.fulfill(),l.unsync()},function(e){console.log(e,t)}),a},m.search=function(e,t){13===e.keyCode&&(""===t.value?m.toggleList("mulistall"):m.toggleList("musearch"))},m.displayLang=function(){m.dom.querySelector(".langlist").classList.remove("invisible")},m.filterLang=function(e,t){var s=parseInt(t.getAttribute("data-select_id"),10);m.dom.querySelector(".langlist").classList.add("invisible"),0===s?w.set("selectedLang","all"):w.set("selectedLang",L.get(s).name),A.spin(document.getElementById("mulistspinner")),m.filterList().then(function(){A.stop()})},m.filterMode=function(e,t){var s=t.selectedIndex;switch(w.set("selectedMode",w.get("modes")[s]),s){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}A.spin(document.getElementById("mulistspinner")),m.filterList().then(function(){A.stop()})},m.filterList=function(e){var t=[],s=e||m.dom.querySelector("#mulist-content input").value,i=new n,a="",l="";return s=s.replace(/:/g,"\\:"),"allmodes"!==w.get("selectedMode")&&(a=w.get("selectedMode")),"all"!==w.get("selectedLang")&&(l=w.get("selectedLang")),""===a&&""===l?m.buildList(T,s).then(function(){i.fulfill()}):"mulistall"===T?(b.reset([]),a?m.addSessions(t,a,l).then(function(){b.reset(t),t.length?m.dom.querySelector(".noresult").classList.add("invisible"):m.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()}):m.addSessions(t,"roulette",l).then(function(){return m.addSessions(t,"campfire",l)}).then(function(){return m.addSessions(t,"boardroom",l)}).then(function(){b.reset(t),t.length?m.dom.querySelector(".noresult").classList.add("invisible"):m.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()})):(f.reset([]),m.syncSearch(t,s,{mode:a,lang:l}).then(function(){f.reset(t),t.length?m.dom.querySelector(".noresult").classList.add("invisible"):m.dom.querySelector(".noresult").classList.remove("invisible"),i.fulfill()})),i},m.zoom=function(e,t){var s;t.classList.add("pressed"),"mulistall"===T?(s=parseInt(t.getAttribute("data-muall_id"),10),y.reset(b.get(s).id)):"musearch"===T&&(s=t.getAttribute("data-musearch_id"),y.reset(f.get(s).id))},m.toggleList=function(e){e!==T&&(m.dom.querySelector("#"+T).classList.add("invisible"),m.dom.querySelector("#"+e).classList.remove("invisible"),T=e),A.spin(m.dom.querySelector("#mulistspinner")),m.filterList().then(function(){A.stop()})},m.refreshList=function(){m.dom.querySelector("#mulist-content input").value||(T="mulistall"),m.toggleList(T)},m.showPreview=function(e){"musearch"!==T&&(m.dom.querySelector("#mulistall").classList.add("invisible"),m.dom.querySelector("#musearch").classList.remove("invisible"),T="musearch"),A.spin(m.dom.querySelector("#mulistspinner")),m.filterList(e).then(function(){m.dom.querySelector("#mulist-content input").value=f.get(0).fields.title,A.stop()}),y.reset(e)},y.init(m.refreshList),v.watchValue("lang",function(){var e;w.set("modes",["allmodes","roulette","campfire","boardroom"]),e=w.get("lang"),e.splice(0,1,g.get("all")),w.set("lang",e)}),a.get("observer").watch("show-session",function(e){m.dom.querySelector("#mulist-content input").value=e.get("title"),m.toggleList("musearch")}),a.get("observer").watch("session-exited",function(){m.refreshList()}),MULISTSPI=A,m}});