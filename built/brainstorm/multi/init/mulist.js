/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBView","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","./mupreview"],function(e,t,s,i,a,n,l,o,d,c,r){return function(){var u=new e,m=a.get("labels"),g=a.get("user"),v=a.get("db"),p=a.get("transport"),h=new l([]),b=new l([]),f=new r,y=(new l([]),new l({modes:["allmodes","roulette","campfire","boardroom"],selectedLang:"all",selectedMode:"allmodes"})),w=new l([{name:"*"}]),L=a.get("userLanguages"),S="mulistall",T=o.getUserContactIds(),A=new d({color:"#9AC9CD",lines:10,length:10,width:6,radius:10,top:200}).spin();return L.forEach(function(e){w.alter("push",e)}),u.plugins.addAll({labels:new t(m),options:new t(y,{setBg:function(e){"all"===e?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))},setMode:function(e){var t,s,i="";for(t=0,s=e.length;s>t;t++)i+="<option>"+m.get(e[t])+"</option>";this.innerHTML=i}}),select:new t(w,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');"))}}),muall:new t(h,{setParticipants:function(e){var t,s=e.length+1,i="<ul>";for(t=0;s>t;t++)i+="<li></li>";i+="</ul>",this.innerHTML=i},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setDate:function(e){console.log(e);var t,s;e?(t=new Date,s=new Date(e),this.innerHTML=t.getDate()===s.getDate()?s.getTime()-t.getTime()<=3e5?m.get("now"):m.get("today"):s.toLocaleDateString()):this.innerHTML=m.get("now")},setLang:function(e){this.setAttribute("style","background-image: url('img/flags/"+e.substring(0,2)+".png');"),this.innerHTML=" "}}),musearch:new t(b,{setParticipants:function(e){var t,s=parseInt(e,10)+1,i="<ul>";for(t=0;s>t;t++)i+="<li></li>";i+="</ul>",this.innerHTML=i},setMode:function(e){switch(e){case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');")}},setDate:function(e){var t,s;e?(t=new Date,s=new Date(e),this.innerHTML=t.getDate()===s.getDate()?s.getTime()-t.getTime()<=3e5?m.get("now"):m.get("today"):s.toLocaleDateString()):this.innerHTML=m.get("now")},setLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');"),this.innerHTML=" "}}),mupreview:new c({preview:f}),mulistevent:new s(u)}),u.template='<div id="mulist"><div id="mulist-content"><div id="mulistspinner"></div><div data-mupreview = "place: preview"></div><legend data-labels="bind:innerHTML, selectsession"></legend><div class="mulistoptions"><input class="search" type="search" data-mulistevent="listen: keypress, search"><select class="modes" data-options="bind: setMode, modes" data-mulistevent="listen:change, filterMode"></select><div class="selectlang"><div data-options="bind:setBg, selectedLang"></div><button data-mulistevent = "listen:mouseup, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-mulistevent="listen: mouseup, filterLang"></li></ul></div><hr/><div class="mulistheader"><div class="mumode" data-labels="bind:innerHTML, mode"></div><div class="mutitle" data-labels="bind:innerHTML, title"></div><div class=mudate data-labels="bind:innerHTML, sbydate"></div><div class="mulang" data-labels="bind:innerHTML, lang"></div><div class="muleadername" data-labels="bind:innerHTML, leader"></div><div class="muparts" data-labels="bind:innerHTML, participants"></div></div><div class="noresult invisible" data-labels="bind:innerHTML, nosessionfound"></div><ul id="mulistall" data-muall="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-muall="bind:setMode, value.mode"></div><div class="mutitle" data-muall="bind:innerHTML, value.title">Title</div><div class="mudate" data-muall="bind:setDate, value.scheduled"></div><div class="mulang" data-muall="bind:setLang, value.lang"></div><div class="muleadername" data-muall="bind:innerHTML, value.initiator.username">Leader</div><div class="muparts" data-muall="bind: setParticipants, value.participants"></div></li></ul><ul id="musearch" class="invisible" data-musearch="foreach"><li data-mulistevent="listen: mousedown, zoom"><div class="mumode" data-musearch="bind:setMode, fields.mode"></div><div class="mutitle" data-musearch="bind:innerHTML, fields.title">Title</div><div class="mudate" data-musearch="bind:setDate, fields.scheduled"></div><div class="mulang" data-musearch="bind:setLang, fields.lang"></div><div class="muleadername" data-musearch="bind:innerHTML, fields.initiator">Leader</div><div class="muparts" data-musearch="bind: setParticipants, fields.participants"></div></li></ul></div></div>',u.reset=function(){S="mulistall",A.spin(document.getElementById("mulistspinner")),y.set("selectedLang","all"),y.set("selectedMode","allmodes"),u.buildList(S).then(function(){A.stop()})},u.buildList=function(e,t){var s=[],i=new n;return"mulistall"===e&&(h.reset([]),u.addSessions(s,"roulette").then(function(){return u.addSessions(s,"campfire")}).then(function(){return u.addSessions(s,"boardroom")}).then(function(){s.length?u.dom.querySelector(".noresult").classList.add("invisible"):u.dom.querySelector(".noresult").classList.remove("invisible"),h.reset(s),i.fulfill()})),"musearch"===e&&(b.reset([]),u.syncSearch(s,t).then(function(){s.length?u.dom.querySelector(".noresult").classList.add("invisible"):u.dom.querySelector(".noresult").classList.remove("invisible"),b.reset(s),i.fulfill()})),i},u.syncSearch=function(e,t,s){var a=new n,l=new i;return l.setTransport(p),l.sync("_fti/local/"+v,"indexedsessions","waiting",{q:t,descending:!0}).then(function(){l.loop(function(t){var i=!1;"roulette"===t.fields.mode?i=!0:"campfire"===t.fields.mode&&T.indexOf(t.fields.initiator.id)>-1?i=!0:"boardroom"===t.fields.mode&&t.fields.invited.search(g.get("_id"))>-1&&(i=!0),i&&(s?t.fields.mode.search(s.mode)>-1&&t.fields.lang.search(s.lang)>-1&&e.push(t):e.push(t))}),a.fulfill()}),a},u.addSessions=function(e,t,s){var a=new n,l=new i,o="_view/"+t,d={};return l.setTransport(p),d="roulette"===t?s?{key:'"'+s+'"',descending:!1,limit:50}:{descending:!1,limit:50}:s?{key:'["'+g.get("_id")+'","'+s+'"]',descending:!1}:{startkey:'["'+g.get("_id")+'",{}]',endkey:'["'+g.get("_id")+'"]',descending:!0},l.sync(v,"library",o,d).then(function(){l.loop(function(t){var s=new Date;(!t.value.scheduled||s-t.value.scheduled<=9e5)&&e.unshift(t)}),a.fulfill(),l.unsync()},function(e){console.log(e,t)}),a},u.search=function(e,t){13===e.keyCode&&(""===t.value?u.toggleList("mulistall"):u.toggleList("musearch"))},u.displayLang=function(){u.dom.querySelector(".langlist").classList.remove("invisible")},u.filterLang=function(e,t){var s=parseInt(t.getAttribute("data-select_id"),10);u.dom.querySelector(".langlist").classList.add("invisible"),0===s?y.set("selectedLang","all"):y.set("selectedLang",w.get(s).name),A.spin(document.getElementById("mulistspinner")),u.filterList().then(function(){A.stop()})},u.filterMode=function(e,t){var s=t.selectedIndex;switch(y.set("selectedMode",y.get("modes")[s]),s){case 1:t.setAttribute("style","color: #5F8F28;");break;case 2:t.setAttribute("style","color: #F27B3D");break;case 3:t.setAttribute("style","color: #4D4D4D;");break;default:t.setAttribute("style","color: black;")}A.spin(document.getElementById("mulistspinner")),u.filterList().then(function(){A.stop()})},u.filterList=function(){var e=[],t=u.dom.querySelector("#mulist-content input").value,s=new n,i="",a="";return"allmodes"!==y.get("selectedMode")&&(i=y.get("selectedMode")),"all"!==y.get("selectedLang")&&(a=y.get("selectedLang")),""===i&&""===a?u.buildList(S,t).then(function(){s.fulfill()}):"mulistall"===S?(h.reset([]),i?u.addSessions(e,i,a).then(function(){h.reset(e),e.length?u.dom.querySelector(".noresult").classList.add("invisible"):u.dom.querySelector(".noresult").classList.remove("invisible"),s.fulfill()}):u.addSessions(e,"roulette",a).then(function(){return u.addSessions(e,"campfire",a)}).then(function(){return u.addSessions(e,"boardroom",a)}).then(function(){h.reset(e),e.length?u.dom.querySelector(".noresult").classList.add("invisible"):u.dom.querySelector(".noresult").classList.remove("invisible"),s.fulfill()})):(b.reset([]),u.syncSearch(e,t,{mode:i,lang:a}).then(function(){b.reset(e),e.length?u.dom.querySelector(".noresult").classList.add("invisible"):u.dom.querySelector(".noresult").classList.remove("invisible"),s.fulfill()})),s},u.zoom=function(e,t){var s;t.classList.add("pressed"),"mulistall"===S?(s=parseInt(t.getAttribute("data-muall_id"),10),f.reset(h.get(s).id)):"musearch"===S&&(s=t.getAttribute("data-musearch_id"),f.reset(b.get(s).id))},u.toggleList=function(e){e!==S&&(u.dom.querySelector("#"+S).classList.add("invisible"),u.dom.querySelector("#"+e).classList.remove("invisible"),S=e),A.spin(u.dom.querySelector("#mulistspinner")),u.filterList().then(function(){A.stop()})},u.refreshList=function(){u.toggleList(S)},f.init(u.refreshList),g.watchValue("lang",function(){var e;y.set("modes",["allmodes","roulette","campfire","boardroom"]),e=y.get("lang"),e.splice(0,1,m.get("all")),y.set("lang",e)}),a.get("observer").watch("show-session",function(e){u.dom.querySelector("#mulist-content input").value=e.get("title"),u.toggleList("musearch")}),u}});