/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBDocument","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","service/date","service/time","dashboard/profile/calendar"],function(e,t,s,n,a,l,o,d,r,c,u,g,m){return function(){var p=new e,v=new o({}),h=new o([]),b=new o([]),f=new o({errormsg:""}),w=a.get("labels"),y=a.get("user"),L=new o(a.get("userLanguages")),T=function(){var e=y.get("lang").substring(0,2);v.set("lang",e),L.loop(function(t,i){t.name===e?L.update(i,"selected",!0):L.update(i,"selected",!1)})},S=({title:"",description:"",initiator:{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:y.get("active_deck"),status:"waiting",step:"mustart",lang:y.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null},new u),M=new g,A=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:680}).spin();return T(),p.plugins.addAll({labels:new t(w),newmub:new t(v,{initSessionMode:function(e){switch(e){case"campfire":this.selectedIndex=1,this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2,this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0,this.setAttribute("style","color: #5F8F28;")}},setSessionInfo:function(e){switch(e){case"campfire":this.innerHTML=w.get("campfireinfo");break;case"boardroom":this.innerHTML=w.get("boardroominfo");break;default:this.innerHTML=w.get("rouletteinfo")}},displayInvitations:function(e){"boardroom"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setTitle:function(e){new Date,e&&e.username&&this.setAttribute("placeholder",w.get("quickstarttitleplaceholderpre")+e.username+w.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),select:new t(L,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),auto:new t(h,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),place:new c({dateUI:S,timeUI:M}),invited:new t(b,{setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),errormsg:new t(f),newmubevent:new s(p)}),p.template='<div id="newmub"><div id="newmub-content"><form><div class="idealang"><div class="currentlang" data-newmub="bind: displayLang, lang" data-newmubevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newmubevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="schedule-session"><label data-labels="bind:innerHTML, schedulesession"></label><hr/><input type="radio" name="schedule" checked=true data-newmubevent="listen:click, hideDTUI"><span data-labels="bind:innerHTML, now"></span><input type="radio" name="schedule" data-newmubevent="listen: click, showDTUI"><span data-labels="bind:innerHTML, schedule"></span><br/><div class="dateandtime invisible"><div data-place="place: dateUI"></div><div data-place="place:timeUI"></div></div></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label>Invitez les participants</label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-newmubevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:mouseup, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:mousedown, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=40 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: mousedown, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: mousedown, press; listen:mouseup, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:mousedown, press; listen:mouseup, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>',p.place(document.getElementById("newmub")),p.reset=function(){var e={title:"",description:"",initiator:{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:y.get("active_deck"),status:"waiting",step:"",lang:y.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null};v.reset(e),v.set("lang",y.get("lang")),v.set("deck",y.get("active_deck")),v.set("initiator",{id:y.get("_id"),username:y.get("username"),intro:y.get("intro")}),p.hideDTUI(),p.dom.querySelector("input[name='schedule']").checked=!0,b.reset([]),f.set("errormsg",""),h.reset(y.get("connections").concat())},p.showLang=function(){p.dom.querySelector(".idealang ul").classList.remove("invisible")},p.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),L.loop(function(e,t){i===t?L.update(t,"selected",!0):L.update(t,"selected",!1)})},p.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),v.set("lang",L.get(i).name),p.dom.querySelector(".idealang ul").classList.add("invisible")},p.changeSessionMode=function(e,t){var i=t.selectedIndex,s=t.childNodes[i],n=s.getAttribute("name");h.reset(y.get("connections")),b.reset([]),v.set("mode",n)},p.showDTUI=function(){p.dom.querySelector(".dateandtime").setAttribute("style","display: inline-block;")},p.hideDTUI=function(){p.dom.querySelector(".dateandtime").setAttribute("style","display: none;"),S.reset(),M.reset()},p.displayAutoContact=function(){document.getElementById("invitelistauto").classList.remove("invisible"),h.reset(y.get("connections").concat())},p.updateAutoContact=function(e,t){var s,n=JSON.parse(h.toJSON()),a=y.get("connections").concat(),l=t.value.toLowerCase();if(""===t.value)h.reset(a);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),0!==s.search(l)&&n.splice(i,1);h.reset(n)}h.loop(function(e,t){b.toJSON().search(e.contact.userid)>-1&&h.update(t,"selected",!0)})},p.close=function(e,t){t.parentNode.classList.add("invisible")},p.discardContact=function(e,t){var i=t.getAttribute("data-invited_id"),s=b.get(i).userid;b.alter("splice",i,1),h.loop(function(e,t){e.userid===s&&setTimeout(function(){h.update(t,"selected",!1)},200)}),p.unselectGroup(s)},p.select=function(e,t){var i=t.getAttribute("data-auto_id");h.get(i).selected?(p.removeContact(h.get(i)),setTimeout(function(){h.update(i,"selected",!1),document.getElementById("invitelistauto").classList.add("invisible")},200)):(p.addContact(h.get(i)),p.selectGroup(),setTimeout(function(){h.update(i,"selected",!0),document.getElementById("invitelistauto").classList.add("invisible")},200))},p.selectAll=function(e,t){t.classList.remove("pressed"),b.reset([]),h.reset(y.get("connections")),h.loop(function(e,t){h.update(t,"selected",!0),"user"===e.type&&b.alter("push",e)})},p.removeContact=function(e){if("group"===e.type)for(j=e.contacts.length-1;j>=0;j--)p.removeContact(e.contacts[j]);else b.loop(function(t,i){t.userid===e.userid&&b.alter("splice",i,1)}),p.unselectGroup(e.userid),h.loop(function(t,i){t.userid===e.userid&&h.update(i,"selected",!1)})},p.selectGroup=function(){var e,t=!1;h.loop(function(i,s){if("group"===i.type&&!i.selected){for(e=i.contacts,t=!0,j=e.length-1;j>=0;j--)if(b.toJSON().search(e[j].userid)<0){t=!1;break}t&&h.update(s,"selected",!0)}})},p.unselectGroup=function(e){h.loop(function(t,i){"group"===t.type&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&h.update(i,"selected",!1)})},p.addContact=function(e){var t,i,s=!0;if("user"===e.type)b.alter("push",e);else for(t=0,i=e.contacts.length;i>t;t++)b.loop(function(i){i.userid===e.contacts[t].userid&&(s=!1)}),s&&(b.alter("push",e.contacts[t]),h.loop(function(i,s){i.userid===e.contacts[t].userid&&h.update(s,"selected",!0)}))},p.removeReadonly=function(e,t){t.removeAttribute("readonly")},p.press=function(e,t){t.classList.add("pressed")},p.clear=function(e,t){t.classList.remove("pressed"),p.reset()},p.create=function(e,t){t.classList.remove("pressed"),f.set("errormsg",""),v.get("title").length<3||v.get("description").length<3?f.set("errormsg",w.get("providesessioninfo")):"roulette"!==v.get("mode")&&y.get("connections").length<1?f.set("errormsg",w.get("nofriendtoinvite")):"boardroom"!==v.get("mode")||b.getNbItems()?(t.classList.add("invisible"),A.spin(t.parentNode),p.uploadSession().then(function(){A.stop(),t.classList.remove("invisible"),p.reset()})):f.set("errormsg",w.get("inviteatleastone"))},p.createChat=function(e){var t=new n,i=(new Date).getTime(),s=new l;return t.setTransport(a.get("transport")),t.set("users",[{username:y.get("username"),userid:y.get("_id")}]),t.set("msg",[{user:"SYS",type:0,arg:0,time:i}]),t.set("sid",v.get("_id")),t.set("lang",v.get("lang")),t.set("readonly",!1),t.set("step",0),t.set("type",17),t.sync(a.get("db"),e).then(function(){return t.upload()}).then(function(){s.fulfill(),t.unsync()}),s},p.uploadSession=function(){var e,t,i=new n,s=new Date,o=v.get("chat")||[],r=new l;return v.set("_id","S:MU:"+s.getTime()),e=S.getDatestamp()+M.getTimestamp(),e-s.getTime()>6e5&&(v.set("status","scheduled"),v.set("scheduled",e)),v.set("date",S.getDate()),"boardroom"===v.get("mode")&&b.loop(function(e){v.get("invited").push(e.userid)}),"campfire"===v.get("mode")&&v.set("invited",d.getUserContactIds()),t=v.get("_id")+"_0",o.push(t),v.set("chat",o),i.reset(JSON.parse(v.toJSON())),i.setTransport(a.get("transport")),i.sync(a.get("db"),i.get("_id")).then(function(){return p.createChat(t)}).then(function(){return i.upload()}).then(function(){return v.get("scheduled")?m.add({date:i.get("scheduled"),type:"MU",docId:i.get("_id"),info:"scheduled"}):m.add({date:s.getTime(),type:"MU",docId:i.get("_id"),info:"started"})}).then(function(){var e=a.get("observer");"boardroom"===i.get("mode")?(f.set("errormsg",w.get("sendinginvites")),p.sendInvites(i.get("invited"),i.get("_id"),i.get("title"),i.get("scheduled")).then(function(){i.get("scheduled")?e.notify("show-session",v):e.notify("start-mu_session",i.get("_id")),r.fulfill(),i.unsync()})):("scheduled"===i.get("status")?e.notify("show-session",v):e.notify("start-mu_session",i.get("_id")),r.fulfill(),i.unsync())}),r},p.sendInvites=function(e,t,i,s){var n=new l,o=new Date,d={type:"INV",status:"unread",date:[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getMinutes()],author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:t,docTitle:i,scheduled:s,dest:e};return a.get("transport").request("Notify",d,function(){f.set("errormsg",w.get("invitesent")),n.fulfill()}),n},p.reset(),y.watchValue("lang",function(){var e=JSON.parse(v.toJSON()),t=JSON.parse(f.toJSON());v.reset({}),v.reset(e),f.reset({}),f.reset(t)}),p}});