/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","CouchDBDocument","service/config","Promise","Store","service/utils","lib/spin.min","Place.plugin","service/date","service/time"],function(e,t,s,n,a,l,o,d,r,c,u,g){return function(){var m=new e,p=new o({}),v=new o([]),b=new o([]),h=new o({errormsg:""}),f=a.get("labels"),w=a.get("user"),y=new o(a.get("userLanguages")),L=function(){var e=w.get("lang").substring(0,2);p.set("lang",e),y.loop(function(t,i){t.name===e?y.update(i,"selected",!0):y.update(i,"selected",!1)})},T=({title:"",description:"",initiator:{id:w.get("_id"),username:w.get("username"),intro:w.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:w.get("active_deck"),status:"waiting",step:"mustart",lang:w.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null},new u),A=new g,S=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:680}).spin();return L(),m.plugins.addAll({labels:new t(f),newmub:new t(p,{initSessionMode:function(e){switch(e){case"campfire":this.selectedIndex=1,this.setAttribute("style","color: #F27B3D;");break;case"boardroom":this.selectedIndex=2,this.setAttribute("style","color: #4D4D4D;");break;default:this.selectedIndex=0,this.setAttribute("style","color: #5F8F28;")}},setSessionInfo:function(e){switch(e){case"campfire":this.innerHTML=f.get("campfireinfo");break;case"boardroom":this.innerHTML=f.get("boardroominfo");break;default:this.innerHTML=f.get("rouletteinfo")}},displayInvitations:function(e){"boardroom"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setTitle:function(e){new Date,e&&e.username&&this.setAttribute("placeholder",f.get("quickstarttitleplaceholderpre")+e.username+f.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),select:new t(y,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),auto:new t(v,{highlight:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),place:new c({dateUI:T,timeUI:A}),invited:new t(b,{setSelected:function(e){this.innerHTML=e?"&#10003;":""}}),errormsg:new t(h),newmubevent:new s(m)}),m.template='<div id="newmub"><div id="newmub-content"><form><div class="idealang"><div class="currentlang" data-newmub="bind: displayLang, lang" data-newmubevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newmubevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, selectmode"></label><hr/><div class="select-mode"><select data-newmub="bind:initSessionMode, mode" data-newmubevent="listen:change, changeSessionMode"><option name="roulette" data-labels="bind:innerHTML, roulette"></option><option name="campfire" data-labels="bind:innerHTML, campfire"></option><option name="boardroom" data-labels="bind:innerHTML, boardroom"></option></select><span class="session-info" data-newmub="bind: setSessionInfo, mode"></span></div><div class="schedule-session"><label data-labels="bind:innerHTML, schedulesession"></label><hr/><div data-place="place: dateUI"></div><div data-place="place:timeUI"></div></div><div class="invite-contacts invisible" data-newmub="bind:displayInvitations, mode"><label>Invitez les participants</label><hr/><div class="selectall" data-labels="bind:innerHTML, selectall" data-newmubevent="listen: mousedown, press; listen:mouseup, selectAll">Select all</div><input class="search" data-newmubevent="listen:mousedown, displayAutoContact; listen:input, updateAutoContact" data-labels="bind:placeholder, tocontactlbl"><div id="invitelistauto" class="autocontact invisible"><div class="autoclose" data-newmubevent="listen:mousedown,close"></div><ul data-auto="foreach"><li data-auto="bind:innerHTML, username; bind:highlight, selected" data-newmubevent="listen:mouseup, select"></li></ul></div><div class="invitecontactlist"><ul data-invited="foreach"><li class = "contact list-item" data-newmubevent="listen:mousedown, discardContact"><p class="contact-name" data-invited="bind:innerHTML, username"></p><div class="remove-contact"></div></li></ul></div></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="session-title" maxlength=40 readonly="readonly" name="title" data-newmub="bind:value, title; bind: setTitle, initiator" data-newmubevent="listen: mousedown, removeReadonly"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="session-desc" name="description" data-newmub="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea></form><div class="newmub-footer"><p class="send"><label class="clear" data-labels="bind:innerHTML, clear" data-newmubevent="listen: mousedown, press; listen:mouseup, clear"></label><label class="create" data-labels="bind:innerHTML, create" data-newmubevent="listen:mousedown, press; listen:mouseup, create"></label><label class="editerror" data-errormsg="bind:innerHTML, errormsg"></label></p></div></div></div>',m.place(document.getElementById("newmub")),m.reset=function(){var e={title:"",description:"",initiator:{id:w.get("_id"),username:w.get("username"),intro:w.get("intro")},participants:[],date:[],startTime:null,resumeTime:null,duration:null,elapsedTime:0,elapsedTimers:{},mode:"roulette",type:8,deck:w.get("active_deck"),status:"waiting",step:"",lang:w.get("lang"),characters:[],contexts:[],problems:[],scenarioWB:[],scenario:[],techno:[[]],ideaWB:[],idea:[],score:"",chat:[],invited:[],scheduled:null};p.reset(e),p.set("lang",w.get("lang")),p.set("deck",w.get("active_deck")),p.set("initiator",{id:w.get("_id"),username:w.get("username"),intro:w.get("intro")}),T.reset(),A.reset(),b.reset([]),h.set("errormsg",""),v.reset(w.get("connections").concat())},m.showLang=function(){m.dom.querySelector(".idealang ul").classList.remove("invisible")},m.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),y.loop(function(e,t){i===t?y.update(t,"selected",!0):y.update(t,"selected",!1)})},m.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),p.set("lang",y.get(i).name),m.dom.querySelector(".idealang ul").classList.add("invisible")},m.changeSessionMode=function(e,t){var i=t.selectedIndex,s=t.childNodes[i],n=s.getAttribute("name");v.reset(w.get("connections")),b.reset([]),p.set("mode",n)},m.displayAutoContact=function(){document.getElementById("invitelistauto").classList.remove("invisible"),v.reset(w.get("connections").concat())},m.updateAutoContact=function(e,t){var s,n=JSON.parse(v.toJSON()),a=w.get("connections").concat(),l=t.value.toLowerCase();if(""===t.value)v.reset(a);else{for(i=n.length-1;i>=0;i--)s=n[i].username.toLowerCase(),0!==s.search(l)&&n.splice(i,1);v.reset(n)}v.loop(function(e,t){b.toJSON().search(e.contact.userid)>-1&&v.update(t,"selected",!0)})},m.close=function(e,t){t.parentNode.classList.add("invisible")},m.discardContact=function(e,t){var i=t.getAttribute("data-invited_id"),s=b.get(i).userid;b.alter("splice",i,1),v.loop(function(e,t){e.userid===s&&setTimeout(function(){v.update(t,"selected",!1)},200)}),m.unselectGroup(s)},m.select=function(e,t){var i=t.getAttribute("data-auto_id");v.get(i).selected?(m.removeContact(v.get(i)),setTimeout(function(){v.update(i,"selected",!1),document.getElementById("invitelistauto").classList.add("invisible")},200)):(m.addContact(v.get(i)),m.selectGroup(),setTimeout(function(){v.update(i,"selected",!0),document.getElementById("invitelistauto").classList.add("invisible")},200))},m.selectAll=function(e,t){t.classList.remove("pressed"),b.reset([]),v.reset(w.get("connections")),v.loop(function(e,t){v.update(t,"selected",!0),"user"===e.type&&b.alter("push",e)})},m.removeContact=function(e){if("group"===e.type)for(j=e.contacts.length-1;j>=0;j--)m.removeContact(e.contacts[j]);else b.loop(function(t,i){t.userid===e.userid&&b.alter("splice",i,1)}),m.unselectGroup(e.userid),v.loop(function(t,i){t.userid===e.userid&&v.update(i,"selected",!1)})},m.selectGroup=function(){var e,t=!1;v.loop(function(i,s){if("group"===i.type&&!i.selected){for(e=i.contacts,t=!0,j=e.length-1;j>=0;j--)if(b.toJSON().search(e[j].userid)<0){t=!1;break}t&&v.update(s,"selected",!0)}})},m.unselectGroup=function(e){v.loop(function(t,i){"group"===t.type&&t.selected&&JSON.stringify(t.contacts).search(e)>0&&v.update(i,"selected",!1)})},m.addContact=function(e){var t,i,s=!0;if("user"===e.type)b.alter("push",e);else for(t=0,i=e.contacts.length;i>t;t++)b.loop(function(i){i.userid===e.contacts[t].userid&&(s=!1)}),s&&(b.alter("push",e.contacts[t]),v.loop(function(i,s){i.userid===e.contacts[t].userid&&v.update(s,"selected",!0)}))},m.removeReadonly=function(e,t){t.removeAttribute("readonly")},m.press=function(e,t){t.classList.add("pressed")},m.clear=function(e,t){t.classList.remove("pressed"),m.reset()},m.create=function(e,t){t.classList.remove("pressed"),h.set("errormsg",""),p.get("title").length<3||p.get("description").length<3?h.set("errormsg",f.get("providesessioninfo")):"roulette"!==p.get("mode")&&w.get("connections").length<1?h.set("errormsg",f.get("nofriendtoinvite")):"boardroom"!==p.get("mode")||b.getNbItems()?(t.classList.add("invisible"),S.spin(t.parentNode),m.uploadSession().then(function(){S.stop(),t.classList.remove("invisible"),m.reset()})):h.set("errormsg",f.get("inviteatleastone"))},m.createChat=function(e){var t=new n,i=(new Date).getTime(),s=new l;return t.setTransport(a.get("transport")),t.set("users",[{username:w.get("username"),userid:w.get("_id")}]),t.set("msg",[{user:"SYS",type:0,arg:0,time:i}]),t.set("sid",p.get("_id")),t.set("lang",p.get("lang")),t.set("readonly",!1),t.set("step",0),t.set("type",17),t.sync(a.get("db"),e).then(function(){return t.upload()}).then(function(){s.fulfill(),t.unsync()}),s},m.uploadSession=function(){var e,t,i=new n,s=new Date,o=p.get("chat")||[],r=new l;return p.set("_id","S:MU:"+s.getTime()),e=T.getDatestamp()+A.getTimestamp(),p.set("scheduled",e),e-s.getTime()>6e5&&p.set("status","scheduled"),p.set("date",T.getDate()),"boardroom"===p.get("mode")&&b.loop(function(e){p.get("invited").push(e.userid)}),"campfire"===p.get("mode")&&p.set("invited",d.getUserContactIds()),t=p.get("_id")+"_0",o.push(t),p.set("chat",o),i.reset(JSON.parse(p.toJSON())),i.setTransport(a.get("transport")),i.sync(a.get("db"),i.get("_id")).then(function(){return m.createChat(t)}).then(function(){return i.upload()}).then(function(){var e=a.get("observer");"boardroom"===i.get("mode")?(h.set("errormsg",f.get("sendinginvites")),m.sendInvites(i.get("invited"),i.get("_id"),i.get("title"),i.get("scheduled")).then(function(){i.get("scheduled")?e.notify("show-session",p):e.notify("start-mu_session",i.get("_id")),r.fulfill(),i.unsync()})):("scheduled"===i.get("status")?e.notify("show-session",p):e.notify("start-mu_session",i.get("_id")),r.fulfill(),i.unsync())}),r},m.sendInvites=function(e,t,i,s){var n=new l,o=new Date,d={type:"INV",status:"unread",date:[o.getFullYear(),o.getMonth(),o.getDate(),o.getHours(),o.getMinutes(),o.getMinutes()],author:w.get("_id"),username:w.get("username"),firstname:w.get("firstname"),toList:"",ccList:"",object:"",body:"",signature:"",docId:t,docTitle:i,scheduled:s,dest:e};return a.get("transport").request("Notify",d,function(){h.set("errormsg",f.get("invitesent")),n.fulfill()}),n},m.reset(),w.watchValue("lang",function(){var e=JSON.parse(p.toJSON()),t=JSON.parse(h.toJSON());p.reset({}),p.reset(e),h.reset({}),h.reset(t)}),m}});