/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Amy/Stack-plugin","Bind.plugin","Event.plugin","./mustart","./musetup","./muscenario","./mutech","./muidea","./muwrapup","CouchDBDocument","service/config","Promise","Store","lib/spin.min","Place.plugin","service/confirm"],function(e,t,s,i,n,a,l,o,r,d,c,u,g,m,p,v,h,b){return function(t){var f,w,y,L,S,T,k,A,M=new e,H=new e,I=(document.createDocumentFragment(),new s),D=g.get("labels"),C=[{name:"mustart",label:D.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:D.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:D.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:D.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:D.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:D.get("quickstepwrapup"),currentStep:!1,status:null}],q=new p(C),_=g.get("user"),x=g.get("db"),N=new u,B=new p,E=new p({msg:""}),P=new v({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin();return H.plugins.addAll({labels:new i(D),step:new i(q,{setCurrent:function(e){e?this.classList.add("pressed"):this.classList.remove("pressed")},setActive:function(e){e?this.classList.remove("inactive"):this.classList.add("inactive")}}),progressevent:new n(H)}),H.template='<div class = "progressbar invisible"><ul id = "musteplist" class="steplist" data-step="foreach"><li class="step inactive" data-step="bind: innerHTML, label; bind:setCurrent, currentStep; bind:setActive, status" data-progressevent="listen: mousedown, changeStep"></li></ul><div class="exit-brainstorm" data-progressevent="listen: mousedown, press; listen:mouseup, exit"></div></div>',H.changeStep=function(e,t){var s=t.getAttribute("data-step_id");q.get(s).status?(q.loop(function(e,t){s==t?q.update(t,"currentStep",!0):q.update(t,"currentStep",!1)}),I.getStack().show(q.get(s).name)):e.stopImmediatePropagation()},H.press=function(e,t){t.classList.add("pressed")},H.exit=function(e,s){s.classList.remove("pressed"),_.get("sessionInProgress").id!==N.get("_id")?t():"muwrapup"===N.get("step")?N.get("initiator").id===_.get("_id")?T.getChatUI().setMsg("end").then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){t()}):(T.getChatUI().leave(),_.set("sessionInProgress",""),_.upload().then(function(){t()})):k.show()},M.template='<div id="musession"><div data-place="place:progress"></div><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></div><div class="stack" data-musessionstack="destination"></div></div>',M.plugins.addAll({musessionstack:I,place:new h({progress:H}),info:new i(E)}),M.toggleProgress=function(e){e?H.exit():H.dom.classList.toggle("invisible")},M.leaveSession=function(){var e,s=N.get("participants"),i=I.getStack().get(N.get("step"));for(e=s.length-1;e>=0;e--)if(s[e].id===_.get("_id")){s.splice(e,1);break}N.set("participants",s),N.upload().then(function(){i.getChatUI().leave(),N.unsync(),k.hide(),document.body.removeChild(document.querySelector(".confirm"))}),_.set("sessionInProgress",""),_.upload().then(function(){t()})},M.cancelSession=function(){var e=5e3;M.displayInfo("deleting",e).then(function(){t()})},M.displayInfo=function(e,t){var s,i=document.querySelector(".sessionmsg"),n=new m,a=function(){i.classList.add("invisible"),clearInterval(s),E.set("msg",""),n.fulfill()};return k.hide(),document.body.removeChild(document.querySelector(".confirm")),i.classList.remove("invisible"),s=setInterval(function(){switch(e){case"deleting":E.set("msg",D.get("deletingsession")+t/1e3+"s");break;case"participantsleft":E.set("msg",D.get("participantsleft")+" "+t/1e3+"s");break;default:e!==E.get("msg")&&E.set("msg",e)}0>=t&&a(),t-=1e3},1e3),("deleting"===e||"participantsleft"===e)&&(N.set("status","deleted"),N.upload().then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){var e=N.get("chat"),t=e.length,s=new m;return t?e.forEach(function(e){var i=new u;i.setTransport(g.get("transport")),i.sync(x,e).then(function(){return i.remove()}).then(function(){t--,0>=t&&s.fulfill})}):s.fulfill(),s}).then(function(){N.remove()})),n},M.createChat=function(e){var t,s,i=new u,n=(new Date).getTime(),a=[],l=new m;switch(a.push({username:N.get("initiator").username,userid:N.get("initiator").id}),N.get("participants").forEach(function(e){a.push({username:e.username,userid:e.id})}),i.set("users",a),e){case 1:t="quicksetup";break;case 2:t="quickscenario";break;case 3:t="quicktech";break;case 4:t="quickidea";break;case 5:t="quickwrapup";break;default:t="quickstart"}return i.set("msg",[{user:"SYS",type:5,arg:t,time:n}]),i.set("sid",N.get("_id")),i.set("lang",N.get("lang")),i.set("readonly",!1),i.set("step",e),i.set("type",17),s=i.get("sid")+"_"+e,i.setTransport(g.get("transport")),i.sync(x,s).then(function(){return i.upload()}).then(function(){var e=N.get("chat").concat();i.unsync(),e.push(s),N.set("chat",e),l.fulfill()}),l},M.retrieveSession=function(e,t){P.spin(document.getElementById("brainstorm")),N.reset({}),N.sync(x,e).then(function(){var e=N.get("step"),s=1e4;q.getNbItems(),t||(k=new b(document.body,null,null,"musession-confirm"),A=function(e){e?N.get("initiator").id===_.get("_id")?M.cancelSession():M.leaveSession():k.hide()},N.get("initiator").id===_.get("_id")?k.reset(D.get("leaderleave"),A):k.reset(D.get("participantleave"),A)),q.loop(function(i,n){s>n&&(I.getStack().get(i.name).reset(t),q.update(n,"status","done"),i.name===e&&(s=n,q.update(n,"currentStep",!0),"muwrapup"===i.name?q.update(n,"status","done"):q.update(n,"status","ongoing")))}),t?(P.stop(),I.getStack().show("muwrapup")):(P.stop(),I.getStack().show(e))})},M.reset=function(e,t){N.unsync(),B.reset(),document.querySelector(".confirm")&&document.body.removeChild(document.querySelector(".confirm")),q.reset([{name:"mustart",label:D.get("quickstepstart"),currentStep:!1,status:"done"},{name:"musetup",label:D.get("quickstepsetup"),currentStep:!1,status:null},{name:"muscenario",label:D.get("quickstepscenario"),currentStep:!1,status:null},{name:"mutech",label:D.get("quicksteptech"),currentStep:!1,status:null},{name:"muidea",label:D.get("quickstepidea"),currentStep:!1,status:null},{name:"muwrapup",label:D.get("quickstepwrapup"),currentStep:!1,status:null}]),e&&M.retrieveSession(e,t)},M.prev=function(e){var s;q.loop(function(t,i){t.name===e&&(s=i)}),s>0?(q.update(s,"currentStep",!1),q.update(s-1,"currentStep",!0),I.getStack().show(q.get(s-1).name)):(alert("Exiting session"),t())},M.next=function(e){var t,s,i=I.getStack().get(e),n="",a=new m;return q.loop(function(s,i){s.name===e&&(t=i)}),t<q.getNbItems()&&(n=q.get(t+1).name,s=I.getStack().get(n),q.update(t,"currentStep",!1),q.update(t+1,"currentStep",!0),"done"!==q.get(t).status?(q.update(t,"status","done"),q.update(t+1,"status","ongoing"),"muwrapup"===q.get(t+1).name&&q.update(t+1,"status","done"),s.reset(),M.createChat(t+1).then(function(){return N.set("step",n),N.upload()}).then(function(){s.initTimer&&s.initTimer(),i.stopSpinner(),I.getStack().show(n),"muwrapup"===n?(_.unsync(),_.sync(g.get("db"),_.get("_id")).then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){a.fulfill()})):a.fulfill()})):(i.stopSpinner(),I.getStack().show(n),a.fulfill())),a},M.init=function(){f=new a(N,M.prev,M.next,M.toggleProgress),w=new l(N,B,M.prev,M.next,M.toggleProgress),y=new o(N,B,M.prev,M.next,M.toggleProgress),L=new r(N,B,M.prev,M.next,M.toggleProgress),S=new d(N,B,M.prev,M.next,M.toggleProgress),T=new c(N,B,M.prev,M.next,M.toggleProgress),N.setTransport(g.get("transport")),I.getStack().add("mustart",f),I.getStack().add("musetup",w),I.getStack().add("muscenario",y),I.getStack().add("mutech",L),I.getStack().add("muidea",S),I.getStack().add("muwrapup",T)},M.init(),N.watchValue("status",function(e){"deleted"===e&&N.get("initiator").id!==_.get("_id")&&(_.set("sessionInProgress",""),_.upload(),M.displayInfo(D.get("canceledbyleader"),2e3).then(function(){N.unsync(),t()}))}),N.watchValue("step",function(e){var t,s=N.get("step");N.get("initiator")&&N.get("initiator").id!==_.get("_id")&&(q.loop(function(e,i){e.name===s&&(t=i)}),q.update(t-1,"status","done"),q.update(t,"status","ongoing"),q.update(t-1,"currentStep",!1),q.update(t,"currentStep",!0),I.getStack().get(e).reset(),I.getStack().show(e)),"muwrapup"===step&&(_.unsync(),_.sync(g.get("db"),_.get("_id")).then(function(){return _.set("sessionInProgress",""),_.upload()}))}),N.watchValue("participants",function(e){0===e.length&&"muwrapup"!==N.get("step")&&M.displayInfo("participantsleft",1e4).then(function(){return _.set("sessionInProgress",""),_.upload()}).then(function(){t(),document.body.removeChild(document.querySelector(".confirm"))})}),M}});