/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","lib/spin.min"],function(e,t,s,i,n,a,o){return function(){var t,l=new e,r=n.get("labels"),d=new a,c=n.get("user"),u=null,p=!1;return l.plugins.addAll({label:new s(r),model:new s(d,{setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},setButton:function(e){e?this.setAttribute("style","display: inline-block;"):this.setAttribute("style","display:none;")},displayVote:function(e){var t=this.getAttribute("name"),s=d.get(t+"Votes"),i=this.querySelector(".yesvote"),n=this.querySelector(".novote");e?s.indexOf(c.get("_id"))>-1?n.classList.add("invisible"):i.classList.add("invisible"):(i.classList.remove("invisible"),n.classList.remove("invisible"))},setResult:function(e){this.innerHTML=e?r.get(e):""}}),event:new i(l)}),l.template='<div class = "confirm invisible"><legend><span data-label="bind:innerHTML, decidemsg"></span><span class="unanimity" data-label="bind: innerHTML, unanimity"></span></legend><div class="votingitem invisible" name="public" data-model="bind:setVisible,public; bind: displayVote, publicVote"><div class="sessionquestion" data-label="bind:innerHTML,setpublic"></div><div class = "votingbuttons" name="public"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, publicResult"></div></div><div class="votingitem invisible" name = "replay" data-model="bind:setVisible,replay; bind: displayVote, replayVote"><div class="sessionquestion" data-label="bind:innerHTML,enablereplay"></div><div class = "votingbuttons" name="replay"><span class="yesvote" data-label="bind:innerHTML, yeslbl" data-event="listen: mousedown, push; listen: mouseup, vote">Yes</span><span class="novote" data-label="bind:innerHTML, nolbl" data-event="listen: mousedown, push; listen: mouseup, vote">No</span></div><div class="votingresult" data-model="bind: setResult, replayResult"></div></div><div id="muvotespinner"></div><div class="option left votebutton" data-event="listen:mousedown, press; listen:mouseup, submit" data-model="bind:setButton, submit" data-label="bind: innerHTML, submitlbl">Submit</div><div class="option right votebutton" data-event="listen:mousedown, press; listen:mouseup, skip" data-model="bind:setButton, skip" data-label="bind:innerHTML, skiplbl">Skip</div></div>',l.press=function(e,t){e.stopPropagation(),t.classList.add("pressed")},l.push=function(e,t){var s=t.parentNode,i=s.getAttribute("name");d.get(i+"Vote")||d.get(i+"Result")||t.setAttribute("style","-webkit-box-shadow: 0px 0px 2px #657B99;")},l.vote=function(e,t){var s=t.parentNode,i=s.getAttribute("name");if(t.setAttribute("style","-webkit-box-shadow: none;"),d.get("leader"))t.classList.toggle("voted"),t.classList.contains("yesvote")?t.classList.contains("voted")?(d.set(i+"Votes",[c.get("_id")]),s.querySelector(".novote").classList.remove("voted")):d.set(i+"Votes",[]):(s.querySelector(".yesvote").classList.remove("voted"),d.set(i+"Votes",[])),d.get("publicVotes").length||d.get("replayVotes").length?d.set("submit",!0):d.set("submit",!1);else if(!d.get(i+"Vote")){var n=d.get(i+"Votes");t.classList.contains("novote")?("public"===i&&d.set("publicResult","rejected"),"replay"===i&&d.set("replayResult","rejected")):(n.push(c.get("_id")),d.set(i+"Votes",n),n.length===u.get("participants").length+1&&("public"===i&&d.set("publicResult","accepted"),"replay"===i&&d.set("replayResult","accepted"))),t.classList.add("voted"),d.set(i+"Vote",!0),p?setTimeout(l.uploadVote,3e3):l.uploadVote()}},l.uploadVote=function(){var e;d.get("leader")||(e=u.get("vote"),p=!0,e.public&&(e.publicVotes=d.get("publicVotes"),e.publicResult=d.get("publicResult")),e.replay&&(e.replayVotes=d.get("replayVotes"),e.replayResult=d.get("replayResult")),u.set("vote",e),u.upload().then(function(){p=!1},function(e){console.log(e)}))},l.submit=function(e,t){var s={};t.classList.remove("pressed"),d.set("skip",!1),d.set("submit",!1),["public","replay"].forEach(function(e){d.get(e+"Votes").length?(s[e]=!0,s[e+"Votes"]=[c.get("_id")]):d.get(e+"Vote")?d.set(e+"Result","rejected"):d.set(e,!1),d.set(e+"Vote",!0)}),u.set("vote",s),u.upload().then(function(){console.log("VOTE : leader upload successful")},function(e){console.log(e)})},l.skip=function(e,s){s&&s.classList.remove("pressed"),l.close(),t({visibility:"private",replay:!1})},l.close=function(){document.getElementById("cache").classList.remove("votingcache"),l.dom.classList.add("invisible"),u=null},l.isActive=function(){return!(null===u)},l.show=function(){document.getElementById("cache").classList.add("votingcache"),l.dom.classList.remove("invisible")},l.reset=function(e,s){var i;u=e,t=s,d.reset({}),u.get("vote")&&d.reset(u.get("vote")),u.get("initiator").id===c.get("_id")?(d.set("leader",!0),d.set("submit",!1),d.set("skip",!0),["public","replay"].forEach(function(e){d.set(e,!0),d.set(e+"Vote",!1),d.set(e+"Votes",[]),d.set(e+"Result","")})):(d.set("leader",!1),d.set("submit",!1),d.set("skip",!1)),d.set("publicVote",!1),d.set("replayVote",!1),l.show(),i=u.watchValue("vote",function(e){var s={},n=new o({lines:10,length:8,width:4,radius:8,top:10});exitVote=function(){u.unwatch(i),n.spin(l.dom.querySelector("#muvotespinner")),setTimeout(function(){n.stop(),document.getElementById("cache").classList.remove("votingcache"),t&&t(s)},5e3)},e&&e.public&&e.replay?(d.set("publicResult",e.publicResult),d.set("replayResult",e.replayResult),e.publicResult&&e.replayResult&&(s.visibility="accepted"===e.publicResult?"public":"private",s.replay="accepted"===e.replayResult?!0:!1,exitVote())):e&&e.public?(d.set("publicResult",e.publicResult),s.replay=!1,e.publicResult&&(s.visibility="accepted"===e.publicResult?"public":"private",s.replay=!1,exitVote())):e&&e.replay&&(d.set("replayResult",e.replayResult),s.visibility="private",e.replayResult&&(s.replay="accepted"===e.replayResult?!0:!1,exitVote()))})},l}});