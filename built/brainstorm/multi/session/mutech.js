/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Place.plugin","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min","./mubchat"],function(e,t,s,i,n,a,o,r,d,l,c,u,p,m){return function(g,h,v,b,f){var w,y,L,S=new e,T=null,k=null,x=new r({timer:null,display:!1}),A=a.get("transport"),M=a.get("user"),I=a.get("db"),D=a.get("labels"),_=new m,H=new r({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),C=[],N=!0,q=new r,P=new r,O=new r,B={tech1:q,tech2:P,tech3:O},E=0,J=new r([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),V="step",j=new p({color:"#657B99",lines:10,length:8,width:4,radius:8,top:336,left:481}).spin(),F={};return S.isLeader=function(){return g.get("initiator")&&g.get("initiator").id===M.get("_id")},S.plugins.addAll({labels:new i(D),display:new i(H,{setReload:function(e){!e&&E>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(){S.isLeader()&&H.get("tech1").selected&&H.get("tech2").selected&&H.get("tech3").selected&&"step"===V?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new i(J,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){this.innerHTML=e?e.toUpperCase():D.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),mutechtimer:new i(x,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),place:new s({chat:_}),mutechevent:new n(S)}),S.template='<div id = "mutech"><div class="previousbutton" data-mutechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="mutech-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, mutech" data-mutechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-mutechtimer="bind:setTime, timer; bind: displayTimer, display" data-mutechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-mutechevent="listen:mousedown, help"></div><div id="mutech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-mutechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-mutechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-mutechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-mutechevent="listen: mousedown, pushOk; listen:mouseup, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-mutechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',S.place(t.get("mutech")),S.press=function(e,t){t.classList.add("pressed")},S.next=function(e,t){var s=new Date;s.getTime()-T,j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===V?(V="screen",h.set("techno",J),clearInterval(w),x.set("display",!0),S.updateSessionScore(x.get("timer")).then(function(){g.unsync(),g.sync(I,g.get("_id")).then(function(){var e=g.get("elapsedTimers");_.conclude("next"),e.mutech=x.get("timer"),g.set("elapsedTimers",e),g.set("techno",[[J.get(0).id,J.get(1).id,J.get(2).id]]),b("mutech")})})):b("mutech")},S.stopSpinner=function(){j.stop()},S.help=function(){o.setContent("mutechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},S.prev=function(e,t){t.classList.remove("pressed"),v("mutech")},S.toggleProgress=function(){f()},S.toggleTimer=function(){S.isLeader()&&x.set("display",!x.get("display"))},S.select=function(e,t){var s=t.getAttribute("name");(s.search("tech")<0||E>0||"screen"===V)&&t.classList.add("highlighted")},S.zoom=function(e,t){var s=t.getAttribute("name");(s.search("tech")<0||E>0||"screen"===V)&&S.setPopup(s)},S.setPopup=function(e){var t,s={x:0,y:257},i="left",n=H.get(L)||"",a=new r,o=H.get(e);n&&(n.popup=!1,H.set(L,n)),o.popup=!0,H.set(e,o),L=e,"scenario"===e?(s.x=147,s.y=275,a.reset(g.get("scenario")[0]),a.set("type",5),t=a.toJSON()):("tech1"===e&&(s.x=467),"tech2"===e&&(s.x=186,i="right"),"tech3"===e&&(s.x=333,i="right"),B[e].get("_id")&&(t=B[e].toJSON())),t&&y.reset(t,s,i,document.getElementById("mutech-popup"))},S.closePopup=function(){var e=H.get(L);e.popup=!1,H.set(L,e),L=""},S.push=function(e,t){var s=t.getAttribute("name");t.classList.contains("drawok")?B[s].get("_id")&&"step"===V&&S.isLeader()&&t.classList.add("pushed"):t.classList.add("pushed")},S.draw=function(e,t){var s=[];S.isLeader()&&"step"===V&&N?(N=!1,["tech1","tech2","tech3"].forEach(function(e){H.get(e).selected||s.push(e)}),S.drawTech(s).then(function(){t.classList.remove("pushed"),N=!0})):t.classList.remove("pushed")},S.drawTech=function(e){var t,s=[],i=new l,n=new r({count:e.length});return e.length?(e.forEach(function(e){C.length<=0&&(C=h.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){H.get(e).selected&&s.push(J.get(t).id)}),C.filter(function(e){return!(s.indexOf(e)>-1)})),t=Math.floor(Math.random()*C.length),S.getCardDetails(C[t],e).then(function(){var e=n.get("count");e--,n.set("count",e)}),E++,C.splice(t,1),H.set("left",C.length)}),n.watchValue("count",function(e){e||(g.unsync(),g.sync(I,g.get("_id")).then(function(){return["tech1","tech2","tech3"].forEach(function(e,t){g.set("drawn"+e,J.get(t).id)}),g.upload()}).then(function(){i.fulfill()}))})):i.fulfill(),i},S.getCardDetails=function(e,t){var s=new d,i=["tech1","tech2","tech3"],n=i.indexOf(t),a=new l;return s.setTransport(A),s.sync(I,e).then(function(){B[t].reset(JSON.parse(s.toJSON())),J.update(n,"id",e),J.update(n,"title",s.get("title")),J.update(n,"pic",s.get("picture_file")),a.fulfill(),s.unsync()}),a},S.pushOk=function(e,t){var s=F[t.getAttribute("name")]||null;S.isLeader()&&"step"===V&&(s?F[t.getAttribute("name")].spin(t):F[t.getAttribute("name")]=(new p).spin(t))},S.accept=function(e,t){var s=t.getAttribute("name"),i=["tech1","tech2","tech3"],n=i.indexOf(s),a=H.get(s);"step"===V&&S.isLeader()&&(a.selected=J.get(n)&&J.get(n).id?!a.selected:!1,g.unsync(),g.sync(I,g.get("_id")).then(function(){return g.set("selected_"+s,a.selected),g.upload()}).then(function(){F[t.getAttribute("name")].stop(),H.set(s,a)}))},S.reset=function(e){var t=g.get("techno")[0];_.clear(),g.get("chat")[3]&&_.reset(g.get("chat")[3]),H.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),e||t.length?(V="screen",_.dom.querySelector(".chatread").classList.add("extended"),S.getCardDetails(t[0],"tech1").then(function(){return S.getCardDetails(t[1],"tech2")}).then(function(){return S.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){H.set(e,{popup:!1,selected:!0})}),h.set("techno",J)})):(C=[],E=0,V="step",q.reset(),P.reset(),O.reset(),J.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),g.get("elapsedTimers").mutech&&(k=g.get("elapsedTimers").mutech,x.set("timer",k),"screen"===V?x.set("display",!0):S.isLeader()&&S.initTimer(k))},S.updateSessionScore=function(e){var t=new l,s={sid:g.get("_id"),step:"mutech",time:e,cards:E};return A.request("UpdateSessionScore",s,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},S.initTimer=function(e){var t=new Date,s=t.getTime(),i=e||0;x.set("display",!1),x.set("timer",i),"mutech"===g.get("step")&&(clearInterval(w),w=setInterval(function(){var e=new Date;x.set("timer",i+e.getTime()-s)},1e3))},y=new c(S.closePopup),S.getChatUI=function(){return _},g.watchValue("chat",function(e){4===e.length&&_.getModel().get("_id")!==e[3]&&_.reset(e[3])}),h.watchValue("deck",function(e){C=e.techno.concat(),H.set("left",C.length)}),["tech1","tech2","tech3"].forEach(function(e){g.watchValue("drawn"+e,function(t){S.isLeader()||S.getCardDetails(t,e)}),g.watchValue("selected_"+e,function(t){var s;S.isLeader()||(s=H.get(e),s.selected=t,H.set(e,s),t&&h.set("techno",J))})}),S}});