/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/cardpopup","../../whiteboard/whiteboard","Store","CouchDBDocument","Promise","service/utils","lib/spin.min","./mubchat","./muvote"],function(e,t,i,s,n,a,o,r,l,d,c,u,g,p,m){return function(v,h,b,f,w){var y,L,S,T,k=new e,A=new p,M=new m,I="step",D=0,H=new l({timer:null,display:!1}),_=new l({title:"",description:"",solution:"",visibility:"private"}),C=new l,q=new l([]),x=[],N={cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1},P=new l(N),E=new l([]),B=new r("idea",E,P,"mu"),O=a.get("transport"),F=a.get("user"),j=a.get("db"),V=a.get("labels"),J=!1,U=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();return k.isLeader=function(){return v.get("initiator")&&v.get("initiator").id===F.get("_id")},k.plugins.addAll({labels:new i(V,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),scenario:new i(C),techs:new i(q,{setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(P,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){k.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showIdea:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){var t;"scenario"===this.getAttribute("name")?e?this.classList.add("highlighted"):this.classList.remove("highlighted"):(t=this.getAttribute("data-techs_id"),e[t]?this.classList.add("highlighted"):this.classList.remove("highlighted"))}}),muideatimer:new i(H,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),idea:new i(_),wbstack:B,place:new n({chat:A,vote:M}),muideaevent:new s(k)}),k.template='<div id = "muidea"><div class="previousbutton" data-muideaevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, muidea" data-muideaevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muideatimer="bind:setTime, timer; bind: displayTimer, display" data-muideaevent="listen:mousedown,toggleTimer"></div><div id="muidea-left"><div class="idea-cards leftarea folded" data-muideaevent="listen:mousedown, fold"><div class="card defaultscenario" name="scenario" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.scenario"><div class="cardpicture"></div><div class="cardtitle" data-scenario="bind:innerHTML, title"></div></div><ul class="cardlist" data-techs="foreach"><li><div class="card tech" data-muideaevent="listen: mousedown, zoom" data-wbtools="bind: popup,cardpopup.techs"><div class="cardpicture" data-techs="bind:setPic, pic"></div><div class="cardtitle" data-techs="bind:innerHTML,title"></div></div></li></ul><div class="caret"></div></div><div id="muidea-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showidea"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muideaevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muideaevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muideaevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muidea-right" class="workarea"><div id="idea-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muideaevent="listen:mousedown, toggleCaret"></div></div><div id = "muidea-writeup" class="writeup invisible" data-wbtools="bind: showIdea,showidea"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, ideatitleplaceholder" data-idea="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterDesc" data-labels="bind:setPlaceholder, ideadescplaceholder" data-idea="bind:value, description" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, ideasolplaceholder" data-idea="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muideaevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muideaevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionvote" data-place="place:vote"></div><div class="sessionchat" data-place="place:chat"></div></div>',k.place(t.get("muidea")),k.press=function(e,t){t.classList.add("pressed")},k.next=function(e,t){var i,s,n,a,o=new Date,r=new c;t.classList.add("invisible"),t.classList.remove("pressed"),"step"===I?(I="screen",P.set("readonly",!0),clearInterval(S),H.set("display",!0),clearInterval(T),s=k.getSessionDuration(),M.reset(v,function(e){J=!0,n=e.visibility,a=e.replay,_.set("visibility",n),_.set("sessionReplay",a),r.fulfill(),M.close()}),r.then(function(){return U.spin(t.parentNode),h.set("idea",JSON.parse(_.toJSON())),i="I:"+o.getTime(),k.createIdeaDoc(i)}).then(function(){return v.unsync(),v.sync(j,v.get("_id"))}).then(function(){var e=v.get("elapsedTimers");return A.conclude("next"),e.muidea=H.get("timer"),v.set("idea",[JSON.parse(_.toJSON())]),a&&v.set("replayIdeas",[i]),v.set("elapsedTimers",e),v.set("duration",s),v.set("status","completed"),v.set("idea",[h.get("idea")]),v.upload()}).then(function(){return k.updateSessionScore(H.get("timer"))}).then(function(){f("muidea")})):f("muidea")},k.stopSpinner=function(){U.stop()},k.prev=function(e,t){t.classList.remove("pressed"),b("muidea")},k.toggleProgress=function(){w()},k.toggleTimer=function(){k.isLeader()&&H.set("display",!H.get("display"))},k.toggleVisibility=function(){"step"===I&&k.isLeader()&&("public"===_.get("visibility")?_.set("visibility","private"):_.set("visibility","public"))},k.push=function(e,t){var i=t.getAttribute("name");P.set(i,"active")},k.zoom=function(e,t){e.stopPropagation();var i,s;"scenario"===t.getAttribute("name")?i="scenario":(i="techno",s=t.getAttribute("data-techs_id")),k.setPopup(i,s)},k.fold=function(e,t){v.get("ideaReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),L&&y.close())},k.setPopup=function(e,t){var i,s={x:147,y:30},n="left",o=P.get("cardpopup"),r=new l,c="";L&&("scenario"===L.type?o.scenario=!1:o.techs[L.id]=!1,P.set("cardpopup",o)),"scenario"===e?o.scenario=!0:o.techs[t]=!0,P.set("cardpopup",o),L={type:e,id:t},"scenario"===e?(s.y=55,r.reset(h.get("scenario")),r.set("type",5),c=r.toJSON(),y.reset(c,s,n,document.getElementById("muidea-popup"))):(0==t&&(s.y=200),1==t&&(s.y=260),2==t&&(s.y=350),x[t]?(c=x[t],y.reset(c,s,n,document.getElementById("muidea-popup"))):(i=new d,i.setTransport(O),i.sync(a.get("db"),h.get("techno").get(t).id).then(function(){c=i.toJSON(),y.reset(c,s,n,document.getElementById("muidea-popup")),x[t]=c})))},k.closePopup=function(){P.set("cardpopup",{scenario:!1,techs:[!1,!1,!1]}),L=""},y=new o(k.closePopup),k.getChatUI=function(){return A},k.post=function(){B.selectScreen("postit"),P.set("import","inactive"),P.set("drawing","inactive")},k.importpic=function(){B.selectScreen("import"),P.set("postit","inactive"),P.set("drawing","inactive")},k.draw=function(){B.selectScreen("drawing"),P.set("import","inactive"),P.set("postit","inactive")},k.exitTool=function(e){P.set(e,"inactive")},k.finish=function(e,t){var i=new g({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();i.spin(t.parentNode),t.classList.add("invisible"),v.unsync(),v.sync(j,v.get("_id")).then(function(){return v.set("ideaReady",!0),v.upload()}).then(function(){i.stop(),t.classList.remove("pressed"),P.set("ready",!1),k.displayIdea(),k.updateIdea()})},k.updateField=function(e,t){t.classList.contains("enterTitle")&&_.set("title",t.value),t.classList.contains("enterDesc")&&_.set("description",t.value),t.classList.contains("enterSol")&&_.set("solution",t.value)},k.displayIdea=function(){B.setReadonly(!0),P.set("showidea",!0),k.dom.querySelector(".idea-cards").classList.remove("folded"),k.dom.querySelector(".idea-cards .caret").classList.add("invisible"),k.dom.querySelector(".writeup").scrollIntoView(),k.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},k.hideIdea=function(){k.dom.querySelector(".idea-cards").classList.add("folded"),k.dom.querySelector(".idea-cards .caret").classList.remove("invisible"),k.dom.querySelector(".whiteboard .caret").classList.add("invisible")},k.toggleCaret=function(e,t){e.stopPropagation();var i=k.dom.querySelector(".writeup"),s=k.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?i.scrollIntoView():s.scrollIntoView()},k.toggleView=function(e,t){var i=t.querySelector(".caret"),s=k.dom.querySelector(".writeup"),n=k.dom.querySelector(".whiteboard");i.classList.contains("descending")?(i.classList.remove("descending"),n.scrollIntoView()):e.pageY-t.scrollHeight>0&&(i.classList.add("descending"),s.scrollIntoView())},k.updateIdea=function(){T=setInterval(function(){var e=v.get("idea")[0]||{title:"",description:"",solution:""},t=e.title,i=e.description,s=e.solution,n={};(_.get("title")!==t||_.get("description")!==i||_.get("solution")!==s)&&(n.title=_.get("title"),n.description=_.get("description"),n.solution=_.get("solution"),v.set("idea",[n]),v.upload().then(function(){return!0},function(e){console.log("failed to update idea",e)}))},8e3)},k.updateSessionScore=function(e){var t=new c,i={sid:v.get("_id"),step:"muidea",time:e,wbcontent:E.toJSON(),idea:_.toJSON()};return O.request("UpdateSessionScore",i,function(e){"ok"===e.res?(v.unsync(),v.sync(j,v.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},k.getSessionDuration=function(){var e=v.get("elapsedTime"),t=v.get("resumeTime")||v.get("startTime");return now=new Date,now.getTime()-t+e},k.createIdeaDoc=function(e){var t=new d(a.get("ideaTemplate")),i=new Date(parseInt(e.slice(2,e))),s=[],n=new c;return auth.push(v.get("initiator").id),s.push(v.get("initiator").username),v.get("participants").forEach(function(e){e.present&&(auth.push(e.id),s.push(e.username))}),t.setTransport(O),t.set("title",_.get("title")),t.set("sessionId",v.get("_id")),t.set("authors",auth),t.set("description",_.get("description")),t.set("solution",_.get("solution")),t.set("creation_date",[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()]),t.set("character",v.get("characters")[0]),t.set("problem",v.get("problems")[0]),t.set("context",v.get("contexts")[0]),t.set("techno",v.get("techno")[0]),t.set("visibility",_.get("visibility")),t.set("sessionReplay",_.get("sessionReplay")),t.set("authornames",s.join(", ")),t.set("lang",v.get("lang").substring(0,2)),t.set("_id",e),t.sync(a.get("db"),e).then(function(){return t.upload()}).then(function(){"public"===t.get("visibility")&&(O.request("UpdateUIP",{userid:F.get("_id"),type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(e){"ok"!==e&&console.log(e)}),v.get("participants").forEach(function(e){O.request("UpdateUIP",{userid:e.id,type:t.get("type"),docId:t.get("_id"),docTitle:t.get("title")},function(t){"ok"!==t&&console.log(e.id," "+t)})})),n.fulfill(),t.unsync()}),n},k.reset=function(e){A.clear(),v.get("chat")[4]&&A.reset(v.get("chat")[4]),P.reset({cardpopup:{scenario:!1,techs:[!1,!1,!1]},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showidea:!1,shownext:!1,readonly:!1}),q.reset(),B.setSessionId(v.get("_id")),E.reset(v.get("ideaWB")),B.init(),E.getNbItems()?B.selectScreen("main"):B.selectScreen("default"),clearInterval(S),e||v.get("idea").length?(I="screen",A.dom.querySelector(".chatread").classList.add("extended"),P.set("ready",!1),k.displayIdea(),_.reset(v.get("idea")[0]),h.set("idea",v.get("idea")[0]),P.set("readonly",!0),P.set("shownext",!1)):(_.reset({title:"",description:"",solution:"",visibility:"private"}),E.getNbItems()?P.set("ready",!0):P.set("ready",!1),B.setReadonly(!1),I="step",J=!1),v.get("elapsedTimers").muidea&&(D=v.get("elapsedTimers").muidea,H.set("timer",D),"screen"===I?H.set("display",!0):k.isLeader()&&k.initTimer(D))},k.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;H.set("display",!1),H.set("timer",s),"muidea"===v.get("step")&&(S=setInterval(function(){var e=new Date;H.set("timer",s+e.getTime()-i)},1e3))},v.watchValue("_id",function(e){B.setSessionId(e)}),v.watchValue("chat",function(e){5===e.length&&A.getModel().get("_id")!==e[4]&&A.reset(e[4])}),h.watchValue("scenario",function(){C.reset(h.get("scenario"))}),h.watchValue("techno",function(){q.reset(JSON.parse(h.get("techno").toJSON()))}),["added","deleted","updated"].forEach(function(e){E.watch(e,function(){P.get("showidea")||((v.get("ideaWB").length!==E.getNbItems()||JSON.stringify(v.get("ideaWB"))!==E.toJSON())&&(v.set("ideaWB",JSON.parse(E.toJSON())),v.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)})),E.getNbItems()?P.set("ready",!0):P.set("ready",!1))})}),v.watchValue("ideaWB",function(e){"muidea"!==v.get("step")||P.get("showidea")||(e.length&&"default"===B.getStack().getCurrentName()&&B.selectScreen("main"),e.length||B.selectScreen("default"),(e.length!==E.getNbItems()||JSON.stringify(e)!==E.toJSON())&&E.reset(e))}),v.watchValue("ideaReady",function(e){"muidea"===v.get("step")&&e&&!k.isLeader()&&(P.set("readonly",!0),k.displayIdea())}),v.watchValue("idea",function(e){k.isLeader()||(_.reset(e[0]),h.set("idea",JSON.parse(_.toJSON())))}),_.watch("updated",function(){k.isLeader()&&_.get("title")&&_.get("description")&&_.get("solution")?P.set("shownext",!0):P.set("shownext",!1)}),v.watchValue("vote",function(e){!e||J||k.isLeader()||M.isActive()||(M.reset(v,function(e){e&&M.close()}),J=!0)}),k}});