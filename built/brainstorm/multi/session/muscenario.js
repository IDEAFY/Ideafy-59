/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../../whiteboard/whiteboard","Promise","service/utils","lib/spin.min","./mubchat"],function(e,t,i,s,n,a,o,r,l,d,c,u,p,g){return function(m,v,h,b,f){var w,y,L,S,T=new e,k=new g,A=a.get("labels"),M=a.get("user"),I=a.get("db"),x=new o,H=new o,D=new o,q=new o({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),C={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},N=new o(C),_=new o({timer:null,display:!1}),O=new o({title:"",story:"",solution:""}),P=new o([]),B=new d("scenario",P,N,"mu"),E=0,V="step",J=a.get("transport"),j=new p({color:"#657B99",lines:10,length:8,width:4,radius:8,top:695,left:670}).spin();return T.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===M.get("_id")},T.plugins.addAll({labels:new i(A,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new i(q,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},a.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(N,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){T.isLeader()?e?this.classList.remove("invisible"):this.classList.add("invisible"):this.classList.add("invisible")},showStory:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),muscenariotimer:new i(_,{setTime:function(e){this.innerHTML=u.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new i(O),wbstack:B,place:new n({chat:k}),muscenarioevent:new s(T)}),T.template='<div id = "muscenario"><div class="previousbutton" data-muscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, muscenario" data-muscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-muscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-muscenarioevent="listen:mousedown,toggleTimer"></div><div id="muscenario-left"><div class="scenario-cards leftarea folded" data-muscenarioevent="listen:mousedown, fold"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-muscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div><div class="caret"></div></div><div id="muscenario-popup"></div><div class ="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-muscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-muscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-muscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div></div></div><div id="muscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard" data-muscenarioevent = "listen:mousedown, toggleView"><div class="stack" data-wbstack="destination"></div><div class="caret descending invisible" data-muscenarioevent="listen:mousedown, toggleCaret"></div></div><div id = "muscenario-writeup" class="writeup invisible" data-wbtools="bind: showStory,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly" data-muscenarioevent="listen:input, updateField"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-muscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div><div class="sessionchat" data-place="place:chat"></div></div>',T.place(t.get("muscenario")),T.press=function(e,t){t.classList.add("pressed")},T.isLeader=function(){return m.get("initiator")&&m.get("initiator").id===M.get("_id")},T.next=function(e,t){j.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===V?(V="screen",N.set("readonly",!0),clearInterval(L),_.set("display",!0),clearInterval(S),v.set("scenario",JSON.parse(O.toJSON())),m.unsync(),m.sync(I,m.get("_id")).then(function(){var e;return k.conclude("next"),e=m.get("elapsedTimers"),e.muscenario=_.get("timer"),m.set("elapsedTimers",e),m.set("scenario",[v.get("scenario")]),m.upload()}).then(function(){return T.updateSessionScore(_.get("timer"))}).then(function(){b("muscenario")})):b("muscenario")},T.stopSpinner=function(){j.stop()},T.prev=function(e,t){t.classList.remove("pressed"),h("muscenario")},T.toggleProgress=function(){f()},T.toggleTimer=function(){T.isLeader()&&_.set("display",!_.get("display"))},T.push=function(e,t){var i=t.getAttribute("name");N.set(i,"active")},T.zoom=function(e,t){e.stopPropagation();var i=t.getAttribute("name");T.setPopup(i)},T.fold=function(e,t){m.get("scReady")||(t.classList.toggle("folded"),t.querySelector(".caret").classList.toggle("folding"),y&&w.close())},T.setPopup=function(e){var t,i={x:147,y:130},s="left",n=q.get(e),a=N.get("cardpopup"),o="";y&&(a[y]=!1),a[e]=!0,N.set("cardpopup",a),y=e,"char"===e&&(i.y=120,n.id===x.get("_id")&&(o=x.toJSON())),"context"===e&&(i.y=290,n.id===H.get("_id")&&(o=H.toJSON())),"problem"===e&&(i.y=350,n.id===D.get("_id")&&(o=D.toJSON())),o?w.reset(o,i,s,document.getElementById("muscenario-popup")):(t=new r,t.setTransport(J),t.sync(I,n.id).then(function(){o=t.toJSON(),w.reset(o,i,s,document.getElementById("muscenario-popup")),"char"===e&&x.reset(JSON.parse(t.toJSON())),"context"===e&&H.reset(JSON.parse(t.toJSON())),"problem"===e&&D.reset(JSON.parse(t.toJSON()))}))},T.closePopup=function(){var e=N.get("cardpopup");e[y]=!1,N.set("cardpopup",e),y=""},w=new l(T.closePopup),T.getChatUI=function(){return k},T.post=function(){B.selectScreen("postit"),N.set("import","inactive"),N.set("drawing","inactive")},T.importpic=function(){B.selectScreen("import"),N.set("postit","inactive"),N.set("drawing","inactive")},T.draw=function(){B.selectScreen("drawing"),N.set("import","inactive"),N.set("postit","inactive")},T.exitTool=function(e){N.set(e,"inactive")},T.finish=function(e,t){var i=new p({color:"#657B99",lines:10,length:8,width:4,radius:8,top:550,left:50}).spin();i.spin(t.parentNode),t.classList.add("invisible"),m.unsync(),m.sync(I,m.get("_id")).then(function(){return m.set("scReady",!0),m.upload()}).then(function(){i.stop(),t.classList.remove("pressed"),N.set("ready",!1),T.displayStory(),T.updateScenario()})},T.updateField=function(e,t){t.classList.contains("enterTitle")&&O.set("title",t.value),t.classList.contains("enterDesc")&&O.set("story",t.value),t.classList.contains("enterSol")&&O.set("solution",t.value)},T.displayStory=function(){B.setReadonly(!0),N.set("showstory",!0),T.dom.querySelector(".scenario-cards").classList.remove("folded"),T.dom.querySelector(".scenario-cards .caret").classList.add("invisible"),T.dom.querySelector(".writeup").scrollIntoView(),T.dom.querySelector(".whiteboard .caret").classList.remove("invisible")},T.hideStory=function(){T.dom.querySelector(".scenario-cards").classList.add("folded"),T.dom.querySelector(".scenario-cards .caret").classList.remove("invisible"),T.dom.querySelector(".whiteboard .caret").classList.add("invisible")},T.toggleCaret=function(e,t){e.stopPropagation();var i=T.dom.querySelector(".writeup"),s=T.dom.querySelector(".whiteboard");t.classList.toggle("descending"),t.classList.contains("descending")?i.scrollIntoView():s.scrollIntoView()},T.toggleView=function(e,t){var i=t.querySelector(".caret"),s=T.dom.querySelector(".writeup"),n=T.dom.querySelector(".whiteboard");i.classList.contains("descending")?(i.classList.remove("descending"),n.scrollIntoView()):e.pageY-t.scrollHeight>0&&(i.classList.add("descending"),s.scrollIntoView())},T.updateScenario=function(){S=setInterval(function(){var e=m.get("scenario")[0]||{title:"",story:"",solution:""},t=e.title,i=e.story,s=e.solution,n={};(O.get("title")!==t||O.get("story")!==i||O.get("solution")!==s)&&(n.title=O.get("title"),n.story=O.get("story"),n.solution=O.get("solution"),m.set("scenario",[n]),m.upload().then(function(){return console.log("scenario updated in CouchDB"),!0},function(e){console.log("failed to update scenario",e)}))},8e3)},T.updateSessionScore=function(e){var t=new c,i={sid:m.get("_id"),step:"muscenario",time:e,wbcontent:P.toJSON(),scenario:O.toJSON()};return J.request("UpdateSessionScore",i,function(e){console.log(e),"ok"===e.res?(m.unsync(),m.sync(I,m.get("_id")).then(function(){t.fulfill()})):t.reject()}),t},T.reset=function(e){k.clear(),m.get("chat")[2]&&k.reset(m.get("chat")[2]),N.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),B.setSessionId(m.get("_id")),P.reset(m.get("scenarioWB")),B.init(),P.getNbItems()?B.selectScreen("main"):B.selectScreen("default"),e||m.get("scenario").length?(V="screen",k.dom.querySelector(".chatread").classList.add("extended"),N.set("ready",!1),T.displayStory(),N.set("readonly",!0),N.set("shownext",!1),O.reset(m.get("scenario")[0]),v.set("scenario",m.get("scenario")[0])):(O.reset({title:"",story:"",solution:""}),P.getNbItems()?N.set("ready",!0):N.set("ready",!1),B.setReadonly(!1),T.hideStory(),V="step"),m.get("elapsedTimers").muscenario&&(E=m.get("elapsedTimers").muscenario,_.set("timer",E),"screen"===V?_.set("display",!0):T.isLeader()&&T.initTimer(E))},T.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;_.set("display",!1),_.set("timer",s),"muscenario"===m.get("step")&&(clearInterval(L),L=setInterval(function(){var e=new Date;_.set("timer",s+e.getTime()-i)},1e3))},v.watchValue("characters",function(e){q.set("char",e)}),v.watchValue("contexts",function(e){q.set("context",e)}),v.watchValue("problems",function(e){q.set("problem",e)}),m.watchValue("_id",function(e){B.setSessionId(e)}),m.watchValue("chat",function(e){3===e.length&&k.getModel().get("_id")!==e[2]&&k.reset(e[2])}),["added","deleted","updated"].forEach(function(e){P.watch(e,function(){N.get("showstory")||((m.get("scenarioWB").length!==P.getNbItems()||JSON.stringify(m.get("scenarioWB"))!==P.toJSON())&&(m.set("scenarioWB",JSON.parse(P.toJSON())),m.upload().then(function(e){console.log("success : ",e)},function(e){console.log("failure : ",e)})),P.getNbItems()&&"step"===V?N.set("ready",!0):N.set("ready",!1))})}),m.watchValue("scenarioWB",function(e){"muscenario"!==m.get("step")||N.get("showstory")||(e.length&&"default"===B.getStack().getCurrentName()&&B.selectScreen("main"),e.length||B.selectScreen("default"),(e.length!==P.getNbItems()||JSON.stringify(e)!==P.toJSON())&&P.reset(e))}),m.watchValue("scReady",function(e){"muscenario"===m.get("step")&&e&&!T.isLeader()&&(N.set("readonly",!0),T.displayStory())}),m.watchValue("scenario",function(e){T.isLeader()||(O.reset(e[0]),v.set("scenario",JSON.parse(O.toJSON())))}),O.watch("updated",function(){T.isLeader()&&O.get("title")&&O.get("story")&&O.get("solution")?N.set("shownext",!0):N.set("shownext",!1)}),T}});