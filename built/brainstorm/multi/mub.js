/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Amy/Stack-plugin","Bind.plugin","Event.plugin","CouchDBDocument","CouchDBView","service/config","Promise","Store","./mubinit","./mubwait","./session/mucontroller","lib/spin.min"],function(e,t,i,s,n,a,o,l,d,r,c,u,g){return function(i,s){var a,l,d,m=new e,p=new t,v=o.get("user");return new g({color:"#9AC9CD",lines:10,length:12,width:6,radius:10,top:328}).spin(),m.plugins.add("mustack",p),m.template='<div id="ideafy-multi"><div class="stack" data-mustack="destination"></div></div>',m.place(document.getElementById("ideafy-multi")),m.reset=function(e){e?"join"===e.mode?m.join(e.id):"preview"===e.mode?m.showPreview(e.id):m.replayMUSession(e.id):(l.reset(),p.getStack().show("mubinit"))},m.replayMUSession=function(e){d.reset(e,!0),p.getStack().show("musession")},m.showPreview=function(e){l.showPreview(e),p.getStack().show("mubinit")},m.join=function(e){var t=new n;t.setTransport(o.get("transport")),t.sync(o.get("db"),e).then(function(){var i=t.get("participants").concat(),s=!1;t.get("initiator").id===v.get("_id")?s=!0:i.forEach(function(e){e.id===v.get("_id")&&(s=!0,e.present=!0,t.set("participants",i),t.upload())}),s?t.get("step")&&"mustart"!==t.get("step")?m.startSession(e):(a.reset(e),p.getStack().show("mubwait")):(i.push({id:v.get("_id"),username:v.get("username"),intro:v.get("intro"),present:!0}),t.set("participants",i),3===i.length&&t.set("status","full"),t.upload().then(function(){a.reset(e),p.getStack().show("mubwait")},function(e){console.log(e),alert("failed to join session")}))},function(e){console.log(e),alert("failed to join session")})},m.startSession=function(e){p.getStack().show("musession"),d.reset(e)},l=new r(s),a=new c(s,m.startSession),d=new u(s),p.getStack().add("mubinit",l),p.getStack().add("mubwait",a),p.getStack().add("musession",d),i?"join"===i.mode?m.join(i.id):"preview"===i.mode?m.showPreview(i.id):m.replayMUSession(i.id):p.getStack().show("mubinit"),o.get("observer").watch("start-mu_session",function(e){a.reset(e),p.getStack().show("mubwait")}),m}});