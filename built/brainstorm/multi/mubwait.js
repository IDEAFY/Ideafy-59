/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,s,n,a,o,l,r,d,c,u,m,g,p,v){return function(n,h){var b,f,w=new e,y=new s,L=new t,T=new t({msg:""}),S=r.get("user"),k=r.get("labels"),A=new p,M={listener:null},D=new v({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return y.setTransport(r.get("transport")),w.plugins.addAll({labels:new a(k),model:new a(y,{setTitle:function(e){e&&(this.innerHTML=e),S.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),S.get("_id")===y.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new g([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},showStartButton:function(e){e&&e.length&&S.get("_id")===y.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new a(L,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new g([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},setPresent:function(e){var t=this.getAttribute("data-participant_id")||0;e||S.get("_id")===L.get(t).id?this.setAttribute("style","opacity: 1;"):this.setAttribute("style","opacity: 0.4;")}}),info:new a(T),place:new l({chat:A}),mubwaitevent:new o(w)}),w.template='<div id="mubwait"><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact" data-participant="bind:setPresent, present"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="exit-brainstorm" data-mubwaitevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessionmsg invisible"><span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',w.place(document.getElementById("mubwait")),w.help=function(){d.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},w.reset=function(e){A.clear(),y.unsync(),y.reset({}),L.reset([]),y.sync(r.get("db"),e).then(function(){M.listener=c.exitListener("mubwait",w.leave),L.reset(y.get("participants")),A.reset(y.get("chat")[0]),S.set("sessionInProgress",{id:e,type:"musession",mode:"join"}),S.upload()})},w.press=function(e,t){t.classList.add("press")},w.exit=function(e,t){var i=(new Date).getTime(),s=y.get("scheduled")||null;t.classList.remove("pressed"),s&&s-i>3e5?n():(y.get("initiator").id===S.get("_id")?u.reset(k.get("leaderleave"),b,"musession-confirm"):u.reset(k.get("participantleave"),b,"musession-confirm"),u.show("musession-confirm"))},w.leave=function(e){var t=(new Date).getTime();f=e.getAttribute("href")||e,y.get("initiator").id===S.get("_id")?u.reset(k.get("leaderleave"),b,"musession-confirm"):u.reset(k.get("participantleave"),b,"musession-confirm"),(!y.get("scheduled")||y.get("scheduled")-t<3e5)&&u.show("musession-confirm")},b=function(e){e?(S.set("sessionInProgress",""),S.upload(),y.get("initiator").id===S.get("_id")?w.cancelSession():w.leaveSession()):u.hide()},w.leaveSession=function(){var e,t=y.get("participants");for(e=t.length-1;e>=0;e--)if(t[e].id===S.get("_id")){t.splice(e,1);break}y.set("participants",t),y.set("status","waiting"),y.upload().then(function(){return A.leave()}).then(function(){w.goToScreen(),y.unsync(),y.reset({})}),n(),u.hide()},w.cancelSession=function(){var e=5e3;y.get("participants").length?w.displayInfo("deleting",e).then(function(){y.remove(),u.hide(),w.goToScreen()}):(w.goToScreen(),u.hide(),A.cancel(),y.remove().then(function(e){console.log("session remove result : ",e)},function(e){console.log("session removal error: ",e)}))},w.displayInfo=function(e,t){var i,s=document.querySelector(".sessionmsg"),n=new m,a=function(){s.classList.add("invisible"),clearInterval(i),T.set("msg",""),n.fulfill()};return u.hide(),s.classList.remove("invisible"),i=setInterval(function(){"deleting"!==e?T.set("msg",e):T.set("msg",k.get("deletingsession")+t/1e3+"s"),0>=t&&a(),t-=1e3},1e3),"deleting"===e&&(y.set("status","deleted"),y.upload().then(function(){A.cancel()})),n},w.goToScreen=function(){var e;n(),document.removeEventListener("mousedown",M.listener,!0),f&&f.getAttribute&&f.getAttribute("data-notify_id")?(r.get("observer").notify("goto-screen","#connect"),e=f.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(e,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){f===e&&r.get("observer").notify("goto-screen",e)})},w.checkUpdate=function(e,t){var i=t.getAttribute("name");13===e.keyCode&&(w.updateSession(i,t.innerHTML),t.blur())},w.updateField=function(e,t){var i=t.getAttribute("name");w.updateSession(i,t.innerHTML)},w.updateSession=function(e,t){y.get(e)!==t&&(y.set(e,t),y.upload())},w.start=function(e,t){var s=new Date,n=y.get("chat"),a=y.get("participants").concat();if(y.get("initiator").id===S.get("_id")){for(A.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),D.spin(t.parentNode),y.set("status","in progress"),y.set("step","musetup"),y.set("startTime",s.getTime()),y.set("date",[s.getFullYear(),s.getMonth(),s.getDate()]),n.push(y.get("_id")+"_1"),y.set("chat",n),i=a.length-1;i>=0;i--)a[i].present||a.splice(i,1);y.set("participants",a),w.createChat(y.get("chat")[1]).then(function(){return y.upload()}).then(function(){y.unsync(),D.stop(),t.classList.remove("invisible"),document.removeEventListener("mousedown",M.listener,!0),h(y.get("_id"))})}},w.createChat=function(e){var t=new s,i=(new Date).getTime(),n=new m;return t.setTransport(r.get("transport")),t.set("users",A.getModel().get("users")),t.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:i}]),t.set("sid",y.get("_id")),t.set("lang",y.get("lang")),t.set("readonly",!1),t.set("step",1),t.set("type",17),t.sync(r.get("db"),e).then(function(){return t.upload()}).then(function(){n.fulfill(),t.unsync()}),n},y.watchValue("status",function(e){"deleted"===e&&y.get("initiator").id!==S.get("_id")&&(y.unsync(),w.displayInfo(k.get("canceledbyleader"),2e3).then(function(){document.removeEventListener("mousedown",M.listener,!0),n()})),"in progress"===e&&y.get("initiator").id!==S.get("_id")&&(y.unsync(),document.removeEventListener("mousedown",M.listener,!0),h(y.get("_id")),y.reset({}),L.reset([]))}),y.watchValue("participants",function(e){L.reset(e)}),w}});