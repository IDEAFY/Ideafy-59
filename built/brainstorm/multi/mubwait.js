/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,i,s,n,a,l,o,d,r,c,u,m,g,p){return function(s,r){var v,b,h=new e,f=new i,w=new t,y=new t({msg:""}),L=o.get("user"),T=o.get("labels"),S=new g,A=new p({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return f.setTransport(o.get("transport")),h.plugins.addAll({labels:new n(T),model:new n(f,{setTitle:function(e){e&&(this.innerHTML=e),L.get("_id")===f.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),L.get("_id")===f.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new m([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},showStartButton:function(e){e&&e.length&&L.get("_id")===f.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new n(w,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new m([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "}}),info:new n(y),place:new l({chat:S}),mubwaitevent:new a(h)}),h.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div><div class="exit-brainstorm" data-mubwaitevent="listen: mousedown, press; listen:mouseup, exit"></div></form><div class="sessionmsg invisible"> <span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',h.place(document.getElementById("mubwait")),h.help=function(){d.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},v=new c(document.body,null,null,"musession-confirm"),h.reset=function(e){S.clear(),f.unsync(),f.reset({}),w.reset([]),f.sync(o.get("db"),e).then(function(){b=function(e){e?(L.set("sessionInProgress",""),L.upload(),f.get("initiator").id===L.get("_id")?h.cancelSession():h.leaveSession()):v.hide()},f.get("initiator").id===L.get("_id")?v.reset(T.get("leaderleave"),b):v.reset(T.get("participantleave"),b),w.reset(f.get("participants")),S.reset(f.get("chat")[0]),L.set("sessionInProgress",{id:e,type:"musession",mode:"join"}),L.upload()})},h.press=function(e,t){t.classList.add("press")},h.exit=function(e,t){var i=(new Date).getTime(),n=f.get("scheduled")||null;t.classList.remove("pressed"),n&&n-i>3e5?s():v.show()},h.leaveSession=function(){var e,t=f.get("participants");for(e=t.length-1;e>=0;e--)if(t[e].id===L.get("_id")){t.splice(e,1);break}f.set("participants",t),f.set("status","waiting"),f.upload().then(function(){return S.leave()}).then(function(){f.unsync(),f.reset({})}),s(),v.hide()},h.cancelSession=function(){var e=5e3;f.get("participants").length||(e=2e3),h.displayInfo("deleting",e).then(function(){f.remove(),s(),v.hide()})},h.displayInfo=function(e,t){var i,s=document.querySelector(".sessionmsg"),n=new u,a=function(){s.classList.add("invisible"),clearInterval(i),y.set("msg",""),n.fulfill()};return v.hide(),document.body.removeChild(document.querySelector(".confirm")),s.classList.remove("invisible"),i=setInterval(function(){"deleting"!==e?y.set("msg",e):y.set("msg",T.get("deletingsession")+t/1e3+"s"),0>=t&&a(),t-=1e3},1e3),"deleting"===e&&(f.set("status","deleted"),f.upload().then(function(){S.cancel()})),n},h.checkUpdate=function(e,t){var i=t.getAttribute("name");13===e.keyCode&&(h.updateSession(i,t.innerHTML),t.blur())},h.updateField=function(e,t){var i=t.getAttribute("name");h.updateSession(i,t.innerHTML)},h.updateSession=function(e,t){f.get(e)!==t&&(f.set(e,t),f.upload())},h.press=function(e,t){t.classList.add("pressed")},h.start=function(e,t){var i=new Date,s=f.get("chat");document.body.removeChild(document.querySelector(".confirm")),S.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),A.spin(t.parentNode),f.set("status","in progress"),f.set("step","musetup"),f.set("startTime",i.getTime()),f.set("date",[i.getFullYear(),i.getMonth(),i.getDate()]),s.push(f.get("_id")+"_1"),f.set("chat",s),h.createChat(f.get("chat")[1]).then(function(){return f.upload()}).then(function(){document.removeEventListener("mousedown",exitListener.listener,!0),f.unsync(),A.stop(),t.classList.remove("invisible"),r(f.get("_id"))})},h.createChat=function(e){var t=new i,s=(new Date).getTime(),n=new u;return t.setTransport(o.get("transport")),t.set("users",S.getModel().get("users")),t.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:s}]),t.set("sid",f.get("_id")),t.set("lang",f.get("lang")),t.set("readonly",!1),t.set("step",1),t.set("type",17),t.sync(o.get("db"),e).then(function(){return t.upload()}).then(function(){n.fulfill(),t.unsync()}),n},f.watchValue("status",function(e){"deleted"===e&&f.get("initiator").id!==L.get("_id")&&h.displayInfo(T.get("canceledbyleader"),2e3).then(function(){f.unsync(),s(),document.removeEventListener("mousedown",exitListener.listener,!0)}),"in progress"===e&&f.get("initiator").id!==L.get("_id")&&(document.removeEventListener("mousedown",exitListener.listener,!0),f.unsync(),r(f.get("_id")),f.reset({}),w.reset([]))}),f.watchValue("participants",function(e){w.reset(e)}),h}});