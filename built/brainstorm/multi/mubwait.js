/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","CouchDBDocument","service/map","Bind.plugin","Event.plugin","Place.plugin","service/config","service/help","service/utils","service/confirm","Promise","service/avatar","./session/mubchat","lib/spin.min"],function(e,t,i,s,n,a,o,l,r,d,c,u,m,g,p){return function(s,v){var h,b,f=new e,w=new i,y=new t,L=new t({msg:""}),T=l.get("user"),S=l.get("labels"),M=new g,A={listener:null},k=new p({color:"#5F8F28",lines:10,length:10,width:6,radius:10,left:269,top:306}).spin();return w.setTransport(l.get("transport")),f.plugins.addAll({labels:new n(S),model:new n(w,{setTitle:function(e){e&&(this.innerHTML=e),T.get("_id")===w.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setDescription:function(e){e&&(this.innerHTML=e.replace(/\n/g,"<br>")),T.get("_id")===w.get("initiator").id?this.setAttribute("contenteditable",!0):this.setAttribute("contenteditable",!1)},setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new m([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},showStartButton:function(e){e&&e.length&&T.get("_id")===w.get("initiator").id?this.classList.remove("invisible"):this.classList.add("invisible")}}),participant:new n(y,{setAvatar:function(e){var t,i;e&&(this.setAttribute("style","background:none;"),t=document.createDocumentFragment(),i=new m([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))},setIntro:function(e){this.innerHTML=e?e:" "},setPresent:function(e){var t=this.getAttribute("data-participant_id")||0;e||T.get("_id")===y.get(t).id?this.setAttribute("style","opacity: 1;"):this.setAttribute("style","opacity: 0.4;")}}),info:new n(L),place:new o({chat:M}),mubwaitevent:new a(f)}),f.template='<div id="mubwait"><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, waitingroomlbl"></div><div class="help-brainstorm" data-mubwaitevent="listen:mousedown, help"></div><form class="mubwait-form"><div class="mubwait-title" name="title" data-model="bind:setTitle, title" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></div><div class="mubdesc"><label data-labels="bind:innerHTML, quickstepstart"></label><p name="description" data-model="bind:setDescription, description" data-mubwaitevent="listen: keypress, checkUpdate; listen:blur, updateField"></p></div><div class="mubroster"><label data-labels="bind:innerHTML, participants">Participants</label><div class="mubleader contact"><div data-model="bind:setAvatar, initiator.id"></div><p class="contact-name" data-model="bind:innerHTML, initiator.username"></p><p class="contact-intro" data-model="bind:setIntro, initiator.intro"></p></div><ul class="participants" data-participant="foreach"><li class="contact" data-participant="bind:setPresent, present"><div data-participant="bind:setAvatar, id"></div><p class="contact-name" data-participant="bind:innerHTML, username"></p><p class="contact-intro" data-participant="bind:setIntro, intro"></p></li></ul></div><div class="start-button invisible" data-labels="bind:innerHTML, startbutton" data-model="bind: showStartButton, participants" data-mubwaitevent="listen: mousedown, press; listen:mouseup, start"></div></form><div class="exit-brainstorm" data-mubwaitevent="listen: mousedown, press; listen:mouseup, exit"></div><div class="sessionmsg invisible"><span data-info="bind:innerHTML, msg"></span></div><div class="sessionchat" data-place="place:chat"></div></div>',f.place(document.getElementById("mubwait")),f.help=function(){r.setContent("mustarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},f.reset=function(e){M.clear(),w.unsync(),w.reset({}),y.reset([]),w.sync(l.get("db"),e).then(function(){A.listener=d.exitListener("mubwait",f.leave),y.reset(w.get("participants")),M.reset(w.get("chat")[0]),T.set("sessionInProgress",{id:e,type:"musession",mode:"join"}),T.upload()})},f.press=function(e,t){t.classList.add("press")},f.exit=function(e,t){var i=(new Date).getTime(),n=w.get("scheduled")||null;t.classList.remove("pressed"),n&&n-i>3e5?s():(w.get("initiator").id===T.get("_id")?c.reset(S.get("leaderleave"),h,"musession-confirm"):c.reset(S.get("participantleave"),h,"musession-confirm"),c.show("musession-confirm"))},f.leave=function(e){var t=(new Date).getTime();b=e.getAttribute("href")||e,w.get("initiator").id===T.get("_id")?c.reset(S.get("leaderleave"),h,"musession-confirm"):c.reset(S.get("participantleave"),h,"musession-confirm"),(!w.get("scheduled")||w.get("scheduled")-t<3e5)&&c.show("musession-confirm")},h=function(e){e?(T.set("sessionInProgress",""),T.upload(),w.get("initiator").id===T.get("_id")?f.cancelSession():f.leaveSession()):c.hide()},f.leaveSession=function(){var e,t=w.get("participants");for(e=t.length-1;e>=0;e--)if(t[e].id===T.get("_id")){t.splice(e,1);break}w.set("participants",t),w.set("status","waiting"),w.upload().then(function(){return M.leave()}).then(function(){f.goToScreen(),w.unsync(),w.reset({})}),s(),c.hide()},f.cancelSession=function(){var e=5e3;w.get("participants").length?f.displayInfo("deleting",e).then(function(){w.remove(),c.hide(),f.goToScreen()}):(f.goToScreen(),c.hide(),M.cancel(),w.remove().then(function(e){console.log("session remove result : ",e)},function(e){console.log("session removal error: ",e)}))},f.displayInfo=function(e,t){var i,s=document.querySelector(".sessionmsg"),n=new u,a=function(){s.classList.add("invisible"),clearInterval(i),L.set("msg",""),n.fulfill()};return c.hide(),s.classList.remove("invisible"),i=setInterval(function(){"deleting"!==e?L.set("msg",e):L.set("msg",S.get("deletingsession")+t/1e3+"s"),0>=t&&a(),t-=1e3},1e3),"deleting"===e&&(w.set("status","deleted"),w.upload().then(function(){M.cancel()})),n},f.goToScreen=function(){var e;s(),document.removeEventListener("mousedown",A.listener,!0),b&&b.getAttribute&&b.getAttribute("data-notify_id")?(l.get("observer").notify("goto-screen","#connect"),e=b.getAttribute("data-notify_id"),observer.notify("display-message",parseInt(e,10))):["#public","#library","#brainstorm","#connect","#dashboard"].forEach(function(e){b===e&&l.get("observer").notify("goto-screen",e)})},f.checkUpdate=function(e,t){var i=t.getAttribute("name");13===e.keyCode&&(f.updateSession(i,t.innerHTML),t.blur())},f.updateField=function(e,t){var i=t.getAttribute("name");f.updateSession(i,t.innerHTML)},f.updateSession=function(e,t){w.get(e)!==t&&(w.set(e,t),w.upload())},f.press=function(e,t){t.classList.add("pressed")},f.start=function(e,t){var i=new Date,s=w.get("chat");M.conclude("start"),t.classList.add("invisible"),t.classList.remove("pressed"),k.spin(t.parentNode),w.set("status","in progress"),w.set("step","musetup"),w.set("startTime",i.getTime()),w.set("date",[i.getFullYear(),i.getMonth(),i.getDate()]),s.push(w.get("_id")+"_1"),w.set("chat",s),f.createChat(w.get("chat")[1]).then(function(){return w.upload()}).then(function(){w.unsync(),k.stop(),t.classList.remove("invisible"),document.removeEventListener("mousedown",A.listener,!0),v(w.get("_id"))})},f.createChat=function(e){var t=new i,s=(new Date).getTime(),n=new u;return t.setTransport(l.get("transport")),t.set("users",M.getModel().get("users")),t.set("msg",[{user:"SYS",type:5,arg:"quicksetup",time:s}]),t.set("sid",w.get("_id")),t.set("lang",w.get("lang")),t.set("readonly",!1),t.set("step",1),t.set("type",17),t.sync(l.get("db"),e).then(function(){return t.upload()}).then(function(){n.fulfill(),t.unsync()}),n},w.watchValue("status",function(e){"deleted"===e&&w.get("initiator").id!==T.get("_id")&&(w.unsync(),f.displayInfo(S.get("canceledbyleader"),2e3).then(function(){document.removeEventListener("mousedown",A.listener,!0),s()})),"in progress"===e&&w.get("initiator").id!==T.get("_id")&&(w.unsync(),document.removeEventListener("mousedown",A.listener,!0),v(w.get("_id")),w.reset({}),y.reset([]))}),w.watchValue("participants",function(e){y.reset(e)}),f}});