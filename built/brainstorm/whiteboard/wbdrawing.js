/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,i,s,n,a,o,r){return function(t,c){var d,l,u,p=new e,g=null,m={},v=new a({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),h=new a([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),b=new a([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),f=i.get("labels"),w=new a({status:null}),y=new a({type:"drawing",content:"",background:"",author:i.get("user").get("_id")}),L=function(e){var t=new o,s="/upload",n=new FormData,a="postit",c="sessions/"+d,l=p.dom.querySelector(".drawingcanvas"),u=l.toDataURL("image/png"),g=new Date,m=e||i.get("user").get("_id")+"_"+g.getTime();return n.append("type",a),n.append("dir",c),n.append("filename",m),n.append("dataString",u),r.uploadFile(s,n,w,function(){y.set("content",m),y.set("background",v.get("bg")),t.fulfill()}),t},k=!1,S=93;return p.plugins.addAll({labels:new s(f),color:new s(h,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),pencil:new s(v,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){"pencil"===e?this.setAttribute("fill",v.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){"pencil"===v.get("mode")?this.setAttribute("fill",e):this.setAttribute("fill",v.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new s(b,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),uploadprogress:new s(w,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),drawing:new s(y,{draw:function(e){var t,s=i.get("transport"),n=this;e&&(t={dir:d,filename:e},s.request("GetFile",t,function(e){var t=new Image,i=n.getContext("2d");t.src=e,i.drawImage(t,0,0)}))}}),drawingevent:new n(p)}),p.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',p.setSessionId=function(e){d=e},p.clear=function(e,t){var i=p.dom.querySelector(".drawingcanvas"),s=i.getContext("2d");s.clearRect(0,0,i.width,i.height),t.classList.remove("selected")},p.resetColors=function(){v.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),h.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),b.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},p.erase=function(){v.set("mode","erase"),v.set("color",v.get("bg"))},p.drawactive=function(){v.set("mode","pencil"),h.loop(function(e){e.active&&v.set("color",e.color)})},p.expand=function(e,t){var i=t.getAttribute("name"),s=document.getElementById(i);s.classList.contains("invisible")?s.classList.remove("invisible"):s.classList.add("invisible")},p.stop=function(e){e.stopPropagation()},p.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},p.select=function(e,t){t.classList.add("selected")},p.getColor=function(e,t){var i=t.getAttribute("data-color_id");e.stopPropagation(),h.loop(function(e,t){t===parseInt(i)?h.update(t,"active",!0):h.update(t,"active",!1)}),v.set("color",h.get(i).color),v.set("mode","pencil"),t.parentNode.classList.add("invisible")},p.getBgColor=function(e,t){var i=t.getAttribute("data-bgcolor_id");e.stopPropagation(),b.loop(function(e,t){t===parseInt(i)?b.update(t,"active",!0):b.update(t,"active",!1)}),v.set("bg",b.get(i).color),t.parentNode.classList.add("invisible")},p.cancel=function(e,t){p.clear(e,t),p.resetColors(),y.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),c("drawing")},p.deletedrawing=function(e,i){(g||0===g)&&t.del(g),p.cancel(e,i)},p.post=function(e,i){i.classList.add("selected"),L(y.get("content")).then(function(){g||0===g?t.alter("splice",g,1,JSON.parse(y.toJSON())):t.alter("push",JSON.parse(y.toJSON())),i.classList.remove("selected"),p.cancel(e,i),w.reset({status:""})})},p.reset=function(e){var s=p.dom.querySelector(".drawingcanvas");g=e,p.resetColors(),_lines=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&s.setAttribute("height",380),g||0===g?(y.reset(t.get(e)),v.set("bg",y.get("background")),b.loop(function(e,t){e.color===y.get("background")?b.update(t,"active",!0):b.update(t,"active",!1)})):y.reset({type:"drawing",content:"",background:"",author:i.get("user").get("_id")})},p.start=function(e,t){var i=t.offsetLeft+S;l=(document.body.clientWidth-1024)/2,u=(document.body.clientHeight-748)/2,m={x:e.pageX-i-l,y:e.pageY-t.offsetTop-u},k=!0,e.preventDefault()},p.end=function(){k=!1},p.move=function(e,t){var i,s,n,a=t.offsetLeft+S;k&&(i=e.pageX-a-l-m.x,s=e.pageY-t.offsetTop-u-m.y,n=p.draw(t,i,s),m={x:n.x,y:n.y}),e.preventDefault()},p.draw=function(e,t,i){var s=e.getContext("2d");return s.lineWidth=v.get("size"),s.strokeStyle=v.get("color"),s.lineCap=v.get("cap"),s.beginPath(),s.moveTo(m.x,m.y),s.lineTo(m.x+t,m.y+i),s.stroke(),s.closePath(),{x:m.x+t,y:m.y+i}},p}});