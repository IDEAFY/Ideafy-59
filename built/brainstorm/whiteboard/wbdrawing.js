/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","Promise","service/utils"],function(e,t,i,s,n,a,o,d){return function(t,r){var c,l=new e,u=null,p={},g=new a({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m=new a([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v=new a([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}]),h=i.get("labels"),b=new a({status:null}),f=new a({type:"drawing",content:"",background:""}),w=function(e){var t=new o,s="/upload",n=new FormData,a="postit",r="sessions/"+c,u=l.dom.querySelector(".drawingcanvas"),p=u.toDataURL("image/png"),m=new Date,v=e||i.get("user").get("_id")+"_"+m.getTime();return n.append("type",a),n.append("dir",r),n.append("filename",v),n.append("dataString",p),d.uploadFile(s,n,b,function(){f.set("content",v),f.set("background",g.get("bg")),t.fulfill()}),t},y=!1,L=(document.body.clientWidth-1024)/2,k=(document.body.clientHeight-748)/2,S=93;return l.plugins.addAll({labels:new s(h),color:new s(m,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),pencil:new s(g,{setSize:function(e){this.setAttribute("r",Math.round(e/2))},setColor:function(e){this.setAttribute("style","background:"+e+";")},togglebgfill:function(e){this.setAttribute("fill",e)},togglemode:function(e){"pencil"===e?this.setAttribute("fill",g.get("bg")):this.setAttribute("fill","#CCCCCC")},togglepencil:function(e){"pencil"===g.get("mode")?this.setAttribute("fill",e):this.setAttribute("fill",g.get("bg"))},toggleselected:function(e){this.classList.contains(e)?this.classList.add("selected"):this.classList.remove("selected")}}),bgcolor:new s(v,{setColor:function(e){this.setAttribute("style","background:"+e+";")},setActive:function(e){this.innerHTML=e?"&#10003;":""}}),uploadprogress:new s(b,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),drawing:new s(f,{draw:function(e){var t,s=i.get("transport"),n=this;e&&(t={dir:c,filename:e},s.request("GetFile",t,function(e){var t=new Image,i=n.getContext("2d");t.src=e,i.drawImage(t,0,0)}))}}),drawingevent:new n(l)}),l.template='<div class = "wbdrawing"><div class="drawingtools"><div class="pencil selected" data-pencil="bind:toggleselected, mode" data-drawingevent="listen:mousedown, drawactive"><span></span></div><div class="erase" data-drawingevent="listen:mousedown, erase" data-pencil="bind:toggleselected, mode"><span></span></div><div class="clear" data-drawingevent="listen:mousedown, select; listen:mouseup,clear"><span data-labels="bind:innerHTML, cleardrawinglbl">Clear</span></div><p name="pencilsize" data-drawingevent="listen:mousedown, expand"><svg width="60" height="39"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><circle class="stroke" cx="30" cy="21" r="18" stroke-width="1" stroke="rgba(145,145,145,0.7)" data-pencil="bind:togglebgfill,bg; bind:togglemode,mode"/><circle class="fill" cx="30" cy="21" r="18" data-pencil="bind:setSize,size; bind:togglepencil,color"/></svg><div class="drawinglabel" data-labels="bind:innerHTML, pencilsizelbl">size</div></p><input id="pencilsize" class="vertical invisible" type="range" min="1" max="36" data-pencil="bind:value,size" data-drawingevent="listen:mousedown, stop; listen:mousemove,stop; listen:mouseup,hide"><div name="pencilcolors" id="pencilcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilcolors"  class="pencilcolors invisible" data-color="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getColor"><div data-color="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="pencilpreview" data-pencil="bind:setColor, color"></div><div class="drawinglabel" data-labels="bind:innerHTML, pencilcolorlbl">Color</div></div><div name="pencilbgcolors" id="pencilbgcolor" data-drawingevent="listen:mousedown, expand"><ul id="pencilbgcolors"  class="pencilbgcolors invisible" data-bgcolor="foreach"><li class="color-item" data-drawingevent="listen:mousedown, getBgColor"><div data-bgcolor="bind:setColor, color; bind:setActive, active"></div></li></ul><div class="bgpreview" data-pencil="bind:setColor, bg"></div><div class="drawinglabel" data-labels="bind:innerHTML, drawbgcolorlbl">Background</div></div><div class="canceldrawing" data-drawingevent="listen:mousedown, select; listen:mouseup,cancel"></div><div class="deletedrawing" data-drawingevent="listen:mousedown,select;listen:mouseup,deletedrawing"></div><div class="savedrawing" data-drawingevent="listen:mousedown, post" data-uploadprogress="bind:showProgress,status" ></div></div><canvas class="drawingcanvas" width=652 height=438 data-pencil="bind:setColor, bg" data-drawingevent="listen:mousedown,start;listen:mousemove,move;listen:mouseup,end;" data-drawing="bind:draw, content"></canvas></div>',l.setSessionId=function(e){c=e},l.clear=function(e,t){var i=l.dom.querySelector(".drawingcanvas"),s=i.getContext("2d");s.clearRect(0,0,i.width,i.height),t.classList.remove("selected")},l.resetColors=function(){g.reset({color:"#4D4D4D",size:"1",cap:"round",bg:"white",mode:"pencil"}),m.reset([{color:"#4D4D4D",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"white",active:!1}]),v.reset([{color:"white",active:!0},{color:"#657B99",active:!1},{color:"#9AC9CD",active:!1},{color:"#F2E520",active:!1},{color:"#F27B3D",active:!1},{color:"#BD262C",active:!1},{color:"#5F8F28",active:!1},{color:"#4D4D4D",active:!1}])},l.erase=function(){g.set("mode","erase"),g.set("color",g.get("bg"))},l.drawactive=function(){g.set("mode","pencil"),m.loop(function(e){e.active&&g.set("color",e.color)})},l.expand=function(e,t){var i=t.getAttribute("name"),s=document.getElementById(i);s.classList.contains("invisible")?s.classList.remove("invisible"):s.classList.add("invisible")},l.stop=function(e){e.stopPropagation()},l.hide=function(e,t){e.stopPropagation(),t.classList.add("invisible")},l.select=function(e,t){t.classList.add("selected")},l.getColor=function(e,t){var i=t.getAttribute("data-color_id");e.stopPropagation(),m.loop(function(e,t){t===parseInt(i)?m.update(t,"active",!0):m.update(t,"active",!1)}),g.set("color",m.get(i).color),g.set("mode","pencil"),t.parentNode.classList.add("invisible")},l.getBgColor=function(e,t){var i=t.getAttribute("data-bgcolor_id");e.stopPropagation(),v.loop(function(e,t){t===parseInt(i)?v.update(t,"active",!0):v.update(t,"active",!1)}),g.set("bg",v.get(i).color),t.parentNode.classList.add("invisible")},l.cancel=function(e,t){l.clear(e,t),l.resetColors(),f.reset({type:"drawing",content:"",background:""}),t.classList.remove("selected"),r("drawing")},l.deletedrawing=function(e,i){(u||0===u)&&t.del(u),l.cancel(e,i)},l.post=function(e,i){i.classList.add("selected"),w(f.get("content")).then(function(){u||0===u?t.alter("splice",u,1,JSON.parse(f.toJSON())):t.alter("push",JSON.parse(f.toJSON())),i.classList.remove("selected"),l.cancel(e,i),b.reset({status:""})})},l.reset=function(e){var i=l.dom.querySelector(".drawingcanvas");u=e,l.resetColors(),_lines=[],(document.getElementById("muscenario")||document.getElementById("muidea"))&&i.setAttribute("height",380),u||0===u?(f.reset(t.get(e)),g.set("bg",f.get("background")),v.loop(function(e,t){e.color===f.get("background")?v.update(t,"active",!0):v.update(t,"active",!1)})):f.reset({type:"drawing",content:"",background:""})},l.start=function(e,t){var i=t.offsetLeft+S;p={x:e.pageX-i-L,y:e.pageY-t.offsetTop-k},y=!0,e.preventDefault()},l.end=function(){y=!1},l.move=function(e,t){var i,s,n,a=t.offsetLeft+S;y&&(i=e.pageX-a-L-p.x,s=e.pageY-t.offsetTop-k-p.y,n=l.draw(t,i,s),p={x:n.x,y:n.y}),e.preventDefault()},l.draw=function(e,t,i){var s=e.getContext("2d");return s.lineWidth=g.get("size"),s.strokeStyle=g.get("color"),s.lineCap=g.get("cap"),s.beginPath(),s.moveTo(p.x,p.y),s.lineTo(p.x+t,p.y+i),s.stroke(),s.closePath(),{x:p.x+t,y:p.y+i}},l}});