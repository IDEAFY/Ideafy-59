/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","service/utils","Store","Promise","lib/spin.min"],function(e,t,i,s,n,a,o,r,d){return function(t,c){var l,u=new e,p=i.get("labels"),g=(new FileReader,new o({status:null})),m=null,v=new o({type:"import",content:"",author:i.get("user").get("_id")}),h=400,b=300,f=function(e){var t,i,s=document.getElementById("preview"),n=s.getContext("2d");t=e.width,i=e.height,t>i?t>h&&(i*=h/t,t=h):i>b&&(t*=b/i,i=b),s.width=t,s.height=i,n.drawImage(e,0,0,t,i)},w=function(e){var t=new r,s="/upload",n=new FormData,o="postit",d="sessions/"+l,c=document.getElementById("preview"),u=c.toDataURL("image/png"),p=new Date,m=e||i.get("user").get("_id")+"_"+p.getTime();return n.append("type",o),n.append("dir",d),n.append("filename",m),n.append("dataString",u),a.uploadFile(s,n,g,function(){v.set("content",m),t.fulfill()}),t},y=function(){var e=document.getElementById("preview"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)};return u.template='<div class="import"><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/*" data-importevent="listen: mousedown, selectpress; listen:mouseup, check; listen: change, preview"><div data-labels="bind:innerHTML, importlbl" data-importevent="listen: mousedown, press; listen: mouseup, release"></div></span><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:mousedown,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-importevent="listen:mousedown, press;listen:mouseup, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>',u.plugins.addAll({labels:new s(p),importmodel:new s(v,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(e){var t,s,n=this,a=i.get("transport");e?(s=(new d).spin(n),t={dir:"sessions/"+l,filename:e},a.request("GetFile",t,function(e){var t=new Image,i=n.getContext("2d");t.src=e,n.width=t.width,n.height=t.height,i.drawImage(t,0,0),s.stop(),u.dom.querySelector("#postpic").scrollIntoView(!1)})):this.innerHTML=""}}),importprogress:new s(g,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),importevent:new n(u)}),u.cancel=function(e,t){t.parentNode.classList.add("invisible"),c("import")},u.check=function(e,t){t.classList.remove("pressed"),t.files.length&&u.preview("change",t)},u.preview=function(e,t){var i=new Image,s=new FileReader;s.onloadend=function(e){i.src=e.target.result,setTimeout(function(){f(i),document.getElementById("postpic").classList.remove("invisible")},300)},s.readAsDataURL(t.files[0])},u.selectpress=function(e,t){t.value=""},u.press=function(e,t){t.classList.add("pressed")},u.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},u.post=function(e,i){w(v.get("content")).then(function(){m||0===m?t.alter("splice",m,1,JSON.parse(v.toJSON())):t.alter("push",JSON.parse(v.toJSON())),i.classList.remove("pressed"),u.reset(),g.reset({status:""}),y(),u.dom.querySelector(".importbutton").classList.remove("invisible"),c("import")})},u.reset=function(e){m=e,v.reset({type:"import",content:"",author:i.get("user").get("_id")}),(m||0===m)&&(v.reset(t.get(e)),u.dom.querySelector("#postpic").scrollIntoView())},u.setSessionId=function(e){l=e},u.del=function(e,i){(m||0===m)&&t.del(m),i.classList.remove("pressed"),i.parentNode.classList.add("invisible"),u.reset(),y(),u.dom.querySelector(".importbuttons").classList.remove("invisible"),c("import")},u}});