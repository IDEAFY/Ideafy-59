/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","service/utils","Store","Promise"],function(e,t,i,s,n,a,o,r){return function(t,d){var c,l=new e,u=i.get("labels"),p=(new FileReader,new o({status:null})),g=null,m=new o({type:"import",content:""}),v=400,h=300,b=function(e){var t,i,s=document.getElementById("preview"),n=s.getContext("2d");t=e.width,i=e.height,t>i?t>v&&(i*=v/t,t=v):i>h&&(t*=h/i,i=h),s.width=t,s.height=i,n.drawImage(e,0,0,t,i)},f=function(e){var t=new r,s="/upload",n=new FormData,o="postit",d="sessions/"+c,l=document.getElementById("preview"),u=l.toDataURL("image/png"),g=new Date,v=e||i.get("user").get("_id")+"_"+g.getTime();return n.append("type",o),n.append("dir",d),n.append("filename",v),n.append("dataString",u),a.uploadFile(s,n,p,function(){m.set("content",v),t.fulfill()}),t},w=function(){var e=document.getElementById("preview"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)};return l.template='<div class="import"><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/*" data-importevent="listen: mousedown, selectpress; listen:mouseup, check; listen: change, preview"><div data-labels="bind:innerHTML, importlbl" data-importevent="listen: mousedown, press; listen: mouseup, release"></div></span><div id="postpic" class="wbpostit invisible" data-importmodel="bind:setVisibility, content"><div class="postit-cancel postit-close" data-importevent="listen:mousedown,cancel"></div><div class="picframe"><canvas id="preview" data-importmodel="bind:showPreview, content"></canvas></div><div name="post" class = "postpostit" data-importevent="listen: mousedown, press; listen:mouseup, post"></div><div class = "delpostit" name="del" data-importevent="listen:mousedown, press;listen:mouseup, del"></div><div class="uploadprogress" data-importprogress="bind:showProgress, status"></div></div>',l.plugins.addAll({labels:new s(u),importmodel:new s(m,{setVisibility:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},showPreview:function(e){var t,s=this,n=i.get("transport");e?(t={dir:"sessions/"+c,filename:e},n.request("GetFile",t,function(e){var t=new Image,i=s.getContext("2d");t.src=e,s.width=t.width,s.height=t.height,i.drawImage(t,0,0),l.dom.querySelector("#postpic").scrollIntoView(!1)})):this.innerHTML=""}}),importprogress:new s(p,{showProgress:function(e){this.innerHTML=e?e+"%":""}}),importevent:new n(l)}),l.cancel=function(e,t){t.parentNode.classList.add("invisible"),d("import")},l.check=function(e,t){t.classList.remove("pressed"),t.files.length&&l.preview("change",t)},l.preview=function(e,t){var i=new Image,s=new FileReader;s.onloadend=function(e){i.src=e.target.result,setTimeout(function(){b(i),document.getElementById("postpic").classList.remove("invisible")},300)},s.readAsDataURL(t.files[0])},l.selectpress=function(e,t){t.value=""},l.press=function(e,t){t.classList.add("pressed")},l.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},l.post=function(e,i){f(m.get("content")).then(function(){g||0===g?t.alter("splice",g,1,JSON.parse(m.toJSON())):t.alter("push",JSON.parse(m.toJSON())),i.classList.remove("pressed"),l.reset(),p.reset({status:""}),w(),l.dom.querySelector(".importbutton").classList.remove("invisible"),d("import")})},l.reset=function(e){g=e,m.reset({type:"import",content:""}),(g||0===g)&&(m.reset(t.get(e)),l.dom.querySelector("#postpic").scrollIntoView())},l.setSessionId=function(e){c=e},l.del=function(e,i){(g||0===g)&&t.del(g),i.classList.remove("pressed"),i.parentNode.classList.add("invisible"),l.reset(),w(),document.getElementById("importbuttons").classList.remove("invisible"),d("import")},l}});