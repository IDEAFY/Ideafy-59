/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","lib/spin.min","Store"],function(e,t,i,s,n,a){return function(o,r,d){var c,l=new e,u=!0,p=!1,g=s.get("transport"),m=new a([]),v=8,h=new a({currentPage:1,nbPages:1});return l.plugins.addAll({pagination:new t(h,{setPage:function(e){var t=e;this.innerHTML=h.get("nbPages")>1?labels.get("page")+t+" / "+h.get("nbPages"):""},setNbPages:function(e){var t=h.get("currentPage");this.innerHTML=e>1?labels.get("page")+t+" / "+h.get("nbPages"):""},setLeft:function(e){e>1?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<h.get("nbPages")?this.classList.remove("invisible"):this.classList.add("invisible")}}),wbmain:new t(m,{displayPost:function(e){var t,i,s,a=this,o=a.getAttribute("data-wbmain_id"),r=m.get(o).content,d=m.get(o).style,l=m.get(o).background;switch(e){case"postit":a.classList.remove("photo"),a.classList.remove("drawing"),a.innerHTML='<div class="inner-postit">'+r.replace(/\n/g,"<br>")+"</div>",a.setAttribute("style","background:url('img/brainstorm/"+d.img+"') no-repeat center center; background-size: contain; color:"+d.marker+";");break;case"import":a.classList.add("photo"),a.classList.remove("drawing"),this.innerHTML="",i=new n({color:"#657B99",lines:10,length:8,width:4,radius:8,left:50,top:50}).spin(a),t="sessions/"+c,s={dir:t,filename:r},g.request("GetFile",s,function(e){a.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;"),i.stop()});break;case"drawing":a.classList.remove("photo"),a.classList.add("drawing"),this.innerHTML="",i=new n({color:"#657B99",lines:10,length:8,width:4,radius:8,left:50,top:30}).spin(a),t="sessions/"+c,s={dir:t,filename:r},g.request("GetFile",s,function(e){a.setAttribute("style","background:"+l+"; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;"),i.stop()})}}}),wbevent:new i(l)}),l.template='<div class="wbmain"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-wbevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage; bind:setNbPages, nbPages"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-wbevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul class="wblist" data-wbmain="foreach"><li class="wb-item postit" data-wbmain="bind: displayPost, type" data-wbevent="listen: mouseup, edit; listen:dblclick, cancelEdit"></li><ul><div>',l.push=function(e,t){t.classList.add("invisible"),e.stopPropagation()},l.previousPage=function(){l.displayPage("previous")},l.nextPage=function(){l.displayPage("next")},l.edit=function(e,t){var i=t.getAttribute("data-wbmain_id"),s=o.get(i).type;u?p?"postit"!==o.get(i).type&&(t.classList.contains("enlarge")?t.classList.remove("enlarge"):t.classList.add("enlarge")):(r.set(s,"active"),d(s,i)):u=!0},l.cancelEdit=function(e){e.stopPropagation(),u=!1},l.setSessionId=function(e){c=e},l.setReadonly=function(e){p=e},l.displayPage=function(e){var t,i,s,n=h.get("currentPage");switch(e){case"next":t=n,h.set("currentPage",t+1);break;case"previous":t=n-2,h.set("currentPage",t+1);break;default:t=n-1}for(m.reset([]),i=0;v>i&&(s=t*v+i,o.get(s));i++)m.alter("push",o.get(s))},l.getNbPages=function(){var e=o.getNbItems(),t=e/v,i=e%v;return i>0?parseInt(t)+1:0===t?1:t},l.init=function(){h.set("nbPages",l.getNbPages()),l.displayPage("current"),h.get("nbPages")>1&&l.dom.querySelector(".rightcaret").classList.remove("invisible"),o.watch("added",function(e){var t=l.getNbPages();h.set("nbPages",t),m.getNbItems()===v&&o.get(e).author===s.get("user").get("_id")?l.displayPage("next"):l.displayPage("current")}),o.watch("deleted",function(){h.set("nbPages",l.getNbPages()),1===m.getNbItems()&&h.get("currentPage")===h.get("nbPages")?l.displayPage("previous"):l.displayPage("current")}),o.watch("updated",function(){l.displayPage("current")})},l}});