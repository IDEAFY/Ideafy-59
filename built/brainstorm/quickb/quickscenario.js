/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","CouchDBDocument","service/cardpopup","../whiteboard/whiteboard","Promise","service/utils","lib/spin.min"],function(e,t,i,s,n,a,o,r,d,l,c,u){return function(p,g,m,v,h){var b,f,w,y=new e,L=n.get("labels"),S=new a,k=new a,T=new a,x=new a({"char":{id:"",title:"",pic:""},context:{id:"",title:"",pic:""},problem:{id:"",title:"",pic:""}}),A={cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1},q=new a(A),M=new a({timer:null,display:!1}),I=new a({title:"",story:"",solution:""}),H=new a([]),D=new d("scenario",H,q),_=0,N="step",C=n.get("transport"),P=new u({color:"#657B99",lines:10,length:8,width:4,radius:8,top:665,left:690}).spin();return y.plugins.addAll({labels:new i(L,{setPlaceholder:function(e){this.setAttribute("placeholder",e)}}),cards:new i(x,{formatTitle:function(e){e&&(this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase())},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},n.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),wbtools:new i(q,{setActive:function(e){"active"===e?this.classList.add("pushed"):this.classList.remove("pushed")},setReady:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleToolbox:function(e){e?this.classList.add("invisible"):this.classList.remove("invisible")},setReadonly:function(e){e?this.setAttribute("readonly","readonly"):this.removeAttribute("readonly")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),quickscenariotimer:new i(M,{setTime:function(e){e&&(this.innerHTML=c.formatDuration(e))},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),scenario:new i(I),wbstack:D,quickscenarioevent:new s(y)}),y.template='<div id = "quickscenario"><div class="previousbutton" data-quickscenarioevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickscenario" data-quickscenarioevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quickscenariotimer="bind:setTime, timer; bind: displayTimer, display" data-quickscenarioevent="listen:mousedown,toggleTimer"></div><div id="quickscenario-left" class="leftarea"><div class = "card char" data-wbtools="bind:popup,cardpopup.char" name="char" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,char.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,char.title">Character</div></div><div class="card context" name="context" data-wbtools="bind: popup,cardpopup.context" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,context.pic"></div><div class="cardtitle" data-cards="bind: formatTitle,context.title">Context</div></div><div class="card problem" name="problem" data-wbtools="bind:popup, cardpopup.problem" data-quickscenarioevent="listen:mousedown, zoom"><div class="cardpicture" data-cards="bind:setPic,problem.pic"></div><div class="cardtitle" data-cards="bind:formatTitle,problem.title">Problem</div></div></div><div id="quickscenario-popup"></div><div id="quickscenario-right" class="workarea"><div id="scenario-whiteboard" class="whiteboard"><div class="stack" data-wbstack="destination"></div></div><div id="toolbox" data-wbtools="bind:toggleToolbox, showstory"><div class="toolbox-button"><div class="postit-button" name="postit" data-wbtools="bind:setActive, postit" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, post"></div><legend data-labels="bind:innerHTML, post">Post-it</legend></div><div class="toolbox-button"><div class="importpic-button" name="import" data-wbtools="bind:setActive, import" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, importpic"></div><legend data-labels="bind:innerHTML, import">Import pictures</legend></div><div class="toolbox-button"><div class="drawingtool-button" name="drawing" data-wbtools="bind:setActive, drawing" data-quickscenarioevent="listen: mousedown, push; listen:mouseup, draw"></div><legend data-labels="bind:innerHTML, draw">Drawing tool</legend></div></div><div class="finish-button invisible" data-wbtools="bind:setReady, ready" data-labels="bind:innerHTML, finishbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, finish"></div><div id = "quickscenario-writeup" class="writeup invisible" data-wbtools="bind: setReady,showstory"><textarea class = "enterTitle" maxlength="30" data-labels="bind:setPlaceholder, storytitleplaceholder" data-scenario="bind:value, title" data-wbtools="bind:setReadonly, readonly"></textarea><div class="setPrivate"></div><div class="setPublic"></div><textarea class = "enterDesc" data-labels="bind:setPlaceholder, storydescplaceholder" data-scenario="bind:value, story" data-wbtools="bind:setReadonly, readonly"></textarea><textarea class = "enterSol" data-labels="bind:setPlaceholder, storysolplaceholder" data-scenario="bind:value, solution" data-wbtools="bind:setReadonly, readonly"></textarea></div><div class="next-button invisible" data-wbtools="bind:setReady, shownext" data-labels="bind:innerHTML, nextbutton" data-quickscenarioevent="listen: mousedown, press; listen:mouseup, next"></div></div></div>',y.place(t.get("quickscenario")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){P.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===N?(N="screen",clearInterval(w),M.set("display",!0),g.set("scenario",JSON.parse(I.toJSON())),y.updateSessionScore(M.get("timer")).then(function(){return p.unsync(),p.sync(n.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quickscenario=M.get("timer"),p.set("scenario",[JSON.parse(I.toJSON())]),p.set("elapsedTimers",e),q.set("readonly",!0),v("quickscenario")})):v("quickscenario")},y.stopSpinner=function(){P.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.prev=function(e,t){t.classList.remove("pressed"),m("quickscenario")},y.toggleProgress=function(){h()},y.toggleTimer=function(){M.set("display",!M.get("display"))},y.push=function(e,t){var i=t.getAttribute("name");q.set(i,"active")},y.zoom=function(e,t){var i=t.getAttribute("name");y.setPopup(i)},y.setPopup=function(e){var t,i={x:147,y:130},s="left",a=x.get(e),r=q.get("cardpopup"),d="";f&&(r[f]=!1),r[e]=!0,q.set("cardpopup",r),f=e,"char"===e&&(i.y=120,a.id===S.get("_id")&&(d=S.toJSON())),"context"===e&&(i.y=290,a.id===k.get("_id")&&(d=k.toJSON())),"problem"===e&&(i.y=350,a.id===T.get("_id")&&(d=T.toJSON())),d?b.reset(d,i,s,document.getElementById("quickscenario-popup")):(t=new o,t.setTransport(C),t.sync(n.get("db"),a.id).then(function(){d=t.toJSON(),b.reset(d,i,s,document.getElementById("quickscenario-popup")),"char"===e&&S.reset(JSON.parse(t.toJSON())),"context"===e&&k.reset(JSON.parse(t.toJSON())),"problem"===e&&T.reset(JSON.parse(t.toJSON()))}))},y.closePopup=function(){var e=q.get("cardpopup");e[f]=!1,q.set("cardpopup",e),f=""},b=new r(y.closePopup),y.post=function(){D.selectScreen("postit"),q.set("import","inactive"),q.set("drawing","inactive")},y.importpic=function(){D.selectScreen("import"),q.set("postit","inactive"),q.set("drawing","inactive")},y.draw=function(){D.selectScreen("drawing"),q.set("import","inactive"),q.set("postit","inactive")},y.exitTool=function(e){q.set(e,"inactive")},y.finish=function(e,t){D.setReadonly(!0),q.set("ready",!1),q.set("showstory",!0),t.classList.remove("pressed")},y.updateSessionScore=function(e){var t=new l,i={sid:p.get("_id"),step:"quickscenario",time:e,wbcontent:H.toJSON(),scenario:I.toJSON()};return C.request("UpdateSessionScore",i,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},y.reset=function(){q.reset({cardpopup:{"char":!1,context:!1,problem:!1},postit:"inactive","import":"inactive",drawing:"inactive",ready:!1,showstory:!1,shownext:!1,readonly:!1}),D.setSessionId(p.get("_id")),H.reset(p.get("scenarioWB")),D.init(),H.getNbItems()?D.selectScreen("main"):D.selectScreen("default"),p.get("scenario").length?(N="screen",q.set("ready",!1),q.set("showstory",!0),D.setReadonly(!0),I.reset(p.get("scenario")[0]),g.set("scenario",p.get("scenario")[0]),q.set("readonly",!0),q.set("shownext",!0)):(I.reset({title:"",story:"",solution:""}),H.getNbItems()?q.set("ready",!0):q.set("ready",!1),D.setReadonly(!1),N="step"),p.get("elapsedTimers").quickscenario&&(_=p.get("elapsedTimers").quickscenario,M.set("timer",_)),"screen"===N?M.set("display",!0):y.initTimer(_)},y.initTimer=function(e){var t=new Date,i=t.getTime(),s=e||0;M.set("display",!1),M.set("timer",s),"quickscenario"===p.get("step")&&(clearInterval(w),w=setInterval(function(){var e=new Date;M.set("timer",s+e.getTime()-i)},1e3))},g.watchValue("characters",function(e){x.set("char",e)}),g.watchValue("contexts",function(e){x.set("context",e)}),g.watchValue("problems",function(e){x.set("problem",e)}),p.watchValue("_id",function(e){D.setSessionId(e)}),["added","deleted","updated"].forEach(function(e){H.watch(e,function(){JSON.stringify(p.get("scenarioWB"))!==H.toJSON()&&(p.set("scenarioWB",JSON.parse(H.toJSON())),p.upload()),H.getNbItems()&&"step"===N?q.set("ready",!0):q.set("ready",!1)})}),I.watch("updated",function(){I.get("title")&&I.get("story")&&I.get("solution")?q.set("shownext",!0):q.set("shownext",!1)}),y}});