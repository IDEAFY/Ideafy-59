/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","Store","CouchDBDocument","Promise","service/cardpopup","service/utils","lib/spin.min"],function(e,t,s,i,n,a,o,r,d,c,l,u){return function(p,g,m,v,h){var b,f,w,y=new e,L=null,k=null,S=new o({timer:null,display:!1}),T=n.get("transport"),x=(n.get("user"),n.get("labels")),q={left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}},A=new o(q),M=[],I=!0,D=new o,_=new o,H=new o,N={tech1:D,tech2:_,tech3:H},P=0,C=new o([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),O="step",B=new u({color:"#657B99",lines:10,length:8,width:4,radius:8,top:373,left:373}).spin();return y.plugins.addAll({labels:new s(x),display:new s(A,{setReload:function(e){!e&&P>0?this.classList.add("reload"):this.classList.remove("reload")},updateNext:function(){A.get("tech1").selected&&A.get("tech2").selected&&A.get("tech3").selected?this.classList.remove("invisible"):this.classList.add("invisible")},setSelected:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},popup:function(e){e?this.classList.add("highlighted"):this.classList.remove("highlighted")}}),techcards:new s(C,{removeDefault:function(e){e?this.classList.remove("defaultcard"):this.classList.add("defaultcard")},formatTitle:function(e){this.innerHTML=e?e.toUpperCase():x.get(this.parentNode.getAttribute("name")+"lbl")},setPic:function(e){var t=this;e?e.search("img/decks")>-1?this.setAttribute("style","background-image:url('"+e+"');"):(json={dir:"cards",filename:e},n.get("transport").request("GetFile",json,function(e){t.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")})):this.setAttribute("style","background-image: none;")}}),quicktechtimer:new s(S,{setTime:function(e){this.innerHTML=l.formatDuration(e)},displayTimer:function(e){e?this.classList.add("showtimer"):this.classList.remove("showtimer")}}),quicktechevent:new i(y)}),y.template='<div id = "quicktech"><div class="previousbutton" data-quicktechevent="listen: mousedown, press; listen: mousedown, prev"></div><div id="quicktech-popup" class="invisible"></div><div class="brainstorm-header header blue-dark" data-labels="bind: innerHTML, quicktech" data-quicktechevent="listen:mousedown, toggleProgress"></div><div class="timer" data-quicktechtimer="bind:setTime, timer; bind: displayTimer, display" data-quicktechevent="listen:mousedown,toggleTimer"></div><div class="help-brainstorm" data-quicktechevent="listen:mousedown, help"></div><div id="quicktech-left" class="leftarea"><div class="card defaultscenario" name="scenario" data-quicktechevent="listen: mousedown, select; listen:mousedown, zoom" data-display="bind: popup, scenario.popup"><div class="cardpicture"></div><div class="cardtitle" data-labels="bind:innerHTML, scenariolbl"></div></div></div><div class="drawarea"><div class="decks"><div class="drawbutton drawtech" "name"="tech" data-quicktechevent="listen: mousedown, push; listen:mouseup, draw" data-display="bind: setReload, left"></div></div><div class="cards"><div class="card tech defaultcard" name="tech1" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 0.pic" data-display="bind: popup, tech1.popup"><div class="cardpicture" data-techcards="bind:setPic, 0.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 0.title" data-labels="bind:innerHTML, tech1lbl"></div></div><div class="card tech defaultcard" name="tech2" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 1.pic" data-display="bind: popup, tech2.popup"><div class="cardpicture" data-techcards="bind:setPic, 1.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 1.title" data-labels="bind:innerHTML,tech2lbl"></div></div><div class="card tech defaultcard" name="tech3" data-quicktechevent="listen: mousedown, select; listen:mouseup, zoom" data-techcards="bind:removeDefault, 2.pic" data-display="bind: popup, tech3.popup"><div class="cardpicture" data-techcards="bind:setPic, 2.pic"></div><div class="cardtitle" data-techcards="bind:formatTitle, 2.title" data-labels="bind:innerHTML, tech3lbl"></div></div></div><div class="confirmdraw"><div class="drawok" name="tech1" data-display="bind:setSelected, tech1.selected" data-quicktechevent="listen: mousedown,  accept"></div><div class="drawok" name="tech2" data-display="bind:setSelected, tech2.selected" data-quicktechevent="listen: mousedown, accept"></div><div class="drawok" name="tech3" data-display="bind:setSelected, tech3.selected" data-quicktechevent="listen: mousedown, accept"></div></div><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quicktechevent="listen: mousedown, press; listen:mouseup, next" data-display="bind:updateNext, tech1.selected;bind:updateNext, tech2.selected;bind:updateNext, tech3.selected"></div></div></div>',y.place(t.get("quicktech")),y.press=function(e,t){t.classList.add("pressed")},y.next=function(e,t){var s=new Date;s.getTime()-L,B.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===O?(O="screen",g.set("techno",C),clearInterval(b),S.set("display",!0),y.updateSessionScore(S.get("timer")).then(function(){return p.unsync(),p.sync(n.get("db"),p.get("_id"))}).then(function(){var e=p.get("elapsedTimers");e.quicktech=S.get("timer"),p.set("elapsedTimers",e),p.set("techno",[[C.get(0).id,C.get(1).id,C.get(2).id]]),v("quicktech")})):v("quicktech")},y.stopSpinner=function(){B.stop(),y.dom.querySelector(".next-button").classList.remove("invisible")},y.help=function(){a.setContent("quicktechhelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},y.prev=function(e,t){t.classList.remove("pressed"),m("quicktech")},y.toggleProgress=function(){h()},y.toggleTimer=function(){S.set("display",!S.get("display"))},y.select=function(e,t){var s=t.getAttribute("name");(s.search("tech")<0||P>0||"screen"===O)&&t.classList.add("highlighted")},y.zoom=function(e,t){var s=t.getAttribute("name");(s.search("tech")<0||P>0||"screen"===O)&&y.setPopup(s)},y.setPopup=function(e){var t,s={x:0,y:337},i="left",n=A.get(w)||"",a=new o,r=A.get(e);n&&(n.popup=!1,A.set(w,n)),r.popup=!0,A.set(e,r),w=e,"scenario"===e?(s.x=147,s.y=275,a.reset(p.get("scenario")[0]),a.set("type",5),t=a.toJSON()):("tech1"===e&&(s.x=467),"tech2"===e&&(s.x=186,i="right"),"tech3"===e&&(s.x=333,i="right"),N[e].get("_id")&&(t=N[e].toJSON())),t&&f.reset(t,s,i,document.getElementById("quicktech-popup"))},y.closePopup=function(){var e=A.get(w);e.popup=!1,A.set(w,e),w=""},y.push=function(e,t){var s=t.getAttribute("name");t.classList.contains("drawok")?N[s].get("_id")&&"step"===O&&t.classList.add("pushed"):t.classList.add("pushed")},y.draw=function(e,t){var s=[];"step"===O&&I&&(I=!1,["tech1","tech2","tech3"].forEach(function(e){A.get(e).selected||s.push(e)}),y.drawTech(s).then(function(){t.classList.remove("pushed"),I=!0}))},y.drawTech=function(e){var t,s=[],i=new d;return e.forEach(function(e){M.length<=0&&(M=g.get("deck").techno.concat(),["tech1","tech2","tech3"].forEach(function(e,t){A.get(e).selected&&s.push(C.get(t).id)}),M.filter(function(e){return!(s.indexOf(e)>-1)})),t=Math.floor(Math.random()*M.length),y.getCardDetails(M[t],e),A.set("left",M.length),P++,M.splice(t,1)}),i.fulfill(),i},y.getCardDetails=function(e,t){var s=new r,i=["tech1","tech2","tech3"].indexOf(t),a=new d;return s.setTransport(T),s.sync(n.get("db"),e).then(function(){N[t].reset(JSON.parse(s.toJSON())),C.update(i,"id",e),C.update(i,"title",s.get("title")),C.update(i,"pic",s.get("picture_file")),a.fulfill(),s.unsync()}),a},y.accept=function(e,t){var s=t.getAttribute("name"),i=["tech1","tech2","tech3"].indexOf(s),n=A.get(s);"step"===O&&(C.get(i).id?(n.selected=!n.selected,A.set(s,n)):alert("please draw a card first"))},y.reset=function(e){var t=p.get("techno")[0];A.reset({left:"",scenario:{popup:!1},tech1:{popup:!1,selected:!1},tech2:{popup:!1,selected:!1},tech3:{popup:!1,selected:!1}}),C.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}]),O="step",e&&t&&t.length?(O="screen",y.getCardDetails(t[0],"tech1").then(function(){return y.getCardDetails(t[1],"tech2")}).then(function(){return y.getCardDetails(t[2],"tech3")}).then(function(){["tech1","tech2","tech3"].forEach(function(e){A.set(e,{popup:!1,selected:!0})}),g.set("techno",C)})):(M=[],P=0,D.reset(),_.reset(),H.reset(),C.reset([{id:"",title:"",pic:""},{id:"",title:"",pic:""},{id:"",title:"",pic:""}])),k=p.get("elapsedTimers").quicktech?p.get("elapsedTimers").quicktech:0,S.set("timer",k),"screen"===O?S.set("display",!0):y.initTimer(k)},y.updateSessionScore=function(e){var t=new d,s={sid:p.get("_id"),step:"quicktech",time:e,cards:P};return T.request("UpdateSessionScore",s,function(e){"ok"===e.res?t.fulfill():t.reject()}),t},y.initTimer=function(e){var t=new Date,s=t.getTime(),i=e||0;S.set("display",!1),S.set("timer",i),"quicktech"===p.get("step")&&(b=setInterval(function(){var e=new Date;S.set("timer",i+e.getTime()-s)},1e3))},f=new c(y.closePopup),g.watchValue("deck",function(e){M=e.techno.concat(),A.set("left",M.length)}),y}});