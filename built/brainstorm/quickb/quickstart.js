/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","service/help","lib/spin.min","Promise","Store"],function(e,t,s,i,n,a,o,r,d){return function(l,c,u,p){var g=new e,m=n.get("user"),v=n.get("db"),h=new d(n.get("userLanguages")),b=function(){var e=m.get("lang").substring(0,2);l.set("lang",e),h.loop(function(t,s){t.name===e?h.update(s,"selected",!0):h.update(s,"selected",!1)})},f=n.get("labels"),w="step",y=new o({color:"#657B99",lines:10,length:8,width:4,radius:8,top:360,left:545}).spin();return b(),g.plugins.addAll({labels:new s(f),select:new s(h,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),model:new s(l,{setTitle:function(e){new Date,e&&e.username&&this.setAttribute("placeholder",f.get("quickstarttitleplaceholderpre")+e.username+f.get("quickstarttitleplaceholderpost"))},displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),quickstartevent:new i(g)}),g.template='<div id = "quickstart"><div class="previousbutton" data-quickstartevent="listen: mousedown, press; listen: mousedown, prev"></div><div class="brainstorm-header header blue-light" data-labels="bind: innerHTML, quickstart" data-quickstartevent="listen:mousedown, toggleProgress"></div><div class="help-brainstorm" data-quickstartevent="listen:mousedown, help"></div><form class="quickstart-form"><div class="idealang"><div class="currentlang" data-model="bind: displayLang, lang" data-quickstartevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-quickstartevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><label data-labels="bind:innerHTML, quickstarttitle"></label><hr/><textarea class="quickstart-title" autofocus="" name="title" data-model="bind:value, title; bind: setTitle, initiator"></textarea><label data-labels="bind:innerHTML, quickstartdesc"></label><hr/><textarea class="quickstart-desc" name="description" data-model="bind:value, description" data-labels="bind: placeholder, quickstartdescplaceholder"></textarea><div class="next-button" data-labels="bind:innerHTML, nextbutton" data-quickstartevent="listen: mousedown, press; listen:mouseup, next"></div></form><div>',g.place(t.get("quickstart")),g.press=function(e,t){t.classList.add("pressed")},g.next=function(e,t){y.spin(t.parentNode),t.classList.add("invisible"),t.classList.remove("pressed"),"step"===w?(w="screen",""===l.get("title")&&l.set("title",f.get("quickstarttitleplaceholderpre")+l.get("initiator").username+f.get("quickstarttitleplaceholderpost")),l.set("lang",m.get("lang")),l.set("_id","S:QUICK:"+l.get("startTime")),l.sync(v,l.get("_id")).then(function(){return m.set("sessionInProgress",{id:l.get("_id"),type:"quick"}),m.upload()}).then(function(){u("quickstart")})):u("quickstart")},g.stopSpinner=function(){y.stop(),g.dom.querySelector(".next-button").classList.remove("invisible")},g.prev=function(e,t){t.classList.remove("pressed"),c("quickstart")},g.toggleProgress=function(){p()},g.showLang=function(){g.dom.querySelector(".idealang ul").classList.remove("invisible")},g.selectFlag=function(e,t){var s;e.stopPropagation(),s=parseInt(t.getAttribute("data-select_id"),10),h.loop(function(e,t){s===t?h.update(t,"selected",!0):h.update(t,"selected",!1)})},g.setLang=function(e,t){var s;e.stopPropagation(),s=t.getAttribute("data-select_id"),l.set("lang",h.get(s).name),g.dom.querySelector(".idealang ul").classList.add("invisible")},g.reset=function(e){var t=new Date,s=l.get("step");new r,e?(w="quickstart"===s?"step":"screen","quickwrapup"!==s&&l.set("resumeTime",t.getTime())):(l.set("startTime",t.getTime()),l.set("date",[t.getFullYear(),t.getMonth(),t.getDate()]),l.set("lang",m.get("lang")),w="step")},g.help=function(){a.setContent("quickstarthelp"),document.getElementById("cache").classList.add("appear"),document.getElementById("help-popup").classList.add("appear")},g}});