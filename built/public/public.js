/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Amy/Control-plugin","Bind.plugin","Place.plugin","Amy/Delegate-plugin","service/map","service/config","./public-stack","service/utils","./lists/list-public","./lists/list-polling","Amy/Stack-plugin","service/submenu","Store","lib/spin.min","service/newidea"],function(e,t,i,n,s,a,o,r,l,c,d,u,p,g,h,m){return function(){var l,v,f,b,w,y,L=new e,k=o.get("db"),S=o.get("observer"),T=new t(L),M=new r,A=o.get("user"),C=o.get("labels"),x=A.get("lang").substring(0,2),H=new g([{name:"#list-fav",css:"byfav",pushed:!1,lang:null},{name:"#list-date",css:"bydate",pushed:!0,lang:null},{name:"#list-rating",css:"byrating",pushed:!1,lang:null},{name:"#lang",css:"bylang",pushed:!1,lang:x}]),q=new g([{name:"*"}]),I=o.get("userLanguages"),_=new u,D=new h({color:"#808080",lines:10,length:12,width:6,radius:10,top:328}).spin();return I.forEach(function(e){q.alter("push",e)}),L.template='<div id="public"><div class="cache"></div><div id = "public-menu"></div><div id="public-list" class="list"><div class="header blue-light"><div class="option left" data-publiccontrol="toggle:.option.left,mosaic,mousedown,mosaic"></div><span data-label="bind: innerHTML, publicideasheadertitle"></span><div class="option right" data-publicevent="listen: mousedown, plus"></div></div><div data-liststack="destination" data-publiccontrol="radio:li.list-item,selected,mousedown,selectStart"><div class="tools"><input class="search" type="text" data-label="bind: placeholder, searchpublicplaceholder" data-publicevent="listen: keypress, search"><ul class="listbtns" data-listbtns="foreach"><li class="tools-button" data-listbtns="bind:setName, name; bind:setClass, css; bind:setPushed, pushed; bind:setLang, lang" data-publicevent="listen:mouseup,show"></li></ul><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-publicevent="listen: mousedown, setLang; listen:mouseup, stopPropagation"></li></ul></div></div></div><div id="public-detail" class="details" data-publicplace="place:details"></div></div>',L.plugins.addAll({liststack:_,listbtns:new i(H,{setPushed:function(e){e?this.classList.add("pushed"):this.classList.remove("pushed")},setLang:function(e){e&&"*"!==e&&(this.setAttribute("style","background-image:url('img/flags/"+e+".png');"),this.innerHTML=""),"*"===e&&(this.setAttribute("style","background-image: none;"),this.innerHTML="*")},setClass:function(e){e&&this.classList.add(e)},setName:function(e){e&&this.setAttribute("name",e)}}),select:new i(q,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;"),this.innerHTML="*"):this.setAttribute("style","background-image:url('img/flags/"+e+".png');")}}),label:new i(C),publicevent:new s(L),publicplace:new n({details:M}),publiccontrol:T}),L.place(a.get("public")),L.selectStart=function(e){var t=_.getStack().getCurrentScreen().getModel(),i=e.target.getAttribute("data-listideas_id");M.reset(t,i)},L.displayHighlightedIdea=function(){var e,t,i;e=_.getStack().getCurrentScreen(),t=e.dom.querySelector(".list-item.selected")||e.dom.querySelector("li[data-listideas_id='0']"),i=0,t&&(i=t.getAttribute("data-listideas_id")),t.classList.add("selected"),t.scrollIntoView(),T.init(t),M.reset(e.getModel(),i)},L.show=function(e,t){var i=parseInt(t.getAttribute("data-listbtns_id"),10),n=H.get(i).name,s=_.getStack();"#lang"===n?L.dom.querySelector(".langlist").classList.remove("invisible"):(H.loop(function(e,t){t===i?H.update(t,"pushed",!0):H.update(t,"pushed",!1)}),n!==s.getCurrentName()&&(s.show(n),s.get(n).getModel().getNbItems()?L.displayHighlightedIdea():M.displayEmpty(n)))},L.setLang=function(e,t){var i,n;e.stopPropagation(),e.preventDefault(),i=t.getAttribute("data-select_id"),n=q.get(i).name,x=n,D.spin(L.dom.querySelector("#public-list")),H.loop(function(e,t){"#lang"===e.name&&H.update(t,"lang",n)}),L.dom.querySelector(".langlist").classList.add("invisible"),["#list-rating","#list-fav","#list-date"].forEach(function(e){var t=_.getStack();t.get(e).setLang(n).then(function(){D.stop(),t.getCurrentName()===e&&0===t.get(e).getModel().getNbItems()?M.displayEmpty(e):L.displayHighlightedIdea()})})},L.stopPropagation=function(e){e.stopPropagation(),e.preventDefault()},L.mosaic=function(){var e=document.getElementById("public-detail");L.dom.classList.toggle("mosaic"),e.classList.contains("invisible")&&(e.classList.remove("invisible"),M.reset(v.getModel(),0)),L.dom.classList.contains("mosaic")?["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(e){_.getStack().get(e).setMosaic(!0)}):["#list-date","#list-rating","#list-fav","#list-search"].forEach(function(e){_.getStack().get(e).setMosaic(!1)})},L.plus=function(){m.reset(),document.getElementById("cache").classList.add("appear")},L.search=function(e,t){13===e.keyCode&&(""===t.value?v.resetQuery().then(function(){L.dom.querySelector(".listbtns").classList.remove("invisible"),_.getStack().show("#list-date"),H.loop(function(e,t){"#list-date"===e.name?H.update(t,"pushed",!0):H.update(t,"pushed",!1)}),L.displayHighlightedIdea()}):L.searchIdea(t.value),t.blur())},L.searchIdea=function(e){L.dom.querySelector(".listbtns").classList.add("invisible"),w.resetQuery({q:e,sort:"\\creation_date<date>",include_docs:!0}).then(function(){_.getStack().show("#list-search"),w.getModel().getNbItems()>0?L.displayHighlightedIdea():M.displayEmpty("search")})},L.reset=function(){f.init(M.reset),v.init(M.reset).then(function(){_.getStack().show("#list-date"),M.reset(v.getModel(),0)})},L.showMenu=function(){l.toggleActive(!0)},L.hideMenu=function(){l.toggleActive(!1)},l=new p(L.dom.querySelector("#public-menu")),l.toggleActive(!1),x=A.get("settings").contentLang?A.get("settings").contentLang:A.get("lang").substring(0,2),"all"===x&&(x="*"),H.loop(function(e,t){"#lang"===e.name&&H.update(t,"lang",x)}),y="*"===x?{startkey:"[0,{}]",endkey:"[0]",descending:!0,limit:50}:{startkey:'[1,"'+x+'", {}]',endkey:'[1,"'+x+'"]',descending:!0,limit:50},v=new d(k,"library","_view/publicideasbylang",y),f=new c(k,"ideas","_view/ideasbyvotes",y),b=new c(k,"library","_view/publicideas","fav"),w=new c("_fti/local/"+k,"indexedideas","publicbyname",{q:"init_listSearch_UI",sort:"\\creation_date<date>",limit:60,include_docs:!0}),_.getStack().add("#list-rating",f),_.getStack().add("#list-search",w),_.getStack().add("#list-fav",b),_.getStack().add("#list-date",v),v.init().then(function(){return _.getStack().show("#list-date"),v.getModel().getNbItems()?L.displayHighlightedIdea():M.displayEmpty("#list-date"),b.setLang(x)}).then(function(){A.watchValue("public-favorites",function(e){e.length!==b.getModel().getNbItems()&&b.resetQuery(x).then(function(){"#list-fav"===_.getStack().getCurrentName()&&(b.getModel().getNbItems()?L.displayHighlightedIdea():M.displayEmpty("#list-fav"))})}),A.watchValue("settings",function(e){var t=e.contentLang;"all"===t&&(t="*"),t&&t!==x&&(x=t,H.loop(function(e,t){"#lang"===e.name&&H.update(t,"lang",x)}),["#list-date","#list-rating","#list-fav"].forEach(function(e){_.getStack().get(e).setLang(x)}))})}),f.init(),["#list-date","#list-rating","#list-fav"].forEach(function(e){var t=_.getStack().get(e);t.getModel()}),S.watch("NewIdea",function(e,t){var i,n,s,a=v.getModel();t&&("#list-date"!==_.getStack().getCurrentName()&&_.getStack().show("#list-date"),H.loop(function(e,t){"#list-date"===e.name?H.update(t,"pushed",!0):H.update(t,"pushed",!1)}),D.spin(document.getElementById("public-list")),v.resetQuery().then(function(){a.loop(function(t,i){t.id===e&&(n=i)}),i=v.dom.querySelector(".list-item.selected"),i&&i.classList.remove("selected"),s=v.dom.querySelector("li[data-listideas_id='"+n+"']"),s.classList.add("selected"),T.init(n),s.scrollIntoView(),M.reset(a,n),D.stop()}))}),L}});