/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","service/map","Store","Bind.plugin","Place.plugin","Event.plugin","service/avatar"],function(e,t,n,s,a,o,r,c){return function(){var n=new e,d=new e,u=t.get("user"),p=t.get("observer"),g=t.get("labels"),h=0,m=new s({unread:0,newmsg:!1}),v=new s([]);return n.plugins.addAll({notif:new a(m,{flashNew:function(e){var t,n=this;e&&(t=setInterval(function(){n.classList.contains("orange")?n.classList.remove("orange"):n.classList.add("orange")},600),setTimeout(function(){clearInterval(t),n.classList.remove("orange"),m.set("newmsg",!1)},3e3))}}),place:new o({notifyPopup:d}),notifevent:new r(n)}),n.template='<div id="notify"><div class = "notif-bubble" data-notif="bind:innerHTML, unread"></div><div class="deedee" data-notif="bind:flashNew, newmsg" data-notifevent="listen: mousedown, push; listen:mouseup, showPopup"></div><div class = "signout-bubble" data-notifevent="listen:mousedown, signout"></div><div class = "info-bubble" data-notifevent="listen:mousedown, press; listen:mouseup, showAbout"></div><div id="notify-popup" data-place="place:notifyPopup"></div></div>',n.getUnread=function(){var e=u.get("notifications"),t=0;for(i=0,l=e.length;l>i;i++)"unread"===e[i].status&&t++;return t},n.push=function(e,t){t.classList.add("orange"),e.stopPropagation()},n.press=function(e,t){t.classList.add("pressed")},n.showPopup=function(e,t){t.classList.remove("orange"),d.showPopup()},n.signout=function(){document.getElementById("cache").classList.add("appear"),document.getElementById("dock").querySelector(".selected").classList.remove("selected"),document.querySelector('a[href="#public"]').classList.add("selected"),t.get("observer").notify("signout")},n.showAbout=function(e,n){n.classList.remove("pressed"),t.get("observer").notify("goto-screen","#dashboard"),t.get("observer").notify("show-about")},d.plugins.addAll({labels:new a(g),notify:new a(v,{setObject:function(e){var t=this.getAttribute("data-notify_id");if(e)switch(e){case"CXR":this.innerHTML=v.get(t).username+g.get("CXRobject");break;case"INV":this.innerHTML=v.get(t).username+g.get("INVObject");break;case"CXRaccept":this.innerHTML=v.get(t).username+g.get("acceptedCXR");break;case"CXRreject":this.innerHTML=v.get(t).username+g.get("rejectedCXR");break;case"CXCancel":this.innerHTML=v.get(t).username+g.get("canceledCX");break;case"DOC":this.innerHTML=v.get(t).username+g.get("sentdocmsg");break;case"2Q+":this.innerHTML=v.get(t).username+g.get("askednew");break;case"2C+":this.innerHTML=v.get(t).username+g.get("senttc");break;case"REF":this.innerHTML=v.get(t).username+g.get("joinedideafy");break;case"MUD-":this.innerHTML=g.get("muinaday");break;case"MUQ-":this.innerHTML=g.get("mufifteen");break;case"MUP+":this.innerHTML=g.get("newpart");break;case"MUP-":this.innerHTML=g.get("partleft");break;case"SCANCEL":this.innerHTML=g.get("scancel");break;case"SSTART":this.innerHTML=g.get("sstart");break;default:this.innerHTML=v.get(t).object}},setStyle:function(e){"unread"===e?this.setAttribute("style","font-weight: bold;"):this.setAttribute("style","font-weight: normal;")},setFirstname:function(e){this.innerHTML=e?e:g.get("ideafy")},setAvatar:function(e){var t,n,i=this;e&&(t=document.createDocumentFragment(),n=new c([e]),n.place(t),i.firstChild?i.replaceChild(t,i.firstChild):i.appendChild(t))}}),notifyevent:new r(d)}),d.template='<div class="invisible"><div class="notify-header" data-labels="bind:innerHTML, notificationlbl" data-notifyevent="listen:mousedown, closePopup"></div><ul class="notify-list" data-notify="foreach: messages, 0, 7"><li data-notify="bind: setStyle, status" data-notifyevent="listen:mousedown, displayComCenter"><div data-notify="bind:setAvatar, author"></div><p><span class="notify-name" data-notify="bind:setFirstname, firstname"></span> : <span class="notify-body" data-notify="bind:setObject, type"></span></p></li></ul></div>',d.closePopup=function(){d.dom.classList.add("invisible")},d.showPopup=function(){d.dom.classList.remove("invisible"),v.reset(u.get("notifications").concat())},d.displayComCenter=function(e,t){var n=t.getAttribute("data-notify_id");p.notify("display-message",n)},p.watch("display-message",function(){d.closePopup()}),n.init=function(){n.reset(),d.dom.classList.add("invisible")},n.reset=function(){h=n.getUnread(),m.set("unread",h),m.set("newmsg",!1),v.reset(u.get("notifications").concat())},u.watchValue("notifications",function(){var e=n.getUnread(),t=u.get("notifications").concat()||[];e>h?(m.set("newmsg",!0),m.set("unread",e),h=e,u.get("settings")&&u.get("settings").notifyPopup&&popup.classList.add("show-notify")):h>e&&(m.set("unread",e),h=e),v.reset(t)}),n}});