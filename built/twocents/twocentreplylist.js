/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/utils","service/config","twocents/writetwocentreply","service/avatar"],function(e,t,n,i,s,a,o,r){function l(e,l,c){var d=new t(e),u=this,p=a.get("user"),g=a.get("labels"),h=a.get("transport");u.plugins.addAll({reply:new n(d,{date:function m(m){m&&(this.innerHTML=s.formatDate(m))},setFirstname:function(e){var t=this.getAttribute("data-reply_id");this.innerHTML=e,d.get(t).author===p.get("_id")&&(this.innerHTML=g.get("youlbl"))},setReplylbl:function(){var e=this.getAttribute("data-reply_id");this.innerHTML=g.get("twocentreplycommentlbl"),d.get(e).author===p.get("_id")&&(this.innerHTML=g.get("yourepliedlbl"))},setAvatar:function(e){var t=document.createDocumentFragment(),n=new r([e]);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},setVisible:function(e){e&&e===p.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;")},setInVisible:function(e){e&&e===p.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;")}}),replyevent:new i(u),labels:new n(g)}),u.template='<ul class="replies" data-reply="foreach"><li class="twocentReply"><div class="twocentHeader"><div class="replyAvatar" data-reply="bind:setAvatar, author"></div><div class="twocentAuthor" data-reply="bind: setFirstname, firstname"></div><span class="commentLabel" data-labels="bind: setReplylbl, firstname"></span><br/><div class="twocentDate date" data-reply="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-reply="bind: setVisible, author" data-replyevent="listen: mousedown, deleteTwocentReply"></div><div class="twocentButton twocentReplyButton" data-reply="bind: setInVisible, author" data-replyevent="listen:mousedown, reply"></div></div></div><p class="twocentMessage replyMessage" data-reply="bind: innerHTML, message"></p><div class="writePublicTwocentReply replyToReply invisible"></div></li></ul>',u.edit=function(t,n){var i=n.getAttribute("data-reply_id"),s=u.dom.children[i],a=new o,r=function(){u.dom.replaceChild(s,a.dom)},d=document.createDocumentFragment();a.reset(l,c,e[i],i,null,r),a.render(),a.place(d),u.dom.replaceChild(d,s),UI=u.dom},u.deleteTwocentReply=function(e,t){var n=t.getAttribute("data-reply_id"),i={docId:l,type:"deltcreply",twocent:c,position:n};h.request("WriteTwocent",i,function(e){"ok"!==e&&alert(a.get("labels").get("somethingwrong"))})},u.reply=function(t,n){var i=n.getAttribute("data-reply_id"),s=u.dom.parentNode,a=s.querySelector(".writePublicTwocentReply[data-reply_id='"+i+"']"),r=document.createDocumentFragment(),d=new o(a);d.reset(l,c,null,i,e[i].firstname),d.render(),d.place(r),a.hasChildNodes()||a.appendChild(r),a.classList.remove("invisible")}}return function(t,n,i,s){return l.prototype=new e,new l(t,n,i,s)}});