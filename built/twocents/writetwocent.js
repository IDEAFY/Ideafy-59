/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,i,s,a,o){return function(r){var l,c,d=new e,u=t.get("user"),p=t.get("transport"),g=new Date,h=new s({author:u.get("_id"),message:"",firstname:u.get("firstname"),date:[g.getFullYear(),g.getMonth(),g.getDate()],datemod:"",plusones:0,replies:[]}),m=new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:24}),f=r||"public",v="new",b=0;return d.plugins.addAll({twocent:new n(h,{date:function(e){e&&(this.innerHTML=a.formatDate(e))},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),config:new n(t,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),labels:new n(t.get("labels")),twocentevent:new i(d)}),d.template='<div class = "writeTwocent"><div class="userAvatar twocentAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText" data-labels="bind: placeholder, addtwocentplaceholder" data-twocent="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-twocent="bind: date, date"></span></li><li class="moddate invisible" data-twocent="bind: setVisible, datemod"><span class="moddatelbl" data-labels="bind: innerHTML, twocentmodificationdate"></span><span class="date" data-twocent="bind: date, datemod"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-twocentevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-twocentevent="listen: mousedown, press; listen: mouseup, publish">Publish</div></div></div>',d.reset=function(e,t,n,i){var s=new Date;e&&(l=e),t?(h.reset(t),v=t,b=n,h.set("datemod",[s.getFullYear(),s.getMonth(),s.getDate()])):(h.reset({author:u.get("_id"),message:"",firstname:u.get("firstname"),date:"",datemod:"",plusones:0,replies:[]}),h.set("date",[s.getFullYear(),s.getMonth(),s.getDate()]),v="new"),i&&(c=i)},d.cancel=function(e,t){t.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),c?c():document.getElementById(f+"-writetwocents").classList.add("invisible")},d.publish=function(e,n){if(n.setAttribute("style","-webkit-box-shadow: none; background: none;"),h.get("message")){var i,s,a=JSON.parse(h.toJSON());m.spin(n),s="new"===v?"new":"edit",i={docId:l,type:s,position:b,twocent:a},p.request("WriteTwocent",i,function(e){"ok"!==e?alert(t.get("labels").get("somethingwrong")):"new"===v?document.getElementById(f+"-writetwocents").classList.add("invisible"):c(),n.setAttribute("style","background: #8cab68;"),m.stop()},d)}},d.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")},d}});