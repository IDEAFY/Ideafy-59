/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/config","service/utils","lib/spin.min"],function(e,t,i,n,s,a,o){function r(e){var r,l,c,d,u,p=s.get("user"),g=s.get("transport"),h=(new Date,new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:24})),m={author:p.get("_id"),message:"",firstname:p.get("firstname"),date:"",datemod:"",plusones:0},v=new t(m);this.plugins.addAll({model:new i(v,{date:function f(f){this.innerHTML=a.formatDate(f)}}),config:new i(s,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),writereplyevent:new n(this),labels:new i(s.get("labels"))}),this.template='<div class="writeTwocent writeTwocentReply"><div class="replyAvatar" data-config="bind: setAvatar, avatar"></div><textarea class="twocentText replyMessage" data-labels="bind: placeholder, addtwocentreplyplaceholder" data-model="bind: value, message"></textarea><div class="writeFooter"><ul class="twocentContext"><li class="creadate"><span class="creadatelbl" data-labels="bind:innerHTML, twocentcreationdate"></span><span class="date" data-model="bind: date, date"></span></li></ul><div class="twocentCancel" data-labels="bind: innerHTML, cancellbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div><div class="twocentPublish" data-labels="bind: innerHTML, publishlbl" data-writereplyevent="listen: mousedown, press; listen: mouseup, publish;">Publish</div></div></div>',this.reset=function(e,t,i,n,s,a){var o=new Date;e&&t&&(r=e,l=t),d=s?s:"",i?(v.reset(i),editTCR=i,c=n,v.set("datemod",[o.getFullYear(),o.getMonth(),o.getDate()])):(v.reset({author:p.get("_id"),message:"",firstname:p.get("firstname"),date:"",datemod:"",plusones:0}),v.set("date",[o.getFullYear(),o.getMonth(),o.getDate()]),editTCR="newreply"),u=a},this.cancel=function(t,i){i.setAttribute("style","-webkit-box-shadow: none; background: #e69b73;"),u?u():e.classList.add("invisible"),v.reset({author:p.get("_id"),message:"",firstname:p.get("firstname"),date:"",datemod:"",plusones:0})},this.publish=function(t,i){if(i.setAttribute("style","-webkit-box-shadow: none; background: none;"),v.get("message")){var n,a,o=JSON.parse(v.toJSON());h.spin(i),a="newreply"===editTCR?editTCR:"editreply",d&&(o.message="@ "+d+" : "+o.message),n={docId:r,type:a,position:c,twocent:l,reply:o},g.request("WriteTwocent",n,function(t){i.setAttribute("style","background: #8cab68;"),h.stop(),"ok"!==t?alert(s.get("labels").get("somethingwrong")):(e.classList.add("invisible"),v.reset({author:p.get("_id"),message:"",firstname:p.get("firstname"),date:"",datemod:"",plusones:0}))})}},this.press=function(e,t){t.setAttribute("style","-webkit-box-shadow: inset 0 0 5px 1px rgba(0,0,0,0.6); background: #666666;")}}return function(t){return r.prototype=new e,new r(t)}});