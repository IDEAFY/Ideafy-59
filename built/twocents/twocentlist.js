/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","CouchDBDocument","Store","Promise","service/utils","Bind.plugin","Event.plugin","twocents/twocentreplylist","twocents/writetwocent","twocents/writetwocentreply","service/avatar"],function(e,t,i,n,s,a,o,r,l,c,d,u){function p(e){var p,g=this,h=new i,m=t.get("labels"),v=new n([]),f=t.get("transport"),b=t.get("user"),y=e;h.setTransport(f),g.plugins.addAll({labels:new o(t.get("labels")),twocents:new o(v,{date:function w(w){w&&(this.innerHTML=a.formatDate(w))},setFirstName:function(e){var i;e&&(e!==b.get("firstname")?this.innerHTML=e:(i=this.getAttribute("data-twocents_id"),this.innerHTML=v.get(i).author===b.get("_id")?t.get("labels").get("youlbl"):e))},setCommentlbl:function(e){var t;e&&(e!==b.get("firstname")?this.innerHTML=m.get("twocentcommentlbl"):(t=this.getAttribute("data-twocents_id"),this.innerHTML=v.get(t).author===b.get("_id")?m.get("youcommentedlbl"):m.get("twocentcommentlbl")))},setVisible:function(e){e&&(e===b.get("_id")?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},setInVisible:function(e){e&&(e===b.get("_id")?this.setAttribute("style","display: none;"):this.setAttribute("style","display: block;"))},deleteOK:function(e){var t;e&&e.length>0?this.setAttribute("style","display: none;"):(t=this.getAttribute("data-twocents_id"),b.get("_id")===v.get(t).author?this.setAttribute("style","display: block;"):this.setAttribute("style","display: none;"))},toggleHideButton:function(e){e&&e.length?(this.classList.remove("invisible"),this.innerHTML=1===e.length?t.get("labels").get("showonetcreply"):t.get("labels").get("showtcrepliesbefore")+e.length+t.get("labels").get("showtcrepliesafter")):this.classList.add("invisible")},displayReplies:function(e){var t,i,n;e&&e.length?(t=this.getAttribute("data-twocents_id"),i=new l(e,p,t,y),n=document.createDocumentFragment(),i.render(),i.place(n),this.hasChildNodes()?this.replaceChild(n,this.firstChild):this.appendChild(n),this.classList.remove("invisible")):this.classList.add("invisible")},setAvatar:function(e){var t,i;e&&(t=document.createDocumentFragment(),i=new u([e]),i.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t))}}),twocentevent:new r(g)}),g.template='<ul class="twocentList" data-twocents="foreach"><li class="twocent"><div class="twocentHeader"><div class="twocentAvatar" data-twocents="bind: setAvatar, author"></div><div class="twocentAuthor"data-twocents="bind: setFirstName, firstname"></div><span class="commentLabel" data-twocents="bind: setCommentlbl, firstname"></span><br/><div class="twocentDate date" data-twocents="bind: date, date"></div><div class="twocentMenu"><div class="twocentButton twocentEditButton" data-twocents="bind: setVisible, author" data-twocentevent="listen: mousedown, edit"></div><div class="twocentButton twocentDeleteButton" data-twocents="bind: deleteOK, replies" data-twocentevent="listen: mousedown, deleteTwocent"></div><div class="twocentButton twocentReplyButton" data-twocents="bind: setInVisible, author" data-twocentevent="listen: mousedown, reply"></div></div></div><div class="twocentBody"><p class="twocentMessage" data-twocents="bind: innerHTML, message"></p><div class="repliesButton hideReplies" name="hide" data-twocents="bind: toggleHideButton, replies" data-twocentevent="listen: mousedown, toggleReplies" data-labels="bind:innerHTML, hidetwocentreplies"></div></div><div class="writePublicTwocentReply invisible"></div><div class="displayReplies" data-twocents="bind: displayReplies, replies"></div></li></ul>',g.edit=function(e,t){var i=t.getAttribute("data-twocents_id"),n=g.dom.children[i],s=new c,a=document.createDocumentFragment(),o=function(){g.dom.replaceChild(n,s.dom)};s.reset(p,v.get(i),i,o),s.render(),s.place(a),g.dom.replaceChild(a,n)},g.reset=function(e){var i=new s;return p=e,v.reset([]),h.unsync(),h.reset({}),h.sync(t.get("db"),p).then(function(){var e=h.get("twocents")||[];e.length&&v.reset(h.get("twocents")),h.watchValue("twocents",function(e){v.reset(e)}),i.fulfill()},function(e){console.log(e)}),i},g.deleteTwocent=function(e,i){var n=i.getAttribute("data-twocents_id"),s={docId:p,type:"delete",position:n,twocent:{author:b.get("_id")}};alert("Are you sure?"),f.request("WriteTwocent",s,function(e){"ok"!==e&&alert(t.get("labels").get("somethingwrong"))})},g.reply=function(e,t){var i=t.getAttribute("data-twocents_id"),n=g.dom.querySelector(".writePublicTwocentReply[data-twocents_id='"+i+"']"),s=new d(n),a=document.createDocumentFragment();s.reset(p,i),s.render(),s.place(a),n.hasChildNodes()||n.appendChild(a),n.classList.remove("invisible")},g.toggleReplies=function(e,t){var i=t.getAttribute("data-twocents_id"),n=(v.get(i).replies,t.getAttribute("name")),s=g.dom.querySelector(".displayReplies[data-twocents_id='"+i+"']");"show"===n?(s.classList.remove("invisible"),t.setAttribute("name","hide"),t.classList.remove("showReplies"),t.classList.add("hideReplies")):(s.classList.add("invisible"),t.setAttribute("name","show"),t.classList.remove("hideReplies"),t.classList.add("showReplies"))}}return function(t){return p.prototype=new e,new p(t)}});