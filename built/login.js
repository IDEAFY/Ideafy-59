/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Amy/Stack-plugin","service/map","Event.plugin","service/config","Bind.plugin","Store","lib/spin.min","Promise","CouchDBDocument"],function(e,t,n,i,s,a,o,r,c,l){return function(d,u,p){var g,h=new e,m=new e,f=new e,v=new e,b=new e,w=new e,y=new t,L=new o({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:!1}),k=s.get("labels"),S=s.get("transport"),T=(s.get("db"),new r({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270}).spin()),M=!1,A=new o({eula:""});return h.plugins.addAll({loginstack:y}),h.template='<div id="login"><div id="login-stack" data-loginstack="destination"><div class="squirrel"></div></div></div>',v.plugins.add("label",new a(k)),v.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>',v.place(document.getElementById("loading")),b.plugins.add("label",new a(k)),b.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p></div>',w.plugins.add("label",new a(k)),w.template='<div id="nointernet"><p data-label="bind: innerHTML, nointernet"></p></div>',f.plugins.addAll({label:new a(k),loginmodel:new a(L),eula:new a(A),signupevent:new i(f)}),f.template='<div><form id="signup-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: input, resetError"><input name="confirm-password" data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: input, resetError"><input name="firstname" data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: input, resetError"><input name="lastname" data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:input, resetError; listen:keypress, entersignup"></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, signup"></label></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label class="signup-button pressed-btn" name="#login-screen" data-signupevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form><div id="EULA" class="invisible"><div class = "confirm EULA"><div class="help-doctor"></div><p class="confirm-question" data-eula="bind:innerHTML,eula"></p><div class="option left" data-signupevent="listen:mousedown, press; listen:mouseup, acceptEULA" data-label="bind: innerHTML, accept"></div><div class="option right" data-signupevent="listen:mousedown, press; listen:mouseup, rejectEULA" data-label="bind:innerHTML, reject"></div></div></div><div>',f.press=function(e,t){t.focus(),t.classList.add("pressed")},f.release=function(e,t){t.classList.remove("pressed")},f.entersignup=function(e){13===e.keyCode&&(e.target.blur(),f.signup())},f.showLogin=function(){h.reset(),y.getStack().show("#login-screen")},f.resetError=function(e,t){var n=t.getAttribute("name"),i=f.dom.querySelector("#signup");L.set("error",""),L.set(n,t.value),L.get("email")&&L.get("password")&&L.get("confirm-password")&&L.get("firstname")&&L.get("lastname")?i.classList.add("btn-ready"):i.classList.remove("btn-ready")},f.getEULA=function(){S.request("GetEULA",{},function(e){var t,n,i=JSON.parse(e),s=k.get("language");i.translations&&(t=i.translations[s]),n=t?"<h4>"+t.title+"</h4></div>"+t.body+"</div>":"<h4>"+i.title+"</h4></div>"+i.body+"</div>",A.set("eula",n),k.watchValue("language",function(e){n="",t=i.translations[e],n=t?"<h4>"+t.title+"</h4></div>"+t.body+"</div>":"<h4>"+i.title+"</h4></div>"+i.body+"</div>",A.set("eula",n)})})},f.showEULA=function(){f.dom.querySelector("#EULA").classList.remove("invisible")},f.acceptEULA=function(e,t){t.classList.remove("pressed"),f.completeSignup(!0)},f.rejectEULA=function(e,t){t.classList.remove("pressed"),f.completeSignup(!1)},f.completeSignup=function(e){var t=L.get("firstname"),n=L.get("lastname"),i=L.get("password"),a=L.get("email").toLowerCase(),o=(new c,new l);e?(f.dom.querySelector("#EULA").classList.add("invisible"),T.spin(f.dom),S.request("Signup",{name:a,password:i,fn:t,ln:n,lang:s.get("lang")},function(e){if("ok"===e.signup){o.reset(s.get("userTemplate")),o.set("firstname",t),o.set("lastname",n),o.set("username",t+" "+n),o.set("lang",s.get("lang"));var i=new Date;o.set("regdate",[i.getTime()]),o.set("notifications",[{type:"MSG",toList:t+" "+n,date:[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()],object:k.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:k.get("signupwelcomebody")}]),S.request("Welcome",{userid:a,language:o.get("lang")},function(e){return e}),e.db&&p.set("db",e.db),o.set("online",!0),o.set("sock",s.get("socket").socket.sessionid),o.setTransport(S),o.sync(e.db,a).then(function(){return o.upload()}).then(function(){p.set("currentLogin",a),p.set("userAvatar",o.get("picture_file")),p.sync("ideafy-data"),s.set("uid",'"'+a+'"'),o.unsync(),M?u(!0):d(!0)})}else L.set("error","error : "+e.message),L.set("email",""),T.stop()},this)):(f.dom.querySelector("#EULA").classList.add("invisible"),L.set("error",k.get("EULArejected")))},f.signup=function(e,t){var n=L.get("email"),i=L.get("firstname"),s=L.get("lastname"),a=L.get("password"),o=L.get("confirm-password");if(t.classList.remove("btn-ready"),""===n)L.set("error",k.get("signupmissingemail"));else if(""===a)L.set("error",k.get("signupmissingpwd"));else if(""===o)L.set("error",k.get("signupmissingpwdok"));else if(""===i)L.set("error",k.get("signupmissingfn"));else if(""===s)L.set("error",k.get("signupmissingln"));else{var r=n.toLowerCase(),c=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;c.test(r)?a!==o?L.set("error",k.get("signuppwdnomatch")):f.showEULA():L.set("error",k.get("signupinvalidemail"))}},m.plugins.addAll({label:new a(k),loginmodel:new a(L,{forgotpwd:function(e){e?this.classList.remove("loginvisible"):this.classList.add("loginvisible")}}),loginevent:new i(m)}),m.template='<form id="login-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: input, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:mousedown, press; listen: mouseup, release; listen:mouseup, login"></label></p><p class="login-error"><label data-loginmodel="bind:innerHTML,error" class="login-error"></label><label class="forgotpwd" data-loginmodel="bind:forgotpwd,reset" data-label="bind:innerHTML, forgotpwd"  data-loginevent="listen:mousedown, press; listen:mouseup, release; listen:mouseup, resetPassword">Forgot your password?</label></p><p><label class="signup-button pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showSignup"></label></p></form>',m.press=function(e,t){t.classList.add("pressed")},m.release=function(e,t){t.classList.remove("pressed")},m.enterlogin=function(e){13===e.keyCode&&(e.target.blur(),m.login())},m.showSignup=function(){h.reset(),y.getStack().show("#signup-screen")},m.resetError=function(e,t){var n=t.getAttribute("name"),i=m.dom.querySelector(".login-button");L.set("error",""),L.set("reset",!1),L.set(n,t.value),L.get("email")&&L.get("password")?i.classList.add("btn-ready"):i.classList.remove("btn-ready")},m.login=function(e,t){var n=L.get("email").toLowerCase(),i=L.get("password"),a=t||m.dom.querySelector(".login-button");n&&i?(T.spin(m.dom),S.request("Login",{name:n,password:i,sock:s.get("socket").socket.sessionid},function(e){"ok"===e.login?(s.set("uid",'"'+n+'"'),e.db&&p.set("db",e.db),p.set("currentLogin",n),S.request("GetAvatar",{id:n},function(e){e.error||(p.set("userAvatar",e),p.sync("ideafy-data"),s.set("avatar",e)),M?u():d()})):(L.set("error",k.get("invalidlogin")),L.set("reset",!0),T.stop())})):L.set("error",k.get("invalidlogin")),a.classList.remove("btn-ready")},m.resetPassword=function(){var e=L.get("email").toLowerCase();S.request("ResetPWD",{user:e},function(t){"ok"===t?L.set("error",k.get("temppwd")+e):t.rst?L.set("error",k.get("failedpwdreset")+"<a href='mailto:"+t.contact+"?Subject=Password%20support%20"+e+"'>"+k.get("support")+"</a>"):(console.log(t),L.set("error",k.get("somethingwrong")))})},y.getStack().add("#login-screen",m),y.getStack().add("#signup-screen",f),y.getStack().add("#loading-screen",v),y.getStack().add("#maintenance-screen",b),y.getStack().add("#nointernet",w),h.place(n.get("login")),h.init=function(){y.getStack().show("#loading-screen"),g=new r({color:"#06b7fc",lines:10,length:10,width:4,radius:6}).spin(document.getElementById("loadingspin"))},h.setScreen=function(e){y.getStack().show(e),"#signup-screen"===e&&f.getEULA()},h.reset=function(e){L.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:!1}),e&&(M=!0)},h.stopSpinner=function(){T&&T.stop(),g&&g.stop()},SPI=g,LOSPI=T,LSTACK=y.getStack(),h}});