/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Amy/Stack-plugin","service/map","Event.plugin","service/config","Bind.plugin","Store","lib/spin.min","Promise","CouchDBDocument","service/confirm"],function(e,t,n,i,s,a,o,r,c,l,d){return function(u,p,g){var h,m,v,f=new e,b=new e,w=new e,y=new e,L=new e,k=new e,S=new t,T=new o({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:!1}),M=s.get("labels"),A=s.get("transport"),x=(s.get("db"),new r({color:"#657B99",lines:10,length:10,width:8,radius:15,top:270}).spin()),C=!1;return f.plugins.addAll({loginstack:S}),y.plugins.add("label",new a(M)),y.template='<div id="loading"><p data-label="bind: innerHTML, loadingmessage"></p><div id="loadingspin"></div></div>',y.place(document.getElementById("loading")),L.plugins.add("label",new a(M)),L.template='<div id="serverdown"><p data-label="bind: innerHTML, maintenancemessage"></p><div id="loadingspin"></div></div>',k.plugins.add("label",new a(M)),k.template='<div id="nointernt"><p data-label="bind: innerHTML, nointernet"></p><div id="loadingspin"></div></div>',w.plugins.addAll({label:new a(M),loginmodel:new a(T),signupevent:new i(w)}),w.template='<form id="signup-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" data-label="bind:placeholder, emailplaceholder" type="text" data-signupevent="listen: input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-signupevent="listen: input, resetError"><input name="confirm-password" data-loginmodel="bind:value,confirm-password" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-signupevent="listen: input, resetError"><input name="firstname" data-loginmodel="bind:value,firstname" type="text" data-label="bind:placeholder, firstnameplaceholder" data-signupevent="listen: input, resetError"><input name="lastname" data-loginmodel="bind:value,lastname" type="text" data-label="bind:placeholder, lastnameplaceholder" data-signupevent="listen:input, resetError; listen:keypress, entersignup"></p><p><label data-loginmodel="bind:innerHTML,error" class="login-error"></label></p><p><label id="signup" class="login-button pressed-btn" data-label="bind:innerHTML, signupbutton" data-signupevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, signup"></label></p><p><label class="login-button pressed-btn" name="#login-screen" data-signupevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showLogin" data-label="bind:innerHTML, loginbutton"></label></p></form>',w.press=function(e,t){t.focus(),t.classList.add("pressed")},w.release=function(e,t){t.classList.remove("pressed")},w.entersignup=function(e){13===e.keyCode&&(e.target.blur(),w.signup())},w.showLogin=function(){f.reset(),S.getStack().show("#login-screen")},w.resetError=function(e,t){var n=t.getAttribute("name"),i=w.dom.querySelector("#signup");T.set("error",""),T.set(n,t.value),T.get("email")&&T.get("password")&&T.get("confirm-password")&&T.get("firstname")&&T.get("lastname")?i.classList.add("btn-ready"):i.classList.remove("btn-ready")},w.getEULA=function(){A.request("GetEULA",{},function(e){var t,n=JSON.parse(e),i=M.get("language");n.translations&&(t=n.translations[i]),v=t?"<h4>"+t.title+"</h4></div>"+t.body+"</div>":"<h4>"+n.title+"</h4></div>"+n.body+"</div>",M.watchValue("language",function(e){t=n.translations[e],v=t?"<h4>"+t.title+"</h4></div>"+t.body+"</div>":"<h4>"+n.title+"</h4></div>"+n.body+"</div>"})})},w.showEULA=function(){m||(m=new d(w.dom,v,w.completeSignup,"EULA")),m.show()},w.completeSignup=function(e){var t=T.get("firstname"),n=T.get("lastname"),i=T.get("password"),a=T.get("email").toLowerCase(),o=(new c,new l);e?(m.hide(),x.spin(w.dom),A.request("Signup",{name:a,password:i,fn:t,ln:n,lang:s.get("lang")},function(e){if("ok"===e.signup){o.reset(s.get("userTemplate")),o.set("firstname",t),o.set("lastname",n),o.set("username",t+" "+n),o.set("lang",s.get("lang"));var i=new Date;o.set("regdate",[i.getFullYear(),i.getMonth(),i.getDate()]),o.set("notifications",[{type:"MSG",toList:t+" "+n,date:[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()],object:M.get("signupwelcomeobject"),status:"unread",author:"IDEAFY",firstname:"DeeDee",signature:"-- Ideas made easy!",username:"Ideafy",body:M.get("signupwelcomebody")}]),A.request("Welcome",{userid:a,language:o.get("lang")},function(e){return e}),e.db&&g.set("db",e.db),o.set("online",!0),o.set("sock",s.get("socket").socket.sessionid),o.setTransport(A),o.sync(e.db,a).then(function(){return o.upload()}).then(function(){g.set("currentLogin",a),g.set("userAvatar",o.get("picture_file")),g.sync("ideafy-data"),s.set("uid",'"'+a+'"'),o.unsync(),C?p(!0):u(!0)})}else T.set("error","error : "+e.message),T.set("email",""),x.stop()},this)):(m.hide(),T.set("error",M.get("EULArejected")))},w.signup=function(e,t){var n=T.get("email"),i=T.get("firstname"),s=T.get("lastname"),a=T.get("password"),o=T.get("confirm-password");if(t.classList.remove("btn-ready"),""===n)T.set("error",M.get("signupmissingemail"));else if(""===a)T.set("error",M.get("signupmissingpwd"));else if(""===o)T.set("error",M.get("signupmissingpwdok"));else if(""===i)T.set("error",M.get("signupmissingfn"));else if(""===s)T.set("error",M.get("signupmissingln"));else{var r=n.toLowerCase(),c=/^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;c.test(r)?a!==o?T.set("error",M.get("signuppwdnomatch")):w.showEULA():T.set("error",M.get("signupinvalidemail"))}},b.plugins.addAll({label:new a(M),loginmodel:new a(T,{forgotpwd:function(e){e?this.classList.remove("loginvisible"):this.classList.add("loginvisible")}}),loginevent:new i(b)}),b.template='<form id="login-form"><p class="login-fields"><input name="email" data-loginmodel="bind:value,email" autofocus="autofocus" data-label="bind:placeholder, emailplaceholder" type="text" data-loginevent="listen:input, resetError"><input name="password" data-loginmodel="bind:value,password" type="password" data-label="bind:placeholder, passwordplaceholder" data-loginevent="listen: input, resetError; listen:keypress, enterlogin"></p><p><label class="login-button pressed-btn" data-label="bind: innerHTML, loginbutton" data-loginevent="listen:mousedown, press; listen: mouseup, release; listen:mouseup, login"></label></p><p class="login-error"><label data-loginmodel="bind:innerHTML,error" class="login-error"></label><label class="forgotpwd" data-loginmodel="bind:forgotpwd,reset" data-label="bind:innerHTML, forgotpwd"  data-loginevent="listen:mousedown, press; listen:mouseup, release; listen:mouseup, resetPassword">Forgot your password?</label></p><p><label id="signup-button" class="pressed-btn" name="#signup-screen" data-label="bind: innerHTML, newuserbutton" data-loginevent="listen: mousedown, press; listen:mouseup, release; listen: mouseup, showSignup"></label></p></form>',b.press=function(e,t){t.classList.add("pressed")},b.release=function(e,t){t.classList.remove("pressed")},b.enterlogin=function(e){13===e.keyCode&&(e.target.blur(),b.login())},b.showSignup=function(){f.reset(),S.getStack().show("#signup-screen")},b.resetError=function(e,t){var n=t.getAttribute("name"),i=b.dom.querySelector(".login-button");T.set("error",""),T.set("reset",!1),T.set(n,t.value),T.get("email")&&T.get("password")?i.classList.add("btn-ready"):i.classList.remove("btn-ready")},b.login=function(e,t){var n=T.get("email").toLowerCase(),i=T.get("password"),a=t||b.dom.querySelector(".login-button");n&&i?(x.spin(b.dom),A.request("Login",{name:n,password:i,sock:s.get("socket").socket.sessionid},function(e){"ok"===e.login?(s.set("uid",'"'+n+'"'),e.db&&g.set("db",e.db),g.set("currentLogin",n),A.request("GetAvatar",{id:n},function(e){e.error||(g.set("userAvatar",e),g.sync("ideafy-data"),s.set("avatar",e)),C?p():u()})):(T.set("error",M.get("invalidlogin")),T.set("reset",!0),x.stop())})):T.set("error",M.get("invalidlogin")),a.classList.remove("btn-ready")},b.resetPassword=function(){var e=T.get("email").toLowerCase();A.request("ResetPWD",{user:e},function(t){"ok"===t?T.set("error",M.get("temppwd")+e):t.rst?T.set("error",M.get("failedpwdreset")+"<a href='mailto:"+t.contact+"?Subject=Password%20support%20"+e+"'>"+M.get("support")+"</a>"):(console.log(t),T.set("error",M.get("somethingwrong")))})},S.getStack().add("#login-screen",b),S.getStack().add("#signup-screen",w),S.getStack().add("#loading-screen",y),S.getStack().add("#maintenance-screen",L),S.getStack().add("#nointernet",k),f.alive(n.get("login")),f.init=function(){S.getStack().show("#loading-screen"),h=new r({color:"#9AC9CD",lines:10,length:20,width:8,radius:15}).spin(document.getElementById("loadingspin"))},f.setScreen=function(e){S.getStack().show(e),"#signup-screen"===e&&w.getEULA()},f.reset=function(e){T.reset({email:"",firstname:"",lastname:"","confirm-password":"",password:"",error:"",reset:!1}),e&&(C=!0)},f.stopSpinner=function(){x&&x.stop(),h&&h.stop()},f}});