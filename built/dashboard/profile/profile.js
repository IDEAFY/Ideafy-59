/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","./leaderboard","./editprofile","Promise"],function(e,t,s,n,a,o,r,d,c,u){return function(){var p,g,m=new e,v=a.get("user"),b=(v.get("ip"),a.get("labels")),h=new o({total:0,ideas:0,sessions:0,contacts:0,twoQ:0}),f=new o({status:""}),w=new o({view:"info",completion:0,socialnw:0}),y=new o(v.get("news")),L=new o([]),k=new o;return m.plugins.addAll({label:new s(b),stats:new s(w,{setViewLbl:function(e){this.innerHTML=b.get(e),"info"===e?this.setAttribute("style","background: #9ac9cd;"):this.setAttribute("style","background: #5F8F28;")},toggleInformation:function(e){"info"===e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleLeaderboard:function(e){"leaderboard"===e?this.classList.remove("invisible"):this.classList.add("invisible")},setPercentage:function(e){this.innerHTML=b.get("completionprefix")+e+b.get("completionsuffix")},setProgress:function(e){100===e?this.setAttribute("style","width:100%;border-top-right-radius:5px;border-bottom-right-radius:5px;"):this.setAttribute("style","width:"+e+"%;")},showDetails:function(e){100===e?this.classList.add("invisible"):this.classList.remove("invisible")},showSocialNW:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),grades:new s(L,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),achievements:new s(k,{showBadge:function(e){this.setAttribute("style","background: url('img/profile/"+e+"') no-repeat center center; background-size: cover;")}}),progressbar:new s(h,{setWidth:function(e){this.setAttribute("style","width:"+e+"%;")}}),progress:new s(f),config:new s(a,{setAvatar:function(e){this.setAttribute("style","background: url('"+e+"') no-repeat center center;background-size:cover;")}}),user:new s(v,{setLocation:function(e){this.innerHTML=e.country?e.country.toUpperCase():b.get("completeprofile"),e.city&&e.country&&(this.innerHTML=e.city+", "+e.country.toUpperCase()),e.city&&e.state&&e.country&&(this.innerHTML=e.city+", "+e.state.toUpperCase()+" "+e.country.toUpperCase())},setAge:function(e){var t,s,i=new Date;e&&3===e.length?(t=new Date(e[0],e[1],e[2]),s=i.getTime()-t.getTime(),this.innerHTML=Math.floor(s/1e3/3600/24/365)+" "+b.get("agelbl")):this.innerHTML=b.get("completeprofile")},setFamily:function(e){var t,s,i=e.couple,n=e.children;null===i?t=b.get("completeprofile"):0===i?t=b.get("singlelbl"):1===i?t=b.get("marriedlbl"):2===i?t=b.get("divorcedlbl"):3===i&&(t=b.get("widowlbl")),n&&0!==n?(s=v.get("age")<20?1===n?n+b.get("onesiblinglbl"):n+b.get("siblingslbl"):1===n?n+b.get("onechildlbl"):n+b.get("childrenlbl"),s=", "+s):s="",this.innerHTML=t+s},setOccupation:function(e){this.innerHTML=4===e.situation?b.get("stayathome"):3===e.situation?b.get("unemployed"):0===e.situation?e.organization?b.get("student")+" @ "+e.organization:b.get("student"):2===e.situation?e.job?e.job+" ("+b.get("retired")+")":b.get("retired"):1===e.situation?e.job||e.organization?e.job&&!e.organization?e.job:!e.job&&e.organization?b.get("active")+" @ "+e.organization:e.job+" @ "+e.organization:b.get("active"):b.get("completeprofile")},showLeisure:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setLeisure:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)t+=e[i].comment?"<li>"+e[i].name+" ("+e[i].comment+")</li>":"<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showInterests:function(e){e[0].name||e[1].name||e[2].name?this.classList.remove("invisible"):this.classList.add("invisible")},setInterests:function(e){var t="<ul>";if(e&&e.length){for(i=0;i<e.length;i++)t+=e[i].comment?"<li>"+e[i].name+" ("+e[i].comment+")</li>":"<li>"+e[i].name+"</li>";this.innerHTML=t+"</ul>"}else this.innerHTML=""},showSN:function(e){this.innerHTML=e?e:""},setSessionCount:function(){var e=v.get("su_sessions_count")||0,t=v.get("mu_sessions_count")||0;this.innerHTML=e+t},setContactCount:function(e){var t=0;for(i=0,l=e.length;l>i;i++)"user"===e[i].type&&t++;this.innerHTML=t},setBarLength:function(e){e>=3e5?this.setAttribute("style","width: 100%"):e>=3e4?this.setAttribute("style","width: 75%"):e>=3e3?this.setAttribute("style","width: 50%"):this.setAttribute("style","width: 25%")}}),news:new s(y,{setType:function(e){e.search("CX")>-1?this.setAttribute("style","background: url('img/profileDisable.png') no-repeat center center; background-size: contain;"):e.search("RWD")>-1||e.search("RANK")>-1?this.setAttribute("style","background: url('img/brainstorm/yourScore40.png') no-repeat center center; background-size: 40px;"):e.search("ID")>-1?this.setAttribute("style","background: url('img/libraryIdeaDisabled40.png') no-repeat center center; background-size: 40px;"):e.search("2Q")>-1?this.setAttribute("style","background: url('img/2questionDisable50.png') no-repeat center center; background-size: 40px;"):e.search("2CTS")>-1&&this.setAttribute("style","background: url('img/2centDisable.png') no-repeat center center; background-size: 40px;")},setContent:function(){var e=this.getAttribute("data-news_id");switch(y.get(e).type){case"CX+":this.innerHTML="<span class='newsinfo'>"+y.get(e).content.username+"</span>"+b.get("isnowacontact");break;case"CX-":this.innerHTML="<span class='newsinfo'>"+y.get(e).content.username+"</span>"+b.get("isnolongeracontact");break;case"IDEA+":this.innerHTML=b.get("enterednewidea")+"<span class='newsinfo'>"+y.get(e).content.title+"</span>";break;case"SHID":this.innerHTML=b.get("sharedanidea")+"("+"<span class='newsinfo'>"+y.get(e).content.title+"</span>)";break;case"RANK":this.innerHTML=b.get("reachedrank")+"<span class='newsinfo'>"+y.get(e).content.label+"</span>";break;case"RWD":this.innerHTML=b.get("gotaward")+"<span class='newsinfo'>"+y.get(e).content.label+"</span>";break;case"2Q+":this.innerHTML=b.get("posted2q")+"<span class='newsinfo'>"+y.get(e).content.question+"</span>";break;case"2CTS":this.innerHTML=b.get("commentedon")+"<span class='newsinfo'>"+y.get(e).content.title+"</span>"+b.get("by")+y.get("id").content.username}},formatDate:function(e){this.innerHTML=r.formatDate(e)}}),profileevent:new n(m)}),m.template='<div id="dashboard-profile"><div class="header blue-dark"><span data-label="bind:innerHTML, profilelbl"></span></div><input class="infoslider" type="range" min="0" max="1" value ="0" data-profileevent="listen:mouseup, switchLeaderboard"><span class="slidertext" data-stats="bind:setViewLbl, view"></span><div id="profile-content" data-stats="bind:toggleInformation, view"><div class="leftprofile"><div class="userdetails"><div class="editbtn" data-profileevent="listen:mousedown, edit"></div><div class="cd-picarea"><div class="cardpicture" data-config="bind:setAvatar, avatar"></div><div class="cardinfo"><h2 data-user="bind:innerHTML,username"></h2><blockquote data-user="bind:innerHTML, intro"></blockquote><p><span class="cd-agelbl"></span><span data-user="bind:setAge, birthdate"></span></p><p><span class="cd-locationlbl"></span><span class="cd-info" data-user="bind: setLocation, address"></span></p><p><span class="cd-joblbl"></span><span class="cd-info" data-user="bind: setOccupation, occupation"></span></p><p><span class="cd-familylbl"></span><span class="cd-info" data-user="bind: setFamily, family"></span></p></div></div><div class="cd-contentarea"><div data-user="bind:showLeisure, leisure_activities"><span class="contentTitle" data-label="bind: innerHTML, hobbieslbl"></span><p class = "userinfo" data-user="bind:setLeisure, leisure_activities"></p></div><div data-user="bind:showInterests, interests"><span class="contentTitle" data-label="bind: innerHTML, interestslbl">Centers of interest</span><p class = "userinfo" data-user="bind: setInterests, interests"></p></div><div data-stats="bind:showSocialNW, socialnw"><span class="contentTitle" data-label="bind: innerHTML, socialnwlbl"></span><p class = "userinfo fb" data-user="bind:showSN, facebook"></p><p class = "userinfo gp" data-user="bind:showSN, gplus; bind:innerHTML"></p><p class = "userinfo tw" data-user="bind:showSN, twitter"></p><p class = "userinfo lin" data-user="bind:showSN, linkedin"></p></div></div><div><legend data-stats="bind: setPercentage, completion"></legend><div class="completionbar"><div class="innerbar" data-stats = "bind:setProgress, completion"></div></div></div></div><div class="edituserdetails invisible"></div><div class="mystats"><legend data-label="bind:innerHTML, mystatslbl"></legend><div class="completionbar"><ul data-user="bind: setBarLength, ip"><li class="innerbar myids" data-progressbar="bind: setWidth, ideas"></li><li class="innerbar myss" data-progressbar="bind:setWidth, sessions"></li><li class="innerbar myctcts" data-progressbar="bind: setWidth, contacts"></li><li class="innerbar my2q" data-progressbar="bind:setWidth, twoQ"></li></ul></div><table><tr class ="myids"><th data-label="bind:innerHTML, ideaslbl"></th><td data-user="bind: innerHTML, ideas_count"></td></tr><tr class ="myss"><th data-label="bind:innerHTML, sessionslbl"></th><td data-user="bind: setSessionCount, ip"></td></tr><tr class="myctcts"><th data-label="bind:innerHTML, contactslbl"></th><td data-user="bind: setContactCount, connections"></td></tr><tr class="my2q"><th data-label="bind:innerHTML, toquestionslbl"></th><td data-user="bind: innerHTML, twoquestions_count"></td></tr></table></div><div class="recentactivity"><legend data-label="bind:innerHTML, recentactivitylbl"></legend><ul data-news="foreach"><li><div class="newstype" data-news="bind:setType, type"></div><div class="newsdate" data-news="bind:formatDate, date"></div><p class="newstext" data-news="bind:setContent, content"></p></li></ul></div></div><div class = "rightprofile"><div class="userscore"><span class="ip" data-user="bind:innerHTML, ip"></span><span data-label="bind:innerHTML, ideafypoints"></span></div><div class="userachievements"><h2 class="grade" data-stats="bind:innerHTML, title"></h2><ul class="badges" data-grades="foreach"><li class="badge"><div data-grades="bind:showBadge, badge"></div><legend data-grades="bind:innerHTML, title"></legend></li></ul><ul class="badges" data-achievements="foreach"><li class="badge"><div data-achievements="bind:showBadge, badge"></div><legend data-achievements="bind:innerHTML, label"></legend></li></ul></div></div></div><div id="leaderboard" data-stats="bind:toggleLeaderboard, view"></div></div>',m.place(t.get("dashboard-profile")),m.switchLeaderboard=function(e,t){var s=document.getElementById("leaderboard");document.getElementById("profile-content"),1==t.value?(w.set("view","leaderboard"),p?p.refresh():(p=new d,p.init(s))):w.set("view","info")},m.edit=function(){var e=document.querySelector(".edituserdetails");document.querySelector(".userdetails").classList.add("invisible"),g?g.reset():(g=new c,g.init(e)),e.classList.remove("invisible")},a.get("observer").watch("profile-updated",function(){m.checkProfileCompletion().then(function(){m.updateGrade(),m.updateAchievements()})}),v.watchValue("ip",function(){m.updateGrade(),m.updateProgressBar()}),v.watchValue("tutorial_complete",function(){m.updateGrade(),m.updateAchievements()}),v.watchValue("settings",function(){m.updateGrade(),m.updateAchievements()}),v.watchValue("news",function(){y.reset(v.get("news"))}),v.watchValue("lang",function(){m.updateGrade().then(function(){m.updateAchievements()}),y.reset([]),y.reset(v.get("news"))}),m.checkProfileCompletion=function(){var e=r.checkProfileCompletion(),t=new u;return w.set("completion",e.percentage),w.set("missing",e.missing),e.missing.indexOf(b.get("entersocialnw"))<0&&w.set("socialnw",1),100===e.percentage&&v.get("profile_complete")!==!0?(v.set("profile_complete",!0),v.upload().then(function(){t.fulfill()})):e.percentage<100&&v.get("profile_complete")?(v.set("profile_complete",!1),v.upload().then(function(){t.fulfill()})):t.fulfill(),t},m.updateGrade=function(){var e=new u;return r.getGrade(v.get("ip"),function(t){var s;s=t.distinction?[t.grade,t.distinction]:[t.grade],L.reset(s),w.set("title",t.grade.label),e.fulfill()}),e},m.updateAchievements=function(){var e=new u;return r.getAchievements(v.get("_id"),function(t){t.length?k.reset(t):k.reset(v.get("achievements")),e.fulfill()}),e},m.updateProgressBar=function(){var e,t,s,i,n,a,o,l,r;for(t=v.get("ideas_count"),i=v.get("su_sessions_count")||0,n=v.get("mu_sessions_count")||0,s=i+n,o=v.get("twoquestions_count")||0,a=0,l=0,r=v.get("connections").length;r>l;l++)"user"===v.get("connections")[l].type&&a++;e=t+o+a+s,h.set("total",e),h.set("ideas",Math.floor(100*(t/e))),h.set("contacts",Math.floor(100*(a/e))),h.set("sessions",Math.floor(100*(s/e))),h.set("twoQ",Math.floor(100*(o/e)))},m.cleanOldNews=function(){var e,t,s=new Date,i=v.get("news"),n=i.length,a=new u;if(n){for(e=n-1;e>=0;e--)t=new Date(i[e].date[0],i[e].date[1],i[e].date[2]),s.getTime()-t.getTime()>1296e6&&i.splice(e,1);i.length!==n?(v.set("news",i),v.upload().then(function(){a.fulfill()})):a.fulfill()}return a},m.init=function(){m.checkProfileCompletion().then(function(){return m.updateGrade()}).then(function(){return m.updateAchievements()}).then(function(){m.updateProgressBar(),m.cleanOldNews()})},m.reset=function(){y.reset([]),y.reset(v.get("news")),m.init()},m.init(),m}});