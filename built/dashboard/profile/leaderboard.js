/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBView","service/utils","service/avatar","lib/spin.min"],function(e,t,s,i,n,a,o,l){return function(){var r=new e,d=new n([]),c=new l({color:"#9ac9cd",lines:10,length:12,width:6,radius:10,top:328}).spin();return r.template='<div><ul data-leaders="foreach"><li class="leader" data-leaders="bind:setSpotLight, value.userid"><div data-leaders="bind:setAvatar, value.userid"></div><div class="username" data-leaders="bind:innerHTML, value.username"></div><div class="distinction" data-leaders="bind:setDistinction, value.ip"></div><div class="grade" data-leaders="bind:setGrade, value.ip"></div><div class="score" data-leaders="bind: setScore, value.ip"></div></li></ul></div>',r.plugins.addAll({leaders:new s(d,{setSpotLight:function(e){e===t.get("user").get("_id")?(this.classList.add("userleader"),this.scrollIntoView(!1)):this.classList.remove("userleader")},setAvatar:function(e){var t,s;e&&(s=document.createDocumentFragment(),t=new o([e]),t.place(s),this.hasChildNodes()?this.replaceChild(s,this.firstChild):this.appendChild(s))},setGrade:function(e){var t=this;a.getGrade(e,function(e){t.setAttribute("style","background: url('img/profile/"+e.grade.badge+"') no-repeat center center; background-size: 40px 40px;")})},setDistinction:function(e){var t=this;a.getGrade(e,function(e){e.distinction&&t.setAttribute("style","background: url('img/profile/"+e.distinction.badge+"') no-repeat center center; background-size: 40px 40px;")})},setScore:function(e){this.innerHTML=e+" ip"}}),leaderevent:new i(r)}),r.init=function(e){console.log("init",e),c.spin(e),d.setTransport(t.get("transport")),d.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0}).then(function(){r.place(e),c.stop(),d.unsync()})},r.refresh=function(){d.reset([]),c.spin(r.dom),d.sync(t.get("db"),"users","_view/leaderboard",{limit:100,descending:!0}).then(function(){c.stop(),d.unsync()})},t.get("observer").watch("reconnect",function(){r.refresh()}),r}});