/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store","service/utils","CouchDBBulkDocuments"],function(e,t,s,i,n,a,o,l){return function(){var r=new e,d=n.get("labels"),c=n.get("user"),u=n.get("transport"),p=[{name:d.get("public"),dest:"#public"},{name:d.get("library"),dest:"#library"},{name:d.get("brainstorm"),dest:"#brainstorm"},{name:d.get("connect"),dest:"#connect"},{name:d.get("dashboard"),dest:"#dashboard"}],g=[{name:d.get("everymin"),value:6e4},{name:d.get("everyfive"),value:3e5},{name:d.get("everyfifteen"),value:9e5},{name:d.get("never"),value:864e5}],m=new a({screens:p,timers:g,pwd:"",pwdbis:"",lang:[],pwdchange:"",contentLang:c.get("lang").substring(0,2)}),v=new a([{name:"*"}]),b=n.get("userLanguages"),h=new a;return b.forEach(function(e){v.alter("push",e)}),r.plugins.addAll({label:new s(d),options:new s(m,{setLang:function(e){var t,s,i="";for(t=0,s=e.length;s>t;t++)i+="<option>"+e[t]+"</option>";this.innerHTML=i,this.selectedIndex=e.indexOf(c.get("lang"))},setStartupScreen:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].name+"</option>",e[t].dest===c.get("settings").startupScreen&&(i=t);this.innerHTML=n,this.selectedIndex=i},setPollingInterval:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].name+"</option>",e[t].value===c.get("settings").polling_interval&&(i=t);this.innerHTML=n,this.selectedIndex=i},setDecks:function(e){var t,s,i,n="";for(t=0,s=e.length;s>t;t++)n+="<option>"+e[t].title+"</option>",e[t].id===c.get("active_deck")&&(i=t);this.innerHTML=n,this.selectedIndex=i},setBg:function(e){"all"===e?(this.setAttribute("style","background-image: none;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png');background-size: contain;"))}}),select:new s(v,{setBg:function(e){"*"===e?(this.setAttribute("style","background-image: none;background: whitesmoke;text-align: center;"),this.innerHTML="*"):(this.innerHTML=" ",this.setAttribute("style","background-image:url('img/flags/"+e+".png'); background-size: contain;"))}}),settings:new s(h),settingsevent:new i(r)}),r.template='<div id="dashboard-settings"><div class="header blue-dark"><span data-label="bind:innerHTML, settingslbl"></span></div><div class="settingscontent"><div class="settingmodule"><legend data-label="bind:innerHTML, publicwallsettings"></legend><ul><li class="startupscreen"><span data-label="bind: innerHTML, choosepolling"></span><select data-options="bind:setPollingInterval, timers" data-settingsevent="listen: change, updatePollingInterval"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, brainstormsettings"></legend><ul><li class="activedeck"><span data-label="bind:innerHTML, setdeck">Set brainstorming deck</span><select data-options="bind:setDecks, decks" data-settingsevent="listen: mousedown, getDecks; listen: change, updateDeck"></select></li></ul></div><div class="settingmodule"><legend data-label="bind:innerHTML, userpref"></legend><ul><li><span data-label="bind:innerHTML, setlang"></span><select data-options="bind:setLang, lang" data-settingsevent="listen: change, updateLang"></select></li><li class="activelang"><span data-label="bind:innerHTML, defaultlangfilter"></span><div class="selectlang"><div data-options="bind:setBg, contentLang"></div><button data-settingsevent = "listen:mouseup, displayLang"></button></div><ul class="langlist invisible" data-select="foreach"><li data-select="bind: setBg, name" data-settingsevent="listen: mouseup, setContentLang"></li></ul></li><li class="startupscreen"><span data-label="bind: innerHTML, choosestartup"></span><select data-options="bind:setStartupScreen, screens" data-settingsevent="listen: change, updateStartup"></select></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, showTips" data-settingsevent="listen: change, showTips"><label data-label="bind:innerHTML, showtips"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, notifyPopup" data-settingsevent="listen: change, showNotif"><label data-label="bind:innerHTML, shownotif"></label></li><li class="setting-input"><input type="checkbox" data-settings="bind: checked, useascharacter" data-settingsevent="listen: change, useAsChar"><label data-label="bind:innerHTML, usechar"></label></li><li><span data-label="bind: innerHTML, changepwd"></span><input class="input" type="password" data-label="bind:placeholder, passwordplaceholder" data-options="bind: value, pwd" data-settingsevent="listen:input, updatepwd; listen: input, clearOK"><input class="input" type="password" data-label="bind:placeholder, repeatpasswordplaceholder" data-options="bind: value, pwdbis" data-settingsevent="listen:input, updatepwdbis; listen: input, clearOK"><span class="changeok" data-options="bind: innerHTML, pwdchange"></span><div class="next-button" data-label="bind:innerHTML, changelbl" data-settingsevent="listen: mousedown, press; listen:mouseup, changePWD"></div></li></ul></div></div></div>',r.place(t.get("dashboard-settings")),r.updateLang=function(e,t){t.value!==c.get("lang")&&o.updateLabels(t.value).then(function(){c.set("lang",t.value),c.upload(),m.set("timers",[{name:d.get("everymin"),value:6e4},{name:d.get("everyfive"),value:3e5},{name:d.get("everyfifteen"),value:9e5},{name:d.get("never"),value:864e5}]),m.set("screens",[{name:d.get("public"),dest:"#public"},{name:d.get("library"),dest:"#library"},{name:d.get("brainstorm"),dest:"#brainstorm"},{name:d.get("connect"),dest:"#connect"},{name:d.get("dashboard"),dest:"#dahsboard"}]),h.get("contentLang")?m.set("contentLang",h.get("contentLang")):m.set("contentLang",c.get("lang").substring(0,2))})},r.displayLang=function(){r.dom.querySelector(".langlist").classList.remove("invisible")},r.setContentLang=function(e,t){var s=parseInt(t.getAttribute("data-select_id"),10),i=c.get("settings");r.dom.querySelector(".langlist").classList.add("invisible"),0===s?(i.contentLang="all",m.set("contentLang","all")):(i.contentLang=v.get(s).name,m.set("contentLang",i.contentLang)),c.set("settings",i),c.upload()},r.getDecks=function(){var e=new l,t=c.get("taiaut_decks").concat(c.get("custom_decks")),s=[];e.setTransport(n.get("transport")),e.sync(n.get("db"),{keys:t}).then(function(){m.set("decks",[]),e.loop(function(e){var t=e.doc.content;t.characters.length>=2&&t.contexts.length>=2&&t.problems.length>=2&&t.techno.length>=4&&s.push({id:e.doc._id,title:e.doc.title})}),e.unsync(),s.sort(function(e,t){var s=e.title,i=t.title;return i>s?-1:s>i?1:s===i?0:void 0}),m.set("decks",s)})},r.updateDeck=function(e,t){var s=t.selectedIndex,i=m.get("decks")[s].id;c.set("active_deck",i),c.upload()},r.updateStartup=function(e,t){var s=t.selectedIndex,i=c.get("settings");i.startupScreen=p[s].dest,c.set("settings",i),c.upload()},r.updatePollingInterval=function(e,t){var s=t.selectedIndex,i=c.get("settings");i.polling_interval=g[s].value,c.set("settings",i),c.upload()},r.showTips=function(e,t){var s=c.get("settings");s.showTips=t.checked,c.set("settings",s),c.upload().then(function(){console.log("upload successful")})},r.showNotif=function(e,t){var s=c.get("settings");s.notifyPopup=t.checked,c.set("settings",s),c.upload()},r.useAsChar=function(e,t){var s=c.get("settings");s.useascharacter=t.checked,c.set("settings",s),c.upload()},r.press=function(e,t){t.classList.add("pressed")},r.clearOK=function(){m.set("pwdchange","")},r.updatepwd=function(e,t){m.set("pwd",t.value)},r.updatepwdbis=function(e,t){m.set("pwdbis",t.value)},r.changePWD=function(e,t){t.classList.remove("pressed"),m.get("pwd")!==m.get("pwdbis")?(m.set("pwdbis",""),m.set("pwdchange","&#10007;")):u.request("ChangePWD",{userid:c.get("_id"),pwd:m.get("pwd")},function(e){var t,s={},i={},n=c.get("notifications").concat()||[];"ok"===e&&(m.set("pwdchange","&#10003;"),s.type="pwd",s.to=c.get("_id"),s.subject=d.get("pwdchange"),s.html=d.get("pwdchangebody")+m.get("pwd"),u.request("SendMail",s,function(e){"ok"!==e.sendmail&&console.log(e)}),c.set("resetPWD",!1),t=new Date,i.type="pwd",i.status="unread",i.date=[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()],i.author="IDEAFY",i.username="Ideafy",i.firstname="DeeDee",i.object=d.get("pwdupdate"),i.body=d.get("pwdchangebody")+m.get("pwd"),n.unshift(i),c.set("notifications",n),c.upload().then(function(e){e.ok||console.log(e)}))})},r.reset=function(){h.reset(c.get("settings")),c.watchValue("settings",function(){h.reset(c.get("settings"))}),r.getDecks(),u.request("GetLanguages",{},function(e){m.set("lang",e)}),h.get("contentLang")?m.set("contentLang",h.get("contentLang")):m.set("contentLang",c.get("lang").substring(0,2)),m.set("timers",[{name:d.get("everymin"),value:6e4},{name:d.get("everyfive"),value:3e5},{name:d.get("everyfifteen"),value:9e5},{name:d.get("never"),value:864e5}]),m.set("screens",[{name:d.get("public"),dest:"#public"},{name:d.get("library"),dest:"#library"},{name:d.get("brainstorm"),dest:"#brainstorm"},{name:d.get("connect"),dest:"#connect"},{name:d.get("dashboard"),dest:"#dahsboard"}]),m.set("pwd",""),m.set("pwdbis",""),m.set("pwdchange","")},r.reset(),o.updateLabels(c.get("lang")),r}});