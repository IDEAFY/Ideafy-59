/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","Bind.plugin","Event.plugin","service/map","service/utils","service/avatar","service/config","twocents/writetwocent","twocents/twocentlist","Observable","Promise","CouchDBDocument","Place.plugin","lib/spin.min","attach/attachment"],function(e,t,n,i,s,a,o,r,c,l,d,u,p,g,h,m){return function(f){var v=new e,b=new l("library"),w=new c("library"),y=m,L=r.get("labels"),k=new t([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),S=!1,T=r.get("user"),M=r.get("transport"),C=new p,x=new t([]),A=new t([]),q=s.get("ideas-detail"),_=s.get("library-writetwocents");return new d,C.setTransport(M),v.plugins.addAll({label:new n(L),ideadetail:new n(C,{displayView:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")},toggleFavEdit:function(e){var t=this;e.indexOf(T.get("_id"))>-1?t.setAttribute("href","#library-edit"):(t.setAttribute("href","#library-favorites"),T.get("library-favorites")&&T.get("library-favorites").indexOf(C.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav"),T.watchValue("library-favorites",function(e){e.indexOf(C.get("_id"))>-1?t.classList.add("unfav"):t.classList.remove("unfav")}))},toggleTwocentShare:function(e){e.indexOf(T.get("_id"))>-1?this.setAttribute("href","#library-share"):this.setAttribute("href","#library-2cents")},displayWriteTwocent:function(e){e.indexOf(T.get("_id"))<0?this.classList.remove("invisible"):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length&&document.getElementById("library-writetwocents").classList.add("invisible")},date:function H(H){H&&(this.innerHTML=a.formatDate(H))},setAuthor:function(e){this.innerHTML=e===T.get("username")&&C.get("authors").indexOf(T.get("_id"))>-1?L.get("youlbl"):e},setWrotelbl:function(e){this.innerHTML=1===e.length&&e[0]===T.get("_id")?L.get("youwrotelbl"):e.length>1?L.get("theywrotelbl"):L.get("ideawrotelbl")},setAvatar:function(e){var t=document.createDocumentFragment(),n=new o(e);n.place(t),this.hasChildNodes()?this.replaceChild(t,this.firstChild):this.appendChild(t)},hideRating:function(e){e.search("I:WELCOME")>-1?this.classList.add("invisible"):this.classList.remove("invisible")},setRating:function(e){this.innerHTML=0===e.length?"":Math.round(100*(e.reduce(function(e,t){return e+t})/e.length))/100},setDescription:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setSolution:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},toggleVoteButton:function(e){var t=C.get("_id"),n=C.get("authors");document.getElementById("ratingPopup").classList.remove("appear"),T.get("rated_ideas").indexOf(t)<0&&n.indexOf(T.get("_id"))<0&&!S?(this.setAttribute("name","vote"),this.innerHTML=L.get("votebuttonlbl"),this.classList.remove("votes"),this.classList.add("publicButton")):(S=!0,this.classList.remove("publicButton"),this.setAttribute("name","voted"),this.innerHTML=0===e.length?"("+L.get("novotesyet")+")":1===e.length?"("+L.get("onevote")+")":"("+e.length+" "+L.get("votes")+")",this.classList.add("votes"))},setSharedWith:function(e){C.get("_id").search("I:WELCOME")<0&&e&&e.length?(this.classList.remove("invisible"),this.innerHTML=1===e.length?L.get("sharedwith")+"<b><u>"+1+L.get("ideafyer")+"</u></b>":L.get("sharedwith")+"<b><u>"+e.length+L.get("ideafyer")+"</u></b>"):this.classList.add("invisible")},showAttachments:function(e){e&&e.length?this.classList.remove("invisible"):this.classList.add("invisible")}}),alist:new n(A,{setCat:function(e){var t=r.get("cat"),n=r.get("catColors"),i=t.indexOf(e);i>-1?(this.innerHTML=L.get(e),this.setAttribute("style","color:"+n[i])):(this.innerHTML=e,this.setAttribute("sytle","color: #404040"))},setType:function(e){switch(e){default:this.setAttribute("style","background-image: url('../img/r2/download.png')")}},setRef:function(e){var t=r.get("location")+"/downloads";this.getAttribute("data-alist_id"),e&&(t+="?atype=idea&docid="+C.get("_id")+"&file="+e,this.setAttribute("href",t))},setRating:function(e){var t,n=this;e&&(t=new p,t.setTransport(M),t.sync(r.get("db"),e).then(function(){var e=t.get("votes")||[],i=e.length;0===i?(n.innerHTML="",n.parentNode.setAttribute("style","display: none;")):(n.innerHTML=Math.round(100*(e.reduce(function(e,t){return e+t})/i))/100,n.parentNode.setAttribute("style","display: inline-block;"))}))}}),share:new n(x),vote:new n(k,{setIcon:function(e){var t="background-image: url('img/public/activeIdeaVote.png');",n="background-image: url('img/public/rateForList.png');";e?this.setAttribute("style",t):this.setAttribute("style",n)}}),place:new g({LibraryTwocentUI:b}),ideadetailevent:new i(v)}),v.template='<div class="library-idea invisible" data-ideadetail="bind:displayView, _id"><div class="header blue-dark"><a href="#library-2cents" data-ideadetail="bind: toggleTwocentShare, authors" data-ideadetailevent="listen: mousedown, action" class="option left"></a><span data-label="bind: innerHTML, ideadetailsheadertitle"></span><a href="#library-favorites" data-ideadetail="bind: toggleFavEdit, authors" data-ideadetailevent="listen: mousedown, action" class="option right"></a></div><div id="idea-cache" class="invisible"></div><div class = "detail-contents"><div class="detail-header"><div class="avatar" data-ideadetail="bind:setAvatar, authors"></div><h2 data-ideadetail="bind:innerHTML,title"></h2><span class="date" data-ideadetail="bind:date, creation_date"></span><br><span class="author" data-ideadetail="bind:setAuthor,authornames"></span><span class="commentlbl" data-ideadetail="bind: setWrotelbl, authors"></span></div><div class="detail-body"><legend class="idealegend" data-label="bind:innerHTML, principle"></legend><p data-ideadetail="bind:setDescription,description"></p><legend class="idealegend" data-label="bind:innerHTML, solution"></legend><p data-ideadetail="bind:setSolution,solution"></p><div class="attachments invisible" data-ideadetail="bind:showAttachments, attachments"><legend class="idealegend" data-label="bind:innerHTML, attachments"></legend><div class="toggleattach" data-ideadetailevent="listen: mousedown, toggleAttachments"></div><ul class="a-list" data-alist="foreach"><li><a class="a-type" data-alist="bind:setType, type; bind: setRef, fileName" data-ideadetailevent="listen: mousedown, press; listen: mouseup, release"></a><label class="a-name" data-alist="bind:innerHTML, name">Name</label><label class="a-cat" data-alist="bind:setCat, category"></label><div class="a-rating"><a class="item-acorn"></a><label class="rating" data-alist="bind:setRating,docId"></label></div><label class="a-zoom" data-ideadetailevent="listen: mousedown, press; listen: mouseup, release; listen:mouseup, zoom"></label></li></ul></div></div><div class="detail-footer"><div class="sharedwith invisible" data-ideadetail="bind: setSharedWith, sharedwith" data-ideadetailevent="listen:mousedown, displayList"></div><div id="sharelist" class="autocontact invisible"><div class="autoclose" data-ideadetailevent="listen:mousedown,close"></div><ul data-share="foreach"><li data-share="bind:innerHTML, value.username"></li></ul></div><div class ="rateIdea" data-ideadetail="bind:hideRating, id"><a class="item-acorn"></a><div class="rating" data-ideadetail="bind:setRating,votes"></div><div class="publicButton" data-ideadetail="bind: toggleVoteButton, votes" name="vote" data-ideadetailevent="listen: mousedown, press; listen: mouseup, vote;" data-label="bind: innerHTML, votebuttonlbl"></div><div id="ratingPopup" class="popup"><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-ideadetailevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div></div></div><div id="library-writetwocents" class="invisible" data-ideadetail="bind: displayWriteTwocent, authors"></div><div id="library-twocents" class="twocents" data-ideadetail="bind: displayTwocentList, twocents" data-place="place: LibraryTwocentUI"></div></div>',v.showCache=function(){v.dom.querySelector("#idea-cache").classList.remove("invisible")},v.hideCache=function(){v.dom.querySelector("#idea-cache").classList.add("invisible")},v.reset=function(e,t){var n=e.get(t).id,i=new u;return k.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),v.getIdea(n).then(function(){C.get("attachments")?A.reset(C.get("attachments")):A.reset([]),C.watchValue("attachments",function(e){A.reset(e)}),S=!1,w.reset(C.get("_id")),b.reset(C.get("_id")),_=document.getElementById("library-writetwocents"),w.place(_),i.fulfill()}),i},v.getIdea=function(e){return C.unsync(),C.reset(),C.sync(r.get("db"),e)},v.refresh=function(){return v.getIdea(C.get("_id"))},v.action=function(e,t){var n,i,s=t.getAttribute("href"),a=C.get("_id"),o=new h({color:"#FFFFFF",lines:8,length:6,width:3,radius:6,left:3,top:3});switch(s){case"#library-2cents":w.reset(a),_.classList.remove("invisible");break;case"#library-favorites":t.classList.add("favwait"),o.spin(t),n=T.get("library-favorites")?T.get("library-favorites").concat():[],i=n.indexOf(a),i>-1?n.splice(n.indexOf(a),1):n.push(a),n.length<100?(T.set("library-favorites",n),T.upload().then(function(){o.stop(),t.classList.remove("favwait"),i>-1?alert(L.get("removedfav")):alert(L.get("addedfav")),t.classList.toggle("unfav")})):(alert(L.get("maxfavsize")),o.stop(),t.classList.remove("favwait"));break;default:f(s)}},v.edit=function(){_stack.getStack().show("#public-edit")},v.press=function(e,t){t.classList.add("pressed")},v.release=function(e,t){t.classList.remove("pressed")},v.toggleAttachments=function(e,t){var n=v.dom.querySelector(".a-list");t.classList.contains("show")?(n.classList.remove("invisible"),t.classList.remove("show")):(n.classList.add("invisible"),t.classList.add("show"))},v.zoom=function(e,t){var n=t.getAttribute("data-alist_id");y.reset(A.get(n).docId,"idea")},v.vote=function(e,t){S||(document.getElementById("cache").classList.add("appear1"),document.getElementById("ratingPopup").classList.add("appear")),t.classList.remove("pressed")},v.previewVote=function(e,t){var n=t.getAttribute("data-vote_id");k.loop(function(e,t){n>=t?k.update(t,"active",!0):k.update(t,"active",!1)})},v.castVote=function(e,t){var n=parseInt(t.getAttribute("data-vote_id"))+1,i=C.get("_id"),s={id:i,vote:n,voter:T.get("_id")};S||(S=!0,M.request("Vote",s,function(e){var t=T.get("rated_ideas")||[];"ok"!==e?(console.log(e,"something went wrong, please try again later"),S=!1):(t.unshift(i),T.set("rated_ideas",t),alert(r.get("labels").get("thankyou")),document.getElementById("ratingPopup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear1"),k.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},v.close=function(e,t){t.parentNode.classList.add("invisible")},v.displayList=function(){M.request("GetUserNames",{list:C.get("sharedwith")},function(e){x.reset(e),document.getElementById("sharelist").classList.remove("invisible")})},v.place(q),v}});