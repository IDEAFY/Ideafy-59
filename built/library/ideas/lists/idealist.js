/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Store","CouchDBView","service/config","Bind.plugin","Event.plugin","service/utils","service/avatar","service/actionbar","Promise"],function(e,t,n,i,s,a,o,r,c,l){function d(e,r,d,u){var p=new n([]),g=new t,h=null,m={db:e,view:d,design:r,query:{descending:!0}},f=i.get("user"),v=i.get("labels"),b=this;p.setTransport(i.get("transport")),u&&(m.query=u),this.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,value.doc.authors"></div><h2 data-listideas="bind:innerHTML,value.doc.authornames" data-display="bind:setAuthornames, mosaic"></h2><span class="date" data-listideas="bind:date, value.doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,value.doc.title"></h3><p data-listideas="bind:innerHTML, value.doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, value.doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, value.rating"></span></div></li></ul></div>',m.query.q&&(this.template='<div><div class="noresult date invisible" data-labels="bind:innerHTML, noresult"></div><ul class="idea-list" data-listideas="foreach"><li class="list-item" data-listevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class="item-header"><div class="avatar" data-listideas="bind:setAvatar,doc.authors"></div><h2 data-listideas="bind:innerHTML,doc.authornames" data-display="bind:setAuthornames, mosaic"></h2><span class="date" data-listideas="bind:date, doc.creation_date"></span></div><div class="item-body"><h3 data-listideas="bind:innerHTML,doc.title"></h3><p data-listideas="bind:setDesc, doc.description"></p></div><div class="item-footer"><a class="idea-type private" data-listideas="bind:setVisibility, doc.visibility"></a><a class="item-acorn"></a><span class="rating" data-listideas="bind:setRating, rating"></span></div></li></ul></div>'),b.plugins.addAll({labels:new s(v),listideas:new s(p,{date:function w(w){this.innerHTML=w?o.formatDate(w):""},setDesc:function(e){this.innerHTML=e.replace(/\n/g,"<br>")},setRating:function(e){if(void 0===e){var t=this.getAttribute("data-listideas_id"),n=p.get(t).doc.votes||[];this.innerHTML=0===n.length?"0":Math.round(100*(n.reduce(function(e,t){return e+t})/n.length))/100}else this.innerHTML=Math.round(100*e)/100},setAvatar:function(){},setVisibility:function(e){"public"===e?this.classList.add("public"):this.classList.remove("public")}}),display:new s(g,{setAuthornames:function(e){var t=this.getAttribute("data-listideas_id"),n=p.get(t).value.doc.authornames,i=p.get(t).value.doc.authors;this.innerHTML=e&&i.length>1?n.split(",")[0]+v.get("andothers"):n}}),listevent:new a(this)}),b.getModel=function(){return p},b.resetQuery=function(e){var t=new l,n=b.dom.querySelector(".noresult"),s=i.get("user").get("library-favorites")||[],a={idList:s};return m.query=e,p.unsync(),p.reset([]),"fav"===u?i.get("transport").request("GetFavList",a,function(i){var s,a,o,r=JSON.parse(i);if(e&&"*"!==e)for(s=0,a=r.length;a>s;s++)o=r[s].value.doc.lang.substring(0,2),e===o&&p.alter("push",r[s]);else p.reset(r);p.getNbItems()?n.classList.add("invisible"):n.classList.remove("invisible"),t.fulfill()}):p.sync(m.db,m.design,m.view,m.query).then(function(){h&&h.hide(),p.getNbItems()?n.classList.add("invisible"):n.classList.remove("invisible"),t.fulfill()}),t},b.setStart=function(e,t){var n=document.getElementById("ideas");h&&(h.hide(),h=null),n.classList.contains("mosaic")&&(n.classList.remove("mosaic"),t.scrollIntoView())},b.setLang=function(e){var t;if("fav"===u)t=e;else switch(d){case"_view/ideas":t="*"===e?{key:'"'+f.get("_id")+'"',descending:!0}:{key:'[0,"'+f.get("_id")+'","'+e+'"]',descending:!0};break;case"_view/privatebyvotes":t="*"===e?{endkey:'[0,"'+f.get("_id")+'"]',startkey:'[0,"'+f.get("_id")+'",{},{}]',descending:!0}:{endkey:'[1,"'+f.get("_id")+'"]',startkey:'[1,"'+f.get("_id")+'","'+e+'",{},{}]',descending:!0}}return b.resetQuery(t)},b.setMosaic=function(e){e?g.set("mosaic",!0):g.set("mosaic",!1)},b.showActionBar=function(e,t){var n,i=t.getAttribute("data-listideas_id"),s=document.getElementById("ideas"),a=!1;h&&h.getParent()===t&&(a=!0),s.classList.contains("mosaic")||a||(h=new c("idea",t,p.get(i).id),n=document.createDocumentFragment(),h.place(n),t.appendChild(n),a=!0)},b.init=function(){var e=new l,t=f.get("library-favorites")||[],n={idList:t},s=b.dom.querySelector(".noresult");return"fav"===u?t.length?i.get("transport").request("GetFavList",n,function(t){p.reset(JSON.parse(t)),s.classList.add("invisible"),e.fulfill()}):(p.reset([]),s.classList.remove("invisible"),e.fulfill()):p.sync(m.db,m.design,m.view,m.query).then(function(){p.getNbItems()?s.classList.add("invisible"):s.classList.remove("invisible"),e.fulfill()}),e}}return function(t,n,i,s){return d.prototype=new e,new d(t,n,i,s)}});