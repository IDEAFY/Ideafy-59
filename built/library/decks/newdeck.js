/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","lib/spin.min","service/utils"],function(e,t,n,i,s,a,o,r){return function(t){var c,l=new e,d=new a({}),u=s.get("user"),p=new a(s.get("userLanguages")),g=function(){var e=u.get("lang").substring(0,2);d.set("default_lang",e),p.loop(function(t,n){t.name===e?p.update(n,"selected",!0):p.update(n,"selected",!1)})},h=(s.get("transport"),s.get("labels")),m=new a({error:""}),f=new o({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin(),v=60,b=60,w=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=v/t,t=v):(t*=b/n,n=b),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},y=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),o=a.getContext("2d"),r=v,c=b;s.src=e,setTimeout(function(){a.width=r,a.height=c,n=Math.floor(Math.max(0,(s.width-r)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),o.drawImage(s,n,i,r,c,0,0,r,c),t(a.toDataURL("image/png"))},300)},L=function(){var e="/upload",t=new FormData,n="deckpic",i="decks",s=c;t.append("type",n),t.append("dir",i),t.append("filename",d.get("_id")),t.append("dataString",s),r.uploadFile(e,t,null,function(e){console.log(e)})};return d.setTransport(s.get("transport")),g(),l.plugins.addAll({newdeck:new n(d,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")}}),select:new n(p,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new n(h),errormsg:new n(m,{setError:function(e){switch(e){case"notitle":this.innerHTML=h.get("titlefield")+h.get("emptyfielderror");break;case"nodesc":this.innerHTML=h.get("descriptionfield")+h.get("emptyfielderror");break;default:this.innerHTML=e}this.setAttribute("style","color: #F27B3D;")}}),newdeckevent:new i(l)}),l.template='<div id="newdeck-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createdecklbl"></span><div class="close-popup" data-newdeckevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-newdeck="bind: displayLang, default_lang" data-newdeckevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-newdeckevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><input maxlength=40 type="text" class="input newideatitle" data-labels="bind:placeholder, decktitleplaceholder" data-newdeck="bind: value, title" data-newdeckevent="listen: input, resetError"><textarea class="description input" data-labels="bind:placeholder, deckdescplaceholder" data-newdeck="bind: value, description" data-newdeckevent="listen: input, resetError"></textarea><legend data-labels="bind: innerHTML, setdecklogo"></legend><div class="deckicon"><div class="decklogo"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-newdeckevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-labels="bind:innerHTML, importlbl" data-newdeckevent="listen: mousedown, press; listen: mouseup, release"></div></span></div><div class="newidea-footer"><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-newdeckevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></form></div>',l.reset=function(){d.reset({_id:"",type:9,description:"",default_lang:u.get("lang"),content:{characters:["newcard"],contexts:["newcard"],problems:["newcard"],techno:["newcard"]},title:"",version:0,date:[],picture_file:"",translations:{},created_by:u.get("_id"),author:u.get("username"),"public":!1,sharedwith:[]}),c=null},l.show=function(){l.reset(),document.querySelector("#library .cache").classList.add("appear"),l.dom.classList.add("appear")},l.press=function(e,t){t.classList.add("pressed")},l.showLang=function(){l.dom.querySelector(".idealang ul").classList.remove("invisible")},l.selectFlag=function(e,t){var n;e.stopPropagation(),n=parseInt(t.getAttribute("data-select_id"),10),p.loop(function(e,t){n===t?p.update(t,"selected",!0):p.update(t,"selected",!1)})},l.setLang=function(e,t){var n;e.stopPropagation(),n=t.getAttribute("data-select_id"),d.set("default_lang",p.get(n).name),l.dom.querySelector(".idealang ul").classList.add("invisible")},l.selectpress=function(e,t){t.value=""},l.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},l.uploadnDisplay=function(e,t){var n=new FileReader,i=new Image,s=l.dom.querySelector(".decklogo"),a=new o({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();s.setAttribute("style","background-image: none;"),a.spin(s),n.onload=function(e){i.src=e.target.result,setTimeout(function(){y(w(i),function(e){s.setAttribute("style","background-image: url('"+e+"')"),a.stop(),c=e,d.set("picture_file","decklogo")})},300)},n.readAsDataURL(t.files[0])},l.closePopup=function(){l.dom.classList.remove("appear"),document.querySelector("#library .cache").classList.remove("appear"),d.unsync(),l.reset(),m.reset({error:""})},l.resetError=function(e,t){var n;t.scrollTop=99999,m.get("error")&&(n=t.classList.contains("description")?"nodesc":t.classList.contains("solution")?"nosol":"notitle",m.get("error")===n&&t.value&&m.set("error",""))},l.cancel=function(){l.closePopup()},l.upload=function(e,n){var i=new Date,a="D:"+i.getTime();n.classList.remove("pressed"),d.get("title")?d.get("description")||m.set("error","nodesc"):m.set("error","notitle"),m.get("error")||d.get("_id")||(n.classList.add("invisible"),f.spin(n.parentNode),d.set("_id",a),d.set("date",[i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds()]),d.sync(s.get("db"),a).then(function(){return d.get("picture_file")&&L(),d.upload()}).then(function(){t("new",a);var e=u.get("custom_decks")||[];return e.unshift(a),u.set("custom_decks",e),u.upload()}).then(function(){f.stop(),n.classList.remove("invisible"),l.closePopup()}))},l.reset(),l}});