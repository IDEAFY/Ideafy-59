/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","Place.plugin","Amy/Stack-plugin","Store","service/map","./deckdetails","./cardlist","service/config","./cardeditor/newcard","./deck-share"],function(e,t,n,i,s,a,o,r,c,l,d,u){return function(o){var p=new e,g=new d(o),h=new u,m=new a([{name:"characters",active:!1,count:0},{name:"contexts",active:!1,count:0},{name:"problems",active:!1,count:0},{name:"techno",active:!1,count:0}]),f=new s,v="",b="";return p.plugins.addAll({cardmenu:new t(m,{setClass:function(e){e&&this.classList.add(e)},setActive:function(e){e?this.classList.add("active"):this.classList.remove("active")}}),place:new i({newCard:g,shareDeck:h}),deckviewstack:f,deckviewevent:new n(p)}),p.template='<div id="deckview" class="details"><div data-place="place: newCard"></div><div data-place="place: shareDeck"></div><ul class="card-menu" data-cardmenu="foreach"><li><div class="card-type" data-cardmenu = "bind: setClass, name; bind:setActive, active" data-deckviewevent="listen: mousedown, viewCards"></div><div class="card-count" data-cardmenu="bind:innerHTML, count"></div></li></li></ul><div id="deckviewstack" data-deckviewstack="destination"></div></div>',p.viewCards=function(e,t){var n=t.getAttribute("data-cardmenu_id");m.loop(function(e,t){t===parseInt(n)?m.update(t,"active",!0):m.update(t,"active",!1)}),f.getStack().show(m.get(n).name)},p.editCard=function(e,t){g.reset(e,t,b,v)},p.hideEditView=function(){g&&g.close()},p.reset=function(e,t){p.hideEditView(),h.hide(),p.dom.setAttribute("style","overflow-y: none;"),["details","characters","contexts","problems","techno"].forEach(function(t){f.getStack().get(t).reset(e)}),b=e._id,v=e.title,m.reset([]),["characters","contexts","problems","techno"].forEach(function(t){"newcard"===e.content[t][0]?m.alter("push",{name:t,active:!1,count:e.content[t].length-1}):m.alter("push",{name:t,active:!1,count:e.content[t].length})}),t?f.getStack().show(t):f.getStack().show("details")},p.init=function(){f.getStack().add("details",new r(o)),f.getStack().add("characters",new c("characters",p.editCard,o)),f.getStack().add("contexts",new c("contexts",p.editCard,o)),f.getStack().add("problems",new c("problems",p.editCard,o)),f.getStack().add("techno",new c("techno",p.editCard,o))},l.get("observer").watch("deck-share",function(e){h.reset(e),h.show()}),p}});