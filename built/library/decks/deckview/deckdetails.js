/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","service/utils","CouchDBDocument","CouchDBView","lib/spin.min"],function(e,t,n,i,s,a,o,r,c){return function(l){var d,u,p=new e,g=new s,h=new s({max:0}),m=new s([]),f=new r,v=new c({top:255,left:297,lines:8,radius:6,color:"#cccccc"}).spin(),b=t.get("user"),w=t.get("labels"),y=new s(t.get("userLanguages")),L=function(){y.loop(function(e,t){g.get("default_lang")&&e.name===g.get("default_lang").substring(0,2)?y.update(t,"selected",!0):y.update(t,"selected",!1)})},k=60,S=60,T=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=k/t,t=k):(t*=S/n,n=S),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},M=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),o=a.getContext("2d"),r=k,c=S;s.src=e,setTimeout(function(){a.width=r,a.height=c,n=Math.floor(Math.max(0,(s.width-r)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),o.drawImage(s,n,i,r,c,0,0,r,c),t(a.toDataURL("image/png"))},300)},x=function(){var e="/upload",t=new FormData,n="deckpic",i=u;t.append("type",n),t.append("dir","decks"),t.append("filename",g.get("_id")),t.append("dataString",i),a.uploadFile(e,t,null,function(e){return e})};return f.setTransport(t.get("transport")),p.plugins.addAll({labels:new n(w),range:new n(h,{setCursorWidth:function(){}}),cards:new n(m,{setStyle:function(e){e&&"null"===e?this.classList.add("invisible"):this.classList.remove("invisible")},formatTitle:function(e){var t,n=this;e&&(t=n.getAttribute("data-cards_id"),m.get(t).type&&4!==m.get(t).type?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;")))},setPic:function(e){var n,i,s=this;e&&e.search("img/decks/")>-1?this.setAttribute("style","background-image:url('"+e+"');"):e?(i=new c({color:"#657b99"}).spin(s),n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');"),i.stop()})):this.setAttribute("style","background-image: none;")}}),deckdetails:new n(g,{displayLang:function(e){var t;e?(p.dom.querySelector(".idealang").classList.remove("invisible"),t=e.substring(0,2),this.setAttribute("style","background-image:url('img/flags/"+t+".png');")):p.dom.querySelector(".idealang").classList.add("invisible")},formatDate:function(e){this.innerHTML=e?a.formatDate(e):""},setPic:function(e){var n,i,s=this;""===e?this.setAttribute("style","background-image:url('img/connect/graygroup.png');"):"img/logo.png"===e?this.setAttribute("style","background-image:url('img/logo.png');"):"decklogo"===e&&(i=new c({color:"#657b99"}).spin(s),n={dir:"decks",filename:g.get("_id")},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');"),i.stop()})),g.get("created_by")===b.get("_id")&&s.querySelector("input").classList.remove("invisible")},edit:function(e){e===b.get("_id")?(this.setAttribute("contenteditable",!0),this.classList.add("editable")):(this.setAttribute("contenteditable",!1),this.classList.remove("editable"))}}),select:new n(y,{setBg:function(e){e&&this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),carouselevent:new i(p),editevent:new i(p)}),p.template='<div class="deckdetails"><div class="deckinfo"><div class="deckheader"><div class="idealang invisible"><div class="currentlang" data-deckdetails="bind: displayLang, default_lang" data-editevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-editevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><div class="decklogo" data-deckdetails="bind: setPic, picture_file" data-editevent="listen: mousedown, editPic"><input class="invisible" type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: change, changePic"></div><p><h2 data-deckdetails="bind:innerHTML, title; bind: edit, created_by" data-editevent="listen:input, displayButtons"></h2><span data-labels="bind:innerHTML, designedby"></span><span data-deckdetails="bind: innerHTML, author"></span></p><span class="date" data-deckdetails="bind:formatDate,date"></span></div><div class="deckbody"><p class="deckdescription" data-deckdetails="bind: innerHTML, description; bind: edit, created_by" data-editevent="listen:input, displayButtons"></p><div class="cancelmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-labels="bind:innerHTML, cancellbl"></div><div class="sendmail invisible" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, savelbl">Save</div></div></div><div class="deckcarousel"><div class="innercarousel"><ul data-cards="foreach"><li data-cards="bind: setStyle,style"><div class="card"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div></div></li></ul><input class="deckslider invisible" type="range" value=0 min=0 data-range="bind: max, max; bind: setCursorWidth, max" data-carouselevent="listen: input, updateCards"></div></div></div>',p.displayCards=function(e){var t,n=[];for(m.reset([]),t=0;5>t;t++)n[t]=f.get(e-2+t)?f.get(e-2+t).value:{style:"null"};m.reset(n),v.stop()},p.updateCards=function(e,t){p.displayCards(t.value)},p.displayButtons=function(){p.dom.querySelector(".cancelmail").classList.remove("invisible"),p.dom.querySelector(".sendmail").classList.remove("invisible")},p.hideButtons=function(){p.dom.querySelector(".cancelmail").classList.add("invisible"),p.dom.querySelector(".sendmail").classList.add("invisible")},p.editPic=function(e,t){g.get("created_by")===b.get("_id")&&(t.setAttribute("style","background-image: url('img/brainstorm/reload.png')"),document.body.onfocus=function(){t.querySelector("input").value.length||(g.set("picture_file",""),g.set("picture_file",d.picture_file)),document.body.onfocus=null})},p.showLang=function(){g.get("created_by")===b.get("_id")&&p.dom.querySelector(".idealang ul").classList.remove("invisible")},p.selectFlag=function(e,t){var n;e.stopPropagation(),e.preventDefault(),n=parseInt(t.getAttribute("data-select_id"),10),y.loop(function(e,t){n===t?y.update(t,"selected",!0):y.update(t,"selected",!1)})},p.setLang=function(e,t){var n;e.stopPropagation(),e.preventDefault(),n=t.getAttribute("data-select_id"),g.set("default_lang",y.get(n).name),g.get("default_lang")!==d.default_lang.substring(0,2)?p.displayButtons():p.hideButtons(),p.dom.querySelector(".idealang ul").classList.add("invisible")},p.changePic=function(e,t){var n=new FileReader,i=new Image,s=p.dom.querySelector(".decklogo"),a=new c({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();s.setAttribute("style","background-image: none"),a.spin(s),n.onload=function(e){i.src=e.target.result,setTimeout(function(){M(T(i),function(e){s.setAttribute("style","background-image: url('"+e+"')"),a.stop(),u=e,p.displayButtons()})},300)},t.files.length?n.readAsDataURL(t.files[0]):t.querySelector("input").classList.add("invisible")},p.press=function(e,t){t.classList.add("pressed")},p.cancel=function(e,t){g.reset(d),p.hideButtons(),t.classList.remove("pressed")},p.upload=function(e,n){var i=new o,s=p.dom.querySelector(".deckheader h2").innerHTML,a=p.dom.querySelector(".deckdescription").innerHTML,r=new c({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-6,left:30}).spin(n);n.classList.add("invisible"),i.setTransport(t.get("transport")),i.sync(t.get("db"),g.get("_id")).then(function(){var e=new Date;return u&&(x(),i.set("picture_file","decklogo")),i.set("title",s),i.set("description",a),i.set("last_updated",[e.getFullYear(),e.getMonth(),e.getDate()]),i.upload()}).then(function(){l("updated",i.get("_id")),p.hideButtons(),n.classList.remove("pressed"),r.stop()}),u&&x()},p.reset=function(e){var n=p.dom.querySelector(".deckslider");p.dom.querySelector(".cancelmail").classList.add("invisible"),p.dom.querySelector(".sendmail").classList.add("invisible"),u=null,g.set("picture_file",""),g.reset(e),L(),d=JSON.parse(g.toJSON()),h.set("max",0),v.spin(p.dom.querySelector(".deckcarousel")),f.reset([]),f.sync(t.get("db"),"library","_view/cards",{key:'"'+g.get("_id")+'"'}).then(function(){f.getNbItems()?n.classList.remove("invisible"):n.classList.add("invisible"),f.getNbItems()&&h.set("max",f.getNbItems()-1),f.unsync(),f.alter("sort",function(e,t){var n=e.value.title,i=t.value.title;return i>n?-1:n>i?1:n===i?0:void 0}),p.displayCards(0)})},p}});