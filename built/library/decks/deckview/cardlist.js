/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","CouchDBBulkDocuments","CouchDBDocument","Store","service/cardpopup","Promise"],function(e,t,n,i,s,a,o,r,c){return function(l,d,u){var p,g=new e,h=new o([]),m=new o([]),f=new o({currentPage:0,nbPages:0}),v=t.get("labels"),b=t.get("user"),w=null,y=null;return g.plugins.addAll({pagination:new n(f,{setPage:function(e){var t=e+1;this.innerHTML=f.get("nbPages")>1?v.get("page")+t+" / "+f.get("nbPages"):""},setLeft:function(e){e>0?this.classList.remove("invisible"):this.classList.add("invisible")},setRight:function(e){e<f.get("nbPages")-1?this.classList.remove("invisible"):this.classList.add("invisible")}}),cards:new n(m,{formatTitle:function(e){e?(this.classList.remove("newcard"),"techno"!==l?this.innerHTML=e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase():(this.innerHTML=e.toUpperCase(),this.setAttribute("style","font-family:Helvetica;"))):this.classList.add("newcard")},setPic:function(e){var n,i=this;if(e&&e.search("img/decks/")>-1)this.setAttribute("style","background-image:url('"+e+"');");else if(e)n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){i.setAttribute("style","background:white; background-image: url('"+e+"'); background-repeat: no-repeat; background-position: center center; background-size:contain;")});else switch(l){case"characters":this.classList.add("newchar");break;case"contexts":this.classList.add("newctx");break;case"problems":this.classList.add("newpb");break;case"techno":this.classList.add("newtech");break;default:this.setAttribute("style","background-image: none;")}}}),cardlistevent:new i(g)}),g.template='<div class="cardlist"><div id="cardlist-popup" class="invisible"></div><div class="cardpage" data-cardlistevent="listen:dblclick, changePage"><div class="pagenb"><div class="leftcaret" data-pagination="bind: setLeft, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, previousPage"></div><span data-pagination="bind: setPage, currentPage"></span><div class = "rightcaret" data-pagination="bind: setRight, currentPage" data-cardlistevent="listen:mousedown, push; listen:mouseup, nextPage"></div></div><ul data-cards="foreach"><li class="card" data-cardlistevent="listen:mousedown, highlight; listen:mouseup, zoom"><div class="cardpicture" data-cards="bind:setPic,picture_file"></div><div class="cardtitle" data-cards="bind: formatTitle, title"></div><div class="cardbtnbar invisible"><div class="editcardbtn" data-cardlistevent="listen: mousedown, press; listen:mouseup, editCard"></div><div class="deletecardbtn " data-cardlistevent="listen: mousedown, press; listen:mouseup, deleteCard"></div></div></li></ul></div></div>',g.reset=function(e){y=null,g.dom.querySelector("#cardlist-popup").classList.add("invisible"),w=e,g.getCardList(e.content[l])},g.getCardList=function(e){var n=new s,i=e,a=new c;return"newcard"===e[0]&&(i=e.slice(1,e.length)),i.length?(n.setTransport(t.get("transport")),n.sync(t.get("db"),{keys:i}).then(function(){"newcard"===e[0]?h.reset([{_id:"newcard",title:"",picture_file:""}]):h.reset([]),n.loop(function(e){h.alter("push",e.doc)}),f.set("nbPages",Math.ceil(h.getNbItems()/12)),g.displayPage(0),a.fulfill(),n.unsync()})):(h.reset([{_id:"newcard",title:"",picture_file:""}]),f.set("nbPages",1),g.displayPage(0),a.fulfill()),a},g.displayPage=function(e){var t,n=h.getNbItems()-12*e;for(f.set("currentPage",e),m.reset([]),t=0;n>t;t++)m.alter("push",h.get(12*e+t))},g.removeCard=function(e){var n,i,s,o,r=new a,d=new a,p=!0;b.get("active_deck")===w._id&&(n=w.content.characters.length,i=w.content.contexts.length,s=w.content.problems.length,o=w.content.techno.length,(2>=n||2>=i||2>=s||4>=o)&&(p=!1,alert(v.get("cannotremovecard")))),p&&(r.setTransport(t.get("transport")),d.setTransport(t.get("transport")),r.sync(t.get("db"),w._id).then(function(){var t=r.get("content"),n=t[l];return n.splice(n.indexOf(e),1),t[l]=n,r.set("content",t),r.upload()}).then(function(){return u("updated",w._id,l),r.unsync(),d.sync(t.get("db"),e)}).then(function(){var e,n=d.get("deck"),i=new c,s=d.get("picture_file");return n.splice(n.indexOf(w._id),1),n.length?(d.set("deck",n),d.upload().then(function(){i.fulfill()})):(-1===s.search("img/decks")&&(e={type:"card",file:s},t.get("transport").request("DeleteAttachment",e,function(e){"ok"!==e&&console.log(e)})),d.remove().then(function(){i.fulfill()})),i}))},g.push=function(e,t){t.classList.add("invisible"),e.stopPropagation()},g.press=function(e,t){t.classList.add("pressed")},g.previousPage=function(){g.displayPrevious()},g.nextPage=function(){g.displayNext()},g.displayPrevious=function(){var e=f.get("currentPage");e>0&&g.displayPage(e-1)},g.displayNext=function(){var e=f.get("currentPage");e<f.get("nbPages")-1&&g.displayPage(e+1)},g.changePage=function(e){var t=[e.pageX,e.pageY];t[0]>(document.width+301)/2?g.displayNext():g.displayPrevious()},g.highlight=function(e,t){null!==y&&document.querySelector("li[data-cards_id='"+y+"']").classList.remove("highlighted"),y=t.getAttribute("data-cards_id"),t.classList.add("highlighted")},g.zoom=function(e,t){var n=t.getAttribute("data-cards_id");"newcard"===m.get(n)._id?(d("newcard",l),t.classList.remove("highlighted")):(g.setPopup(n),b.get("_id")===w.created_by&&(t.querySelector(".cardbtnbar").classList.remove("invisible"),m.get(n).created_by===b.get("_id")?t.querySelector(".editcardbtn").classList.remove("invisible"):t.querySelector(".editcardbtn").classList.add("invisible")))},g.editCard=function(e,t){var n=t.getAttribute("data-cards_id");e.stopPropagation(),p.close(),t.parentNode.classList.add("invisible"),d(m.get(n)._id,l)},g.deleteCard=function(e,t){var n=t.getAttribute("data-cards_id");e.stopPropagation(),p.close(),t.parentNode.classList.add("invisible"),g.removeCard(m.get(n)._id)},g.setPopup=function(e){var t,n={x:0,y:0},i="";switch(t=e%12){case 1:n.x=304,n.y=157,i="left";break;case 2:n.x=23,n.y=157,i="right";break;case 3:n.x=170,n.y=157,i="right";break;case 4:n.x=157,n.y=339,i="left";break;case 5:n.x=304,n.y=339,i="left";break;case 6:n.x=23,n.y=339,i="right";break;case 7:n.x=170,n.y=339,i="right";break;case 8:n.x=157,n.y=350,i="left";break;case 9:n.x=304,n.y=350,i="left";break;case 10:n.x=23,n.y=350,i="right";break;case 11:n.x=170,n.y=350,i="right";break;default:n.x=157,n.y=157,i="left"}p.reset(m.get(e),n,i,document.getElementById("cardlist-popup"))},g.closePopup=function(){g.dom.querySelector("li[data-cards_id='"+y+"']").classList.remove("highlighted"),g.dom.querySelector("li[data-cards_id='"+y+"']").querySelector(".cardbtnbar").classList.add("invisible"),y=null},p=new r(g.closePopup),g}});