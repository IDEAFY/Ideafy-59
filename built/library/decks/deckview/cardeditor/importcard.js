/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","CouchDBView","Promise","lib/spin.min","service/confirm","service/map"],function(e,t,n,i,s,a,o,r,c,l){return function(d,u){var p,h=new e,g=t.get("labels"),m=t.get("user"),f=t.get("transport"),v=t.get("db"),b=new s([]),w=new s([]),y=[],L=new s;return h.template='<div class="importcard"><div class="importfrom"><label data-label="bind:innerHTML, importfrom"></label><select data-model="bind:setDecks, decks" data-importevent="listen: change, updateSelect"></select></div><div class="importlist"><legend data-label="bind:innerHTML, seldeck"></legend><ul name="selected" data-selected="foreach"><li name="selected" data-selected="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="importarea"><button class="addremove invisible" data-model="bind: setVisible, sel; bind: setDirection, direction" data-importevent="listen: mouseup , addRemoveSelected">Add/remove</button><button class="invisible" data-label="bind:innerHTML, selall" data-model="bind:setVisible, sel" data-importevent="listen: mouseup , selectAll"></button><button class="invisible" data-label="bind:innerHTML, clearsel" data-model="bind: setVisible, sel" data-importevent="listen: mouseup , clearSelected">Clear selection</button></div><div class="importlist"><legend data-label="bind:innerHTML, workdeck"></legend><ul data-current="foreach"><li name="current" data-current="bind: setType, type; bind: innerHTML, title; bind: setSelected, selected" data-importevent="listen: mouseup , toggleSelect"></li></ul></div><div class="cancelmail" data-importevent="listen:mousedown, press; listen:mouseup , cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-importevent="listen:mousedown, press; listen:mouseup , upload" data-label="bind:innerHTML, savelbl">Save</div></div>',h.plugins.addAll({label:new n(g),model:new n(L,{setDecks:function(e){var t,n,i="";if(e)for(t=0,n=e.length;n>t;t++)e[t]._id!==p&&(i+="<option>"+e[t].title+"</option>");this.innerHTML=i},setDirection:function(e){e?node.classList.remove("invisible"):node.classList.add("invisible"),this.innerHTML="remove"===e?g.get("remsel"):g.get("impsel")},setVisible:function(e){e?this.classList.remove("invisible"):this.classList.add("invisible")}}),current:new n(b,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;")}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),selected:new n(w,{setType:function(e){switch(e){case 1:this.setAttribute("style","background-image:url('../img/decks/characters.png'); color: #657b99;");break;case 2:this.setAttribute("style","background-image:url('../img/decks/context.png');color:#5f8f28;");break;case 3:this.setAttribute("style","background-image:url('../img/decks/problem.png');color: #bd262c");break;case 4:this.setAttribute("style","background-image:url('../img/decks/technology.png');color: #f27b3d;")}},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),importevent:new i(h)}),h.cancel=function(e,t){t.classList.remove("pressed"),u()},h.upload=function(e,t){var n=new c({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin(t),i=["newcard"],s=["newcard"],a=["newcard"],o=["newcard"];y.length&&f.request("DeleteCards",{idList:y},function(e){return"ok"===e&&(y=[]),e}),b.loop(function(e){switch(e.type){case 1:i.push(e.id);break;case 2:s.push(e.id);break;case 3:a.push(e.id);break;case 4:o.push(e.id);break;default:i.push(e.id)}}),d({characters:i,contexts:s,problems:a,techno:o}).then(function(){n.stop(),t.classList.remove("pressed"),u()})},h.press=function(e,t){t.classList.add("pressed")},h.updateSelect=function(e,t){var n=t.selectedIndex;w.reset([]),h.getDeckCards(L.get("decks")[n]._id,w)},h.toggleSelect=function(e,t){var n,i=t.getAttribute("name"),s=t.getAttribute("data-"+i+"_id"),a=L.get("sel")||0;"current"===i?(n=b,"remove"!==L.get("direction")&&(h.clearSelection("selected"),L.set("direction","remove"),a=0)):(n=w,"add"!==L.get("direction")&&(h.clearSelection("current"),L.set("direction","add"),a=0)),n.get(s).selected?(n.update(s,"selected",!1),L.set("sel",a-1)):(n.update(s,"selected",!0),L.set("sel",a+1))},h.selectAll=function(){var e;e="add"===L.get("direction")?w:b,e.loop(function(t,n){e.update(n,"selected",!0)})},h.clearSelected=function(){var e;e="add"===L.get("direction")?w:b,e.loop(function(t,n){e.update(n,"selected",!1)}),L.set("sel",0)},h.addRemoveSelected=function(){var e=L.get("direction");"add"===e?h.addSelected():h.removeSelected()},h.addSelected=function(){var e=b.toJSON(),t=JSON.parse(e),n=h.dom.querySelector("ul[name='current']"),i=(new c).spin(n);b.reset([]),w.loop(function(n){n.selected&&-1===e.search(n.id)&&t.push({id:n.id,type:n.type,title:n.title,deck:n.deck.concat(),selected:n.selected})}),t.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),b.reset(t),i.stop(),h.clearSelection("selected"),L.set("direction","remove")},h.removeSelected=function(){var e=[],t=[],n="";b.loop(function(n,i){n.selected&&(e.push(i),1===n.deck.length&&n.deck[0]===p&&t.push({title:n.title.toUpperCase(),id:n.id}))}),t.length?(t.forEach(function(e){n+=e.title+", "}),n=n.slice(0,-2),l.reset(g.get("delcardwarning")+n,function(n){n&&(b.delAll(e),h.clearSelection("current"),L.set("sel",0),t.forEach(function(e){y.push(e.id)})),l.hide()},"importcard-confirm"),l.show()):(b.delAll(e),h.clearSelection("current"),L.set("sel",0))},h.clearSelection=function(e){var t;t="current"===e?b:w,t.loop(function(e,n){e.selected&&e.selected===!0&&t.update(n,"selected",!1)})},h.getDecks=function(e){var t=new a,n=m.get("taiaut_decks").concat(m.get("custom_decks")),i=new r;return t.setTransport(f),t.sync(v,{keys:n}).then(function(){var n,s=m.get("lang"),a=[];for(t.loop(function(e){(e.doc.public||e.doc.created_by===m.get("_id")||e.doc.sharedwith&&e.doc.sharedwith.indexOf(m.get("_id")))&&(e.doc.default_lang&&e.doc.default_lang!==s?e.doc.translations&&e.doc.translations[s]?a.push(e.doc.translations[s]):a.push(e.doc):a.push(e.doc))}),n=a.length-1;n>=0;n--)a[n]._id===e&&a.splice(n,1);a.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),L.set("decks",a.concat()),i.fulfill(),t.unsync()}),i},h.getDeckCards=function(e,t){var n=new o,i=new r,s=h.dom.querySelector("ul[name='selected']"),a=(new c).spin(s);return n.setTransport(f),n.sync(v,"library","_view/cards",{key:'"'+e+'"'}).then(function(){var e=[];n.loop(function(t){e.push({id:t.value._id,type:t.value.type,title:t.value.title,deck:t.value.deck})}),e.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),a.stop(),t.reset(e),i.fulfill()}),i},h.reset=function(e){L.reset({}),b.reset([]),w.reset([]),y=[],h.dom.querySelector("select").selectedIndex=0,p=e,h.getDecks(p).then(function(){h.getDeckCards(p,b),h.getDeckCards(L.get("decks")[0]._id,w)})},m.watchValue("taiaut_decks",function(){h.getDecks()}),m.watchValue("custom_decks",function(){h.getDecks()}),m.watchValue("lang",function(){h.getDecks()}),h}});