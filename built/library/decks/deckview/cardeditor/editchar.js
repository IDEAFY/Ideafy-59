/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","CouchDBDocument","Bind.plugin","Event.plugin","Store","service/utils","lib/spin.min"],function(e,t,n,i,s,a,o,r){return function(c,l){var d,u=new e,p=t.get("user"),h=t.get("labels"),g={_id:"",default_lang:p.get("lang"),title:"",gender:0,age:null,firstname:"",lastname:"",location:"",occupation:{description:"",details:[1,"",""]},family:{couple:0,children:0},leisure_activities:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],interests:[{name:"",comment:""},{name:"",comment:""},{name:"",comment:""}],comments:[],type:1,deck:[],created_by:p.get("_id"),created_on:[],picture_file:"img/decks/characters.png",picture_credit:""},m=new n,f={},v=new a({error:""}),b=87,w=87,y=function(e){var t,n,i=document.createElement("canvas"),s=i.getContext("2d");return t=e.width,n=e.height,n>t?(n*=b/t,t=b):(t*=w/n,n=w),i.width=t,i.height=n,s.drawImage(e,0,0,t,n),i.toDataURL("image/png")},L=function(e,t){var n,i,s=new Image,a=document.createElement("canvas"),o=a.getContext("2d"),r=b,c=w;s.src=e,setTimeout(function(){a.width=r,a.height=c,n=Math.floor(Math.max(0,(s.width-r)/2)),i=Math.floor(Math.max(0,(s.height-c)/2)),o.drawImage(s,n,i,r,c,0,0,r,c),t(a.toDataURL("image/png"))},300)},k=function(){var e="/upload",t=new FormData,n="cardpic",i="cards",s=d;t.append("type",n),t.append("dir",i),t.append("filename",m.get("_id")),t.append("dataString",s),o.uploadFile(e,t,null,function(e){"ok"!==e.response&&console.log(e)})},S=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-7,left:28}).spin();return m.setTransport(t.get("transport")),u.plugins.addAll({label:new i(h),model:new i(m,{setTitle:function(e){e&&""!==e&&"<br>"!==e?(this.innerHTML=e.toUpperCase(),this.setAttribute("style","color: white;")):(this.innerHTML=h.get("cardtitle"),this.setAttribute("style","color: whitesmoke;"))},setPic:function(e){var n,i,s=this;e&&e.search("img/decks/")>-1?(i="background-image:url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;",s.setAttribute("style",i)):e&&(n={dir:"cards",filename:e},t.get("transport").request("GetFile",n,function(e){s.setAttribute("style","background-image: url('"+e+"');background-repeat: no-repeat; background-position: center center; background-size: cover;")}))},setAge:function(e){e||0===e||(this.innerHTML="",this.setAttribute("placeholder","age"))},setCity:function(e){var t="";e&&e.length?(t=e.split(",")[0].trim(),this.value=t):this.value=""},setCountry:function(e){var t="";e&&e.length?(t=e.split(",").slice(1,e.length).join().trim(),this.value=t):this.value=""},setFamilyStatus:function(e){(e||0===e)&&(this.selectedIndex=e)},setChildren:function(e){(e||0===e)&&(this.selectedIndex=e)},setChildrenlbl:function(e){this.innerHTML=e&&"1"===e?h.get("onechildlbl"):h.get("childrenlbl")},setSituation:function(e){e&&e.length&&(this.selectedIndex=e[0])},setLeisureName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].name)})},setLeisureDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].comment)})},setInterestName:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].name)})},setInterestDesc:function(e){var t=this,n=t.getAttribute("name");[0,1,2].forEach(function(i){e[i]&&n.search(i)>0&&(t.value=e[i].comment)})},setComment:function(e){var t=this,n=t.getAttribute("name");[0,1].forEach(function(i){e&&e[i]&&n.search(i)>0&&(t.value=e[i])})}}),error:new i(v),editevent:new s(u)}),u.template='<div class="cardpopup editchar"><div class="card-detail"><div class="cd-header blue-dark"><div name="title" data-model="bind: setTitle, title" data-editevent="listen: mousedown, clearDefault; listen: blur, updateTitle" contenteditable=true></div></div><div class="cd-picarea"><div class="cardpicture" data-model="bind:setPic, picture_file"></div><span class="importbutton"><input type="file" enctype="multipart/form-data" accept = "image/gif, image/jpeg, image/png" data-editevent="listen: mousedown, selectpress; listen: change, uploadnDisplay"><div data-label="bind:innerHTML, importlbl"></div></span><input class="input" type="text" name="picture_credit" data-label="bind: placeholder,picturecredit" data-model="bind: value, picture_credit" data-editevent="listen: input, updateField"></div><table class="cardinfo"><tr class="charname"><th></th><td><input class="input" name="firstname" type="text" data-label="bind: placeholder,firstnameplaceholder" data-model="bind: value, firstname" data-editevent="listen: input, updateField"></td><td><input class="input" type="text" name="lastname" data-label="bind: placeholder,lastnameplaceholder" data-model="bind: value, lastname" data-editevent="listen: input, updateField"></td></tr><tr class="age"><th></th><td><input class="input" type="number" name="age" maxlength=3 size=4 data-model="bind: setAge, age; bind: value, age"></td></tr><tr class="loc"><th></th><td><input class="input city" name="city" type="text" data-label="bind:placeholder, city" data-model="bind:setCity, location" data-editevent="listen:input, updateLocation"></td><td><input class="input" name="country" type="text" data-label="bind:placeholder, countrystate" data-model="bind:setCountry, location" data-editevent="listen:input, updateLocation"></td></tr><tr class="family"><th></th><td><select class="status" name="couple" data-model="bind: setFamilyStatus, family.couple" data-editevent="listen:change, updateFamily"><option data-label="bind:innerHTML, single"></option><option data-label="bind:innerHTML, married"></option><option data-label="bind:innerHTML, divorced"></option><option data-label="bind:innerHTML, widow"></option><option data-label="bind:innerHTML, relation"></option></select></td><td><select class="children" name="children" data-model="bind: setChildren, family.children" data-editevent="listen:change, updateFamily"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8+</option></select><span data-model="bind:setChildrenlbl, family.children"></span></td></tr><tr class="occupation"><th></th><td><select class="status" name="situation" data-model="bind: setSituation, occupation.details" data-editevent="listen:change, updateJob"><option data-label="bind:innerHTML, student"></option><option data-label="bind:innerHTML, active"></option><option data-label="bind:innerHTML, retired"></option><option data-label="bind:innerHTML, unemployed"></option><option data-label="bind:innerHTML, stayathome"></option></select></td><td><textarea class="input" type="text" name="jobdesc" data-label="bind: placeholder, desc" data-model="bind:value, occupation.description" data-label="bind:placeholder, jobtitle" data-editevent="listen:input, updateJob"></textarea></td></tr></table><div class="cd-contentarea"><legend data-label="bind:innerHTML, hobbieslbl"></legend><input name="leisure0" class="input inputleft" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure0" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input name="leisure1" class="input inputleft" type="text"  data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure1" type="text" data-label="bind:placeholder, desc" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><input class="input inputleft" name="leisure2" type="text" data-label="bind:placeholder, name" data-model="bind: setLeisureName, leisure_activities" data-editevent="listen: input, updateLeisureName"><input class="input description" name="leisure2" type="text" data-label="bind:placeholder, desc" data-label="bind:placeholder, name" data-model="bind: setLeisureDesc, leisure_activities" data-editevent="listen: input, updateLeisureDesc"><legend data-label="bind:innerHTML, interestslbl"></legend><input class="input inputleft" name="interest0" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest0" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest1" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest1" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><input class="input inputleft" name="interest2" type="text" data-label="bind:placeholder, name" data-model="bind: setInterestName, interests" data-editevent="listen: input, updateInterestName"><input class="input description" name="interest2" type="text" data-label="bind:placeholder, desc" data-model="bind: setInterestDesc, interests" data-editevent="listen: input, updateInterestDesc"><legend data-label="bind:innerHTML, commentslbl"></legend><input class="input" name="comment0" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"><input class="input" name="comment1" type="text" data-label="bind:placeholder, addcomment" data-model="bind: setComment, comments" data-editevent="listen: input, updateComments"></div><label class="editerror" data-error="bind:innerHTML, error"></label><div class="cancelmail" data-editevent="listen:mousedown, press; listen:mouseup, cancel" data-label="bind:innerHTML, cancellbl"></div><div class="sendmail" data-editevent="listen:mousedown, press; listen:mouseup, upload" data-label="bind:innerHTML, savelbl"></div></div></div>',u.reset=function(e,n){var i=new Date;d=null,v.set("error",""),f={},m.reset(),"newcard"===n?(m.reset(g),m.set("_id","C:"+i.getTime()),m.set("created_on",[i.getFullYear(),i.getMonth(),i.getDate()]),m.set("deck",[e])):m.sync(t.get("db"),n)},u.clearDefault=function(e,t){var n=t.getAttribute("name");""===m.get(n)&&(t.innerHTML="")},u.updateTitle=function(e,t){var n=t.innerHTML;n=n.charAt(0).toUpperCase()+n.slice(1),m.set("title",n)},u.selectpress=function(e,t){t.value=""},u.release=function(e,t){setTimeout(function(){t.classList.remove("pressed")},300)},u.uploadnDisplay=function(e,t){var n=new FileReader,i=new Image,s=u.dom.querySelector(".cardpicture"),a=new r({color:"#4d4d4d",lines:12,length:12,width:6,radius:10}).spin();s.setAttribute("style","background-image: none"),a.spin(s),n.onload=function(e){i.src=e.target.result,setTimeout(function(){L(y(i),function(e){s.setAttribute("style","background-image: url('"+e+"')"),a.stop(),d=e})},300)},n.readAsDataURL(t.files[0])},u.updateField=function(e,t){var n=t.getAttribute("name");f[n]=t.value},u.updateLocation=function(){var e,t,n=m.get("location");e=u.dom.querySelector("input[name='city']").value||"",t=u.dom.querySelector("input[name='country']").value||"",n=e&&t?e+", "+t:e+t,f.location=n},u.updateFamily=function(e,t){var n=t.getAttribute("name"),i=m.get("family");i[n]=t.selectedIndex,f.family=i},u.updateJob=function(e,t){var n=m.get("occupation"),i=t.getAttribute("name");switch(i){case"situation":n.details[0]=t.selectedIndex;break;case"job":n.details[1]=t.value;break;case"organization":n.details[2]=t.value;break;default:n.description=t.value}f.occupation=n},u.updateLeisureName=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=m.get("leisure_activities");s[i].name=t.value,f.leisure_activities=s},u.updateLeisureDesc=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=m.get("leisure_activities");s[i].comment=t.value,f.leisure_activities=s},u.updateInterestName=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=m.get("interests");s[i].name=t.value,f.interests=s},u.updateInterestDesc=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=m.get("interests");s[i].comment=t.value,f.interests=s},u.updateComments=function(e,t){var n=t.getAttribute("name"),i=n.charAt(n.length-1),s=m.get("comments");s[i]=t.value,f.comments=s},u.press=function(e,t){t.classList.add("pressed")},u.cancel=function(){l()},u.upload=function(e,n){var i=new Date,s=m.get("firstname"),a=m.get("lastname");n.classList.remove("pressed"),v.set("error",""),S.spin(n),m.get("title")||(s&&a?m.set("title",s+" "+a):(s||a)&&m.set("title",s+a)),m.get("title")||v.set("error",h.get("titlerequired")),v.get("error")?S.stop():m.get("_rev")?(m.set("last_modified",[i.getFullYear(),i.getMonth(),i.getDate()]),u.uploadCard(n)):m.sync(t.get("db"),m.get("_id")).then(function(){u.uploadCard()})},u.uploadCard=function(){var e;if(d&&(k(),m.set("picture_file",m.get("_id"))),f!=={})for(e in f)m.set(e,f[e]);m.upload().then(function(){return c(m.get("type"),m.get("_id"))}).then(function(){S.stop(),l(),m.unsync(),m.reset({})})},u}});