/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","service/config","Bind.plugin","Event.plugin","Store","CouchDBBulkDocuments","Promise","service/utils","service/actionbar"],function(e,t,n,i,s,a,o,r,c,l){return function(t){var r=new e,d=n.get("labels"),u=n.get("user"),p=new a([]),g=null;return r.plugins.addAll({labels:new i(d),active:new i(u,{}),decks:new i(p,{setVersion:function(e){this.innerHTML=e?d.get("version")+e:""},setAuthor:function(e){"Taiaut"===e?(this.innerHTML="",this.setAttribute("style","background-image:url('img/logo.png');")):this.innerHTML=e},date:function(e){this.innerHTML=e?c.formatDate(e):""}}),decklistevent:new s(r)}),r.template='<ul id="deck-list" data-decks="foreach"><li class="list-item" data-decklistevent="listen:mousedown, setStart; listen:dblclick, showActionBar"><div class = "decklight"></div><div class="item-header"><h3 data-decks="bind:innerHTML, title"></h3><span class="version" data-decks="bind:setVersion, version"></span></div><div class="item-body"><p data-decks="bind:innerHTML,description"></p></div><div class="item-footer"><label data-labels="bind:innerHTML, designedby"></label><div class="author" data-decks="bind:setAuthor, author"></div><span class="date" data-decks="bind:date, date"></div></div></li></ul>',r.setStart=function(){g&&g.hide()},r.showActionBar=function(e,t){var n,i=t.getAttribute("data-decks_id"),s=!1;g&&g.getParent()===t&&(s=!0),s||(g=new l("deck",t,p.get(i)._id),n=document.createDocumentFragment(),g.place(n),t.appendChild(n),s=!0)},r.reset=function(e){var n=e||null;p.reset([]),r.getDecks(t,n),display=!1},r.getModel=function(){return p},r.getDecks=function(e,t){var i=new o,s=[];switch(e){default:s=u.get("taiaut_decks").concat(u.get("custom_decks"))}i.setTransport(n.get("transport")),i.sync(n.get("db"),{keys:s}).then(function(){var e=u.get("lang"),n=[];i.loop(function(t){t.doc.default_lang&&t.doc.default_lang!==e?t.doc.translations&&t.doc.translations[e]?n.push(t.doc.translations[e]):n.push(t.doc):n.push(t.doc)}),n.sort(function(e,t){var n=e.title,i=t.title;return i>n?-1:n>i?1:n===i?0:void 0}),p.reset(n),t&&t("ok"),i.unsync()})},r.initSelected=function(e,t){var n=r.dom,i=n.querySelector(".list-item[data-decks_id='"+t+"']");e(i),i.classList.add("selected")},r.highlightDeck=function(e,t){var n,i,s=r.dom;return 0===t?(n=s.querySelector(".list-item[data-decks_id='0']"),i=0):(p.loop(function(e,n){e._id===t&&(i=n)}),n=s.querySelector(".list-item[data-decks_id='"+i+"']")),e(n),n.classList.add("selected"),n.scrollIntoView(),i},r.init=function(e){r.reset(e)},u.watchValue("lang",function(){r.getDecks(t)}),r}});