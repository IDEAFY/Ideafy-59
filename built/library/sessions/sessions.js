/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBView","CouchDBDocument","Store","service/utils","service/avatarlist","service/confirm","lib/spin.min","Promise"],function(e,t,n,s,a,o,r,c,l,d,u,p,g){return function(){var h=new e,m=(new e,t.get("sessions")),v=new c,f=a.get("db"),b=a.get("transport"),w=a.get("user"),y=(a.get("avatars"),a.get("labels")),L=new c({}),k="sbydate",S=[],T=[],M="",A=new o,x=new p({color:"#9AC9CD",lines:10,length:10,width:8,radius:10,top:330}).spin();return A.setTransport(b),h.plugins.addAll({label:new n(y),sort:new n(L,{setSelected:function(e){e?this.classList.add("selectsort"):this.classList.remove("selectsort")},setOrder:function(e){e?(this.classList.remove("sort-ascending"),this.classList.add("sort-descending")):(this.classList.remove("sort-descending"),this.classList.add("sort-ascending"))}}),sessions:new n(v,{setMode:function(e){switch(e){case"roulette":this.setAttribute("style","background-image:url('img/brainstorm/roulette-green.png');");break;case"campfire":this.setAttribute("style","background-image:url('img/brainstorm/campfire-orange.png');");break;case"boardroom":this.setAttribute("style","background-image:url('img/brainstorm/boardroom.png');");break;default:this.setAttribute("style","background-image:url('img/library/sessionQuick.png');")}},formatDate:function(e){e&&e.length&&(this.innerHTML=l.formatDate(e))},formatIdeas:function(e){if(e&&1===e.length)this.innerHTML=e[0].title;else if(e&&e.length>1){var t=[];for(i=0;i<e.length;i++)t.push(e[i].title);this.innerHTML=t.join("<br/>")}else this.innerHTML=y.get("noideayet")},setAvatars:function(e){var t,n;e&&(t=new d(e),n=document.createDocumentFragment(),node=this,t.place(n),node.hasChildNodes()?node.replaceChild(n,node.firstChild):node.appendChild(n))},setStatus:function(e){if(e)switch(e){case"completed":this.innerHTML=y.get("completed");break;case"scheduled":this.innerHTML=y.get("scheduled");break;case"deleted":this.innerHTML=y.get("deleted");break;default:this.innerHTML=y.get("inprogress")}},setScore:function(e){this.innerHTML=e>=0?e:""},setSuffix:function(e){this.innerHTML=void 0===e||""===e||null===e?y.get("noscore"):"ip"},showReplay:function(e){"completed"===e?this.setAttribute("style","display: inline-block; background-size: 40px 40px;"):this.setAttribute("style","display: none;")},showDelete:function(e){var t=this.getAttribute("data-sessions_id");e.id!==w.get("_id")?this.setAttribute("style","display: none;"):v.get(t)._id===w.get("sessionInProgress").id?this.setAttribute("style","display: none;"):"deleted"===v.get(t).status?this.setAttribute("style","display: inline-block; background-size: 40px 40px;"):v.get(t).participants&&v.get(t).participants.length>0?this.setAttribute("style","display: none;"):this.setAttribute("style","display: inline-block; background-size: 40px 40px;")}}),sortevent:new s(h),sessionevent:new s(h)}),h.template='<div id="sessions"><div id="session-list" class="list"><div id="sessionlistspinner"></div><div class="header blue-light" data-label="bind: innerHTML, library-sessions"></div><div class="session-tools"><div class="session-sorting"><div id="sbytitle" class="sort-button" data-sort="bind: setSelected, sbytitle.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbytitle"></span><div class="sort-caret" data-sort="bind: setOrder, sbytitle.descending"></div></div><div id="sbydate" class="sort-button" data-sort="bind: setSelected, sbydate.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbydate"></span><div class="sort-caret" data-sort="bind: setOrder, sbydate.descending"></div></div><div id="sbyidea" class="sort-button" data-sort="bind: setSelected, sbyidea.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyidea"></span><div class="sort-caret" data-sort="bind: setOrder, sbyidea.descending"></div></div><div id="sbyscore" class="sort-button" data-sort="bind: setSelected, sbyscore.selected" data-sortevent="listen: mousedown, sort"><span data-label="bind: innerHTML, sbyscore"></span><div class="sort-caret" data-sort="bind: setOrder, sbyscore.descending"></div></div></div><input class="search" type="text" data-label="bind:placeholder, searchsessions" data-sortevent="listen: keypress, search"><div id="sessionsearchresult"></div></div><div class="session-details"><ul data-sessions="foreach"><li class="session-item" data-sessionevent="listen: dblclick, displayActionBar"><table class="session-boxscore"><tr><td class="session-type" data-sessions="bind: setMode, mode"></td><td class="session-info"><p class="session-title" data-sessions="bind: innerHTML, title">Titre de la session</p><p class="session-date" data-sessions="bind: formatDate, date">jj/mm/aaaa</p></td><td class="session-idea" data-sessions="bind:formatIdeas, idea">Idea(s) generated from session</td><td class="avatarlist" data-sessions="bind: setAvatars, participants"></td><td class="session-status" data-sessions="bind:setStatus, status">completed</td><td class="session-score"><span class="points" data-sessions="bind:setScore, score"></span><span data-sessions="bind: setSuffix, score">ip</span></td></tr></table><div class="actionbar" data-sessionevent="listen: mouseup, hideActionBar"><div class="replaysession" name="replay" data-sessions="bind:showReplay, status" data-sessionevent="listen: mousedown, press; listen:mouseup, replay"></div><div class="deletesession" name="delete" data-sessions="bind:showDelete, initiator" data-sessionevent="listen: mousedown, press; listen:mouseup, deleteSession"></div></div></li></ul></div></div></div>',h.sort=function(e,t){var n=t.getAttribute("id");L.get(n).selected?L.set(n,{selected:!0,descending:!L.get(n).descending}):(L.set(k,{selected:!1,descending:L.get(k).descending}),L.set(n,{selected:!0,descending:L.get(n).descending}),k=n),h.sortSessions(n)},h.sortSessions=function(e){var t;if(t=M?T:S,t.length)switch(e){case"sbytitle":l.sortByProperty(t,"title",L.get("sbytitle").descending);break;case"sbydate":l.sortByProperty(t,"date",L.get("sbydate").descending);break;case"sbyidea":l.sortByProperty(t,"idea",L.get("sbyidea").descending);break;case"sbyscore":l.sortByProperty(t,"score",L.get("sbyscore").descending)}v.reset(t)},h.acceptinput=function(e,t){t.removeAttribute("readonly")},h.search=function(e,t){var n=document.getElementById("sessionsearchresult");n.innerHTML="",13===e.keyCode&&(M=t.value,""===M?(h.sortSessions(k),v.reset(S)):(T=l.searchArray(S,M),n.innerHTML=y.get("foundlbl")+" "+T.length+" "+y.get("matchingsessions"),v.reset(T)))},h.displayActionBar=function(e,t){var n=t.getAttribute("data-sessions_id"),i=t.offsetHeight;v.get(n),t.querySelector(".actionbar").setAttribute("style","display: block;margin-top:-"+i+"px;height: "+i+"px;"),setTimeout(function(){t.querySelector(".actionbar").setAttribute("style","display: none;")},2e3)},h.hideActionBar=function(e,t){t.setAttribute("style","display: none;")},h.press=function(e,t){var n=t.getAttribute("data-sessions_id");t.classList.add("pressed"),n&&x.spin(document.getElementById("sessionlistspinner"))},h.replay=function(e,t){var n=t.getAttribute("data-sessions_id"),i=v.get(n).id,s=v.get(n).mode;t.parentNode.setAttribute("style","display: none;"),t.classList.remove("pressed"),x.stop(),a.get("observer").notify("replay-session",i,s)},h.deleteSession=function(e,t){var n=t.getAttribute("data-sessions_id"),i=v.get(n).id,s=function(e){var t=new r,n=new g;return t.setTransport(b),t.sync(f,e).then(function(){var e=t.get("replayIdeas")||[];e.forEach(function(e){var t=new r;t.setTransport(b),t.sync(f,e).then(function(){return t.set("sessionId",t.get("sessionId")+"_deleted"),t.set("sessionReplay",!1),t.upload()}).then(function(){t.unsync()},function(e){console.log(e)})}),b.request("cleanUpSession",i,function(e){e.err&&console.log(e.err),t.remove().then(function(){t.unsync(),n.fulfill()})})}),n},a=y.get("deletereplay"),o=function(e){e?(x.spin(document.getElementById("sessionlistspinner")),s(i).then(function(){x.stop(),u.hide()})):u.hide()};t.classList.remove("pressed"),t.parentNode.setAttribute("style","display: none;"),v.get(n).replayIdeas&&v.get(n).replayIdeas.length?(x.stop(),u.reset(a,o),u.show()):s(i).then(function(){x.stop()})},h.resetSessionData=function(){S=[],A.loop(function(e){var t={id:e.id,title:e.value.title,date:e.value.date,idea:e.value.idea,participants:[],usernames:[],status:e.value.status,score:e.value.score,mode:e.value.mode,replayIdeas:e.value.replayIdeas};for(t.participants.push(e.value.initiator.id),t.usernames.push(e.value.initiator.username),j=0;j<e.value.participants.length;j++)t.participants.push(e.value.participants[j].id),t.usernames.push(e.value.participants[j].username);t.idea&&t.idea.length>1&&l.sortByProperty(t.idea,"title",!1),S.push(t)}),h.sortSessions("sbydate")},h.getMode=function(e){var t;return A.loop(function(n){n.id===e&&(t=n.value.mode)}),t},h.place(m),h.reset=function(){A.unsync(),A.reset(),v.reset([]),L.reset({sbytitle:{selected:!1,descending:!0},sbydate:{selected:!0,descending:!0},sbyidea:{selected:!1,descending:!0},sbyscore:{selected:!1,descending:!0}}),k="sbydate",S=[],T=[],M="",A.sync(f,"library","_view/sessions",{key:'"'+w.get("_id")+'"',descending:!0}).then(function(){h.resetSessionData()})},["added","deleted","updated"].forEach(function(e){A.watch(e,function(){h.resetSessionData(),h.sortSessions(k)})}),h.reset(),h}});