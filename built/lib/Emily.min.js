/*
 Emily <VERSION> http://flams.github.com/emily

 The MIT License (MIT)

 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
*/

define("Tools",[],function(){function e(e,t,s){var n,i;return t?(t.forEach(function(t,a){var o=s(t,e);o>=0&&("undefined"==typeof i||i>o)&&(i=o,n=a)}),n):void 0}return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(e,t,s){return this.loop(e,function(n,i){t[i]&&s||(t[i]=e[i])}),t},count:function(e){var t=0;return this.loop(e,function(){t++}),t},compareObjects:function(e,t){return Object.getOwnPropertyNames(e).sort().join("")==Object.getOwnPropertyNames(t).sort().join("")},compareNumbers:function(e,t){return e>t?1:t>e?-1:0},toArray:function(e){return[].slice.call(e)},loop:function(e,t,s){var n;if(e instanceof Object&&t instanceof Function){if(e instanceof Array)for(n=0;n<e.length;n++)t.call(s,e[n],n,e);else for(n in e)e.hasOwnProperty(n)&&t.call(s,e[n],n,e);return!0}return!1},objectsDiffs:function(e,t){if(e instanceof Object&&t instanceof Object){var s=[],n=[],i=[],a=[];return this.loop(t,function(t,i){"undefined"==typeof e[i]?a.push(i):t!==e[i]?n.push(i):t===e[i]&&s.push(i)}),this.loop(e,function(e,s){"undefined"==typeof t[s]&&i.push(s)}),{updated:n,unchanged:s,added:a,deleted:i}}return!1},jsonify:function(e){return e instanceof Object?JSON.parse(JSON.stringify(e)):!1},clone:function(e){return e instanceof Array?e.slice(0):"object"!=typeof e||null===e||e instanceof RegExp?!1:this.mixin(e,{})},getNestedProperty:function(e,t){return e&&e instanceof Object?"string"==typeof t&&""!==t?t.split(".").reduce(function(e,t){return e&&e[t]},e):"number"==typeof t?e[t]:e:e},setNestedProperty:function(e,t,s){if(e&&e instanceof Object){if("string"==typeof t&&""!==t){var n=t.split(".");return n.reduce(function(e,t,i){return e[t]=e[t]||{},n.length==i+1&&(e[t]=s),e[t]},e)}return"number"==typeof t?(e[t]=s,e[t]):e}return e},closest:function(t,s){return e(t,s,function(e,t){return Math.abs(e-t)})},closestGreater:function(t,s){return e(t,s,function(e,t){return e-t})},closestLower:function(t,s){return e(t,s,function(e,t){return t-e})}}}),define("Observable",["Tools"],function(e){return function(){var t={};this.watch=function(e,s,n){if("function"==typeof s){var i=t[e]=t[e]||[],s=[s,n];return i.push(s),[e,i.indexOf(s)]}return!1},this.unwatch=function(e){var s=e[0],e=e[1];return t[s]&&t[s][e]?(delete t[s][e],t[s].some(function(e){return!!e})||delete t[s],!0):!1},this.notify=function(s){var n=t[s],i=e.toArray(arguments).slice(1);return n?(e.loop(n,function(e){try{e&&e[0].apply(e[1]||null,i)}catch(t){}}),!0):!1},this.hasObserver=function(e){return!(!e||!t[e[0]]||!t[e[0]][e[1]])},this.hasTopic=function(e){return!!t[e]},this.unwatchAll=function(e){return t[e]?delete t[e]:t={},!0}}}),define("StateMachine",["Tools"],function(e){function t(){var t={};this.add=function(e,s,n,i){var a=[];return t[e]?!1:"string"==typeof e&&"function"==typeof s?(a[0]=s,"object"==typeof n&&(a[1]=n),"string"==typeof n&&(a[2]=n),"string"==typeof i&&(a[2]=i),t[e]=a,!0):!1},this.has=function(e){return!!t[e]},this.get=function(e){return t[e]||!1},this.event=function(s){var n=t[s];return n?(n[0].apply(n[1],e.toArray(arguments).slice(1)),n[2]):!1}}return function(s,n){var i={},a="";this.init=function(e){return i[e]?(a=e,!0):!1},this.add=function(e){return i[e]?i[e]:i[e]=new t},this.get=function(e){return i[e]},this.getCurrent=function(){return a},this.has=function(e){return i.hasOwnProperty(e)},this.advance=function(e){return this.has(e)?(a=e,!0):!1},this.event=function(){var t;return t=i[a].event.apply(i[a].event,e.toArray(arguments)),t===!1?!1:(t&&(i[a].event("exit"),a=t,i[a].event("entry")),!0)},e.loop(n,function(e,t){var s=this.add(t);e.forEach(function(e){s.add.apply(null,e)})},this),this.init(s)}}),define("Promise",["Observable","StateMachine"],function(e,t){return function s(){var n=null,i=null,a=new e,o={Pending:[["fulfill",function(e){n=e,a.notify("fulfill",e)},"Fulfilled"],["reject",function(e){i=e,a.notify("reject",e)},"Rejected"],["toFulfill",function(e){a.watch("fulfill",e)}],["toReject",function(e){a.watch("reject",e)}]],Fulfilled:[["toFulfill",function(e){setTimeout(function(){e(n)},0)}]],Rejected:[["toReject",function(e){setTimeout(function(){e(i)},0)}]]},r=new t("Pending",o);this.fulfill=function(e){return r.event("fulfill",e),this},this.reject=function(e){return r.event("reject",e),this},this.then=function(e,t,a,o){var c=new s;return e instanceof Function?t instanceof Function?r.event("toFulfill",this.makeResolver(c,e)):r.event("toFulfill",this.makeResolver(c,e,t)):r.event("toFulfill",this.makeResolver(c,function(){c.fulfill(n)})),t instanceof Function&&r.event("toReject",this.makeResolver(c,t,a)),a instanceof Function&&r.event("toReject",this.makeResolver(c,a,o)),!(t instanceof Function||a instanceof Function||!r.event("toReject",this.makeResolver(c,function(){c.reject(i)}))),c},this.sync=function(e){return e instanceof Object&&e.then?(e.then(function(e){this.fulfill(e)}.bind(this),function(e){this.reject(e)}.bind(this)),!0):!1},this.makeResolver=function(e,t,s){return function(n){var i;try{i=t.call(s,n),e.sync(i)||e.fulfill(i)}catch(a){e.reject(a)}}},this.getReason=function(){return i},this.getValue=function(){return n},this.getObservable=function(){return a},this.getStateMachine=function(){return r},this.getStates=function(){return o}}}),define("Store",["Observable","Tools"],function(e,t){return function(s){var n=t.clone(s)||{},i=new e,a=new e,o=[],r=function(e){var s=t.objectsDiffs(e,n);["updated","deleted","added"].forEach(function(e){s[e].forEach(function(t){i.notify(e,t,n[t]),a.notify(t,n[t],e)})})};this.count=this.getNbItems=function(){return n instanceof Array?n.length:t.count(n)},this.get=function(e){return n[e]},this.has=function(e){return n.hasOwnProperty(e)},this.set=function(e,t){var s,o;return"undefined"!=typeof e?(s=this.has(e),o=this.get(e),n[e]=t,s=s?"updated":"added",i.notify(s,e,n[e],o),a.notify(e,n[e],s,o),!0):!1},this.update=function(e,s,n){var o;return this.has(e)?(o=this.get(e),t.setNestedProperty(o,s,n),i.notify("updated",s,n),a.notify(e,o,"updated"),!0):!1},this.del=function(e){return this.has(e)?(this.alter("splice",e,1)||(delete n[e],i.notify("deleted",e),a.notify(e,n[e],"deleted")),!0):!1},this.delAll=function(e){return e instanceof Array?(e.sort(t.compareNumbers).reverse().forEach(this.del,this),!0):!1},this.alter=function(e){var s,i;return n[e]?(i=t.clone(n),s=this.proxy.apply(this,arguments),r(i),s):!1},this.proxy=function(e){return n[e]?n[e].apply(n,Array.prototype.slice.call(arguments,1)):!1},this.watch=function(e,t,s){return i.watch(e,t,s)},this.unwatch=function(e){return i.unwatch(e)},this.getStoreObservable=function(){return i},this.watchValue=function(e,t,s){return a.watch(e,t,s)},this.unwatchValue=function(e){return a.unwatch(e)},this.getValueObservable=function(){return a},this.loop=function(e,s){t.loop(n,e,s)},this.reset=function(e){if(e instanceof Object){var s=t.clone(n);return n=t.clone(e)||{},r(s),!0}return!1},this.compute=function(e,s,n,i){return"string"!=typeof e||"object"!=typeof s||"function"!=typeof n||this.isCompute(e)?!1:(o[e]=[],t.loop(s,function(t){o[e].push(this.watchValue(t,function(){this.set(e,n.call(i))},this))},this),this.set(e,n.call(i)),!0)},this.removeCompute=function(e){return this.isCompute(e)?(t.loop(o[e],function(e){this.unwatchValue(e)},this),this.del(e),!0):!1},this.isCompute=function(e){return!!o[e]},this.toJSON=function(){return JSON.stringify(n)},this.dump=function(){return n}}}),define("Transport",[],function(){return function(e){var t=null;this.setReqHandlers=function(e){return e instanceof Object?(t=e,!0):!1},this.getReqHandlers=function(){return t},this.request=function(e,s,n,i){return t.has(e)&&"undefined"!=typeof s?(t.get(e)(s,function(){n&&n.apply(i,arguments)}),!0):!1},this.listen=function(e,s,n,i){if(t.has(e)&&"undefined"!=typeof s&&"function"==typeof n){var a,o=function(){n.apply(i,arguments)};return a=t.get(e)(s,o,o),function(){"function"==typeof a?a():"object"==typeof a&&"function"==typeof a.func&&a.func.call(a.scope)}}return!1},this.setReqHandlers(e)}});