/**
 * https://github.com/flams/CouchDB-emily-tools
 * The MIT License (MIT)
 * Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
 */

define("CouchDBBase",["Store","Tools","Promise"],function(e,t,s){function i(e){return"object"==typeof e&&"function"==typeof e.event?!0:!1}function n(e){return"object"==typeof e&&"function"==typeof e.request&&"function"==typeof e.listen?!0:!1}function a(e){return"object"==typeof e&&"function"==typeof e.fulfill&&"function"==typeof e.reject&&"function"==typeof e.then?!0:!1}function o(){var e,t=null,o="CouchDB",r=null,l=new s;this.setPromise=function(e){return a(e)?(l=e,!0):!1},this.getPromise=function(){return l},this.getStateMachine=function(){return t},this.setStateMachine=function(e){return i(e)?(t=e,!0):!1},this.getTransport=function(){return r},this.setTransport=function(e){return n(e)?(r=e,!0):!1},this.getHandlerName=function(){return o},this.setHandlerName=function(e){return"string"==typeof e?(o=e,!0):!1},this.sync=function(){return l=new s,(e=this.setSyncInfo.apply(this,arguments))?(t.event("sync"),l):!1},this.unsync=function(){return t.event("unsync")},this.getSyncInfo=function(){return e},this.onSync=function(){},this.onListen=function(){},this.onUnsync=function(){this.stopListening&&delete this.stopListening},this.unsync=function(){t.event("unsync")},this.onChange=function(){},this.onAdd=function(){},this.onRemove=function(){},this.setSyncInfo=function(t){return e=t}}return function(t){return o.prototype=new e(t),new o}}),define("CouchDBDocument",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,s,i,n){function a(){this.setSyncInfo=function(e,t,s){return"string"==typeof e&&"string"==typeof t?s&&"object"!=typeof s?!1:{database:e,document:t,query:s||{}}:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document,query:e.query},function(e){var t=JSON.parse(e);t._id&&(this.reset(t),this.getStateMachine().event("listen")),this.getPromise().fulfill(t)},this)},this.onListen=function(){var e=this.getSyncInfo();this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:{feed:"continuous",heartbeat:2e4,descending:!0}},function(t){var s;if("\n"==t)return!1;var s;try{s=JSON.parse(t)}catch(i){s=null,console.error(i,"ERROR IN COUCHDBDOC LISTEN data : ",t)}return s?(s.id==e.document&&s.changes.pop().rev!=this.get("_rev")&&(s.deleted?this.getStateMachine().event("remove"):this.getStateMachine().event("change")),void 0):!1},this)},this.onChange=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/"+e.document},function(e){this.reset(JSON.parse(e))},this)},this.onRemove=function(){this.reset({})},this.upload=function(){var e=new i,t=this.getSyncInfo();return t.document?(this.getStateMachine().event("upload",e),e):!1},this.remove=function(){var e=(this.getSyncInfo(),new i);return this.getStateMachine().event("removeFromDatabase",e),e},this.databaseCreate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(t){var s=JSON.parse(t);s.ok?(this.set("_rev",s.rev),this.set("_id",s.id),this.getStateMachine().event("listen"),e.fulfill(s)):e.reject(s)},this)},this.databaseUpdate=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"PUT",path:"/"+t.database+"/"+t.document,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(t){var s=JSON.parse(t);s.ok?(this.set("_rev",s.rev),e.fulfill(s)):e.reject(s)},this)},this.databaseRemove=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"DELETE",path:"/"+t.database+"/"+t.document,query:{rev:this.get("_rev")}},function(t){var s=JSON.parse(t);s.ok?e.fulfill(s):e.reject(s)})},this.setStateMachine(new n("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"],["upload",this.databaseCreate,this]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this],["removeFromDatabase",this.databaseRemove,this]]}))}return function(e){return a.prototype=new t(e),new a}}),define("CouchDBView",["Store","CouchDBBase","Tools","StateMachine"],function(e,t,s,i){function n(){this.setSyncInfo=function(e,t,s,i){return"string"==typeof e&&"string"==typeof t&&"string"==typeof s?i&&"object"!=typeof i?!1:{database:e,design:t,view:s,query:i||{}}:!1},this.onSync=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(t){var s=JSON.parse(t);if(!s.rows)throw new Error("CouchDBStore ["+e.database+", "+e.design+", "+e.view+"].sync() failed: "+t);this.reset(s.rows),"undefined"==typeof s.total_rows&&(e.reducedView=!0),this.getStateMachine().event("listen"),this.getPromise().fulfill(s)},this)},this.onListen=function(){var e=this.getSyncInfo();s.mixin({feed:"continuous",heartbeat:2e4,descending:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(t){if("\n"==t)return!1;var s,i;try{s=JSON.parse(t)}catch(n){s=null,console.error(n,"ERROR IN VIEW DOC LISTEN data : ",t)}return s?(i=e.reducedView?"updateReduced":s.deleted?"remove":s.changes&&0==s.changes[0].rev.search("1-")?"add":"change",this.getStateMachine().event(i,s.id),void 0):!1},this)},this.onChange=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){var s=JSON.parse(t);s.rows.length==this.getNbItems()?s.rows.some(function(t,s){t.id==e&&this.set(s,t)},this):this.evenDocsInStore.call(this,s.rows,e)},this)},this.evenDocsInStore=function(e,t){var s=this.getNbItems();e.length<s?this.loop(function(e,s){e.id==t&&this.del(s)},this):e.length>s&&e.some(function(e,s){return e.id==t?this.alter("splice",s,0,e):void 0},this)},this.onAdd=function(e){var t=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_design/"+t.design+"/"+t.view,query:t.query},function(t){var s=JSON.parse(t);s.rows.some(function(t,s){t.id==e&&this.alter("splice",s,0,t)},this)},this)},this.onRemove=function(e){this.loop(function(t,s){t.id==e&&this.del(s)},this)},this.updateReduced=function(){var e=this.getSyncInfo();this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+e.database+"/_design/"+e.design+"/"+e.view,query:e.query},function(e){var t=JSON.parse(e);this.set(0,t.rows[0])},this)},this.setStateMachine(new i("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["updateReduced",this.updateReduced,this]]}))}return function(e){return n.prototype=new t(e),new n}}),define("CouchDBBulkDocuments",["Store","CouchDBBase","Tools","Promise","StateMachine"],function(e,t,s,i,n){function a(){this.setSyncInfo=function(e,t){if("string"==typeof e&&"object"==typeof t){var s={database:e,query:t||{}};return Array.isArray(s.query.keys)&&(s.keys=s.query.keys,delete s.query.keys),s}return!1},this.onSync=function(){var e,t=this.getSyncInfo(),s={path:"/"+t.database+"/_all_docs",query:t.query};Array.isArray(t.keys)?(s.method="POST",s.data=JSON.stringify({keys:t.keys}),s.headers={"Content-Type":"application/json"},e=s.data):(s.method="GET",e=JSON.stringify(t.query)),t.query.include_docs=!0,this.getTransport().request(this.getHandlerName(),s,function(s){var i=JSON.parse(s);if(!i.rows)throw new Error('CouchDBBulkDocuments.sync("'+t.database+'", '+e+") failed: "+s);this.reset(i.rows),this.getStateMachine().event("listen"),this.getPromise().fulfill(this)},this)},this.onListen=function(){var e=this.getSyncInfo();s.mixin({feed:"continuous",heartbeat:2e4,descending:!0,include_docs:!0},e.query),this.stopListening=this.getTransport().listen(this.getHandlerName(),{path:"/"+e.database+"/_changes",query:e.query},function(e){var t;if("\n"==e)return!1;var t,s;try{t=JSON.parse(e)}catch(i){t=null,console.error(i,"ERROR IN BULK DOC LISTEN data : ",e)}return t?(s=0==t.changes[0].rev.search("1-")?"add":t.deleted?"remove":"change",this.getStateMachine().event(s,t.id,t.doc),void 0):!1},this)},this.onAdd=function(e){var t=this.getSyncInfo();return t.query.startkey||t.query.endkey?(t.query.include_docs=!0,t.query.update_seq=!0,this.getTransport().request(this.getHandlerName(),{method:"GET",path:"/"+t.database+"/_all_docs",query:t.query},function(t){var s=JSON.parse(t);s.rows.forEach(function(t,s){t.id==e&&this.alter("splice",s,0,t.doc)},this)},this),void 0):!1},this.onChange=function(e,t){this.loop(function(s,i){s.id==e&&this.set(i,t)},this)},this.onRemove=function(e){this.loop(function(t,s){t.id==e&&this.del(s)},this)},this.databaseUpdate=function(e){var t=[],s=this.getSyncInfo();this.loop(function(e){t.push(e.doc)}),this.getTransport().request(this.getHandlerName(),{method:"POST",path:"/"+s.database+"/_bulk_docs",headers:{"Content-Type":"application/json"},data:JSON.stringify({docs:t})},function(t){var s=JSON.parse(t);this.loop(function(e,t){s[t].ok&&(e.doc._rev=s[t].rev)}),e.fulfill(s)},this)},this.upload=function(){var e=new i;return this.getStateMachine().event("upload",e),e},this.setStateMachine(new n("Unsynched",{Unsynched:[["sync",this.onSync,this,"Synched"]],Synched:[["listen",this.onListen,this,"Listening"],["unsync",function(){},"Unsynched"]],Listening:[["unsync",this.onUnsync,this,"Unsynched"],["change",this.onChange,this],["add",this.onAdd,this],["remove",this.onRemove,this],["upload",this.databaseUpdate,this]]}))}return function(e){return a.prototype=new t(e),new a}}),define("CouchDBUser",["CouchDBDocument","Promise"],function(e,t){function s(){var e="_users",s="org.couchdb.user:";this.getUserDB=function(){return e},this.setUserDB=function(t){return t?(e=t,!0):!1},this.getIdPrefix=function(){return s},this.setIdPrefix=function(e){return e?(s=e,!0):!1},this.setId=function(e){return e?(this.set("_id",s+e),!0):!1},this.getId=function(){return this.get("_id")},this.load=function(t){return this.sync(e,s+t)},this.login=function(){var e=new t,s=this.get("name"),i=this.get("password");return s&&"string"==typeof s&&"string"==typeof i?this.getTransport().request("CouchDB",{method:"GET",path:"/_users/org.couchdb.user:"+s,auth:s+":"+i},e.fulfill,e):e.reject({error:"name & password must be strings"}),e},this.create=function(){var e=new t,s=this;return this.get("type")||this.set("type","user"),this.get("roles")||this.set("roles",[]),this.getTransport().request("CouchDB",{method:"PUT",path:"/_users/org.couchdb.user:"+s.get("name"),auth:"admin:innovation4U",headers:{"Content-Type":"application/json",Connection:"close"},data:s.toJSON()},function(t){var s=JSON.parse(t);s.ok?e.fulfill():e.reject(s)}),e}}return function(){return s.prototype=new e,new s}}),define("CouchDBSecurity",["CouchDBDocument"],function(e){function t(){var e="_security";this.setName=function(t){return t?(e=t,!0):!1},this.getName=function(){return e},this.load=function(t){return this.sync(t,e)}}return function(){return t.prototype=new e,new t}});