/*
 Olives <VERSION> http://flams.github.com/olives
 The MIT License (MIT)
 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
*/

define("DomUtils",["Tools"],function(e){return{getNodes:function(e,t){return this.isAcceptedType(e)?(e.parentNode||document.createDocumentFragment().appendChild(e),e.parentNode.querySelectorAll(t||"*")):!1},getDataset:function(e){var t,s,n,i=0,a={};if(this.isAcceptedType(e)){if(e.hasOwnProperty("dataset"))return e.dataset;for(t=e.attributes.length;t>i;i++)s=e.attributes[i].name.split("-"),"data"==s.shift()&&(a[n=s.join("-")]=e.getAttribute("data-"+n));return a}return!1},isAcceptedType:function(e){return e instanceof HTMLElement||e instanceof SVGElement?!0:!1},setAttribute:function(e,t,s){return e instanceof HTMLElement?(e[t]=s,!0):e instanceof SVGElement?(e.setAttribute(t,s),!0):!1},matches:function(t,s,n){return e.toArray(this.getNodes(t,s)).indexOf(n)>-1}}}),define("Bind.plugin",["Store","Observable","Tools","DomUtils"],function(e,t,s,n){return function(t,i){function a(e){l[e]&&(l[e].forEach(function(e){o.unwatchValue(e)}),delete l[e])}var o=null,r={},c={},l={};this.observers=l,this.setModel=function(t){return t instanceof e?(o=t,!0):!1},this.getModel=function(){return o},this.ItemRenderer=function(e,t){var i=null,r=null,c=null,l=null,d=null;this.setRenderer=function(e){return i=e,!0},this.getRenderer=function(){return i},this.setRootNode=function(e){return n.isAcceptedType(e)?(c=e,e=c.querySelector("*"),this.setRenderer(e),e&&c.removeChild(e),!0):!1},this.getRootNode=function(){return c},this.setPlugins=function(e){return r=e,!0},this.getPlugins=function(){return r},this.items={},this.setStart=function(e){return l=parseInt(e,10)},this.getStart=function(){return l},this.setNb=function(e){return d="*"==e?e:parseInt(e,10)},this.getNb=function(){return d},this.addItem=function(e){var t;return"number"!=typeof e||this.items[e]?!1:(t=this.getNextItem(e),(e=this.create(e))?(t?c.insertBefore(e,t):c.appendChild(e),!0):!1)},this.getNextItem=function(e){var t=Object.keys(this.items).map(function(e){return Number(e)}),n=s.closestGreater(e,t),t=t[n];return t!=e?this.items[t]:void 0},this.removeItem=function(e){var t=this.items[e];return t?(c.removeChild(t),delete this.items[e],a(e),!0):!1},this.create=function(e){if(o.has(e)){var t=i.cloneNode(!0),a=n.getNodes(t);return s.toArray(a).forEach(function(t){t.setAttribute("data-"+r.name+"_id",e)}),this.items[e]=t,r.apply(t),t}},this.render=function(){var e="*"==d?o.getNbItems():d,t=[];if(null!==d&&null!==l){s.loop(this.items,function(s,n){n=Number(n),(l>n||n>=l+e||!o.has(n))&&t.push(n)},this),t.sort(s.compareNumbers).reverse().forEach(this.removeItem,this);for(var n=l,i=e+l;i>n;n++)this.addItem(n);return!0}return!1},this.setPlugins(e),this.setRootNode(t)},this.setItemRenderer=function(e,t){c[e||"default"]=t},this.getItemRenderer=function(e){return c[e]},this.foreach=function(e,t,s,n){var i=new this.ItemRenderer(this.plugins,e);i.setStart(s||0),i.setNb(n||"*"),i.render(),o.watch("added",i.render,i),o.watch("deleted",function(e){i.render(),a(e)},this),this.setItemRenderer(t,i)},this.updateStart=function(e,t){var s=this.getItemRenderer(e);return s?(s.setStart(t),!0):!1},this.updateNb=function(e,t){var s=this.getItemRenderer(e);return s?(s.setNb(t),!0):!1},this.refresh=function(e){return(e=this.getItemRenderer(e))?(e.render(),!0):!1},this.bind=function(e,t,i){var i=i||"",a=e.getAttribute("data-"+this.plugins.name+"_id"),r=i.split("."),c=a||r.shift(),l=a?i:r.join("."),a=s.getNestedProperty(o.get(c),l),d=s.toArray(arguments).slice(3);(a||0===a||a===!1)&&(this.execBinding.apply(this,[e,t,a].concat(d))||n.setAttribute(e,t,a)),this.hasBinding(t)||e.addEventListener("change",function(){o.has(c)&&(l?o.update(c,i,e[t]):o.set(c,e[t]))},!0),this.observers[c]=this.observers[c]||[],this.observers[c].push(o.watchValue(c,function(i){this.execBinding.apply(this,[e,t,s.getNestedProperty(i,l)].concat(d))||n.setAttribute(e,t,s.getNestedProperty(i,l))},this))},this.set=function(e){return n.isAcceptedType(e)&&e.name?(o.set(e.name,e.value),!0):!1},this.getItemIndex=function(e){return(e=n.getDataset(e))&&"undefined"!=typeof e[this.plugins.name+"_id"]?+e[this.plugins.name+"_id"]:!1},this.form=function(e){if(e&&"FORM"==e.nodeName){var t=this;return e.addEventListener("submit",function(n){s.toArray(e.querySelectorAll("[name]")).forEach(t.set,t),n.preventDefault()},!0),!0}return!1},this.addBinding=function(e,t){return e&&"string"==typeof e&&"function"==typeof t?(r[e]=t,!0):!1},this.execBinding=function(e,t){return this.hasBinding(t)?(r[t].apply(e,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(e){return r.hasOwnProperty(e)},this.getBinding=function(e){return r[e]},this.addBindings=function(e){return s.loop(e,function(e,t){this.addBinding(t,e)},this)},this.setModel(t),this.addBindings(i)}}),define("Event.plugin",["DomUtils"],function(e){return function(t,s){var n=null,i={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},a=!!s;this.addEventListener=function(e,t,s,n){e.addEventListener(this.map(t),s,!!n)},this.listen=function(e,t,s,i){this.addEventListener(e,t,function(t){n[s].call(n,t,e)},!!i)},this.delegate=function(t,s,i,a,o){this.addEventListener(t,i,function(i){e.matches(t,s,i.target)&&n[a].call(n,i,t)},!!o)},this.getParent=function(){return n},this.setParent=function(e){return e instanceof Object?(n=e,!0):!1},this.map=function(e){return a?i[e]||e:e},this.setMap=function(e,t){return"string"==typeof e&&"string"==typeof t?(i[e]=t,!0):!1},this.setParent(t)}}),define("LocalStore",["Store","Tools"],function(e,t){function s(){var e=null,s=localStorage,n=function(){s.setItem(e,this.toJSON())};this.setLocalStorage=function(e){return e&&e.setItem instanceof Function?(s=e,!0):!1},this.getLocalStorage=function(){return s},this.sync=function(i){return"string"==typeof i?(e=i,i=JSON.parse(s.getItem(i)),t.loop(i,function(e,t){this.has(t)||this.set(t,e)},this),n.call(this),this.watch("added",n,this),this.watch("updated",n,this),this.watch("deleted",n,this),!0):!1}}return function(t){return s.prototype=new e(t),new s}}),define("Plugins",["Tools","DomUtils"],function(e,t){return function(s){var n={},i=function(e){return e.trim()},a=function(e,t,s){t.split(";").forEach(function(t){var a=t.split(":"),t=a[0].trim(),a=a[1]?a[1].split(",").map(i):[];a.unshift(e),n[s]&&n[s][t]&&n[s][t].apply(n[s],a)})};this.add=function(e,t){var s=this;return"string"==typeof e&&"object"==typeof t&&t?(n[e]=t,t.plugins={name:e,apply:function(){return s.apply.apply(s,arguments)}},!0):!1},this.addAll=function(t){return e.loop(t,function(e,t){this.add(t,e)},this)},this.get=function(e){return n[e]},this.del=function(e){return delete n[e]},this.apply=function(s){var n;return t.isAcceptedType(s)?(n=t.getNodes(s),e.loop(e.toArray(n),function(s){e.loop(t.getDataset(s),function(e,t){a(s,e,t)})}),s):!1},this.addAll(s)}}),define("OObject",["StateMachine","Store","Plugins","DomUtils","Tools"],function(e,t,s,n,i){return function(a){var o=function(e){var t=c||document.createElement("div");if(!e.template)throw Error("UI.template must be set prior to render");if("string"==typeof e.template?t.innerHTML=e.template.trim():n.isAcceptedType(e.template)&&t.appendChild(e.template),t.childNodes.length>1)throw Error("UI.template should have only one parent node");e.dom=t.childNodes[0],e.plugins.apply(e.dom)},r=function(e,t,s){t&&(s?t.insertBefore(e.dom,s):t.appendChild(e.dom),c=t)},c=null,l=new e("Init",{Init:[["render",o,this,"Rendered"],["place",function(e){o(e),r.apply(null,i.toArray(arguments))},this,"Rendered"]],Rendered:[["place",r,this],["render",o,this]]});this.model=a instanceof t?a:new t,this.plugins=new s,this.dom=this.template=null,this.place=function(e,t){l.event("place",this,e,t)},this.render=function(){l.event("render",this)},this.setTemplateFromDom=function(e){return n.isAcceptedType(e)?(this.template=e,!0):!1},this.alive=function(e){return n.isAcceptedType(e)?(this.setTemplateFromDom(e),this.place(e.parentNode,e.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return c}}}),define("Place.plugin",["OObject","Tools"],function(e,t){return function(s){var n={};this.place=function(t,s){if(!(n[s]instanceof e))throw Error(s+" is not an OObject UI in place:"+s);n[s].place(t)},this.set=function(t,s){return"string"==typeof t&&s instanceof e?(n[t]=s,!0):!1},this.setAll=function(e){t.loop(e,function(e,t){this.set(t,e)},this)},this.get=function(e){return n[e]},this.setAll(s)}}),define("SocketIOTransport",["Observable","Tools"],function(){return function(e){var t=null;this.setSocket=function(e){return e&&"function"==typeof e.emit?(t=e,!0):!1},this.getSocket=function(){return t},this.on=function(e,s){return t.on(e,s)},this.once=function(e,s){return t.once(e,s)},this.emit=function(e,s,n){return t.emit(e,s,n)},this.removeListener=function(e,s,n){return t.removeListener(e,s,n)},this.request=function(e,t,s,n){return"string"==typeof e&&"undefined"!=typeof t?(t={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t},this.once(t.eventId,function(){s&&s.apply(n||null,arguments)}),this.emit(e,t),!0):!1},this.listen=function(e,t,s,n){if("string"==typeof e&&"undefined"!=typeof t&&"function"==typeof s){var i={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t,keepAlive:!0},a=function(){s&&s.apply(n||null,arguments)},o=this;return this.on(i.eventId,a),this.emit(e,i),function(){o.emit("disconnect-"+i.eventId),o.removeListener(i.eventId,a)}}return!1},this.setSocket(e)}}),define("Stack",["Tools"],function(){var e=require("Tools");return function(t){function s(t){if(!(t>=a.length)){var i=a[t];return-1==e.toArray(n.childNodes).indexOf(i)?s(t+1):i}}var n=document.createDocumentFragment(),i=document.createElement("div"),a=[],o=null;this.add=function(e){return!this.has(e)&&e instanceof HTMLElement?(n.appendChild(e),a.push(e),e):!1},this.remove=function(e){var t;return this.has(e)?(t=a.indexOf(e),n.removeChild(e),a.splice(t,1),e):!1},this.place=function(e){return e instanceof HTMLElement?([].slice.call(n.childNodes).forEach(function(t){this.has(t)&&e.appendChild(t)},this),this._setParent(e)):!1},this.up=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t+1),e}return!1},this.down=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t-1),e}return!1},this.move=function(e,t){if(this.has(e)){var i=a.indexOf(e);return a.splice(i,1),(i=s(t))?n.insertBefore(e,i):n.appendChild(e),a.splice(t,0,e),e}return!1},this.insert=function(e,t){return!this.has(e)&&e instanceof HTMLElement?(a.splice(t,0,e),n.insertBefore(e,n.childNodes[t]),e):!1},this.getPosition=function(e){return a.indexOf(e)},this.count=function(){return n.childNodes.length},this.has=function(e){return this.getPosition(e)>=0},this.hide=function(e){return this.has(e)?(i.appendChild(e),!0):!1},this.show=function(e){return this.has(e)&&e.parentNode===i?(this.move(e,a.indexOf(e)),!0):!1},this.hideAll=function(){a.forEach(this.hide,this)},this.showAll=function(){a.forEach(this.show,this)},this.getParent=function(){return n},this._setParent=function(e){return e instanceof HTMLElement?n=e:!1},this.getHidePlace=function(){return i},this.setHidePlace=function(e){return e instanceof HTMLElement?(i=e,!0):!1},this.getLastTransit=function(){return o},this.transit=function(e){return o&&this.hide(o),this.show(e)?(o=e,!0):!1},this._setParent(t)}}),define("LocationRouter",["Router","Tools"],function(e,t){function s(){function e(){window.location.hash?this.navigate.apply(this,this.parse(window.location.hash)):this.navigate(n)}var s,n="",i=window.location.hash;this.setDefaultRoute=function(e){return e&&"string"==typeof e?(n=e,!0):!1},this.getDefaultRoute=function(){return n},this.parse=function(e){return e.split("#").pop().split("/")},this.toUrl=function(e){return e.join("/")},this.start=function(t){this.setDefaultRoute(t),e.call(this),this.bindOnHashChange(),this.bindOnRouteChange()},this.destroy=function(){this.unwatch(s),window.removeEventListener("hashchange",this.boundOnHashChange,!0)},this.onHashChange=function(){window.location.hash!=i&&e.call(this)},this.boundOnHashChange=this.onHashChange.bind(this),this.bindOnHashChange=function(){window.addEventListener("hashchange",this.boundOnHashChange,!0)},this.bindOnRouteChange=function(){s=this.watch(this.onRouteChange,this)},this.onRouteChange=function(){window.location.hash=this.toUrl(t.toArray(arguments)),i=window.location.hash},this.getLastRoute=function(){return i}}return function(){return s.prototype=new e,new s}});