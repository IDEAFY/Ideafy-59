/*
 Olives <VERSION> http://flams.github.com/olives
 The MIT License (MIT)
 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com> - Olivier Wietrich <olivier.wietrich@gmail.com>
*/

define("DomUtils",["Tools"],function(e){return{getNodes:function(e,t){return this.isAcceptedType(e)?(e.parentNode||document.createDocumentFragment().appendChild(e),e.parentNode.querySelectorAll(t||"*")):!1},getDataset:function(e){var t,n,s,i=0,a={};if(this.isAcceptedType(e)){if(e.hasOwnProperty("dataset"))return e.dataset;for(t=e.attributes.length;t>i;i++)n=e.attributes[i].name.split("-"),"data"==n.shift()&&(a[s=n.join("-")]=e.getAttribute("data-"+s));return a}return!1},isAcceptedType:function(e){return e instanceof HTMLElement||e instanceof SVGElement?!0:!1},setAttribute:function(e,t,n){return e instanceof HTMLElement?(e[t]=n,!0):e instanceof SVGElement?(e.setAttribute(t,n),!0):!1},matches:function(t,n,s){return e.toArray(this.getNodes(t,n)).indexOf(s)>-1}}}),define("Bind.plugin",["Store","Observable","Tools","DomUtils"],function(e,t,n,s){return function(t,i){function a(e){d[e]&&(d[e].forEach(function(e){o.unwatchValue(e)}),delete d[e])}var o=null,r={},c={},d={};this.observers=d,this.setModel=function(t){return t instanceof e?(o=t,!0):!1},this.getModel=function(){return o},this.ItemRenderer=function(e,t){var i=null,r=null,c=null,d=null,l=null;this.setRenderer=function(e){return i=e,!0},this.getRenderer=function(){return i},this.setRootNode=function(e){return s.isAcceptedType(e)?(c=e,e=c.querySelector("*"),this.setRenderer(e),e&&c.removeChild(e),!0):!1},this.getRootNode=function(){return c},this.setPlugins=function(e){return r=e,!0},this.getPlugins=function(){return r},this.items={},this.setStart=function(e){return d=parseInt(e,10)},this.getStart=function(){return d},this.setNb=function(e){return l="*"==e?e:parseInt(e,10)},this.getNb=function(){return l},this.addItem=function(e){var t;return"number"!=typeof e||this.items[e]?!1:(t=this.getNextItem(e),(e=this.create(e))?(t?c.insertBefore(e,t):c.appendChild(e),!0):!1)},this.getNextItem=function(e){var t=Object.keys(this.items).map(function(e){return Number(e)}),s=n.closestGreater(e,t),t=t[s];return t!=e?this.items[t]:void 0},this.removeItem=function(e){var t=this.items[e];return t?(c.removeChild(t),delete this.items[e],a(e),!0):!1},this.create=function(e){if(o.has(e)){var t=i.cloneNode(!0),a=s.getNodes(t);return n.toArray(a).forEach(function(t){t.setAttribute("data-"+r.name+"_id",e)}),this.items[e]=t,r.apply(t),t}},this.render=function(){var e="*"==l?o.getNbItems():l,t=[];if(null!==l&&null!==d){n.loop(this.items,function(n,s){s=Number(s),(d>s||s>=d+e||!o.has(s))&&t.push(s)},this),t.sort(n.compareNumbers).reverse().forEach(this.removeItem,this);for(var s=d,i=e+d;i>s;s++)this.addItem(s);return!0}return!1},this.setPlugins(e),this.setRootNode(t)},this.setItemRenderer=function(e,t){c[e||"default"]=t},this.getItemRenderer=function(e){return c[e]},this.foreach=function(e,t,n,s){var i=new this.ItemRenderer(this.plugins,e);i.setStart(n||0),i.setNb(s||"*"),i.render(),o.watch("added",i.render,i),o.watch("deleted",function(e){i.render(),a(e)},this),this.setItemRenderer(t,i)},this.updateStart=function(e,t){var n=this.getItemRenderer(e);return n?(n.setStart(t),!0):!1},this.updateNb=function(e,t){var n=this.getItemRenderer(e);return n?(n.setNb(t),!0):!1},this.refresh=function(e){return(e=this.getItemRenderer(e))?(e.render(),!0):!1},this.bind=function(e,t,i){var i=i||"",a=e.getAttribute("data-"+this.plugins.name+"_id"),r=i.split("."),c=a||r.shift(),d=a?i:r.join("."),a=n.getNestedProperty(o.get(c),d),l=n.toArray(arguments).slice(3);(a||0===a||a===!1)&&(this.execBinding.apply(this,[e,t,a].concat(l))||s.setAttribute(e,t,a)),this.hasBinding(t)||e.addEventListener("change",function(){o.has(c)&&(d?o.update(c,i,e[t]):o.set(c,e[t]))},!0),this.observers[c]=this.observers[c]||[],this.observers[c].push(o.watchValue(c,function(i){this.execBinding.apply(this,[e,t,n.getNestedProperty(i,d)].concat(l))||s.setAttribute(e,t,n.getNestedProperty(i,d))},this))},this.set=function(e){return s.isAcceptedType(e)&&e.name?(o.set(e.name,e.value),!0):!1},this.getItemIndex=function(e){return(e=s.getDataset(e))&&"undefined"!=typeof e[this.plugins.name+"_id"]?+e[this.plugins.name+"_id"]:!1},this.form=function(e){if(e&&"FORM"==e.nodeName){var t=this;return e.addEventListener("submit",function(s){n.toArray(e.querySelectorAll("[name]")).forEach(t.set,t),s.preventDefault()},!0),!0}return!1},this.addBinding=function(e,t){return e&&"string"==typeof e&&"function"==typeof t?(r[e]=t,!0):!1},this.execBinding=function(e,t){return this.hasBinding(t)?(r[t].apply(e,Array.prototype.slice.call(arguments,2)),!0):!1},this.hasBinding=function(e){return r.hasOwnProperty(e)},this.getBinding=function(e){return r[e]},this.addBindings=function(e){return n.loop(e,function(e,t){this.addBinding(t,e)},this)},this.setModel(t),this.addBindings(i)}}),define("Event.plugin",["DomUtils"],function(e){return function(t,n){var s=null,i={mousedown:"touchstart",mouseup:"touchend",mousemove:"touchmove"},a=!!n;this.addEventListener=function(e,t,n,s){e.addEventListener(this.map(t),n,!!s)},this.listen=function(e,t,n,i){this.addEventListener(e,t,function(t){s[n].call(s,t,e)},!!i)},this.delegate=function(t,n,i,a,o){this.addEventListener(t,i,function(i){e.matches(t,n,i.target)&&s[a].call(s,i,t)},!!o)},this.getParent=function(){return s},this.setParent=function(e){return e instanceof Object?(s=e,!0):!1},this.map=function(e){return a?i[e]||e:e},this.setMap=function(e,t){return"string"==typeof e&&"string"==typeof t?(i[e]=t,!0):!1},this.setParent(t)}}),define("LocalStore",["Store","Tools"],function(e,t){function n(){var e=null,n=localStorage,s=function(){n.setItem(e,this.toJSON())};this.setLocalStorage=function(e){return e&&e.setItem instanceof Function?(n=e,!0):!1},this.getLocalStorage=function(){return n},this.sync=function(i){return"string"==typeof i?(e=i,i=JSON.parse(n.getItem(i)),t.loop(i,function(e,t){this.has(t)||this.set(t,e)},this),s.call(this),this.watch("added",s,this),this.watch("updated",s,this),this.watch("deleted",s,this),!0):!1}}return function(t){return n.prototype=new e(t),new n}}),define("Plugins",["Tools","DomUtils"],function(e,t){return function(n){var s={},i=function(e){return e.trim()},a=function(e,t,n){t.split(";").forEach(function(t){var a=t.split(":"),t=a[0].trim(),a=a[1]?a[1].split(",").map(i):[];a.unshift(e),s[n]&&s[n][t]&&s[n][t].apply(s[n],a)})};this.add=function(e,t){var n=this;return"string"==typeof e&&"object"==typeof t&&t?(s[e]=t,t.plugins={name:e,apply:function(){return n.apply.apply(n,arguments)}},!0):!1},this.addAll=function(t){return e.loop(t,function(e,t){this.add(t,e)},this)},this.get=function(e){return s[e]},this.del=function(e){return delete s[e]},this.apply=function(n){var s;return t.isAcceptedType(n)?(s=t.getNodes(n),e.loop(e.toArray(s),function(n){e.loop(t.getDataset(n),function(e,t){a(n,e,t)})}),n):!1},this.addAll(n)}}),define("OObject",["StateMachine","Store","Plugins","DomUtils","Tools"],function(e,t,n,s,i){return function(a){var o=function(e){var t=c||document.createElement("div");if(!e.template)throw Error("UI.template must be set prior to render");if("string"==typeof e.template?t.innerHTML=e.template.trim():s.isAcceptedType(e.template)&&t.appendChild(e.template),t.childNodes.length>1)throw Error("UI.template should have only one parent node");e.dom=t.childNodes[0],e.plugins.apply(e.dom)},r=function(e,t,n){t&&(n?t.insertBefore(e.dom,n):t.appendChild(e.dom),c=t)},c=null,d=new e("Init",{Init:[["render",o,this,"Rendered"],["place",function(e){o(e),r.apply(null,i.toArray(arguments))},this,"Rendered"]],Rendered:[["place",r,this],["render",o,this]]});this.model=a instanceof t?a:new t,this.plugins=new n,this.dom=this.template=null,this.place=function(e,t){d.event("place",this,e,t)},this.render=function(){d.event("render",this)},this.setTemplateFromDom=function(e){return s.isAcceptedType(e)?(this.template=e,!0):!1},this.alive=function(e){return s.isAcceptedType(e)?(this.setTemplateFromDom(e),this.place(e.parentNode,e.nextElementSibling),!0):!1},this.getCurrentPlace=function(){return c}}}),define("Place.plugin",["OObject","Tools"],function(e,t){return function(n){var s={};this.place=function(t,n){if(!(s[n]instanceof e))throw Error(n+" is not an OObject UI in place:"+n);s[n].place(t)},this.set=function(t,n){return"string"==typeof t&&n instanceof e?(s[t]=n,!0):!1},this.setAll=function(e){t.loop(e,function(e,t){this.set(t,e)},this)},this.get=function(e){return s[e]},this.setAll(n)}}),define("SocketIOTransport",["Observable","Tools"],function(){return function(e){var t=null;this.setSocket=function(e){return e&&"function"==typeof e.emit?(t=e,!0):!1},this.getSocket=function(){return t},this.on=function(e,n){return t.on(e,n)},this.once=function(e,n){return t.once(e,n)},this.emit=function(e,n,s){return t.emit(e,n,s)},this.removeListener=function(e,n,s){return t.removeListener(e,n,s)},this.request=function(e,t,n,s){return"string"==typeof e&&"undefined"!=typeof t?(t={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t},this.once(t.eventId,function(){n&&n.apply(s||null,arguments)}),this.emit(e,t),!0):!1},this.listen=function(e,t,n,s){if("string"==typeof e&&"undefined"!=typeof t&&"function"==typeof n){var i={eventId:Date.now()+Math.floor(1e6*Math.random()),data:t,keepAlive:!0},a=function(){n&&n.apply(s||null,arguments)},o=this;return this.on(i.eventId,a),this.emit(e,i),function(){o.emit("disconnect-"+i.eventId),o.removeListener(i.eventId,a)}}return!1},this.setSocket(e)}}),define("Stack",["Tools"],function(){var e=require("Tools");return function(t){function n(t){if(!(t>=a.length)){var i=a[t];return-1==e.toArray(s.childNodes).indexOf(i)?n(t+1):i}}var s=document.createDocumentFragment(),i=document.createElement("div"),a=[],o=null;this.add=function(e){return!this.has(e)&&e instanceof HTMLElement?(s.appendChild(e),a.push(e),e):!1},this.remove=function(e){var t;return this.has(e)?(t=a.indexOf(e),s.removeChild(e),a.splice(t,1),e):!1},this.place=function(e){return e instanceof HTMLElement?([].slice.call(s.childNodes).forEach(function(t){this.has(t)&&e.appendChild(t)},this),this._setParent(e)):!1},this.up=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t+1),e}return!1},this.down=function(e){if(this.has(e)){var t=this.getPosition(e);return this.move(e,t-1),e}return!1},this.move=function(e,t){if(this.has(e)){var i=a.indexOf(e);return a.splice(i,1),(i=n(t))?s.insertBefore(e,i):s.appendChild(e),a.splice(t,0,e),e}return!1},this.insert=function(e,t){return!this.has(e)&&e instanceof HTMLElement?(a.splice(t,0,e),s.insertBefore(e,s.childNodes[t]),e):!1},this.getPosition=function(e){return a.indexOf(e)},this.count=function(){return s.childNodes.length},this.has=function(e){return this.getPosition(e)>=0},this.hide=function(e){return this.has(e)?(i.appendChild(e),!0):!1},this.show=function(e){return this.has(e)&&e.parentNode===i?(this.move(e,a.indexOf(e)),!0):!1},this.hideAll=function(){a.forEach(this.hide,this)},this.showAll=function(){a.forEach(this.show,this)},this.getParent=function(){return s},this._setParent=function(e){return e instanceof HTMLElement?s=e:!1},this.getHidePlace=function(){return i},this.setHidePlace=function(e){return e instanceof HTMLElement?(i=e,!0):!1},this.getLastTransit=function(){return o},this.transit=function(e){return o&&this.hide(o),this.show(e)?(o=e,!0):!1},this._setParent(t)}}),define("LocationRouter",["Router","Tools"],function(e,t){function n(){function e(){window.location.hash?this.navigate.apply(this,this.parse(window.location.hash)):this.navigate(s)}var n,s="",i=window.location.hash;this.setDefaultRoute=function(e){return e&&"string"==typeof e?(s=e,!0):!1},this.getDefaultRoute=function(){return s},this.parse=function(e){return e.split("#").pop().split("/")},this.toUrl=function(e){return e.join("/")},this.start=function(t){this.setDefaultRoute(t),e.call(this),this.bindOnHashChange(),this.bindOnRouteChange()},this.destroy=function(){this.unwatch(n),window.removeEventListener("hashchange",this.boundOnHashChange,!0)},this.onHashChange=function(){window.location.hash!=i&&e.call(this)},this.boundOnHashChange=this.onHashChange.bind(this),this.bindOnHashChange=function(){window.addEventListener("hashchange",this.boundOnHashChange,!0)},this.bindOnRouteChange=function(){n=this.watch(this.onRouteChange,this)},this.onRouteChange=function(){window.location.hash=this.toUrl(t.toArray(arguments)),i=window.location.hash},this.getLastRoute=function(){return i}}return function(){return n.prototype=new e,new n}});