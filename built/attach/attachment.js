/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","Place.plugin","service/utils","service/confirm","Promise","lib/spin.min"],function(e,t,a,s,n,o,c,d,r,u,p,h){function v(){var e,v,m=this,g=new d("attach"),f=new c("attach"),b=new s,w=new a,y=new a({status:null}),L=t.get("labels"),A=t.get("transport"),T=t.get("user"),N=t.get("cat"),I=new a([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),M=!1;b.setTransport(A),m.plugins.addAll({labels:new n(L),attach:new n(b,{setCat:function(e){var a=t.get("catColors"),s=N.indexOf(e);s>-1?(this.innerHTML=L.get(e),this.setAttribute("style","color:"+a[s])):(this.innerHTML=e,this.setAttribute("sytle","color: #404040"))},setDescription:function(e){e&&"\n"!==e?(this.classList.remove("invisible"),this.innerHTML=e.replace(/\n/g,"<br>")):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){var t=parseInt(e.replace("A:",""),10);this.innerHTML=u.formatDateStamp(t)},setAuthors:function(e){var t="";if(e&&e instanceof Array&&e.length){for(i=0,l=e.length;l>i;i++)t+=i===l-1?e[i]:e[i]+", ";this.innerHTML=t}else this.innerHTML=e},showVoting:function(e){var t=T.get("rated_a")||[],a=b.get("authors");a.indexOf(T.get("_id"))>-1?this.classList.add("invisible"):t.indexOf(e)>-1?this.classList.add("invisible"):this.classList.remove("invisible")},showRating:function(e){var t=m.dom.querySelector(".a-vote");this.classList.add("invisible"),e&&e.length&&t.classList.contains("invisible")&&this.classList.remove("invisible")},displayRating:function(e){e&&e.length&&(this.innerHTML=Math.round(100*(e.reduce(function(e,t){return e+t})/e.length))/100)},displayNbVotes:function(e){this.innerHTML=e?0===e.length?"("+L.get("novotesyet")+")":1===e.length?"("+L.get("onevote")+")":"("+e.length+" "+L.get("votes")+")":""},setRef:function(e){var a,s=t.get("location")+"/downloads";b.get("docId").search("I:")>-1&&(a="idea"),e&&(s+="?atype="+a+"&docid="+b.get("docId")+"&file="+e,this.setAttribute("href",s),this.addEventListener("touchstart",u.showLinkInBrowser))},showWriteTwocent:function(e){length?this.classList.add("invisible"):this.classList.remove("invisible")},displayEdit:function(e){e.indexOf(T.get("_id"))>-1?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},displayDelete:function(e){e&&e.length?this.setAttribute("style","display:none;"):b.get("authors").indexOf(T.get("_id"))<0?this.setAttribute("style","display:none;"):this.setAttribute("style","display:inline-block;")}}),edit:new n(w,{show:function(e){e&&m.dom.classList.contains("edit-a")?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},setSelectCat:function(e){var t,a,s,i=T.get("categories")||[],n=null,o=this,l="<option selected disabled style='display:none;'>"+L.get("choosecat")+"</option>";for([1,2,3,4,5,6].forEach(function(e){o.classList.remove("acolor"+e),o.classList.add("acolor")}),t=0,a=N.length;a>t;t++)s=N[t],l+="<option>"+L.get(s)+"</option>",e===s&&(n=t+1,o.classList.add("acolor"+n));if(i.length)for(t=0,a=i.length;a>t;t++)l+="<option>"+i[t]+"</option>",e===i[t]&&(n=N.length+t+1);l+="<option>"+L.get("other")+"</option>",this.innerHTML=l,this.selectedIndex=n||0}}),progress:new n(y,{showStatus:function(e){e?this.setAttribute("value",e):this.setAttribute("value",0)},showVal:function(e){this.innerHTML=e?e+"%":""}}),vote:new n(I,{setIcon:function(e){var t="background-image: url('img/public/activeIdeaVote.png');",a="background-image: url('img/public/rateForList.png');";e?this.setAttribute("style",t):this.setAttribute("style",a)}}),place:new r({LibraryTwocentUI:g}),attachevent:new o(m)}),m.template='<div class = "attachment-screen invisible"><div class="close-popup" data-attachevent = "listen:mousedown, close"></div><div class="attach-header" data-attach="bind:innerHTML, name"></div><div class="attach-details"><div class="attach-body"><div class="a-type" data-attach="bind:setType, type"></div><div class="a-type-edit" data-attachevent="listen:mousedown, press"><input type="file" class="a-input" data-attachevent="listen:mousedown, check;listen:change, uploadFile"></div><div class="a-left"><div class="a-name" data-attach="bind:innerHTML, name" data-edit="bind:innerHTML, name" data-attachevent="listen:input, updateName"></div><div class="a-contrib"><span class="a-span" data-labels="bind: innerHTML, contrib"></span><span class="a-author" data-attach="bind: setAuthors, authornames"></span></div><div class="a-date" data-attach="bind:setDate, _id"></div></div><div class="a-cat"><span data-attach="bind:setCat, category"></span><select class="acolor invisible" data-edit="bind:setSelectCat, category" data-attachevent="listen: change, selectCat"></select><input maxlength=18 type="text" placeholder="Enter category" class="input custom-cat invisible" data-edit="bind:show, custom" data-attachevent="listen:input, setCat"></div><div class="a-rating invisible" data-attach="bind:showRating, votes"><a class="item-acorn"></a><span data-attach="bind:displayRating, votes"></span><span class="votes" data-attach="bind:displayNbVotes, votes"></span></div><div class="a-preview invisible"><div class="a-content" data-edit="bind:innerHTML, fileName"></div><progress class="uploadbar" data-progress="bind:showStatus, status" max=100></progress><div class="uploadval" data-progress="bind:showVal, status"></div></div><div class="a-vote" data-attach="bind:showVoting, _id"><legend data-labels="bind:innerHTML, rateit"></legend><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-attachevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div><ul class="actionbtn"><li><a class="attach-download" data-attach="bind: setRef, fileName" data-attachevent="listen:mousedown, press; listen:mouseup, download"></a></li><li><div class="a-2cent" data-attachevent="listen:mousedown, press; listen:mouseup, displayWriteTwocent"></div></li><li data-attach="bind:displayEdit, authors"><div class="a-edit" data-attachevent="listen:mousedown, press; listen:mouseup, edit"></div></li><li data-attach="bind:displayDelete, twocents"><div class="a-delete" data-attachevent="listen:mousedown, press; listen:mouseup, confirmDelete"></div></li><li class="a-publish invisible"><div class="sendmail" data-labels="bind: innerHTML, publishlbl" data-attachevent="listen:mousedown, press; listen: mouseup, update"></div></li><li class="a-cancel invisible"><div class="cancelmail" data-labels="bind: innerHTML, cancellbl" data-attachevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div></li></ul><p class="a-desc invisible" data-attach="bind: setDescription, description" data-attachevent="listen:input, updateDesc"></p><div class="attach-preview invisible"></div><div id="attach-writetwocents" data-attach="bind:showWriteTwocent, twocents"></div><div div id="attach-twocents" class="twocents" data-attach="bind:displayTwocentList, twocents" data-place="place:LibraryTwocentUI"></div></div></div>',m.reset=function(e){var a=m.dom.querySelector("#attach-writetwocents");f.reset(e),g.reset(e),M=!1,m.dom.classList.remove("invisible"),f.place(a),v||(v=new p(m.dom,L.get("deleteattachment"),m.deleteAttachment,"a-delconfirm"),v.hide()),b.unsync(),b.reset({}),b.sync(t.get("db"),e).then(function(){b.get("authors").indexOf(T.get("_id"))>-1&&m.resetEdit()},function(e){console.log(e)})},m.resetEdit=function(){w.reset({}),w.set("type",b.get("type")),w.set("name",b.get("name")),w.set("authors",b.get("authors").concat()),w.set("authornames",b.get("authornames")),w.set("fileName",b.get("fileName")),w.set("category",b.get("category")),w.set("custom",b.get("custom")),w.set("description",b.get("description")||L.get("attachdescplaceholder"))},m.close=function(){m.dom.classList.contains("edit-a")&&m.dom.classList.remove("edit-a"),m.dom.classList.add("invisible"),document.querySelector(".cache").classList.remove("appear")},m.previewVote=function(e,t){var a=t.getAttribute("data-vote_id");I.loop(function(e,t){a>=t?I.update(t,"active",!0):I.update(t,"active",!1)})},m.castVote=function(e,a){var s=parseInt(a.getAttribute("data-vote_id"))+1,i=b.get("_id"),n={id:i,vote:s,voter:T.get("_id")};M||(M=!0,A.request("Vote",n,function(e){var a=T.get("rated_a")||[];"ok"!==e?(console.log(e,"something went wrong, please try again later"),M=!1):(a.unshift(i),T.set("rated_a",a),alert(t.get("labels").get("thankyou")),m.dom.querySelector(".a-vote").classList.add("invisible"),m.dom.querySelector(".a-rating").classList.remove("invisible"),I.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},m.press=function(e,t){t.classList.contains("a-type")?m.dom.classList.contains("edit-a")&&t.classList.add("a-pressed"):t.classList.add("a-pressed")},m.download=function(e,t){t.classList.remove("a-pressed")},m.displayWriteTwocent=function(e,t){m.dom.querySelector("#attach-writetwocents").classList.remove("invisible"),t.classList.remove("a-pressed")},m.edit=function(e,t){var a=m.dom.querySelector(".a-name"),s=m.dom.querySelector(".a-desc");t.classList.remove("a-pressed"),m.dom.classList.add("edit-a"),a.setAttribute("contentEditable",!0),s.setAttribute("contentEditable",!0),b.get("description")||(s.classList.remove("invisible"),s.innerHTML=w.get("description"))},m.updateName=function(e,t){w.set("name",t.innerHTML)},m.updateDesc=function(e,t){w.set("description",t.innerText)},m.selectCat=function(e,t){if(t.value===t.lastChild.innerHTML){for(w.set("custom",!0),i=1,l=N.length;l>=i;i++)t.classList.remove("acolor"+i);t.classList.add("acolor")}else for(t.classList.remove("acolor"),w.set("custom",!1),w.set("category",N[t.selectedIndex-1]),i=1,l=N.length;l>=i;i++)t.selectedIndex===i?t.classList.add("acolor"+i):t.classList.remove("acolor"+i)},m.setCat=function(e,t){w.set("category",t.value)},m.check=function(e,t){t.classList.remove("a-pressed")},m.uploadFile=function(t,a){var s,i=new FileReader,n=new FormData,o=b.get("docId"),l="/upload",c="afile",d="";o.search("I:")>-1&&(s="ideas/"+o),a.files&&a.files.length&&(d=a.files[0].name,m.dom.querySelector(".a-preview").classList.remove("invisible"),w.set("fileName",d),w.get("name")||w.set("name",d),i.onloadend=function(){n.append("type",c),n.append("dir",s),n.append("userfile",a.files[0]),n.append("filename",d),e=u.uploadFile(l,n,y,function(e){return e})},i.readAsArrayBuffer(a.files[0]))},m.checkUpdate=function(){var e=!1;return(w.get("name")!==b.get("name")||w.get("description")!==b.get("description")||w.get("fileName")!==b.get("fileName")||w.get("category")!==b.get("category")||w.get("authors").join()!==b.get("authors").join())&&(e=!0),e},m.update=function(e,t){t.classList.remove("a-pressed"),m.checkUpdate()?(b.get("fileName")!==w.get("fileName")&&m.deleteAttachmentFile(b.get("fileName")),b.set("name",w.get("name")),b.set("description",w.get("description")),b.set("fileName",w.get("fileName")),b.set("category",w.get("category")),b.set("custom",w.get("custom")),b.set("authors",w.get("authors")),b.set("authornames",w.get("authornames")),m.dom.classList.remove("edit-a"),m.dom.querySelector(".a-name").setAttribute("contentEditable",!1),m.dom.querySelector(".a-desc").setAttribute("contentEditable",!1),m.dom.querySelector(".a-preview").classList.add("invisible"),m.resetEdit(),b.upload().then(function(){return m.updateParentDoc(b.get("docId"))})):m.cancel()},m.cancel=function(t,a){a&&a.classList.remove("a-pressed"),e&&4!==e.readyState&&(e.abort(),y.reset({status:""})),w.get("fileName")!==b.get("fileName")&&m.deleteAttachmentFile(w.get("fileName")),m.dom.querySelector(".a-name").setAttribute("contentEditable",!1),m.dom.querySelector(".a-desc").setAttribute("contentEditable",!1),m.dom.querySelector(".a-preview").classList.add("invisible"),m.dom.classList.remove("edit-a"),m.resetEdit()},m.confirmDelete=function(e,t){t.classList.remove("a-pressed"),v.reset(L.get("deleteattachment"),m.deleteAttachment),v.show()},m.deleteAttachmentFile=function(e){return u.deleteAttachmentFile(b.get("docId"),e)},m.deleteAttachment=function(e){var a=b.get("docId"),i=b.get("_id"),n=b.get("fileName"),o=new s;e?(o.setTransport(A),o.sync(t.get("db"),a).then(function(){var e,t=o.get("attachments").concat()||[],a=t.length,s=null,n=new h;for(e=0;a>e;e++)if(t[e].docId===i){s=e;break}return null===s?n.reject("error: attachment not found"):(t.splice(s,1),o.set("attachments",t),o.upload().then(function(){n.fulfill()})),n}).then(function(){return console.log("before calling remove"),b.remove()}).then(function(){return m.close(),u.deleteAttachmentFile(a,n)})):v.hide()},m.updateParentDoc=function(e){var a=new h,i=new s;return i.setTransport(A),i.sync(t.get("db"),e).then(function(){var e,t,a=i.get("attachments").concat(),s=a.length;for(t=0;s>t;t++)if(a[t].docId===b.get("_id")){e=t;break}return a.splice(e,1,{docId:b.get("_id"),type:b.get("type"),category:b.get("category"),name:b.get("name"),fileName:b.get("fileName"),authornames:b.get("authornames")}),i.set("attachments",a),i.upload()}).then(function(){a.fulfill()}),a}}return function(t){return v.prototype=new e,new v(t)}});