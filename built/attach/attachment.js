/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","twocents/writetwocent","twocents/twocentlist","Place.plugin","service/utils","service/confirm","Promise","lib/spin.min"],function(e,t,a,s,n,o,c,d,r,u,p,h){function v(){var e,v=this,m=new d("attach"),g=new c("attach"),f=new s,b=new a,y=new a({status:null}),w=t.get("labels"),L=t.get("transport"),A=t.get("user"),T=t.get("cat"),N=new a([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]),I=!1;f.setTransport(L),v.plugins.addAll({labels:new n(w),attach:new n(f,{setCat:function(e){var a=t.get("catColors"),s=T.indexOf(e);s>-1?(this.innerHTML=w.get(e),this.setAttribute("style","color:"+a[s])):(this.innerHTML=e,this.setAttribute("sytle","color: #404040"))},setDescription:function(e){e&&"\n"!==e?(this.classList.remove("invisible"),this.innerHTML=e.replace(/\n/g,"<br>")):this.classList.add("invisible")},displayTwocentList:function(e){e&&e.length?this.classList.remove("invisible"):this.classList.add("invisible")},setDate:function(e){var t=parseInt(e.replace("A:",""),10);this.innerHTML=u.formatDateStamp(t)},setAuthors:function(e){var t="";if(e&&e instanceof Array&&e.length){for(i=0,l=e.length;l>i;i++)t+=i===l-1?e[i]:e[i]+", ";this.innerHTML=t}else this.innerHTML=e},showVoting:function(e){var t=A.get("rated_a")||[],a=f.get("authors");a.indexOf(A.get("_id"))>-1?this.classList.add("invisible"):t.indexOf(e)>-1?this.classList.add("invisible"):this.classList.remove("invisible")},showRating:function(e){var t=v.dom.querySelector(".a-vote");this.classList.add("invisible"),e&&e.length&&t.classList.contains("invisible")&&this.classList.remove("invisible")},displayRating:function(e){e&&e.length&&(this.innerHTML=Math.round(100*(e.reduce(function(e,t){return e+t})/e.length))/100)},displayNbVotes:function(e){this.innerHTML=e?0===e.length?"("+w.get("novotesyet")+")":1===e.length?"("+w.get("onevote")+")":"("+e.length+" "+w.get("votes")+")":""},setRef:function(e){var a,s=t.get("location")+"/downloads";f.get("docId").search("I:")>-1&&(a="idea"),e&&(s+="?atype="+a+"&docid="+f.get("docId")+"&file="+e,this.setAttribute("href",s),this.addEventListener("touchstart",u.showLinkInBrowser))},showWriteTwocent:function(e){length?this.classList.add("invisible"):this.classList.remove("invisible")},displayEdit:function(e){e.indexOf(A.get("_id"))>-1?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},displayDelete:function(e){e&&e.length?this.setAttribute("style","display:none;"):f.get("authors").indexOf(A.get("_id"))<0?this.setAttribute("style","display:none;"):this.setAttribute("style","display:inline-block;")}}),edit:new n(b,{show:function(e){e&&v.dom.classList.contains("edit-a")?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},setSelectCat:function(e){var t,a,s,i=A.get("categories")||[],n=null,o=this,l="<option selected disabled style='display:none;'>"+w.get("choosecat")+"</option>";for([1,2,3,4,5,6].forEach(function(e){o.classList.remove("acolor"+e),o.classList.add("acolor")}),t=0,a=T.length;a>t;t++)s=T[t],l+="<option>"+w.get(s)+"</option>",e===s&&(n=t+1,o.classList.add("acolor"+n));if(i.length)for(t=0,a=i.length;a>t;t++)l+="<option>"+i[t]+"</option>",e===i[t]&&(n=T.length+t+1);l+="<option>"+w.get("other")+"</option>",this.innerHTML=l,this.selectedIndex=n||0}}),progress:new n(y,{showStatus:function(e){e?this.setAttribute("value",e):this.setAttribute("value",0)},showVal:function(e){this.innerHTML=e?e+"%":""}}),vote:new n(N,{setIcon:function(e){var t="background-image: url('img/public/activeIdeaVote.png');",a="background-image: url('img/public/rateForList.png');";e?this.setAttribute("style",t):this.setAttribute("style",a)}}),place:new r({LibraryTwocentUI:m}),attachevent:new o(v)}),v.template='<div class = "attachment-screen invisible"><div class="close-popup" data-attachevent = "listen:mousedown, close"></div><div class="attach-header" data-attach="bind:innerHTML, name"></div><div class="attach-details"><div class="attach-body"><div class="a-type" data-attach="bind:setType, type"></div><div class="a-type-edit" data-attachevent="listen:mousedown, press"><input type="file" class="a-input" data-attachevent="listen:mousedown, check;listen:change, uploadFile"></div><div class="a-left"><div class="a-name" data-attach="bind:innerHTML, name" data-edit="bind:innerHTML, name" data-attachevent="listen:input, updateName"></div><div class="a-contrib"><span class="a-span" data-labels="bind: innerHTML, contrib"></span><span class="a-author" data-attach="bind: setAuthors, authornames"></span></div><div class="a-date" data-attach="bind:setDate, _id"></div></div><div class="a-cat"><span data-attach="bind:setCat, category"></span><select class="acolor invisible" data-edit="bind:setSelectCat, category" data-attachevent="listen: change, selectCat"></select><input maxlength=18 type="text" placeholder="Enter category" class="input custom-cat invisible" data-edit="bind:show, custom" data-attachevent="listen:input, setCat"></div><div class="a-rating invisible" data-attach="bind:showRating, votes"><a class="item-acorn"></a><span data-attach="bind:displayRating, votes"></span><span class="votes" data-attach="bind:displayNbVotes, votes"></span></div><div class="a-preview invisible"><div class="a-content" data-edit="bind:innerHTML, fileName"></div><progress class="uploadbar" data-progress="bind:showStatus, status" max=100></progress><div class="uploadval" data-progress="bind:showVal, status"></div></div><div class="a-vote" data-attach="bind:showVoting, _id"><legend data-labels="bind:innerHTML, rateit"></legend><ul class="acorns" data-vote="foreach"><li class="item-acorn" data-vote="bind: setIcon, active" data-attachevent="listen: mousedown, previewVote; listen: mouseup, castVote"></li></ul></div></div><ul class="actionbtn"><li><a class="attach-download" data-attach="bind: setRef, fileName" data-attachevent="listen:mousedown, press; listen:mouseup, download"></a></li><li><div class="a-2cent" data-attachevent="listen:mousedown, press; listen:mouseup, displayWriteTwocent"></div></li><li data-attach="bind:displayEdit, authors"><div class="a-edit" data-attachevent="listen:mousedown, press; listen:mouseup, edit"></div></li><li data-attach="bind:displayDelete, twocents"><div class="a-delete" data-attachevent="listen:mousedown, press; listen:mouseup, confirmDelete"></div></li><li class="a-publish invisible"><div class="sendmail" data-labels="bind: innerHTML, publishlbl" data-attachevent="listen:mousedown, press; listen: mouseup, update"></div></li><li class="a-cancel invisible"><div class="cancelmail" data-labels="bind: innerHTML, cancellbl" data-attachevent="listen: mousedown, press; listen: mouseup, cancel">Cancel</div></li></ul><p class="a-desc invisible" data-attach="bind: setDescription, description" data-attachevent="listen:input, updateDesc"></p><div class="attach-preview invisible"></div><div id="attach-writetwocents" data-attach="bind:showWriteTwocent, twocents"></div><div div id="attach-twocents" class="twocents" data-attach="bind:displayTwocentList, twocents" data-place="place:LibraryTwocentUI"></div></div></div>',v.reset=function(e){var a=v.dom.querySelector("#attach-writetwocents");g.reset(e),m.reset(e),I=!1,v.dom.classList.remove("invisible"),g.place(a),f.unsync(),f.reset({}),f.sync(t.get("db"),e).then(function(){f.get("authors").indexOf(A.get("_id"))>-1&&v.resetEdit()},function(e){console.log(e)})},v.resetEdit=function(){b.reset({}),b.set("type",f.get("type")),b.set("name",f.get("name")),b.set("authors",f.get("authors").concat()),b.set("authornames",f.get("authornames")),b.set("fileName",f.get("fileName")),b.set("category",f.get("category")),b.set("custom",f.get("custom")),b.set("description",f.get("description")||w.get("attachdescplaceholder"))},v.close=function(){v.dom.classList.contains("edit-a")&&v.dom.classList.remove("edit-a"),v.dom.classList.add("invisible"),document.querySelector(".cache").classList.remove("appear")},v.previewVote=function(e,t){var a=t.getAttribute("data-vote_id");N.loop(function(e,t){a>=t?N.update(t,"active",!0):N.update(t,"active",!1)})},v.castVote=function(e,a){var s=parseInt(a.getAttribute("data-vote_id"))+1,i=f.get("_id"),n={id:i,vote:s,voter:A.get("_id")};I||(I=!0,L.request("Vote",n,function(e){var a=A.get("rated_a")||[];"ok"!==e?(console.log(e,"something went wrong, please try again later"),I=!1):(a.unshift(i),A.set("rated_a",a),alert(t.get("labels").get("thankyou")),v.dom.querySelector(".a-vote").classList.add("invisible"),v.dom.querySelector(".a-rating").classList.remove("invisible"),N.reset([{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}]))}))},v.press=function(e,t){t.classList.contains("a-type")?v.dom.classList.contains("edit-a")&&t.classList.add("a-pressed"):t.classList.add("a-pressed")},v.download=function(e,t){t.classList.remove("a-pressed")},v.displayWriteTwocent=function(e,t){v.dom.querySelector("#attach-writetwocents").classList.remove("invisible"),t.classList.remove("a-pressed")},v.edit=function(e,t){var a=v.dom.querySelector(".a-name"),s=v.dom.querySelector(".a-desc");t.classList.remove("a-pressed"),v.dom.classList.add("edit-a"),a.setAttribute("contentEditable",!0),s.setAttribute("contentEditable",!0),f.get("description")||(s.classList.remove("invisible"),s.innerHTML=b.get("description"))},v.updateName=function(e,t){b.set("name",t.innerHTML)},v.updateDesc=function(e,t){b.set("description",t.innerText)},v.selectCat=function(e,t){if(t.value===t.lastChild.innerHTML){for(b.set("custom",!0),i=1,l=T.length;l>=i;i++)t.classList.remove("acolor"+i);t.classList.add("acolor")}else for(t.classList.remove("acolor"),b.set("custom",!1),b.set("category",T[t.selectedIndex-1]),i=1,l=T.length;l>=i;i++)t.selectedIndex===i?t.classList.add("acolor"+i):t.classList.remove("acolor"+i)},v.setCat=function(e,t){b.set("category",t.value)},v.check=function(e,t){t.classList.remove("a-pressed")},v.uploadFile=function(t,a){var s,i=new FileReader,n=new FormData,o=f.get("docId"),l="/upload",c="afile",d="";o.search("I:")>-1&&(s="ideas/"+o),a.files&&a.files.length&&(d=a.files[0].name,v.dom.querySelector(".a-preview").classList.remove("invisible"),b.set("fileName",d),b.get("name")||b.set("name",d),i.onloadend=function(){n.append("type",c),n.append("dir",s),n.append("userfile",a.files[0]),n.append("filename",d),e=u.uploadFile(l,n,y,function(e){return e})},i.readAsArrayBuffer(a.files[0]))},v.checkUpdate=function(){var e=!1;return(b.get("name")!==f.get("name")||b.get("description")!==f.get("description")||b.get("fileName")!==f.get("fileName")||b.get("category")!==f.get("category")||b.get("authors").join()!==f.get("authors").join())&&(e=!0),e},v.update=function(e,t){t.classList.remove("a-pressed"),v.checkUpdate()?(f.get("fileName")!==b.get("fileName")&&v.deleteAttachmentFile(f.get("fileName")),f.set("name",b.get("name")),f.set("description",b.get("description")),f.set("fileName",b.get("fileName")),f.set("category",b.get("category")),f.set("custom",b.get("custom")),f.set("authors",b.get("authors")),f.set("authornames",b.get("authornames")),v.dom.classList.remove("edit-a"),v.dom.querySelector(".a-name").setAttribute("contentEditable",!1),v.dom.querySelector(".a-desc").setAttribute("contentEditable",!1),v.dom.querySelector(".a-preview").classList.add("invisible"),v.resetEdit(),f.upload().then(function(){return v.updateParentDoc(f.get("docId"))})):v.cancel()},v.cancel=function(t,a){a&&a.classList.remove("a-pressed"),e&&4!==e.readyState&&(e.abort(),y.reset({status:""})),b.get("fileName")!==f.get("fileName")&&v.deleteAttachmentFile(b.get("fileName")),v.dom.querySelector(".a-name").setAttribute("contentEditable",!1),v.dom.querySelector(".a-desc").setAttribute("contentEditable",!1),v.dom.querySelector(".a-preview").classList.add("invisible"),v.dom.classList.remove("edit-a"),v.resetEdit()},v.confirmDelete=function(e,t){t.classList.remove("a-pressed"),p.reset(w.get("deleteattachment"),v.deleteAttachment,"a-delconfirm"),p.show()},v.deleteAttachmentFile=function(e){return u.deleteAttachmentFile(f.get("docId"),e)},v.deleteAttachment=function(e){var a=f.get("docId"),i=f.get("_id"),n=f.get("fileName"),o=new s;e?(o.setTransport(L),o.sync(t.get("db"),a).then(function(){var e,t=o.get("attachments").concat()||[],a=t.length,s=null,n=new h;for(e=0;a>e;e++)if(t[e].docId===i){s=e;break}return null===s?n.reject("error: attachment not found"):(t.splice(s,1),o.set("attachments",t),o.upload().then(function(){n.fulfill()})),n}).then(function(){return console.log("before calling remove"),f.remove()}).then(function(){return v.close(),u.deleteAttachmentFile(a,n)})):p.hide()},v.updateParentDoc=function(e){var a=new h,i=new s;return i.setTransport(L),i.sync(t.get("db"),e).then(function(){var e,t,a=i.get("attachments").concat(),s=a.length;for(t=0;s>t;t++)if(a[t].docId===f.get("_id")){e=t;break}return a.splice(e,1,{docId:f.get("_id"),type:f.get("type"),category:f.get("category"),name:f.get("name"),fileName:f.get("fileName"),authornames:f.get("authornames")}),i.set("attachments",a),i.upload()}).then(function(){a.fulfill()}),a}}return function(t){return v.prototype=new e,new v(t)}});