/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/config","Store","CouchDBDocument","Bind.plugin","Event.plugin","service/utils","Promise","lib/spin.min"],function(e,t,a,n,s,o,d,c,r){function u(){var e,c,u,p,m=this,g=t.get("transport"),f=t.get("user"),h=t.get("cat"),v=t.get("labels"),b=new n({custom:!1,category:"",name:"",description:"",type:"",fileName:"",authors:[f.get("_id")],authornames:f.get("username"),docId:"",rating:null,votes:[],twocents:[],uploaded:!1}),w=new a({status:null}),y=new r({color:"#657b99",lines:8,length:6,width:3,radius:6,top:-2,left:-2}).spin();b.setTransport(g),m.plugins.addAll({labels:new s(v),attach:new s(b,{show:function(e){e?this.setAttribute("style","display:inline-block;"):this.setAttribute("style","display:none;")},setContent:function(e){var t=this;switch(e){case"file":t.innerHTML=b.get("fileName");break;default:t.innerHTML=b.get("name")}},setName:function(e){this.value=e},resetCat:function(e){var t=this;""===e&&(t.selectedIndex=0,[1,2,3,4,5,6].forEach(function(e){t.classList.remove("acolor"+e),t.classList.add("acolor")}))},setAttachmentCat:function(e){if(!e){var t,a,n,s=[],i="<option selected disabled style='display:none;'>"+v.get("choosecat")+"</option>",o=this;for(t=0,a=h.length;a>t;t++)n=h[t],i+="<option>"+v.get(n)+"</option>";o.innerHTML=i,f.watchValue("categories",function(){for(i="<option selected disabled style='display:none;'>"+v.get("choosecat")+"</option>",f.get("categories")&&(s=f.get("categories")),t=0,a=h.length;a>t;t++)n=h[t],i+="<option>"+v.get(n)+"</option>";if(s.length)for(t=0,a=s.length;a>t;t++)i+="<option>"+s[t]+"</option>";i+="<option>"+v.get("other")+"</option>",o.innerHTML=i})}}}),progress:new s(w,{showStatus:function(e){e?this.setAttribute("value",e):this.setAttribute("value",0)},showVal:function(e){this.innerHTML=e?e+"%":""}}),addevent:new o(m)}),m.template='<div class="add-attachments"><select class="acolor" data-attach="bind:setAttachmentCat, uploaded; bind:resetCat, category" data-addevent="listen: change, selectCat"></select><input maxlength=18 type="text" placeholder="Enter category" class="input custom-cat" data-attach="bind:show, custom" data-addevent="listen:input, setCat"><input maxlength=36 type="text" placeholder="Enter name" class="input a-name" data-attach="bind:setName, name" data-addevent="listen: input, setName"><ul class="a-tools" data-attach="bind:show, category"><li class="toolbox-button"><div class="upload-button" name="upload" data-addevent="listen:mousedown, press; listen:mouseup, release"><input type="file" class="a-input" data-addevent="listen:change, uploadFile"></div><legend data-labels="bind:innerHTML, filelbl"></legend></li><li class="toolbox-button" style="display:none"><div class="importpic-button" name="import" data-addevent="listen:mousedown, press"></div><legend data-labels="bind:innerHTML, imagelbl"></legend></li><li class="toolbox-button" style="display:none"><div class="drawingtool-button" name="drawing" data-addevent="listen:mousedown, press"></div><legend data-labels="bind:innerHTML, drawinglbl">Drawing</legend></li></ul><div class="a-preview invisible"><div class="a-content" data-attach="bind:setContent, type"></div><progress class="uploadbar" data-progress="bind:showStatus, status" max=100></progress><div class="uploadval" data-progress="bind:showVal, status"></div></div><div class="a-button a-confirm" data-attach="bind:show, uploaded" data-addevent="listen:mousedown, press; listen: mousedown, aconfirm; listen:mouseup, release">&#10003</div><div class="a-button a-cancel" data-attach="bind:show, uploaded" data-addevent="listen:mousedown, press; listen:mousedown, acancel">&#10007</div><textarea class="a-desc input" data-labels="bind:placeholder, attachdescplaceholder" data-attach="bind: value, description" data-attachevent="listen: input, updateDesc"></textarea></div>',m.reset=function(e,t,a){c=e,u=t,p=a,b.unsync(),b.reset({custom:!1,category:"",name:"",description:"",type:"",fileName:"",authors:[f.get("_id")],authornames:[f.get("username")],docId:c,rating:null,votes:[],twocents:[],uploaded:!1}),m.dom.querySelector(".a-confirm").classList.remove("pressed"),m.dom.querySelector(".a-cancel").classList.remove("pressed"),m.dom.querySelector(".a-preview").classList.add("invisible")},m.show=function(){m.dom.classList.remove("invisible")},m.hide=function(){m.dom.classList.add("invisible")},m.press=function(e,t){t.classList.add("pressed")},m.release=function(e,t){t.classList.remove("pressed")},m.selectCat=function(e,t){if(t.selectedIndex>h.length){if(t.value===t.lastChild.innerHTML)b.set("custom",!0);else{for(b.set("custom",!1),i=1,l=h.length;l>=i;i++)t.classList.remove("acolor"+i);b.set("category",t.value)}t.classList.add("acolor")}else for(t.classList.remove("acolor"),b.set("custom",!1),b.set("category",h[t.selectedIndex-1]),i=1,l=h.length;l>=i;i++)t.selectedIndex===i?t.classList.add("acolor"+i):t.classList.remove("acolor"+i)},m.setCat=function(e,t){b.set("category",t.value)},m.setName=function(e,t){b.set("name",t.value)},m.updateDesc=function(e,t){b.set("description",t.value)},m.check=function(e,t){t.parentNode.classList.remove("pressed")},m.uploadFile=function(e,t){var a,n=new FileReader,s=new FormData,i=new Date,o=c,l="/upload",r="afile",p="";switch(u){case"idea":"new"===o&&(o="I:"+i.getTime()),a="ideas/"+o,c=o;break;default:"new"===o&&(o="I:"+i.getTime()),a="ideas/"+o,c=o}t.files&&t.files.length&&(p=t.files[0].name,m.dom.querySelector(".a-preview").classList.remove("invisible"),b.set("fileName",p),b.set("docId",o),b.get("name")||b.set("name",p),b.set("type","file"),n.onloadend=function(){s.append("type",r),s.append("dir",a),s.append("userfile",t.files[0]),s.append("filename",p),_uploadReq=d.uploadFile(l,s,w,function(){b.set("uploaded",!0)})},n.readAsArrayBuffer(t.files[0]))},m.deleteAttachmentFile=function(e){return d.deleteAttachmentFile(c,e)},m.deleteAttachmentDoc=function(e){return d.deleteAttachmentDoc(e)},m.aconfirm=function(e,a){var n=new Date,s="A:"+n.getTime();b.get("name")&&b.get("category")?(y.spin(a),b.sync(t.get("db"),s).then(function(e){return e&&console.log(e),b.upload()}).then(function(){var e=[];f.get("categories")&&(e=f.get("categories").concat()),p.alter("unshift",{docId:s,type:b.get("type"),category:b.get("category"),name:b.get("name"),fileName:b.get("fileName"),authornames:b.get("authornames")}),b.get("custom")&&-1===e.indexOf(b.get("category"))&&(e.push(b.get("category")),f.set("categories",e),f.upload()),y.stop(),m.reset(c,u,p)})):!b.get("name")},m.acancel=function(){var e=b.get("fileName");m.abortReq(),m.deleteAttachmentFile(e),m.reset(c,u,p)},m.getDocId=function(){return"new"===c?!1:c},m.getFileName=function(){return b.get("fileName")},m.getReq=function(){return e},m.abortReq=function(){e&&4!==e.readyState&&(e.abort(),w.reset({status:""}))}}return function(){return u.prototype=new e,new u}});