/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","Store"],function(e,t,i,n,s,a){return new function(){var o,r=new e,l=new a({userid:"",username:""}),c=s.get("user"),d=new a,u=s.get("labels"),p=s.get("transport"),g=!1,h=new a({error:""});return r.plugins.addAll({new2c:new i(d),dest:new i(l,{setHeader:function(e){this.innerHTML=u.get("sendtcprefix")+e+u.get("sendtcsuffix")}}),labels:new i(u),errormsg:new i(h),new2cevent:new n(r)}),r.template='<div><div class = "header blue-dark"><span data-dest="bind: setHeader, username"></span><div class="close-popup" data-new2cevent="listen:mousedown, cancel"></div></div><form class="form"><p><textarea class="description input" data-labels="bind:placeholder, twocentplaceholder" data-new2c="bind: value, message"></textarea></p><div><span class="errormsg" data-errormsg="bind:innerHTML, error"></span><div class="sendmail" data-new2cevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, sendlbl"></div></div></form></div>',r.render(),r.place(t.get("new2c-popup")),r.press=function(e,t){t.classList.add("pressed")},r.closePopup=function(){document.getElementById("new2c-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),d.reset(),l.reset(),h.reset({error:""})},r.reset=function(e){o=e,t.get("new2c-popup").classList.add("appear"),t.get("cache").classList.add("appear"),l.set("userid",o.userid),l.set("username",o.username),d.reset({author:c.get("_id"),message:"",firstname:c.get("firstname"),username:c.get("username"),date:[],datemod:"",plusones:0,replies:[]}),g=!1},r.cancel=function(){r.closePopup()},r.upload=function(e,t){var i,n=new Date,s={};d.get("message")?(g=!0,i=setInterval(function(){h.get("error")===u.get("sendinginprogress")?h.set("error",u.get("sendinginprogress")+" ..."):h.set("error",u.get("sendinginprogress"))},150),d.set("date",[n.getFullYear(),n.getMonth(),n.getDate()]),s.tc=JSON.parse(d.toJSON()),s.userid=l.get("userid"),s.username=l.get("username"),p.request("SendTwocent",s,function(e){var n,a=o.twocents||[],l=c.get("connections");if("ok"===e){for(a.unshift(s.tc),o.twocents=a,n=l.length-1;n>=0;n--)"user"===l[n].type&&l[n].userid===o.userid&&l.splice(n,1,o);c.set("connections",l),c.upload().then(function(){clearInterval(i),t.classList.remove("pressed"),r.closePopup()})}else h.set("error","something went wrong - try again later"),clearInterval(i),t.classList.remove("pressed")})):(h.set("error",u.get("nomessage")),t.classList.remove("pressed"))},r}});