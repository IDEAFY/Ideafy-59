/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["service/config","Observable","Promise","LocalStore","SocketIOTransport","CouchDBDocument","CouchDBView"],function(e,t,i,n,s,a,o){var r={},c=e.get("user"),d=e.get("transport");return r.isOnline=function(t,n){var s=new o,a=new i;return s.setTransport(d),s.sync(e.get("db"),"users","_view/online",{key:'"'+t+'"'}).then(function(){s.getNbItems()?n.set("online",!0):n.set("online",!1),a.fulfill(),s.unsync()}),a},r.formatDate=function(e){var t=e[1]+1;return 0===c.get("lang").search("en")?t+"/"+e[2]+"/"+e[0]:(10>t&&(t="0"+t),e[2]+"/"+t+"/"+e[0])},r.formatDateStamp=function(e){var t=new Date(e),i=[t.getFullYear(),t.getMonth()+1,t.getDate()];return r.formatDate(i)},r.formatDuration=function(e){var t,i,n,s,a,o;return e?(t=Math.round(e/1e3),i=Math.floor(t/86400),n=Math.floor(t%86400/3600),s=Math.floor(t%86400%3600/60),a=Math.floor(t%86400%3600%60),o=i>0?i+"d ":"",o+=n>0?n+":":"",o+=s>0?(n>0&&10>s?"0":"")+s+":":"0:",o+=10>a?"0"+a:a):o="",o},r.formatTime=function(e){var t=new Date(e),i=t.getHours(),n=t.getMinutes(),s=t.getSeconds(),a="";return a+=i+":",a+=n>0?(i>0&&10>n?"0":"")+n+":":"00:",a+=10>s?"0"+s:s},r.computeTimeStamp=function(e,t){var i,n=new Date,s=n.getTimezoneOffset(),a=e||n.getTime(),o=t||0;return i=a+o+s},r.displayFirstSentence=function(e,t){var i=[];return i=t.split("."[0],1),i[0].length>140&&(e.innerHTML=i[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")),e.innerHTML},r.truncate=function(e,t){for(e.innerHTML=t;e.scrollHeight>e.offsetHeight;){var i=e.innerHTML;e.innerHTML=i.replace(/\W*\s(\S)*$/,"...")}return e.innerHTML},r.setRating=function(e,t){var i,n="<img src = 'img/wall/disableIdeaVote.png'>",s="<img src = 'img/wall/semi-activeIdeaVote.png'>",a="<img src = 'img/wall/activeIdeaVote.png'>",o="";if(t){for(i=0;i<Math.floor(t);)o+=a,i++;for(5>i&&(o+=Math.round(t-Math.floor(t))?s:n,i++);5>i;)o+=n,i++}else for(i=0;5>i;i++)o+=n;e.innerHTML=o},r.searchArray=function(e,t){var i,n,s,a,o=t.toLowerCase().split(" "),r=[];for(i=0,l=e.length;l>i;i++){for(s=JSON.stringify(e[i]).toLowerCase(),a=0,n=0;n<o.length&&s.search(o[n])>-1;n++)a++;a===o.length&&r.push(e[i])}return r},r.sortByProperty=function(e,t,i){switch(t){case"idea":e.sort(function(e,n){var s,a,o=e[t],l=n[t];return i?(o&&o instanceof Array&&o.length?(r.sortByProperty(o,"title",!0),s=o[0].title):s="",l&&l instanceof Array&&l.length?(r.sortByProperty(l,"title",!0),a=l[0].title):a="",a>s?1:s>a?-1:0):(o&&o instanceof Array&&o.length?(r.sortByProperty(o,"title",!1),s=o[0].title):s="",l&&l instanceof Array&&l.length?(r.sortByProperty(l,"title",!1),a=l[0].title):a="",a>s?-1:s>a?1:0)});break;case"date":e.sort(function(e,n){var s=e[t],a=n[t],o=new Date(s[0],s[1],s[2]),r=new Date(a[0],a[1],a[2]);return i?r>o?1:o>r?-1:0:r>o?-1:o>r?1:0});break;default:e.sort(function(e,n){var s=e[t],a=n[t];return"string"==typeof s||"string"==typeof a?(s&&s.toLowerCase&&(s=s.toLowerCase()),a&&a.toLowerCase&&(a=a.toLowerCase()),i?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0):i?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0})}},r.uploadFile=function(t,i,n,s){var a=new XMLHttpRequest;return a.open("POST",e.get("location")+t),a.onreadystatechange=function(){4===a.readyState&&s&&s(a)},a.upload.onprogress=function(e){e.lengthComputable&&n&&n.set("status",Math.round(100*(e.loaded/e.total)))},"afile"===i.type?(a.setRequestHeader("content-type",'multipart/form-data; boundary="--=====Ideafy=====--"'),a.sendAsBinary(i)):a.send(i),a},r.checkServerStatus=function(){var t=new i,n=new XMLHttpRequest;return n.open("GET",e.get("location")),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?t.fulfill():t.reject())},n.send(),t},r.checkSocketStatus=function(){var t=e.get("socket"),i=e.get("observer");t.socket.connected?c.get("online")||i.notify("reconnect","user"):(t.socket.reconnect(),i.notify("reconnect","all"))},r.disconnectSocket=function(){e.get("socket").socket.disconnect(),e.get("observer").notify("disconnect")},r.updateLabels=function(t){var s={lang:t},a=new n,o=e.get("labels"),r=new i;return a.sync("ideafy-data"),d.request("Lang",s,function(t){"nok"===t?(a.set("labels",e.get("defaultLabels")),e.set("lang","en-us")):(a.set("labels",t),e.set("lang",t.language)),a.sync("ideafy-data"),o.reset(a.get("labels")),r.fulfill()}),r},r.getAvatarById=function(t){var s=new i,a=(new n,e.get("avatars"));return a.get(t)&&"in progress"!==a.get(t)?s.fulfill(a.get(t)):"in progress"===a.get(t)?a.watchValue(t,function(e){e&&"in progress"!==e&&(a.unwatch(t),s.fulfill(e))}):(a.set(t,"in progress"),d.request("GetAvatar",{id:t},function(e){if(e.error)s.reject();else{if(a.getNbItems()<100)a.set(t,e);else{var i=a.toJSON(),n=i.keys();a.del(n[0]),a.set(t,e)}s.fulfill(e)}})),s},r.getAvatarByFileName=function(e,t){d.request("GetAvatar",{file:e},function(e){t(e)})},r.getGrade=function(e,t){d.request("GetGrade",{ip:e,lang:c.get("lang")},function(e){t(e)})},r.getAchievements=function(e,t){d.request("GetAchievements",{userid:e,lang:c.get("lang")},function(e){t(e)})},r.getUserDetails=function(e,t){d.request("GetUserDetails",{userid:e},function(e){t(e)})},r.getUserContactIds=function(){var e=[],t=c.get("connections").concat();return t.forEach(function(t){"user"===t.type&&e.push(t.userid)}),e},r.checkProfileCompletion=function(){var t=e.get("labels"),i={percentage:0,missing:[]};return c.get("firstname")&&c.get("lastname")&&(i.percentage+=10),3===c.get("birthdate").length?i.percentage+=10:i.missing.push(t.get("enterbirthdate")),null!==c.get("family").couple&&null!==c.get("family").children?i.percentage+=10:i.missing.push(t.get("enterfamily")),c.get("address").city&&c.get("address").country?i.percentage+=10:i.missing.push(t.get("enteraddress")),c.get("intro")&&"Ideafyer"!==c.get("intro")?i.percentage+=10:i.missing.push(t.get("enterintro")),c.get("occupation").situation>=0&&c.get("occupation").job&&c.get("occupation").organization?i.percentage+=10:i.missing.push(t.get("enteroccupation")),c.get("leisure_activities")[0].name&&c.get("leisure_activities")[1].name?i.percentage+=10:i.missing.push(t.get("enterleisure")),c.get("interests")[0].name&&c.get("interests")[1].name?i.percentage+=10:i.missing.push(t.get("enterinterest")),c.get("twitter")||c.get("facebook")||c.get("gplus")||c.get("linkedin")?i.percentage+=10:i.missing.push(t.get("entersocialnw")),c.get("picture_file").search("img/avatars/deedee")<0?i.percentage+=10:i.missing.push(t.get("enterownpic")),i},r.stringToBytes=function(e){var t,i,n,s,a=[],o=0;for(n=0;n<e.length;n++)if(t=e.charCodeAt(n),127>t)a[o++]=255&t;else{i=[];do i.unshift(255&t),t>>=8;while(t);for(s=0;s<i.length;s++)a[o++]=i[s]}return a},r.changeStyle=function(e){var t=document.querySelector(".currentStyle"),i=t.getAttribute("href");i!=="css/"+e&&t.setAttribute("href","css/"+e)},r.exitListener=function(e,t){var i=function(i){var n;for(n=i.target;n;n=n.parentNode)if(n.id===e)return;i.target.classList.contains("deedee")||i.target.classList.contains("notify-header")||i.target.classList.contains("exit-brainstorm")||"dock"===i.target.id||i.target.classList.contains("close-help")||(i.stopPropagation(),t(i.target))};return document.addEventListener("mousedown",i,!0),i},r.deleteAttachmentFile=function(e,t){var n={},s=new i;return 0===e.search("I:")&&(n.type="idea"),n.docId=e,n.file=t,d.request("DeleteAttachment",n,function(e){"ok"===e?s.fulfill():s.reject()}),s},r.deleteAttachmentDoc=function(t){var n=new i,s=new a;return s.setTransport(d),s.sync(e.get("db"),t).then(function(){var e="",t=s.get("docId");return 0===t.search("I:")&&(e="idea"),r.deleteAttachmentFile(e,t,s.get("fileName"))}).then(function(){return s.remove()}).then(function(){n.fulfill()}),n},r});