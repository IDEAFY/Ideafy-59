/*
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["service/config","Observable","Promise","LocalStore","SocketIOTransport","CouchDBDocument"],function(e,t,n,i,s,a){var o={},r=e.get("user"),c=e.get("transport");return e.get("socket"),o.formatDate=function(e){var t=e[1]+1;return 0===r.get("lang").search("en")?t+"/"+e[2]+"/"+e[0]:(10>t&&(t="0"+t),e[2]+"/"+t+"/"+e[0])},o.formatDateStamp=function(e){var t=new Date(e),n=[t.getFullYear(),t.getMonth()+1,t.getDate()];return o.formatDate(n)},o.formatDuration=function(e){var t,n,i,s,a,o;return e?(t=Math.round(e/1e3),n=Math.floor(t/86400),i=Math.floor(t%86400/3600),s=Math.floor(t%86400%3600/60),a=Math.floor(t%86400%3600%60),o=n>0?n+"d ":"",o+=i>0?i+":":"",o+=s>0?(i>0&&10>s?"0":"")+s+":":"0:",o+=10>a?"0"+a:a):o="",o},o.formatTime=function(e){var t=new Date(e),n=t.getHours(),i=t.getMinutes(),s=t.getSeconds(),a="";return a+=n+":",a+=i>0?(n>0&&10>i?"0":"")+i+":":"00:",a+=10>s?"0"+s:s},o.computeTimeStamp=function(e,t){var n,i=new Date,s=i.getTimezoneOffset(),a=e||i.getTime(),o=t||0;return n=a+o+s},o.displayFirstSentence=function(e,t){var n=[];return n=t.split("."[0],1),n[0].length>140&&(e.innerHTML=n[0].substr(0,139).replace(/\w*\s(\S)*$/," ...")),e.innerHTML},o.truncate=function(e,t){for(e.innerHTML=t;e.scrollHeight>e.offsetHeight;){var n=e.innerHTML;e.innerHTML=n.replace(/\W*\s(\S)*$/,"...")}return e.innerHTML},o.setRating=function(e,t){var n,i="<img src = 'img/wall/disableIdeaVote.png'>",s="<img src = 'img/wall/semi-activeIdeaVote.png'>",a="<img src = 'img/wall/activeIdeaVote.png'>",o="";if(t){for(n=0;n<Math.floor(t);)o+=a,n++;for(5>n&&(o+=Math.round(t-Math.floor(t))?s:i,n++);5>n;)o+=i,n++}else for(n=0;5>n;n++)o+=i;e.innerHTML=o},o.searchArray=function(e,t){var n,i,s,a,o=t.toLowerCase().split(" "),r=[];for(n=0,l=e.length;l>n;n++){for(s=JSON.stringify(e[n]).toLowerCase(),a=0,i=0;i<o.length&&s.search(o[i])>-1;i++)a++;a===o.length&&r.push(e[n])}return r},o.sortByProperty=function(e,t,n){switch(t){case"idea":e.sort(function(e,i){var s,a,r=e[t],l=i[t];return n?(r&&r instanceof Array&&r.length?(o.sortByProperty(r,"title",!0),s=r[0].title):s="",l&&l instanceof Array&&l.length?(o.sortByProperty(l,"title",!0),a=l[0].title):a="",a>s?1:s>a?-1:0):(r&&r instanceof Array&&r.length?(o.sortByProperty(r,"title",!1),s=r[0].title):s="",l&&l instanceof Array&&l.length?(o.sortByProperty(l,"title",!1),a=l[0].title):a="",a>s?-1:s>a?1:0)});break;case"date":e.sort(function(e,i){var s=e[t],a=i[t],o=new Date(s[0],s[1],s[2]),r=new Date(a[0],a[1],a[2]);return n?r>o?1:o>r?-1:0:r>o?-1:o>r?1:0});break;default:e.sort(function(e,i){var s=e[t],a=i[t];return"string"==typeof s||"string"==typeof a?(s&&s.toLowerCase&&(s=s.toLowerCase()),a&&a.toLowerCase&&(a=a.toLowerCase()),n?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0):n?a>s?1:s>a?-1:0:a>s?-1:s>a?1:0})}},o.uploadFile=function(t,n,i,s){var a=new XMLHttpRequest;return a.open("POST",e.get("location")+t),a.onreadystatechange=function(){4===a.readyState&&s&&s(a)},a.upload.onprogress=function(e){e.lengthComputable&&i&&i.set("status",Math.round(100*(e.loaded/e.total)))},"afile"===n.type?(a.setRequestHeader("content-type",'multipart/form-data; boundary="--=====Ideafy=====--"'),a.sendAsBinary(n)):a.send(n),a},o.checkServerStatus=function(){var t=new n,i=new XMLHttpRequest;return i.open("GET",e.get("location")),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?t.fulfill():t.reject())},i.send(),t},o.checkSocketStatus=function(){var t=e.get("socket"),n=e.get("observer");t.socket.connected?r.get("online")||n.notify("reconnect","user"):(t.socket.connect(e.get("location")),n.notify("reconnect","all"))},o.disconnectSocket=function(){e.get("socket").socket.disconnect(),e.get("observer").notify("disconnect")},o.updateLabels=function(t){var s={lang:t},a=new i,o=e.get("labels"),r=new n;return a.sync("ideafy-data"),c.request("Lang",s,function(t){"nok"===t?(a.set("labels",e.get("defaultLabels")),e.set("lang","en-us")):(a.set("labels",t),e.set("lang",t.language)),a.sync("ideafy-data"),o.reset(a.get("labels")),r.fulfill()}),r},o.getAvatarById=function(t){var s=new n,a=(new i,e.get("avatars"));return a.get(t)&&"in progress"!==a.get(t)?s.fulfill(a.get(t)):"in progress"===a.get(t)?a.watchValue(t,function(e){e&&"in progress"!==e&&s.fulfill(e)}):(a.set(t,"in progress"),c.request("GetAvatar",{id:t},function(e){if(e.error)s.reject();else{if(a.getNbItems()<100)a.set(t,e);else{var n=a.toJSON(),i=n.keys();a.del(i[0]),a.set(t,e)}s.fulfill(e)}})),s},o.getAvatarByFileName=function(e,t){c.request("GetAvatar",{file:e},function(e){t(e)})},o.getGrade=function(e,t){c.request("GetGrade",{ip:e,lang:r.get("lang")},function(e){t(e)})},o.getAchievements=function(e,t){c.request("GetAchievements",{userid:e,lang:r.get("lang")},function(e){t(e)})},o.getUserDetails=function(e,t){c.request("GetUserDetails",{userid:e},function(e){t(e)})},o.getUserContactIds=function(){var e=[],t=r.get("connections").concat();return t.forEach(function(t){"user"===t.type&&e.push(t.userid)}),e},o.getContactUsernames=function(){var e=[],t=r.get("connections").concat();return t.forEach(function(t){"user"===t.type&&e.push(t.username)}),e},o.checkProfileCompletion=function(){var t=e.get("labels"),n={percentage:0,missing:[]};return r.get("firstname")&&r.get("lastname")&&(n.percentage+=10),3===r.get("birthdate").length?n.percentage+=10:n.missing.push(t.get("enterbirthdate")),null!==r.get("family").couple&&null!==r.get("family").children?n.percentage+=10:n.missing.push(t.get("enterfamily")),r.get("address").city&&r.get("address").country?n.percentage+=10:n.missing.push(t.get("enteraddress")),r.get("intro")&&"Ideafyer"!==r.get("intro")?n.percentage+=10:n.missing.push(t.get("enterintro")),r.get("occupation").situation>=0&&r.get("occupation").job&&r.get("occupation").organization?n.percentage+=10:n.missing.push(t.get("enteroccupation")),r.get("leisure_activities")[0].name&&r.get("leisure_activities")[1].name?n.percentage+=10:n.missing.push(t.get("enterleisure")),r.get("interests")[0].name&&r.get("interests")[1].name?n.percentage+=10:n.missing.push(t.get("enterinterest")),r.get("twitter")||r.get("facebook")||r.get("gplus")||r.get("linkedin")?n.percentage+=10:n.missing.push(t.get("entersocialnw")),r.get("picture_file").search("img/avatars/deedee")<0?n.percentage+=10:n.missing.push(t.get("enterownpic")),n},o.stringToBytes=function(e){var t,n,i,s,a=[],o=0;for(i=0;i<e.length;i++)if(t=e.charCodeAt(i),127>t)a[o++]=255&t;else{n=[];do n.unshift(255&t),t>>=8;while(t);for(s=0;s<n.length;s++)a[o++]=n[s]}return a},o.changeStyle=function(e){var t=document.querySelector(".currentStyle"),n=t.getAttribute("href");n!=="css/"+e&&t.setAttribute("href","css/"+e)},o.exitListener=function(e,t){var n=function(n){var i;for(i=n.target;i;i=i.parentNode)if(i.id&&i.id===e)return;(n.target.classList.contains("deedee")||n.target.classList.contains("notify-header")||n.target.classList.contains("exit-brainstorm")||n.target.classList.contains("dock-item"))&&(n.stopPropagation(),t(n.target))};return document.addEventListener("mousedown",n,!0),n},o.deleteAttachmentFile=function(e,t){var i={},s=new n;return 0===e.search("I:")&&(i.type="idea"),i.docId=e,i.file=t,c.request("DeleteAttachment",i,function(e){"ok"===e?s.fulfill():s.reject()}),s},o.deleteAttachmentDoc=function(t){var i=new n,s=new a;return s.setTransport(c),s.sync(e.get("db"),t).then(function(){var e="",t=s.get("docId");return 0===t.search("I:")&&(e="idea"),o.deleteAttachmentFile(e,t,s.get("fileName"))}).then(function(){return s.remove()}).then(function(){i.fulfill()}),i},o});