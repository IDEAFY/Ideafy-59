/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,i,n,s,a,o,r){return new function(){var t=new e,o=new a(s.get("TQTemplate")),l=new a(s.get("userLanguages")),c=s.get("user"),d=function(){o.set("lang",c.get("lang")),l.loop(function(e,t){e.name===c.get("lang").substring(0,2)?l.update(t,"selected",!0):l.update(t,"selected",!1)})},u=s.get("labels"),p=140,g=new a({error:""}),h=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();return o.setTransport(s.get("transport")),c.watchValue("lang",function(){d()}),t.plugins.addAll({new2q:new i(o,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setLength:function(e){10===e&&this.setAttribute("maxlength",p)}}),select:new i(l,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new i(u),errormsg:new i(g,{setError:function(e){switch(e){case"noquestion":this.innerHTML=u.get("noquestion");break;case"lengthexceeded":this.innerHTML=u.get("lengthexceeded")+" ("+p+u.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new n(t)}),t.template='<div id="new2q-popup"><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-new2q="bind: displayLang, lang" data-new2qevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-new2qevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',t.showLang=function(e){e.stopPropagation(),e.preventDefault(),t.dom.querySelector(".idealang ul").classList.remove("invisible")},t.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),l.loop(function(e,t){i===t?l.update(t,"selected",!0):l.update(t,"selected",!1)})},t.setLang=function(e,i){var n;e.stopPropagation(),n=i.getAttribute("data-select_id"),o.set("lang",l.get(n).name),t.dom.querySelector(".idealang ul").classList.add("invisible")},t.press=function(e,i){i.classList.add("pressed"),t.dom.querySelector(".description").blur()},t.reset=function(){document.getElementById("cache").classList.add("appear"),o.unsync(),o.reset(s.get("TQTemplate")),d(),g.reset({error:""}),t.dom.querySelector(".idealang ul").classList.add("invisible"),t.dom.classList.add("appear")},t.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear")},t.cancel=function(){t.closePopup()},t.upload=function(e,i){var n,a=new Date,r="Q:"+a.getTime();i.classList.remove("pressed"),o.get("question")||g.set("error","noquestion"),g.get("error")||o.get("_id")||(i.classList.add("invisible"),h.spin(i.parentNode),n=setInterval(function(){g.get("error")===u.get("uploadinprogress")?g.set("error",u.get("uploadinprogress")+"..."):g.set("error",u.get("uploadinprogress"))},150),o.set("author",c.get("_id")),o.set("username",c.get("username")),o.set("creation_date",[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()]),o.set("lang",c.get("lang")),o.sync(s.get("db"),r).then(function(){return o.upload()}).then(function(){s.get("transport").request("UpdateUIP",{userid:c.get("_id"),type:o.get("type"),docId:r,question:o.get("question")},function(e){var l,d=c.get("connections"),p=d.length,m=[],v={type:"2Q+",docId:r,status:"unread",date:[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()],author:c.get("_id"),username:c.get("username"),firstname:c.get("firstname"),toList:"",ccList:"",object:c.get("username")+u.get("askednew"),body:o.get("question"),signature:""};for("ok"!==e&&console.log(e),clearInterval(n),n=setInterval(function(){g.get("error")===u.get("notifyingcontacts")?g.set("error",u.get("notifyingcontacts")+"..."):g.set("error",u.get("notifyingcontacts"))},150),l=0;p>l;l++)"user"===d[l].type&&m.push(d[l].userid);v.dest=m,s.get("transport").request("Notify",v,function(e){console.log(e)}),h.stop(),i.classList.remove("invisible"),t.closePopup()})}))},t.checkLength=function(e,t){t.value.length>=p?g.set("error","lengthexceeded"):g.set("error","")},t}});