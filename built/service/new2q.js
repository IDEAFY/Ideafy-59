/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","service/map","Bind.plugin","Event.plugin","service/config","CouchDBDocument","Promise","lib/spin.min"],function(e,t,i,n,s,a,o,r){return function(){var o=new e,l=new a(s.get("TQTemplate")),c=new a(s.get("userLanguages")),d=s.get("user"),u=function(){l.set("lang",d.get("lang")),c.loop(function(e,t){e.name===d.get("lang").substring(0,2)?c.update(t,"selected",!0):c.update(t,"selected",!1)})},p=s.get("labels"),g=140,h=new a({error:""}),m=new r({color:"#8cab68",lines:10,length:8,width:4,radius:8,top:-8,left:340}).spin();return l.setTransport(s.get("transport")),u(),o.plugins.addAll({new2q:new i(l,{displayLang:function(e){var t=e.substring(0,2);this.setAttribute("style","background-image:url('img/flags/"+t+".png');")},setLength:function(e){10===e&&this.setAttribute("maxlength",g)}}),select:new i(c,{setBg:function(e){this.setAttribute("style","background-image:url('img/flags/"+e+".png');")},setSelected:function(e){e?this.classList.add("selected"):this.classList.remove("selected")}}),labels:new i(p),errormsg:new i(h,{setError:function(e){switch(e){case"noquestion":this.innerHTML=p.get("noquestion");break;case"lengthexceeded":this.innerHTML=p.get("lengthexceeded")+" ("+g+p.get("characters")+")";break;default:this.innerHTML=e}}}),new2qevent:new n(o)}),o.template='<div><div class = "header blue-dark"><span data-labels="bind: innerHTML, createquestion"></span><div class="close-popup" data-new2qevent="listen:mousedown, cancel"></div></div><form class="form"><div class="idealang"><div class="currentlang" data-new2q="bind: displayLang, lang" data-new2qevent="listen: mouseup, showLang"></div><ul class="invisible" data-select="foreach"><li data-select="bind: setBg, name; bind: setSelected, selected" data-new2qevent="listen: mousedown, selectFlag; listen: mouseup, setLang"></li></ul></div><p><textarea class="description input" data-labels="bind:placeholder, questionplaceholder" data-new2q="bind: value, question; bind: setLength, type" data-new2qevent="listen:input, checkLength"></textarea></p><div><span class="errormsg" data-errormsg="bind:setError, error"></span><div class="sendmail" data-new2qevent="listen:mousedown, press; listen:mouseup, upload" data-labels="bind:innerHTML, publishlbl">Publish</div></div></form></div>',o.render(),o.place(t.get("new2q-popup")),o.showLang=function(e){e.stopPropagation(),e.preventDefault(),o.dom.querySelector(".idealang ul").classList.remove("invisible")},o.selectFlag=function(e,t){var i;e.stopPropagation(),i=parseInt(t.getAttribute("data-select_id"),10),c.loop(function(e,t){i===t?c.update(t,"selected",!0):c.update(t,"selected",!1)})},o.setLang=function(e,t){var i;e.stopPropagation(),i=t.getAttribute("data-select_id"),l.set("lang",c.get(i).name),o.dom.querySelector(".idealang ul").classList.add("invisible")},o.press=function(e,t){t.classList.add("pressed"),o.dom.querySelector(".description").blur()},o.closePopup=function(){document.getElementById("new2q-popup").classList.remove("appear"),document.getElementById("cache").classList.remove("appear"),l.unsync(),l.reset(s.get("TQTemplate")),u(),h.reset({error:""}),o.dom.querySelector(".idealang ul").classList.add("invisible")},o.cancel=function(){o.closePopup()},o.upload=function(e,t){var i,n=new Date,a="Q:"+n.getTime();t.classList.remove("pressed"),l.get("question")||h.set("error","noquestion"),h.get("error")||l.get("_id")||(t.classList.add("invisible"),m.spin(t.parentNode),i=setInterval(function(){h.get("error")===p.get("uploadinprogress")?h.set("error",p.get("uploadinprogress")+"..."):h.set("error",p.get("uploadinprogress"))},150),l.set("author",d.get("_id")),l.set("username",d.get("username")),l.set("creation_date",[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()]),l.set("lang",d.get("lang")),l.sync(s.get("db"),a).then(function(){return l.upload()}).then(function(){s.get("transport").request("UpdateUIP",{userid:d.get("_id"),type:l.get("type"),docId:a,question:l.get("question")},function(e){var r,c=d.get("connections"),u=c.length,g=[],v={type:"2Q+",docId:a,status:"unread",date:[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds()],author:d.get("_id"),username:d.get("username"),firstname:d.get("firstname"),toList:"",ccList:"",object:d.get("username")+p.get("askednew"),body:l.get("question"),signature:""};for("ok"!==e&&console.log(e),clearInterval(i),i=setInterval(function(){h.get("error")===p.get("notifyingcontacts")?h.set("error",p.get("notifyingcontacts")+"..."):h.set("error",p.get("notifyingcontacts"))},150),r=0;u>r;r++)"user"===c[r].type&&g.push(c[r].userid);v.dest=g,s.get("transport").request("Notify",v,function(e){console.log(e)}),m.stop(),t.classList.remove("invisible"),o.closePopup()})}))},o.checkLength=function(e,t){t.value.length>=g?h.set("error","lengthexceeded"):h.set("error","")},o}});