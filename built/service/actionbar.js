/**
 * https://github.com/IDEAFY/Ideafy
 * Proprietary License - All rights reserved
 * Author: Vincent Weyl <vincent@ideafy.com>
 * Copyright (c) 2014 IDEAFY LLC
 */

define(["OObject","Bind.plugin","Event.plugin","service/config","Store","CouchDBView","CouchDBDocument","Promise","service/new2c","lib/spin.min","service/confirm","service/utils"],function(e,t,i,n,s,a,o,r,c,d,u,p){function g(e,g,h){var m,v=new s([]),f=g.offsetHeight,b=new s({height:f}),w=10,y=n.get("user"),L=n.get("labels"),k=n.get("observer"),S=n.get("transport"),T=n.get("db"),M=this,A=new d({color:"#9AC9CD",lines:10,length:10,width:8,radius:10}).spin(),x=new d({color:"#a0a0a0",lines:10,length:6,width:4,radius:6}).spin();this.plugins.addAll({buttons:new t(v,{setIcon:function(e){this.setAttribute("style","background-image:url('"+e+"');")}}),style:new t(b,{setPosition:function(e){this.setAttribute("style","height:"+e+"px; margin-top:-"+(e-w)+"px;")},setButtons:function(e){var t=Math.floor((e-w-40)/2);this.setAttribute("style","margin-top:"+t+"px;")}}),action:new i(this)}),this.template='<div class="actionbar" data-style="bind:setPosition, height" data-action="listen:mouseup, hide"><ul class="buttonlist" data-style="bind:setButtons, height" data-buttons="foreach"><li class="actionbutton" data-buttons ="bind:setIcon,icon" data-action="listen:mousedown, press; listen:mouseup, action"></li></ul><div id="abspinner"></div></div>',this.hide=function(){var e=M.dom.parentElement;e&&e.removeChild(e.lastChild)},this.getParent=function(){return g},this.press=function(e,t){e.stopPropagation(),e.preventDefault(),t.classList.add("pressed"),A.el=document.getElementById("abspinner")},this.action=function(e,t){var i=t.getAttribute("data-buttons_id"),s=v.get(i).name;switch(e.stopPropagation(),e.preventDefault(),t.classList.remove("pressed"),s){case"delete":this.deleteItem().then(function(){M.hide()});break;case"edit":this.editItem();break;case"share":this.shareItem();break;case"replay":n.get("observer").notify("replay-session",h.sessionId);break;case"mail":this.mailItem();break;case"twocent":this.sendTwocent();break;case"unfav":x.spin(t),document.getElementById("public")?this.removeFav("public-favorites"):this.removeFav("library-favorites");break;case"addfav":x.spin(t),document.getElementById("public")?this.addFav("public-favorites"):this.addFav("library-favorites")}},m=function(e,t){var i;switch(e){case"idea":i=new a,i.setTransport(S),i.sync(T,"ideas","_view/all",{key:'"'+t+'"',include_docs:!0}).then(function(){var e=y.get("public-favorites")||[],s=y.get("library-favorites")||[];if(t=i.get(0).doc,h=i.get(0).doc,t.authors.indexOf(y.get("_id"))>-1&&v.alter("push",{name:"edit",icon:"img/wall/35modify.png"}),t.sessionId&&""!==t.sessionId&&-1===t.sessionId.search("deleted")&&(t.sessionReplay||t.authors.indexOf(y.get("_id"))>-1)){var o=new a;o.setTransport(n.get("transport")),o.sync(n.get("db"),"library","_view/sessioncount",{key:'"'+t.sessionId+'"'}).then(function(){o.get(0)&&v.alter("push",{name:"replay",icon:"img/library/25goToSession.png"})})}document.getElementById("public")?e.indexOf(t._id)>-1?v.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):v.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"}):document.getElementById("library")&&(s.indexOf(t._id)>-1?v.alter("push",{name:"unfav",icon:"img/public/unfav-actionbar.png"}):v.alter("push",{name:"addfav",icon:"img/public/addfav-actionbar.png"})),v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),t.authors.indexOf(y.get("_id"))>-1&&(y.get("connections")&&y.get("connections").length?v.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&v.alter("push",{name:"share",icon:"img/wall/35share.png"})),1!==t.authors.length||t.authors[0]!==y.get("_id")||t.twocents.length||t.sharedwith.length||"public"===t.visibility||v.alter("push",{name:"delete",icon:"img/wall/35delete.png"}),-1===t.authors.indexOf(y.get("_id"))&&t.sharedwith.indexOf(y.get("_id"))>-1&&document.getElementById("library")&&v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"deck":var s=new o;s.setTransport(S),s.sync(T,h).then(function(){s.get("created_by")===y.get("_id")&&(y.get("connections")&&y.get("connections").length?v.alter("push",{name:"share",icon:"img/wall/35share.png"}):(y.get("facebook")||y.get("twitter")||y.get("gplus")||y.get("linkedin"))&&v.alter("push",{name:"share",icon:"img/wall/35share.png"})),y.get("taiaut_decks").length+y.get("custom_decks").length>1&&v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})});break;case"message":v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),v.alter("push",{name:"delete",icon:"img/wall/35delete.png"});break;case"contact":v.alter("push",{name:"mail",icon:"img/wall/35mail.png"}),"user"===t.type&&v.alter("push",{name:"twocent",icon:"img/2centDisable.png"}),v.alter("push",{name:"delete",icon:"img/wall/35delete.png"})}},this.deleteItem=function(){var t=new r,i=new o,s=this;switch(i.setTransport(S),e){case"idea":1===h.authors.length&&h.authors[0]===y.get("_id")?i.sync(n.get("db"),h._id).then(function(){var e=i.get("attachments")||[];return e.length&&e.forEach(function(e){p.deleteAttachmentDoc(e.docId)}),i.remove()}).then(function(){t.fulfill()}):S.request("RemoveFromLibrary",{id:h._id,userid:y.get("_id")},function(){t.fulfill()});break;case"deck":y.get("active_deck")===h?(alert(L.get("cannotdelactivedeck")),s.hide()):(u.reset(L.get("deldeckwarning"),function(e){var n=new d({lines:10,length:20,width:8,radius:10}).spin();if(e)if(u.hide(),n.spin(document.getElementById("deckview")),document.getElementById("cache").classList.add("appear"),y.get("taiaut_decks").indexOf(h)>-1){var a=y.get("taiaut_decks");a.splice(a.indexOf(h),1),y.set("taiaut_decks",a),y.upload().then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})}else i.sync(T,h).then(function(){var e=i.get("sharedwith")||[],s=y.get("custom_decks").concat();e.length&&e.indexOf(y.get("_id"))>-1?(e.splice(e.indexOf(y.get("_id")),1),i.set("sharedwith",e),i.upload.then(function(){return s.splice(s.indexOf(h),1),y.set("custom_decks",s),y.upload()}).then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})):i.get("created_by")===y.get("_id")&&S.request("DeleteDeck",{id:h,userid:y.get("_id")},function(e){"ok"===e?(s.splice(s.indexOf(h),1),y.set("custom_decks",s),y.upload().then(function(){n.stop(),document.getElementById("cache").classList.remove("appear"),t.fulfill()})):console.log(e)})});else u.hide(),s.hide()},"importcard-confirm"),u.show());break;case"message":var a,c,g=y.get("notifications").concat();for(a=0,l=g.length;l>a;a++)if(JSON.stringify(g[a])===JSON.stringify(h)){c=a;break}g.splice(c,1),y.set("notifications",g),y.upload();break;case"contact":var g=y.get("connections"),m=new Date,v=[m.getFullYear(),m.getMonth(),m.getDate(),m.getHours(),m.getMinutes(),m.getSeconds()];if("user"===h.type){for(a=g.length-1;a>=0;a--)if("user"===g[a].type&&g[a].userid===h.userid)g.splice(a,1);else if("group"===g[a].type){var f=g[a].contacts;for(j=f.length-1;j>=0;j--)f[j].userid===h.userid&&f.splice(j,1)}}else for(a=g.length-1;a>=0;a--)g[a].username===h.username&&g.splice(a,1);y.set("connections",g),"user"===h.type&&y.get("news").unshift({type:"CX-",date:v,content:{userid:h.userid,username:h.username}}),y.upload().then(function(){if("user"===h.type){var e=(new Date,{dest:[h.userid],date:v,original:"",type:"CXCancel",author:y.get("_id"),username:y.get("username"),firstname:y.get("firstname"),toList:h.username,ccList:"",object:y.get("username")+L.get("canceledCX"),body:"",signature:"",contactInfo:{firstname:y.get("firstname"),lastname:y.get("lastname"),userid:y.get("_id"),username:y.get("username"),intro:y.get("intro"),type:"user"}});S.request("Notify",e,function(e){console.log(e)})}k.notify("contact-deleted")})}return t},this.editItem=function(){switch(e){case"idea":document.getElementById("public")?k.notify("public-edit",h._id):k.notify("library-edit",h._id)}A.stop()},this.mailItem=function(){switch(e){case"idea":document.getElementById("public")?k.notify("public-sendmail",h):k.notify("library-sendmail",h);break;case"message":break;case"contact":k.notify("message-contact",h)}},this.shareItem=function(){switch(e){case"idea":document.getElementById("public")?k.notify("public-share",h):k.notify("library-share",h);break;case"deck":k.notify("deck-share",h);break;case"message":break;case"contact":}},this.sendTwocent=function(){c.reset(h)},this.addFav=function(e){var t;t=y.get(e)?y.get(e).concat():[],t.length<100?(t.push(h._id),y.set(e,t),y.upload().then(function(){x.stop(),alert(L.get("addedfav")),M.hide()})):(x.stop(),alert(L.get("maxfavsize")),M.hide())},this.removeFav=function(e){var t;t=y.get(e)?y.get(e).concat():[],t.splice(t.indexOf(h._id),1),y.set(e,t),y.upload().then(function(){x.stop(),alert(L.get("removedfav")),M.hide()})},m(e,h)}return function(t,i,n){return g.prototype=new e,new g(t,i,n)}});